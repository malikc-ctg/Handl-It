<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG ‚Äî Sales Portal</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">
  
  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

  <!-- Sales Portal Styles -->
  <style>
    .health-bar {
      height: 4px;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .health-excellent { background: #10b981; }
    .health-good { background: #3b82f6; }
    .health-fair { background: #f59e0b; }
    .health-poor { background: #ef4444; }
    .timeline-item {
      position: relative;
      padding-left: 2rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: -1rem;
      width: 2px;
      background: #E5E7EB;
    }
    .timeline-item:last-child::before {
      display: none;
    }
    .single-scroll-container {
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
    }
  </style>
</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Sales Portal...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" 
        alt="NFG" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a id="nav-sales" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="sales.html" onclick="event.preventDefault(); if (window.switchTab) window.switchTab('dashboard');">
        <i data-lucide="trending-up" class="w-4 h-4"></i> Sales
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="routes.html">
        <i data-lucide="route" class="w-4 h-4"></i> Routes
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700 space-y-2">
      <a href="dashboard.html" onclick="sessionStorage.removeItem('isSalesMode');" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfgblue dark:bg-blue-600 text-white hover:bg-nfgdark dark:hover:bg-blue-700 w-full text-left font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Ops Mode
      </a>
      <button id="logout-btn" data-action="logout" class="w-full border border-nfgray dark:border-gray-600 text-nftext dark:text-gray-300 hover:bg-nfgray dark:hover:bg-gray-700 rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 id="page-title" class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Sales Portal</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="back-to-queue-btn" class="hidden px-3 py-1.5 text-sm bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 rounded-lg hover:bg-nfgray dark:hover:bg-gray-600 transition">
            <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> Back to Queue
          </button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden flex flex-col">
      <!-- Sales Dashboard Tabs -->
      <div class="border-b border-nfgray dark:border-gray-700 bg-white dark:bg-gray-800">
        <div class="px-4 md:px-6 flex gap-1 overflow-x-auto">
          <button class="sales-tab active px-4 py-3 text-sm font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue dark:border-blue-400 whitespace-nowrap" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-2"></i> Dashboard
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="deals">
            <i data-lucide="briefcase" class="w-4 h-4 inline mr-2"></i> Deals
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="quotes">
            <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i> Quotes
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="leads">
            <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i> Leads
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="contacts">
            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i> Contacts
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="calls">
            <i data-lucide="phone" class="w-4 h-4 inline mr-2"></i> Calls
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="sequences">
            <i data-lucide="repeat" class="w-4 h-4 inline mr-2"></i> Sequences
          </button>
        </div>
      </div>

      <!-- Tab Content Container -->
      <div class="flex-1 overflow-hidden">
        <!-- Dashboard Tab (Command Console) -->
        <div id="tab-dashboard" class="sales-tab-content h-full overflow-y-auto p-4 md:p-6">
          <!-- Sales Pipeline Header -->
          <div class="mb-4">
            <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Sales Pipeline</h2>
          </div>

          <!-- 1. Top KPI Strip (4 Cards) -->
          <div id="kpi-strip" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Card 1: Open Pipeline -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="open-pipeline">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Open Pipeline</span>
                <i data-lucide="trending-up" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <p id="kpi-total-open" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mb-1">$0</p>
              <p id="kpi-weighted-open" class="text-xs text-gray-500 dark:text-gray-400">Weighted: $0</p>
            </div>

            <!-- Card 2: Today -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="today">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Today</span>
                <i data-lucide="calendar" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Calls:</span>
                  <span id="kpi-today-calls" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Quotes:</span>
                  <span id="kpi-today-quotes" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Closed:</span>
                  <span id="kpi-today-closed" class="font-semibold text-green-600 dark:text-green-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Walkthroughs:</span>
                  <span id="kpi-today-walkthroughs" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
              </div>
            </div>

            <!-- Card 3: Next 7 Days -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="next-7-days">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Next 7 Days</span>
                <i data-lucide="clock" class="w-5 h-5 text-orange-500"></i>
              </div>
              <p id="kpi-at-risk" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-1">0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">At Risk</p>
            </div>

            <!-- Card 4: Urgent -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="urgent">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Urgent</span>
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Uncontacted:</span>
                  <span id="kpi-uncontacted" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Quotes <48h:</span>
                  <span id="kpi-quotes-expiring" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Idle >7d:</span>
                  <span id="kpi-idle-deals" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Priority Actions Queue -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Priority Actions</h3>
            <div id="priority-actions" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
              <div id="priority-actions-list" class="divide-y divide-nfgray dark:divide-gray-700">
                <!-- Priority actions will be rendered here -->
              </div>
            </div>
          </div>

          <!-- 3. Active Deals Table (Main Body) -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Active Deals</h3>
              <button id="create-deal-dashboard-btn" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition">
                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> New Deal
              </button>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Company</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Stage</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Deal $</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Last Contact</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Next Action</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Days Idle</th>
                    </tr>
                  </thead>
                  <tbody id="deals-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
                    <!-- Deals will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 4. Pipeline Stage Snapshot -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Pipeline Stages</h3>
            <div id="pipeline-snapshot" class="grid grid-cols-2 md:grid-cols-6 gap-3">
              <!-- Pipeline stages will be rendered here -->
            </div>
          </div>

          <!-- Bottom Section: Quotes Watch & Walkthroughs -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 5. Quotes Watch -->
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Quotes Watch</h3>
              <div id="quotes-watch" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
                <div id="quotes-watch-list" class="divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Quotes will be rendered here -->
                </div>
              </div>
            </div>

            <!-- 6. Walkthroughs Today -->
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Walkthroughs Today</h3>
              <div id="walkthroughs-today" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
                <div id="walkthroughs-list" class="divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Walkthroughs will be rendered here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Deals Tab -->
        <div id="tab-deals" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <!-- Deal Queue View -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div>
            <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Deal Queue</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your sales pipeline</p>
          </div>
          <button id="create-deal-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
            <i data-lucide="plus" class="w-4 h-4"></i> New Deal
          </button>
        </div>

        <!-- Deal List -->
        <div id="deals-list" class="space-y-4">
          <!-- Deals will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
          <div class="bg-white dark:bg-gray-800 border-2 border-dashed border-nfgray dark:border-gray-700 rounded-xl p-12 max-w-md mx-auto">
            <i data-lucide="trending-up" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-nfgblue dark:text-blue-400 font-semibold text-xl mb-2">No Deals Yet</h3>
            <p class="text-nftext dark:text-gray-300 text-sm mb-6">Get started by creating your first deal from a site.</p>
            <button id="create-first-deal-btn" class="bg-nfgblue hover:bg-nfgdark text-white rounded-xl px-6 py-3 font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-5 h-5"></i> Create Your First Deal
            </button>
          </div>
        </div>
      </div>

        <!-- Quotes Tab -->
        <div id="tab-quotes" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Quotes</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage and track all quotes</p>
            </div>
            <button id="new-quote-btn-tab" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Quote
            </button>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-4 mb-6 p-4 bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
              <select id="quotes-filter-status" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                <option value="">All Statuses</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="viewed">Viewed</option>
                <option value="accepted">Accepted</option>
                <option value="declined">Declined</option>
                <option value="expired">Expired</option>
                <option value="withdrawn">Withdrawn</option>
              </select>
            </div>
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quote Type</label>
              <select id="quotes-filter-type" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                <option value="">All Types</option>
                <option value="standard">Standard</option>
                <option value="walkthrough_required">Walkthrough Required</option>
                <option value="ballpark">Ballpark</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="quotes-filter-reset" class="px-4 py-2 text-sm border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition">
                Reset Filters
              </button>
            </div>
          </div>

          <!-- Quotes Table -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-nfglight dark:bg-gray-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Quote Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Latest Revision</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Total / Range</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Sent Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Expiry</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Owner</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="quotes-table-body" class="bg-white dark:bg-gray-800 divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Quotes will be rendered here -->
                </tbody>
              </table>
            </div>
            <div id="quotes-empty-state" class="hidden p-12 text-center">
              <i data-lucide="file-text" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
              <p class="text-gray-500 dark:text-gray-400">No quotes yet</p>
              <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Click "New Quote" to create your first quote</p>
            </div>
          </div>
        </div>

        <!-- Leads Tab -->
        <div id="tab-leads" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Leads</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Track and manage sales leads</p>
            </div>
            <button id="create-lead-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Lead
            </button>
          </div>
          <div id="leads-list" class="space-y-4">
            <!-- Leads will be rendered here -->
          </div>
        </div>

        <!-- Contacts Tab -->
        <div id="tab-contacts" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Contacts</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your contact database</p>
            </div>
            <button id="create-contact-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Contact
            </button>
          </div>
          <div id="contacts-list" class="space-y-4">
            <!-- Contacts will be rendered here -->
          </div>
        </div>

        <!-- Calls Tab -->
        <div id="tab-calls" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Calls</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">View call history and recordings</p>
            </div>
            <button id="new-call-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="phone" class="w-4 h-4"></i> New Call
            </button>
          </div>
          <div id="calls-list" class="space-y-4">
            <!-- Calls will be rendered here -->
          </div>
        </div>

        <!-- Sequences Tab -->
        <div id="tab-sequences" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Follow-Up Sequences</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Automate your follow-up workflows</p>
            </div>
            <button id="create-sequence-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Sequence
            </button>
          </div>
          <div id="sequences-list" class="space-y-4">
            <!-- Sequences will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Deal Detail View (Modal Overlay) -->
      <div id="deal-detail-view" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Deal Details</h3>
            <button id="close-deal-detail" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <!-- Deal Header -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
              <div class="flex-1">
                <h2 id="deal-detail-name" class="text-2xl font-semibold text-nfgblue dark:text-blue-400 mb-2">Deal Name</h2>
                <p id="deal-detail-site" class="text-gray-500 dark:text-gray-400">Site Name</p>
              </div>
              <div class="flex items-center gap-2">
                <span id="deal-detail-status" class="px-3 py-1 rounded-lg text-sm font-medium bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300">Active</span>
                <span id="deal-detail-priority" class="px-3 py-1 rounded-lg text-sm font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">High</span>
              </div>
            </div>
            
            <!-- Health Score -->
            <div class="mb-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Deal Health</span>
                <span id="deal-health-score" class="text-sm font-semibold text-nfgblue dark:text-blue-400">50%</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div id="deal-health-bar" class="health-bar h-2 rounded-full" style="width: 50%"></div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-2">
              <button id="call-deal-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="phone" class="w-4 h-4"></i> Call
              </button>
              <button id="text-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="message-square" class="w-4 h-4"></i> Text
              </button>
              <button id="email-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="mail" class="w-4 h-4"></i> Email
              </button>
              <button id="create-quote-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4"></i> Create Quote
              </button>
              <button id="set-appointment-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i> Set Appointment
              </button>
            </div>
          </div>

          <!-- Timeline Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Timeline</h3>
            <div id="timeline-container" class="space-y-4">
              <!-- Timeline items will be rendered here -->
            </div>
          </div>

          <!-- Post-Call Next Action Panel -->
          <div id="post-call-panel" class="hidden bg-nfglight dark:bg-gray-700 border border-nfgray dark:border-gray-600 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Next Action</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Action</label>
                <input type="text" id="next-action-input" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Follow up in 3 days">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date</label>
                <input type="datetime-local" id="next-action-date-input" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              </div>
              <button id="save-next-action-btn" class="w-full px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
                Save Next Action
              </button>
            </div>
          </div>

          <!-- Follow-Up Sequences -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Follow-Up Sequences</h3>
              <button id="assign-sequence-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                Assign Sequence
              </button>
            </div>
            <div id="sequences-container" class="space-y-3">
              <!-- Sequences will be rendered here -->
            </div>
          </div>

          <!-- Quotes Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Quotes</h3>
              <button id="new-quote-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                New Quote
              </button>
            </div>
            <div id="quotes-container" class="space-y-3">
              <!-- Quotes will be rendered here -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create Deal Modal -->
  <div id="create-deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create New Deal</h3>
          <button id="close-create-deal-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="create-deal-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Site</label>
          <select id="deal-site-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
            <option value="">Select a site...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
          <select id="deal-priority-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="urgent">Urgent</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estimated Value</label>
          <input type="number" id="deal-value-input" step="0.01" min="0" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
          <textarea id="deal-notes-input" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Add any notes..."></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancel-create-deal" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Create Deal
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quote Builder Modal (3-Step Wizard) -->
  <div id="quote-builder-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create Quote</h3>
          <button id="close-quote-builder-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <!-- Step Indicator -->
        <div class="flex items-center justify-between">
          <div class="flex items-center flex-1">
            <div class="flex items-center">
              <div id="wizard-step-1-indicator" class="w-8 h-8 rounded-full bg-nfgblue text-white flex items-center justify-center font-semibold text-sm">1</div>
              <span class="ml-2 text-sm font-medium text-nfgblue dark:text-blue-400">Account Type</span>
            </div>
            <div class="flex-1 h-0.5 bg-nfgray dark:bg-gray-700 mx-4"></div>
            <div class="flex items-center">
              <div id="wizard-step-2-indicator" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">2</div>
              <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Context</span>
            </div>
            <div class="flex-1 h-0.5 bg-nfgray dark:bg-gray-700 mx-4"></div>
            <div class="flex items-center">
              <div id="wizard-step-3-indicator" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">3</div>
              <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Pricing</span>
            </div>
            <div class="flex-1 h-0.5 bg-nfgray dark:bg-gray-700 mx-4"></div>
            <div class="flex items-center">
              <div id="wizard-step-4-indicator" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">4</div>
              <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Terms</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Content (scrollable) -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Step 1: Account Type Selection -->
        <div id="wizard-step-1" class="wizard-step space-y-4">
          <div class="text-center py-8">
            <h4 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Select Account Type</h4>
            <p class="text-gray-600 dark:text-gray-400 mb-8">Choose whether this quote is for a new account or an existing account</p>
            <div class="grid grid-cols-2 gap-6 max-w-2xl mx-auto">
              <button type="button" id="account-type-new" class="account-type-btn p-8 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue dark:hover:border-blue-400 rounded-xl bg-white dark:bg-gray-800 transition cursor-pointer text-center">
                <div class="text-4xl mb-4">‚ú®</div>
                <h5 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">New Account</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400">Create a quote for a new customer</p>
              </button>
              <button type="button" id="account-type-existing" class="account-type-btn p-8 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue dark:hover:border-blue-400 rounded-xl bg-white dark:bg-gray-800 transition cursor-pointer text-center">
                <div class="text-4xl mb-4">üè¢</div>
                <h5 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Existing Account</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400">Create a quote for an existing customer</p>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 2: Context -->
        <div id="wizard-step-2" class="wizard-step hidden space-y-4">
          <!-- Account Selection (conditional based on account type) -->
          <div id="existing-account-fields">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account (Site) <span class="text-red-500">*</span></label>
            <select id="quote-account-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              <option value="">Select an account...</option>
            </select>
          </div>
          <div id="new-account-fields" class="hidden">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
              <p class="text-sm text-blue-900 dark:text-blue-100">This quote is for a new account. Account details will be collected after the quote is accepted.</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Contact</label>
            <select id="quote-contact-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="">Select a contact...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deal (Optional)</label>
            <select id="quote-deal-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="">Link to a deal...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quote Type <span class="text-red-500">*</span></label>
            <select id="quote-type-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              <option value="standard">Standard Quote</option>
              <option value="walkthrough_required" selected>Walkthrough Required (Default for Commercial)</option>
              <option value="ballpark">Ballpark Estimate</option>
            </select>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Walkthrough Required: Client must complete a site walkthrough before final quote</p>
          </div>
        </div>

        <!-- Step 3: Pricing + Scope (dynamic based on quote type) -->
        <div id="wizard-step-3" class="wizard-step hidden space-y-6">
          <!-- CLEANING METRICS SECTION (All Quote Types) -->
          <div class="border border-nfgray dark:border-gray-700 rounded-xl p-4 bg-nfglight dark:bg-gray-700/50">
            <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Cleaning Metrics</h4>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Square Footage</label>
                <input type="number" id="quote-square-footage" min="0" step="100" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm" placeholder="5000">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Restrooms</label>
                <input type="number" id="quote-restrooms" min="0" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm" placeholder="3">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kitchens</label>
                <input type="number" id="quote-kitchens" min="0" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm" placeholder="1">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Floors</label>
                <input type="number" id="quote-floors" min="1" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm" placeholder="2" value="1">
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cleaning Frequency</label>
                <select id="quote-cleaning-frequency" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                  <option value="daily">Daily</option>
                  <option value="weekly" selected>Weekly</option>
                  <option value="biweekly">Bi-Weekly (Every 2 weeks)</option>
                  <option value="monthly">Monthly</option>
                  <option value="one_time">One-Time</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Per Square Foot Rate ($/sqft/month)</label>
                <input type="number" id="quote-per-sqft-rate" min="0" step="0.01" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm" placeholder="0.15">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Leave empty for manual pricing</p>
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cleaning Services</label>
              <div class="border border-nfgray dark:border-gray-600 rounded-lg p-3 bg-white dark:bg-gray-800 max-h-48 overflow-y-auto">
                <div id="quote-services-list" class="space-y-2">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Loading services...</p>
                </div>
              </div>
              <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Select services that will be included in this quote</p>
            </div>
          </div>

          <!-- For Walkthrough Required: Scope Summary Only -->
          <div id="walkthrough-scope-section" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Schedule Summary <span class="text-red-500">*</span></label>
              <textarea id="quote-service-schedule" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Weekly cleaning on Mondays and Thursdays, 2 hours per visit"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Scope Summary <span class="text-red-500">*</span></label>
              <textarea id="quote-scope-summary" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Describe what services will be included..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assumptions</label>
              <textarea id="quote-assumptions" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Any assumptions about the work..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exclusions</label>
              <textarea id="quote-exclusions" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="What is NOT included..."></textarea>
            </div>
            <!-- Optional Range Estimate -->
            <div class="border border-nfgray dark:border-gray-700 rounded-lg p-4 bg-nfglight dark:bg-gray-700/50">
              <label class="flex items-center mb-2">
                <input type="checkbox" id="include-range-estimate" class="mr-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Include Non-Binding Range Estimate</span>
              </label>
              <div id="range-estimate-fields" class="hidden mt-3 grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Low Estimate ($)</label>
                  <input type="number" id="quote-range-low" step="0.01" min="0" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">High Estimate ($)</label>
                  <input type="number" id="quote-range-high" step="0.01" min="0" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                </div>
              </div>
            </div>
          </div>

          <!-- For Standard/Ballpark: Line Items Builder -->
          <div id="binding-line-items-section" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Line Items</h4>
              <button type="button" id="add-line-item-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                + Add Line Item
              </button>
            </div>
            <div id="quote-line-items-list" class="space-y-3">
              <!-- Line items will be dynamically added here -->
            </div>
            <div class="border-t border-nfgray dark:border-gray-700 pt-4 mt-4">
              <div class="flex justify-end">
                <div class="text-right">
                  <div class="text-sm text-gray-600 dark:text-gray-400">Subtotal</div>
                  <div id="quote-subtotal" class="text-xl font-semibold text-gray-900 dark:text-gray-100">$0.00</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Tax (13% HST)</div>
                  <div id="quote-tax" class="text-lg text-gray-900 dark:text-gray-100">$0.00</div>
                  <div class="text-lg font-semibold text-nfgblue dark:text-blue-400 mt-2">Total</div>
                  <div id="quote-total" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">$0.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Terms + Send -->
        <div id="wizard-step-4" class="wizard-step hidden space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Billing Frequency</label>
              <select id="quote-billing-frequency" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                <option value="monthly" selected>Monthly</option>
                <option value="weekly">Weekly</option>
                <option value="biweekly">Bi-Weekly</option>
                <option value="one_time">One-Time</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contract Term (Months)</label>
              <input type="number" id="quote-contract-term" min="1" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="12" value="12">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Proposed Start Date</label>
            <input type="date" id="quote-start-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expiry (Days) <span class="text-red-500">*</span></label>
            <input type="number" id="quote-expiry-days" min="1" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="7" value="7" required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Quote will expire after this many days</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Send To (Email Addresses)</label>
            <input type="text" id="quote-send-emails" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="email@example.com, another@example.com">
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Separate multiple emails with commas</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Internal Notes (Not shown to client)</label>
            <textarea id="quote-internal-notes" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Internal notes only..."></textarea>
          </div>
        </div>
      </div>

      <!-- Footer with Navigation Buttons -->
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex-shrink-0 flex justify-between items-center">
        <button type="button" id="wizard-cancel-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
          Cancel
        </button>
        <div class="flex gap-3">
          <button type="button" id="wizard-back-btn" class="hidden px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            ‚Üê Back
          </button>
          <button type="button" id="wizard-save-draft-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Save Draft
          </button>
          <button type="button" id="wizard-next-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Next ‚Üí
          </button>
          <button type="button" id="wizard-send-btn" class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition">
            Send Quote
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quote Detail Modal -->
  <div id="quote-detail-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400" id="quote-detail-title">Quote Details</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="quote-detail-subtitle">Loading...</p>
          </div>
          <button id="close-quote-detail-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Content (scrollable) -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Walkthrough Status Block (if walkthrough_required) -->
        <div id="quote-walkthrough-block" class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl">
          <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Walkthrough Status</h4>
          <div id="walkthrough-status-content"></div>
          <div id="walkthrough-actions" class="mt-4 flex gap-2"></div>
        </div>

        <!-- Revisions List -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Revisions</h4>
          <div id="quote-revisions-list" class="space-y-4">
            <!-- Revisions will be rendered here -->
          </div>
        </div>

        <!-- Events Timeline -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Timeline</h4>
          <div id="quote-events-timeline" class="space-y-3">
            <!-- Events will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex-shrink-0 flex justify-between items-center">
        <button type="button" id="quote-detail-close-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
          Close
        </button>
        <div id="quote-detail-actions" class="flex gap-3">
          <!-- Action buttons will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Set sales mode flag in sessionStorage
    sessionStorage.setItem('isSalesMode', 'true');
    
    // Initialize environment
    window.ENV = {
      SUPABASE_URL: 'https://zqcbldgheimqrnqmbbed.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxY2JsZGdoZWltcXJucW1iYmVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDM5NjIsImV4cCI6MjA3NjI3OTk2Mn0.UYlnTQeCjNLed6g9oNRLQIXD69OgzRrXupl3LXUvh4I'
    };

    // Import modules
    console.log('[Sales Dashboard] Starting module imports...');
    let supabase, showNotification, toast, hideLoader, initializeUI, sales;
    
    try {
      const supabaseModule = await import('./js/supabase.js');
      supabase = supabaseModule.supabase;
      console.log('[Sales Dashboard] ‚úÖ supabase module loaded');
      
      const notificationsModule = await import('./js/notifications.js');
      toast = notificationsModule.toast;
      showNotification = notificationsModule.showNotification;
      console.log('[Sales Dashboard] ‚úÖ notifications module loaded');
      
      const loaderModule = await import('./js/loader.js');
      hideLoader = loaderModule.hideLoader;
      console.log('[Sales Dashboard] ‚úÖ loader module loaded');
      
      const uiModule = await import('./js/ui.js');
      initializeUI = uiModule.initializeUI;
      console.log('[Sales Dashboard] ‚úÖ ui module loaded');
      
      sales = await import('./js/sales.js');
      console.log('[Sales Dashboard] ‚úÖ sales module loaded');
      
      // Load quotes module
      window.quotesModule = await import('./js/quotes.js');
      console.log('[Sales Dashboard] ‚úÖ quotes module loaded');
      
      // Load quote wizard module
      window.quoteWizard = await import('./js/quote-wizard.js');
      console.log('[Sales Dashboard] ‚úÖ quote wizard module loaded');
      
      // Load quote detail module
      window.quoteDetail = await import('./js/quote-detail.js');
      console.log('[Sales Dashboard] ‚úÖ quote detail module loaded');
      
      console.log('[Sales Dashboard] ‚úÖ All modules loaded successfully');
    } catch (error) {
      console.error('[Sales Dashboard] ‚ùå Error loading modules:', error);
      // Show error immediately if modules can't load
      document.body.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-6 bg-gray-50 dark:bg-gray-900">
          <div class="bg-white dark:bg-gray-800 border border-red-300 dark:border-red-700 rounded-xl p-8 max-w-md text-center shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">Failed to Load</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Could not load required modules. Please check your browser console for details.</p>
            <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-3 rounded mb-4 text-left overflow-auto max-h-32">${error.message}\n${error.stack || ''}</pre>
            <button onclick="window.location.reload()" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
              Reload Page
            </button>
          </div>
        </div>
      `;
      throw error; // Stop execution
    }

    // Tab switching functionality
    function switchTab(targetTabName) {
      const tabs = document.querySelectorAll('.sales-tab');
      const tabContents = document.querySelectorAll('.sales-tab-content');
      const targetTab = Array.from(tabs).find(t => t.dataset.tab === targetTabName);
      
      if (!targetTab) return;
      
      // Update active tab
      tabs.forEach(t => {
        t.classList.remove('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        t.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
      });
      targetTab.classList.add('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
      targetTab.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');
      
      // Show/hide tab content
      tabContents.forEach(content => {
        if (content.id === `tab-${targetTabName}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
      
      // Load data for the active tab
      loadTabData(targetTabName);
    }
    
    // Make switchTab available globally for sidebar links
    window.switchTab = switchTab;
    
    function initTabs() {
      const tabs = document.querySelectorAll('.sales-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          switchTab(tab.dataset.tab);
        });
      });
      
      // Setup sidebar navigation links to switch tabs when on sales.html
      const dashboardLink = document.getElementById('nav-dashboard');
      if (dashboardLink) {
        dashboardLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('dashboard');
          }
        });
      }
      
      const salesLink = document.getElementById('nav-sales');
      if (salesLink) {
        salesLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('dashboard');
          }
        });
      }

      // Setup KPI card click handlers for filtering
      document.querySelectorAll('.kpi-card').forEach(card => {
        card.addEventListener('click', () => {
          const filter = card.dataset.filter;
          applyKPIFilter(filter);
        });
      });

      // Setup create deal button
      const createDealBtn = document.getElementById('create-deal-dashboard-btn');
      if (createDealBtn) {
        createDealBtn.addEventListener('click', () => {
          // Open create deal modal or navigate to deals tab
          if (window.sales && typeof window.sales.openCreateDealModal === 'function') {
            window.sales.openCreateDealModal();
          } else {
            switchTab('deals');
            // Trigger create deal button in deals tab
            setTimeout(() => {
              const dealsCreateBtn = document.getElementById('create-deal-btn');
              if (dealsCreateBtn) dealsCreateBtn.click();
            }, 100);
          }
        });
      }
    }

    // Apply KPI filter
    function applyKPIFilter(filter) {
      const tbody = document.getElementById('deals-table-body');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('.deal-row');
      const now = new Date();
      const sevenDaysFromNow = new Date(now);
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

      rows.forEach(row => {
        let show = true;
        const dealId = row.dataset.dealId;
        
        // This is a simplified filter - you may need to fetch deal data to filter properly
        switch(filter) {
          case 'open-pipeline':
            show = true; // All deals are open pipeline
            break;
          case 'today':
            // Filter deals with activity today
            show = true; // Simplified - would need to check last_contacted_at
            break;
          case 'next-7-days':
            // Filter deals at risk in next 7 days
            show = true; // Simplified - would need to check next_action_date
            break;
          case 'urgent':
            // Filter urgent deals (uncontacted, expiring quotes, idle)
            show = true; // Simplified
            break;
          default:
            show = true;
        }

        row.style.display = show ? '' : 'none';
      });
    }
    
    // Load data for specific tab
    async function loadTabData(tabName) {
      try {
        switch(tabName) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'deals':
            if (sales && typeof sales.loadDeals === 'function') {
              await sales.loadDeals();
            }
            break;
          case 'quotes':
            await loadQuotes();
            break;
          case 'leads':
            await loadLeads();
            break;
          case 'contacts':
            await loadContacts();
            break;
          case 'calls':
            await loadCalls();
            break;
          case 'sequences':
            await loadSequences();
            break;
        }
      } catch (error) {
        console.error(`Error loading ${tabName} data:`, error);
        toast.error(`Failed to load ${tabName}`, 'Error');
      }
    }
    
    // Load functions for each tab
    async function loadDashboardData() {
      try {
        console.log('[Dashboard] Loading dashboard data...');
        
        // Load all data in parallel
        const [dealsData, quotesData, callsData, leadsData] = await Promise.all([
          loadDealsForDashboard(),
          loadQuotesForDashboard(),
          loadCallsForDashboard(),
          loadLeadsForDashboard()
        ]);

        // Calculate and render KPIs
        calculateAndRenderKPIs(dealsData, quotesData, callsData, leadsData);

        // Generate and render priority actions
        generatePriorityActions(dealsData, quotesData, leadsData);

        // Render active deals table
        renderActiveDealsTable(dealsData);

        // Render pipeline stage snapshot
        renderPipelineSnapshot(dealsData);

        // Render quotes watch
        renderQuotesWatch(quotesData);

        // Render walkthroughs today
        renderWalkthroughsToday(dealsData);

        console.log('[Dashboard] ‚úÖ Dashboard data loaded');
      } catch (error) {
        console.error('[Dashboard] Error loading dashboard data:', error);
        toast.error('Failed to load dashboard data', 'Error');
      }
    }

    // Helper functions to load data
    async function loadDealsForDashboard() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return [];

        let query = supabase
          .from('deals')
          .select('*')
          .in('stage', ['prospecting', 'qualification', 'proposal', 'negotiation'])
          .order('updated_at', { ascending: false });

        // Filter by assigned user if rep
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        if (profile && profile.role === 'rep') {
          query = query.or(`assigned_to.eq.${user.id},assigned_user_id.eq.${user.id}`);
        }

        const { data, error } = await query;
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading deals:', error);
        return [];
      }
    }

    async function loadQuotesForDashboard() {
      try {
        const { data, error } = await supabase
          .from('quotes')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading quotes:', error);
        return [];
      }
    }

    async function loadCallsForDashboard() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const { data, error } = await supabase
          .from('calls')
          .select('*')
          .gte('created_at', today.toISOString());
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading calls:', error);
        return [];
      }
    }

    async function loadLeadsForDashboard() {
      try {
        const { data, error } = await supabase
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading leads:', error);
        return [];
      }
    }

    // Calculate and render KPIs
    function calculateAndRenderKPIs(deals, quotes, calls, leads) {
      // Open Pipeline
      const openDeals = deals.filter(d => ['prospecting', 'qualification', 'proposal', 'negotiation'].includes(d.stage));
      const totalOpen = openDeals.reduce((sum, d) => sum + (Number(d.deal_value) || 0), 0);
      const weightedOpen = openDeals.reduce((sum, d) => {
        const stageWeights = { prospecting: 0.1, qualification: 0.3, proposal: 0.7, negotiation: 0.9 };
        return sum + (Number(d.deal_value) || 0) * (stageWeights[d.stage] || 0.5);
      }, 0);

      document.getElementById('kpi-total-open').textContent = `$${totalOpen.toLocaleString()}`;
      document.getElementById('kpi-weighted-open').textContent = `Weighted: $${Math.round(weightedOpen).toLocaleString()}`;

      // Today metrics
      const today = new Date().toISOString().split('T')[0];
      const todayCalls = calls.length;
      const todayQuotes = quotes.filter(q => q.created_at?.startsWith(today)).length;
      const todayClosed = deals.filter(d => d.stage === 'closed_won' && d.updated_at?.startsWith(today)).length;
      const todayWalkthroughs = deals.filter(d => {
        // Check if deal has walkthrough scheduled for today
        // This is a placeholder - adjust based on your schema
        return false; // TODO: Implement based on actual walkthrough data
      }).length;

      document.getElementById('kpi-today-calls').textContent = todayCalls;
      document.getElementById('kpi-today-quotes').textContent = todayQuotes;
      document.getElementById('kpi-today-closed').textContent = todayClosed;
      document.getElementById('kpi-today-walkthroughs').textContent = todayWalkthroughs;

      // Next 7 days at risk
      const sevenDaysFromNow = new Date();
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
      const atRisk = deals.filter(d => {
        if (!d.next_action_date) return false;
        const nextAction = new Date(d.next_action_date);
        return nextAction <= sevenDaysFromNow && nextAction >= new Date();
      }).length;

      document.getElementById('kpi-at-risk').textContent = atRisk;

      // Urgent metrics
      const uncontactedLeads = leads.filter(l => !l.last_contacted_at).length;
      const quotesExpiring = quotes.filter(q => {
        if (!q.expiry_date) return false;
        const expiry = new Date(q.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        return hoursUntilExpiry < 48 && hoursUntilExpiry > 0;
      }).length;
      const idleDeals = deals.filter(d => {
        if (!d.last_contacted_at) return true;
        const lastContact = new Date(d.last_contacted_at);
        const daysSinceContact = (new Date() - lastContact) / (1000 * 60 * 60 * 24);
        return daysSinceContact > 7;
      }).length;

      document.getElementById('kpi-uncontacted').textContent = uncontactedLeads;
      document.getElementById('kpi-quotes-expiring').textContent = quotesExpiring;
      document.getElementById('kpi-idle-deals').textContent = idleDeals;
    }

    // Generate priority actions
    function generatePriorityActions(deals, quotes, leads) {
      const actions = [];

      // Quotes expiring soon
      quotes.forEach(q => {
        if (!q.expiry_date) return;
        const expiry = new Date(q.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        if (hoursUntilExpiry < 48 && hoursUntilExpiry > 0) {
          actions.push({
            type: 'quote_expiring',
            priority: hoursUntilExpiry,
            company: q.company_name || 'Unknown',
            dealValue: q.quote_value || 0,
            reason: `Quote expiring in ${Math.round(hoursUntilExpiry)}h`,
            lastActivity: q.created_at,
            dealId: q.deal_id,
            quoteId: q.id
          });
        }
      });

      // Missed callbacks
      deals.forEach(d => {
        if (d.next_action_date && d.next_action_type === 'callback') {
          const nextAction = new Date(d.next_action_date);
          if (nextAction < new Date()) {
            actions.push({
              type: 'missed_callback',
              priority: (new Date() - nextAction) / (1000 * 60 * 60), // hours overdue
              company: d.company_name || d.title || 'Unknown',
              dealValue: d.deal_value || 0,
              reason: 'Missed callback',
              lastActivity: d.last_contacted_at || d.updated_at,
              dealId: d.id
            });
          }
        }
      });

      // Walkthroughs today
      deals.forEach(d => {
        if (d.next_action_date && d.next_action_type === 'walkthrough') {
          const nextAction = new Date(d.next_action_date);
          const today = new Date();
          if (nextAction.toDateString() === today.toDateString()) {
            actions.push({
              type: 'walkthrough_today',
              priority: nextAction.getHours() * 60 + nextAction.getMinutes(), // minutes from midnight
              company: d.company_name || d.title || 'Unknown',
              dealValue: d.deal_value || 0,
              reason: `Walkthrough at ${nextAction.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`,
              lastActivity: d.last_contacted_at || d.updated_at,
              dealId: d.id,
              walkthroughTime: nextAction
            });
          }
        }
      });

      // Uncontacted leads
      leads.forEach(l => {
        if (!l.last_contacted_at) {
          const hoursSinceCreated = (new Date() - new Date(l.created_at)) / (1000 * 60 * 60);
          if (hoursSinceCreated > 2) {
            actions.push({
              type: 'uncontacted_lead',
              priority: hoursSinceCreated,
              company: l.company_name || l.name || 'Unknown',
              dealValue: 0,
              reason: `New inbound lead untouched for ${Math.round(hoursSinceCreated)}h`,
              lastActivity: l.created_at,
              leadId: l.id
            });
          }
        }
      });

      // Sort by priority (lower number = higher priority)
      actions.sort((a, b) => a.priority - b.priority);

      // Render actions
      const actionsList = document.getElementById('priority-actions-list');
      if (!actionsList) return;

      if (actions.length === 0) {
        actionsList.innerHTML = `
          <div class="p-6 text-center text-gray-500 dark:text-gray-400">
            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 text-green-500"></i>
            <p>No priority actions at this time</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }

      actionsList.innerHTML = actions.slice(0, 10).map(action => `
        <div class="p-4 hover:bg-nfglight dark:hover:bg-gray-700 transition">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-nfgblue dark:text-blue-400">${action.company}</span>
                <span class="text-sm text-gray-600 dark:text-gray-400">$${Number(action.dealValue).toLocaleString()}</span>
              </div>
              <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">${action.reason}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Last activity: ${action.lastActivity ? new Date(action.lastActivity).toLocaleString() : 'Never'}</p>
            </div>
            <div class="flex gap-2 ml-4">
              ${action.dealId ? `
                <button onclick="window.openDeal('${action.dealId}')" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium transition">
                  Open Deal
                </button>
              ` : ''}
              ${action.leadId ? `
                <button onclick="window.openLead('${action.leadId}')" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium transition">
                  Open Lead
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Render active deals table
    function renderActiveDealsTable(deals) {
      const tbody = document.getElementById('deals-table-body');
      if (!tbody) return;

      if (deals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              No active deals
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = deals.map(deal => {
        const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
        const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
        const isIdle = daysIdle && daysIdle > 7;

        return `
          <tr class="deal-row ${isIdle ? 'bg-red-50 dark:bg-red-900/20' : 'hover:bg-nfglight dark:hover:bg-gray-700'} cursor-pointer transition" data-deal-id="${deal.id}">
            <td class="px-4 py-3 text-sm font-medium text-nfgblue dark:text-blue-400">${deal.company_name || deal.title || 'Unknown'}</td>
            <td class="px-4 py-3">
              <select class="text-sm border border-nfgray dark:border-gray-600 rounded-lg px-2 py-1 bg-white dark:bg-gray-800 text-nftext dark:text-gray-200" onchange="updateDealStage('${deal.id}', this.value)" value="${deal.stage || 'prospecting'}">
                <option value="prospecting" ${deal.stage === 'prospecting' ? 'selected' : ''}>Prospecting</option>
                <option value="qualification" ${deal.stage === 'qualification' ? 'selected' : ''}>Qualification</option>
                <option value="proposal" ${deal.stage === 'proposal' ? 'selected' : ''}>Proposal</option>
                <option value="negotiation" ${deal.stage === 'negotiation' ? 'selected' : ''}>Negotiation</option>
                <option value="closed_won" ${deal.stage === 'closed_won' ? 'selected' : ''}>Closed Won</option>
                <option value="closed_lost" ${deal.stage === 'closed_lost' ? 'selected' : ''}>Closed Lost</option>
              </select>
            </td>
            <td class="px-4 py-3 text-sm font-semibold">$${Number(deal.deal_value || 0).toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${lastContact ? lastContact.toLocaleDateString() : 'Never'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${deal.next_action_type || 'None'}</td>
            <td class="px-4 py-3 text-sm ${isIdle ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-600 dark:text-gray-400'}">${daysIdle !== null ? daysIdle : 'N/A'}</td>
          </tr>
        `;
      }).join('');

      // Add click handlers to rows
      tbody.querySelectorAll('.deal-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.tagName !== 'SELECT') {
            const dealId = row.dataset.dealId;
            window.openDeal(dealId);
          }
        });
      });
    }

    // Render pipeline stage snapshot
    function renderPipelineSnapshot(deals) {
      const stages = [
        { key: 'prospecting', label: 'Prospecting' },
        { key: 'qualification', label: 'Qualification' },
        { key: 'proposal', label: 'Proposal' },
        { key: 'negotiation', label: 'Negotiation' },
        { key: 'closed_won', label: 'Closed Won' },
        { key: 'closed_lost', label: 'Closed Lost' }
      ];

      const snapshot = document.getElementById('pipeline-snapshot');
      if (!snapshot) return;

      snapshot.innerHTML = stages.map(stage => {
        const stageDeals = deals.filter(d => d.stage === stage.key);
        const totalValue = stageDeals.reduce((sum, d) => sum + (Number(d.deal_value) || 0), 0);
        const avgDays = stageDeals.length > 0 
          ? Math.round(stageDeals.reduce((sum, d) => {
              const created = new Date(d.created_at);
              const days = (new Date() - created) / (1000 * 60 * 60 * 24);
              return sum + days;
            }, 0) / stageDeals.length)
          : 0;

        return `
          <div class="pipeline-stage-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:shadow-lg transition" data-stage="${stage.key}">
            <div class="text-center">
              <p class="text-2xl font-bold text-nfgblue dark:text-blue-400">${stageDeals.length}</p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">${stage.label}</p>
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">$${totalValue.toLocaleString()}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Avg: ${avgDays}d</p>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers to filter table
      snapshot.querySelectorAll('.pipeline-stage-card').forEach(card => {
        card.addEventListener('click', () => {
          const stage = card.dataset.stage;
          filterDealsTableByStage(stage);
        });
      });
    }

    // Render quotes watch
    function renderQuotesWatch(quotes) {
      const watchList = document.getElementById('quotes-watch-list');
      if (!watchList) return;

      // Sort by expiry date (soonest first)
      const sortedQuotes = quotes
        .filter(q => q.expiry_date)
        .sort((a, b) => new Date(a.expiry_date) - new Date(b.expiry_date))
        .slice(0, 10);

      if (sortedQuotes.length === 0) {
        watchList.innerHTML = `
          <div class="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">
            No quotes to watch
          </div>
        `;
        return;
      }

      watchList.innerHTML = sortedQuotes.map(quote => {
        const expiry = new Date(quote.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        const isExpiringSoon = hoursUntilExpiry < 48;

        return `
          <div class="p-3 hover:bg-nfglight dark:hover:bg-gray-700 transition">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-nfgblue dark:text-blue-400">${quote.company_name || 'Unknown'}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">$${Number(quote.quote_value || 0).toLocaleString()}</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(quote.created_at).toLocaleDateString()}</p>
                <p class="text-xs ${isExpiringSoon ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-500 dark:text-gray-400'}">
                  ${hoursUntilExpiry > 0 ? `${Math.round(hoursUntilExpiry)}h left` : 'Expired'}
                </p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render walkthroughs today
    function renderWalkthroughsToday(deals) {
      const walkthroughsList = document.getElementById('walkthroughs-list');
      if (!walkthroughsList) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const walkthroughs = deals
        .filter(d => d.next_action_type === 'walkthrough' && d.next_action_date)
        .filter(d => {
          const actionDate = new Date(d.next_action_date);
          return actionDate >= today && actionDate < tomorrow;
        })
        .sort((a, b) => new Date(a.next_action_date) - new Date(b.next_action_date));

      if (walkthroughs.length === 0) {
        walkthroughsList.innerHTML = `
          <div class="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">
            No walkthroughs scheduled for today
          </div>
        `;
        return;
      }

      walkthroughsList.innerHTML = walkthroughs.map(deal => {
        const walkthroughTime = new Date(deal.next_action_date);
        return `
          <div class="p-3 hover:bg-nfglight dark:hover:bg-gray-700 transition">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-nfgblue dark:text-blue-400">${deal.company_name || deal.title || 'Unknown'}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">${walkthroughTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">Scheduled</span>
                <button class="px-2 py-1 bg-nfgblue hover:bg-nfgdark text-white rounded text-xs font-medium transition">
                  Outcome
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Helper functions
    function filterDealsTableByStage(stage) {
      const rows = document.querySelectorAll('#deals-table-body .deal-row');
      rows.forEach(row => {
        const rowStage = row.querySelector('select')?.value;
        if (stage === 'all' || rowStage === stage) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    // Make functions available globally
    window.openDeal = (dealId) => {
      window.location.href = `deal-detail.html?id=${dealId}`;
    };

    window.openLead = (leadId) => {
      // TODO: Implement lead detail page
      console.log('Open lead:', leadId);
    };

    window.updateDealStage = async (dealId, newStage) => {
      try {
        const { error } = await supabase
          .from('deals')
          .update({ status: newStage, updated_at: new Date().toISOString() })
          .eq('id', dealId);
        
        if (error) throw error;
        toast.success('Deal stage updated', 'Success');
        await loadDashboardData();
      } catch (error) {
        console.error('Error updating deal stage:', error);
        toast.error('Failed to update deal stage', 'Error');
      }
    };
    
    async function loadQuotes() {
      const tableBody = document.getElementById('quotes-table-body');
      const emptyState = document.getElementById('quotes-empty-state');
      if (!tableBody) return;
      
      try {
        // Use quotes module if available, otherwise fallback
        let quotes = [];
        if (window.quotesModule && typeof window.quotesModule.loadQuotes === 'function') {
          const statusFilter = document.getElementById('quotes-filter-status')?.value || '';
          const typeFilter = document.getElementById('quotes-filter-type')?.value || '';
          quotes = await window.quotesModule.loadQuotes({
            status: statusFilter || undefined,
            quote_type: typeFilter || undefined
          });
        } else {
          // Fallback to direct query
          const { data, error } = await supabase
            .from('quotes')
            .select('*')
            .order('updated_at', { ascending: false })
            .limit(100);
          if (error) throw error;
          quotes = data || [];
        }
        
        if (!quotes || quotes.length === 0) {
          if (tableBody) tableBody.innerHTML = '';
          if (emptyState) {
            emptyState.classList.remove('hidden');
          }
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        
        // Render table rows
        tableBody.innerHTML = quotes.map(quote => {
          const siteName = quote.sites?.name || 'No Account';
          const statusColors = {
            draft: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300',
            sent: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
            viewed: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
            accepted: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
            declined: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300',
            expired: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300',
            withdrawn: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
          };
          const statusColor = statusColors[quote.status] || statusColors.draft;
          
          // Get latest revision info (would need to fetch separately in production)
          const revisionType = quote.quote_type === 'walkthrough_required' ? 'Proposal' : 'Final';
          const totalDisplay = 'TBD'; // Would fetch from latest revision
          
          const sentDate = quote.updated_at ? new Date(quote.updated_at).toLocaleDateString() : '-';
          const expiryDate = '-'; // Would fetch from latest revision
          
          return `
            <tr class="hover:bg-nfglight dark:hover:bg-gray-700 cursor-pointer quote-row" data-quote-id="${quote.id}">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${siteName}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${quote.quote_type === 'walkthrough_required' ? 'Walkthrough' : quote.quote_type === 'standard' ? 'Standard' : 'Ballpark'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium rounded-lg ${statusColor}">${quote.status || 'draft'}</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${revisionType}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${totalDisplay}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${sentDate}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${expiryDate}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">-</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button class="text-nfgblue hover:text-nfgdark font-medium view-quote-btn" data-quote-id="${quote.id}">View</button>
              </td>
            </tr>
          `;
        }).join('');
        
        // Click handlers are set up via event delegation in the initialization section
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading quotes:', error);
        if (tableBody) tableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Failed to load quotes</td></tr>`;
      }
    }
    
    async function loadLeads() {
      const leadsList = document.getElementById('leads-list');
      if (!leadsList) return;
      
      try {
        const { data: leads, error } = await supabase
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        if (!leads || leads.length === 0) {
          leadsList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="user-plus" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No leads yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        leadsList.innerHTML = leads.map(lead => `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${lead.name || 'Unnamed Lead'}</h3>
                <p class="text-sm text-gray-500 mt-1">${lead.email || lead.phone || 'No contact info'}</p>
                <p class="text-sm text-gray-600 mt-2">${lead.notes || 'No notes'}</p>
              </div>
              <span class="px-3 py-1 rounded-lg text-xs font-medium bg-nfglight dark:bg-gray-700">
                ${lead.status || 'new'}
              </span>
            </div>
          </div>
        `).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading leads:', error);
        leadsList.innerHTML = `<div class="text-center py-12 text-red-500">Failed to load leads</div>`;
      }
    }
    
    async function loadContacts() {
      const contactsList = document.getElementById('contacts-list');
      if (!contactsList) return;
      
      try {
        const { data: contacts, error } = await supabase
          .from('contacts')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        if (!contacts || contacts.length === 0) {
          contactsList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="users" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No contacts yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        contactsList.innerHTML = contacts.map(contact => `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${contact.name || 'Unnamed Contact'}</h3>
                <p class="text-sm text-gray-500 mt-1">${contact.email || contact.phone || 'No contact info'}</p>
                <p class="text-sm text-gray-600 mt-2">${contact.company || 'No company'}</p>
              </div>
            </div>
          </div>
        `).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading contacts:', error);
        contactsList.innerHTML = `<div class="text-center py-12 text-red-500">Failed to load contacts</div>`;
      }
    }
    
    async function loadCalls() {
      const callsList = document.getElementById('calls-list');
      if (!callsList) return;
      
      try {
        // Load calls without relationship syntax to avoid FK errors
        const { data: calls, error } = await supabase
          .from('calls')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        // Optionally load deal titles if deal_id exists
        let dealsMap = new Map();
        if (calls && calls.length > 0 && calls[0].deal_id) {
          try {
            const dealIds = [...new Set(calls.map(c => c.deal_id).filter(Boolean))];
            if (dealIds.length > 0) {
              const { data: dealsData } = await supabase
                .from('deals')
                .select('id, title')
                .in('id', dealIds);
              if (dealsData) {
                dealsMap = new Map(dealsData.map(d => [d.id, d]));
              }
            }
          } catch (dealError) {
            console.warn('[Sales] Could not load deal data for calls:', dealError);
          }
        }
        
        if (!calls || calls.length === 0) {
          callsList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="phone" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No calls yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        callsList.innerHTML = calls.map(call => {
          const deal = call.deal_id ? dealsMap.get(call.deal_id) : null;
          return `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${deal?.title || call.deal_id || 'No deal'}</h3>
                <p class="text-sm text-gray-500 mt-1">${call.phone_number || 'No phone'}</p>
                <p class="text-sm text-gray-600 mt-2">${call.outcome || 'No outcome'}</p>
                <p class="text-xs text-gray-400 mt-1">${call.created_at ? new Date(call.created_at).toLocaleString() : ''}</p>
              </div>
            </div>
          </div>
        `;
        }).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading calls:', error);
        callsList.innerHTML = `
          <div class="text-center py-12">
            <i data-lucide="phone" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-2">Failed to load calls</p>
            <p class="text-sm text-gray-400">${error.message || 'Unknown error'}</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      }
    }
    
    async function loadSequences() {
      const sequencesList = document.getElementById('sequences-list');
      if (!sequencesList) return;
      
      try {
        const { data: sequences, error } = await supabase
          .from('sequences')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) {
          // Handle permission denied or table doesn't exist
          if (error.code === '42501' || error.message?.includes('permission denied')) {
            console.warn('[Sales] Sequences table not accessible - may need RLS policies or table may not exist');
            sequencesList.innerHTML = `
              <div class="text-center py-12">
                <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                <p class="text-gray-500 mb-2">Sequences feature not available</p>
                <p class="text-sm text-gray-400">This feature requires database setup</p>
              </div>
            `;
            if (window.lucide) lucide.createIcons();
            return;
          }
          throw error;
        }
        
        if (!sequences || sequences.length === 0) {
          sequencesList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No sequences yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        sequencesList.innerHTML = sequences.map(seq => `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${seq.name || 'Unnamed Sequence'}</h3>
                <p class="text-sm text-gray-500 mt-1">${seq.description || 'No description'}</p>
                <p class="text-sm text-gray-600 mt-2">Steps: ${seq.steps?.length || 0}</p>
              </div>
              <span class="px-3 py-1 rounded-lg text-xs font-medium bg-nfglight dark:bg-gray-700">
                ${seq.status || 'active'}
              </span>
            </div>
          </div>
        `).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading sequences:', error);
        sequencesList.innerHTML = `
          <div class="text-center py-12">
            <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-2">Failed to load sequences</p>
            <p class="text-sm text-gray-400">${error.message || 'Unknown error'}</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      }
    }
    
    async function loadPerformanceMetrics() {
      try {
        const { count: dealsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true });
        
        const { count: callsCount } = await supabase
          .from('calls')
          .select('*', { count: 'exact', head: true });
        
        const { count: quotesCount } = await supabase
          .from('quotes')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'sent');
        
        const { count: winsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true })
          .eq('stage', 'closed_won');
        
        const totalDealsEl = document.getElementById('total-deals');
        const totalCallsEl = document.getElementById('total-calls');
        const totalQuotesEl = document.getElementById('total-quotes');
        const totalWinsEl = document.getElementById('total-wins');
        
        if (totalDealsEl) totalDealsEl.textContent = dealsCount || 0;
        if (totalCallsEl) totalCallsEl.textContent = callsCount || 0;
        if (totalQuotesEl) totalQuotesEl.textContent = quotesCount || 0;
        if (totalWinsEl) totalWinsEl.textContent = winsCount || 0;
      } catch (error) {
        console.error('Error loading performance metrics:', error);
      }
    }
    
    // Close deal detail modal
    document.getElementById('close-deal-detail')?.addEventListener('click', () => {
      document.getElementById('deal-detail-view')?.classList.add('hidden');
    });

    // Initialize
    console.log('[Sales Dashboard] Setting up DOMContentLoaded handler...');
    
    // Check if DOM is already loaded
    if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('[Sales Dashboard] DOMContentLoaded fired, starting initialization...');
        await initializeSalesDashboard();
      });
    } else {
      // DOM already loaded
      console.log('[Sales Dashboard] DOM already loaded, starting initialization immediately...');
      initializeSalesDashboard();
    }
    
    async function initializeSalesDashboard() {
      try {
        console.log('[Sales Dashboard] Step 1: Initializing icons...');
      if (window.lucide) lucide.createIcons();
        
        console.log('[Sales Dashboard] Step 2: Initializing tabs...');
        initTabs();
        
        console.log('[Sales Dashboard] Step 3: Initializing UI...');
        // Initialize UI first
        if (typeof initializeUI === 'function') {
          initializeUI();
        }
        
        console.log('[Sales Dashboard] Step 4: Hiding loader...');
        // Hide loader early, before sales.init() which might redirect
        if (typeof hideLoader === 'function') {
          hideLoader();
        } else {
          // Fallback: directly hide loader
          const loader = document.getElementById('page-loader');
          if (loader) {
            loader.classList.add('hidden');
            console.log('[Sales Dashboard] ‚úÖ Loader hidden (fallback)');
          }
        }
        
        console.log('[Sales Dashboard] Step 5: Initializing sales module...');
        // Initialize sales module (this might redirect if no user)
        if (sales && typeof sales.init === 'function') {
      await sales.init();
          console.log('[Sales Dashboard] ‚úÖ Sales module initialized');
          
          // Initialize quotes module after sales module (to get currentUser)
          if (window.quotesModule && typeof window.quotesModule.initQuotes === 'function') {
            try {
              const { data: { user } } = await supabase.auth.getUser();
              if (user) {
                await window.quotesModule.initQuotes(user);
                console.log('[Sales Dashboard] ‚úÖ Quotes module initialized');
              }
            } catch (err) {
              console.warn('[Sales Dashboard] ‚ö†Ô∏è Could not initialize quotes module:', err);
            }
          }

          // Initialize quote wizard
          if (window.quoteWizard && typeof window.quoteWizard.initQuoteWizard === 'function') {
            window.quoteWizard.initQuoteWizard();
            console.log('[Sales Dashboard] ‚úÖ Quote wizard initialized');
          }
        } else {
          console.warn('[Sales Dashboard] ‚ö†Ô∏è Sales module or init function not available');
        }
        
        console.log('[Sales Dashboard] Step 6: Loading dashboard data...');
        // Load dashboard tab by default
        await loadDashboardData();
        console.log('[Sales Dashboard] ‚úÖ Initialization complete!');
      } catch (error) {
        console.error('[Sales Dashboard] ‚ùå Error during initialization:', error);
        
        // Always hide loader on error
        if (typeof hideLoader === 'function') {
      hideLoader();
        } else {
          const loader = document.getElementById('page-loader');
          if (loader) loader.classList.add('hidden');
        }
        
        // Show error message
        const main = document.querySelector('main');
        if (main) {
          main.innerHTML = `
            <div class="flex items-center justify-center h-full p-6">
              <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-8 max-w-md text-center">
                <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">Failed to Load</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">${error.message || 'An error occurred while loading the sales dashboard'}</p>
                <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-2 rounded mb-4 text-left overflow-auto max-h-24">${error.stack || error.toString()}</pre>
                <button onclick="window.location.reload()" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
                  Reload Page
                </button>
              </div>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
        }
      }
    }

    // Make sales module available globally
    window.sales = sales;
    window.loadTabData = loadTabData;
    
    // Setup quote filter listeners (after DOM is ready)
    setTimeout(() => {
      const quotesFilterStatus = document.getElementById('quotes-filter-status');
      const quotesFilterType = document.getElementById('quotes-filter-type');
      const quotesFilterReset = document.getElementById('quotes-filter-reset');
      
      if (quotesFilterStatus) {
        quotesFilterStatus.addEventListener('change', () => loadQuotes());
      }
      if (quotesFilterType) {
        quotesFilterType.addEventListener('change', () => loadQuotes());
      }
      if (quotesFilterReset) {
        quotesFilterReset.addEventListener('click', () => {
          if (quotesFilterStatus) quotesFilterStatus.value = '';
          if (quotesFilterType) quotesFilterType.value = '';
          loadQuotes();
        });
      }
      
      // Setup new quote button
      const newQuoteBtnTab = document.getElementById('new-quote-btn-tab');
      if (newQuoteBtnTab) {
        newQuoteBtnTab.addEventListener('click', async () => {
          if (window.quoteWizard && typeof window.quoteWizard.openQuoteWizard === 'function') {
            window.quoteWizard.openQuoteWizard();
          } else {
            if (toast) toast.error('Quote wizard not loaded', 'Error');
          }
        });
      }

      // Setup quote detail modal close button
      const closeQuoteDetailBtn = document.getElementById('close-quote-detail-modal');
      const quoteDetailCloseBtn = document.getElementById('quote-detail-close-btn');
      if (closeQuoteDetailBtn) {
        closeQuoteDetailBtn.addEventListener('click', () => {
          document.getElementById('quote-detail-modal')?.classList.add('hidden');
        });
      }
      if (quoteDetailCloseBtn) {
        quoteDetailCloseBtn.addEventListener('click', () => {
          document.getElementById('quote-detail-modal')?.classList.add('hidden');
        });
      }

      // Setup quote row click handlers (delegated)
      const quotesTableBody = document.getElementById('quotes-table-body');
      if (quotesTableBody) {
        quotesTableBody.addEventListener('click', (e) => {
          const row = e.target.closest('.quote-row');
          const viewBtn = e.target.closest('.view-quote-btn');
          if (row || viewBtn) {
            const quoteId = row?.dataset.quoteId || viewBtn?.dataset.quoteId;
            if (quoteId && window.quoteDetail && typeof window.quoteDetail.openQuoteDetail === 'function') {
              window.quoteDetail.openQuoteDetail(quoteId);
            }
          }
        });
      }
    }, 1000);
  </script>
  <script type="module" src="./js/auth.js"></script>
</body>
</html>
