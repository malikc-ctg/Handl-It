<!doctype html>
<html lang="en" class="h-full overflow-hidden">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG — Routes</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  <link rel="stylesheet" href="./css/skeleton-loaders.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

  <!-- Map Library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Leaflet Draw for territory drawing -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  
  <!-- Turf.js for geometry operations -->
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <!-- Prevent page scrollbar -->
  <style>
    html {
      height: 100% !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      position: fixed !important;
    }
    body {
      height: 100vh !important;
      width: 100vw !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      display: flex !important;
    }
    body > aside {
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
    }
    body > div.flex-1 {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1;
      min-width: 0;
      height: 100vh;
    }
    body > div.flex-1 > main {
      flex: 1;
      min-height: 0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    body > div.flex-1 > main > div.scrollable-content {
      flex: 1;
      overflow-y: scroll;
      overflow-x: hidden;
      scrollbar-width: none !important;
      -ms-overflow-style: none !important;
    }
    body > div.flex-1 > main > div.scrollable-content::-webkit-scrollbar {
      width: 0px !important;
      display: none !important;
    }
  </style>
</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" 
        alt="NFG"
        class="company-logo"
      >
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Routes...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" 
        alt="NFG" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a id="nav-sales" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="sales.html">
        <i data-lucide="trending-up" class="w-4 h-4"></i> Sales
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="routes.html">
        <i data-lucide="route" class="w-4 h-4"></i> Routes
      </a>
      <a id="nav-tools" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="sales.html?tab=tools">
        <i data-lucide="wrench" class="w-4 h-4"></i> Tools & Resources
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="bookings.html" onclick="sessionStorage.setItem('isSalesMode','true');">
        <i data-lucide="calendar" class="w-4 h-4"></i> Calendar
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700 space-y-2">
      <a href="dashboard.html" onclick="sessionStorage.removeItem('isSalesMode');" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfgblue dark:bg-blue-600 text-white hover:bg-nfgdark dark:hover:bg-blue-700 w-full text-left font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Ops Mode
      </a>
      <button id="logout-btn" data-action="logout" class="w-full border border-nfgray dark:border-gray-600 text-nftext dark:text-gray-300 hover:bg-nfgray dark:hover:bg-gray-700 rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0 overflow-hidden">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Routes</h1>
        </div>

        <div class="flex items-center gap-1 sm:gap-2 flex-shrink-0">
          <!-- Notification Bell (will be injected by notification-center.js) -->
          
          <button id="create-route-btn" class="inline-flex items-center justify-center sm:gap-1.5 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark transition flex-shrink-0">
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span class="hidden sm:inline text-xs sm:text-sm">New Route</span>
          </button>
        </div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <div class="flex-shrink-0 p-4 md:p-6 pb-0">
        <div>
          <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Sales Routes</h2>
          <p class="text-sm text-gray-500 mt-1">Plan optimized routes and manage territories</p>
        </div>

        <!-- Main Tabs: Route Planner / Territories -->
        <div class="flex items-center gap-1 sm:gap-2 border-b border-nfgray overflow-x-auto mt-6 pb-2">
          <button id="tab-route-planner" class="main-tab-btn px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue whitespace-nowrap flex-shrink-0" data-tab="route-planner">
            <i data-lucide="route" class="w-4 h-4 inline mr-1"></i>
            Route Planner
          </button>
          <button id="tab-territories" class="main-tab-btn px-2 sm:px-4 py-2 text-sm sm:text-base font-medium text-gray-500 hover:text-nfgblue dark:text-blue-400 border-b-2 border-transparent whitespace-nowrap flex-shrink-0" data-tab="territories">
            <i data-lucide="map" class="w-4 h-4 inline mr-1"></i>
            Territories
          </button>
        </div>
      </div>

      <!-- Route Planner Tab Content -->
      <div id="tab-content-route-planner" class="tab-content flex-1 flex flex-col overflow-hidden">
        <!-- Route Planner Sub-tabs -->
        <div class="flex-shrink-0 px-4 md:px-6 pt-4 border-b border-nfgray">
          <div class="flex items-center gap-1 sm:gap-2 overflow-x-auto pb-2">
            <button class="planner-subtab-btn px-2 sm:px-4 py-2 text-sm font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue whitespace-nowrap" data-subtab="plans">
              Saved Plans
            </button>
            <button class="planner-subtab-btn px-2 sm:px-4 py-2 text-sm font-medium text-gray-500 hover:text-nfgblue border-b-2 border-transparent whitespace-nowrap" data-subtab="generate">
              Generate Route
            </button>
          </div>
        </div>

        <!-- Saved Plans View -->
        <div id="planner-subtab-plans" class="planner-subtab-content flex-1 overflow-y-auto p-4 md:p-6">
          <!-- Status Filters -->
          <div class="flex items-center gap-2 mb-4 flex-wrap">
            <button class="route-filter-tab px-3 py-1.5 text-sm font-medium text-nfgblue border-b-2 border-nfgblue" data-status="all">
              All
            </button>
            <button class="route-filter-tab px-3 py-1.5 text-sm font-medium text-gray-500 border-b-2 border-transparent" data-status="draft">
              Draft
            </button>
            <button class="route-filter-tab px-3 py-1.5 text-sm font-medium text-gray-500 border-b-2 border-transparent" data-status="active">
              Active
            </button>
            <button class="route-filter-tab px-3 py-1.5 text-sm font-medium text-gray-500 border-b-2 border-transparent" data-status="completed">
              Completed
            </button>
          </div>
          
          <!-- Routes Grid -->
          <div id="routes-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>

        <!-- Generate Route View -->
        <div id="planner-subtab-generate" class="planner-subtab-content hidden flex-1 overflow-hidden flex">
          <div class="flex-1 flex overflow-hidden">
            <!-- Left Panel: Inputs -->
            <div class="w-80 border-r border-nfgray overflow-y-auto p-4 space-y-4">
              <h3 class="font-semibold text-nfgblue dark:text-blue-400">Route Configuration</h3>
              
              <div>
                <label class="block text-sm font-medium mb-1.5">Date <span class="text-red-500">*</span></label>
                <input type="date" id="plan-date" required class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700" />
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1.5">Rep <span class="text-red-500">*</span></label>
                <select id="plan-rep" required class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700">
                  <option value="">Select rep</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1.5">Territory (Optional)</label>
                <select id="plan-territory" class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700">
                  <option value="">All territories</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1.5">Route Objective</label>
                <select id="plan-objective" class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700">
                  <option value="min_travel_time">Min Travel Time</option>
                  <option value="max_priority">Max Priority Points</option>
                  <option value="hybrid">Hybrid</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1.5">Stops Source</label>
                <select id="plan-stops-source" class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700">
                  <option value="leads">Leads</option>
                  <option value="appointments">Appointments</option>
                  <option value="deals">Deals</option>
                  <option value="mixed">Mixed</option>
                </select>
              </div>
              
              <div class="border-t border-nfgray pt-4">
                <h4 class="font-medium text-sm mb-2">Constraints</h4>
                
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Shift Start</label>
                    <input type="time" id="plan-shift-start" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="08:00" />
                  </div>
                  
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Shift End</label>
                    <input type="time" id="plan-shift-end" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="18:00" />
                  </div>
                  
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Max Stops</label>
                    <input type="number" id="plan-max-stops" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="30" min="1" />
                  </div>
                  
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Lunch Break</label>
                    <div class="flex gap-2">
                      <input type="time" id="plan-lunch-start" class="flex-1 border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="12:00" />
                      <input type="number" id="plan-lunch-duration" class="w-20 border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="30" min="0" placeholder="min" />
                    </div>
                  </div>
                  
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Service Duration (min)</label>
                    <input type="number" id="plan-service-duration" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="15" min="1" />
                  </div>
                </div>
              </div>
              
              <div class="border-t border-nfgray pt-4">
                <h4 class="font-medium text-sm mb-2">Scoring Weights</h4>
                
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Priority Weight</label>
                    <input type="number" id="plan-priority-weight" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="1.0" step="0.1" min="0" />
                  </div>
                  
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Recency Weight</label>
                    <input type="number" id="plan-recency-weight" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="0.5" step="0.1" min="0" />
                  </div>
                  
                  <div>
                    <label class="block text-xs text-gray-500 mb-1">Value Weight</label>
                    <input type="number" id="plan-value-weight" class="w-full border border-nfgray rounded-lg p-2 text-sm dark:bg-gray-700" value="0.3" step="0.1" min="0" />
                  </div>
                </div>
              </div>
              
              <button id="generate-route-btn" class="w-full px-4 py-2.5 bg-nfgblue text-white rounded-xl hover:bg-nfgdark font-medium">
                Generate Route
              </button>
              
              <div id="plan-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>
            </div>
            
            <!-- Right Panel: Output -->
            <div class="flex-1 flex flex-col overflow-hidden">
              <div class="flex-1 overflow-y-auto p-4">
                <div id="route-plan-output" class="space-y-4">
                  <div class="text-center py-12 text-gray-500">
                    <i data-lucide="route" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                    <p>Configure settings and click "Generate Route" to create an optimized route plan</p>
                  </div>
                </div>
              </div>
              
              <!-- Map View Toggle -->
              <div class="border-t border-nfgray p-4">
                <div class="flex items-center justify-between">
                  <button id="toggle-map-view" class="px-4 py-2 border border-nfgray rounded-lg hover:bg-nfglight text-sm">
                    <i data-lucide="map" class="w-4 h-4 inline mr-1"></i>
                    Show Map
                  </button>
                  <div id="route-plan-actions" class="hidden flex items-center gap-2">
                    <button id="save-route-plan-btn" class="px-4 py-2 bg-nfgblue text-white rounded-lg hover:bg-nfgdark text-sm">
                      Save Plan
                    </button>
                    <button id="export-route-plan-btn" class="px-4 py-2 border border-nfgray rounded-lg hover:bg-nfglight text-sm">
                      Export
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Territories Tab Content -->
      <div id="tab-content-territories" class="tab-content hidden flex-1 flex flex-col overflow-hidden">
        <div class="flex-1 flex overflow-hidden">
          <!-- Left Panel: Territory List & Controls -->
          <div class="w-80 border-r border-nfgray flex flex-col">
            <div class="p-4 border-b border-nfgray">
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">Territories</h3>
                <button id="create-territory-btn" class="px-3 py-1.5 bg-nfgblue text-white rounded-lg hover:bg-nfgdark text-sm">
                  <i data-lucide="plus" class="w-4 h-4 inline"></i>
                </button>
              </div>
              <div id="territories-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Territories will be loaded here -->
              </div>
            </div>
            
            <!-- Selected Territory Details -->
            <div id="territory-details" class="flex-1 overflow-y-auto p-4 space-y-4">
              <div class="text-center py-8 text-gray-500 text-sm">
                Select a territory to view details
              </div>
            </div>
          </div>
          
          <!-- Right Panel: Map -->
          <div class="flex-1 relative">
            <div id="territories-map" style="height: 100%; width: 100%;"></div>
            <div id="map-controls" class="absolute top-4 right-4 z-[1000] flex flex-col gap-2">
              <button id="toggle-heatmap-btn" class="px-3 py-2 bg-white dark:bg-gray-800 border border-nfgray rounded-lg shadow text-sm hover:bg-nfglight">
                <i data-lucide="layers" class="w-4 h-4 inline mr-1"></i>
                Heatmap
              </button>
              <button id="draw-territory-btn" class="px-3 py-2 bg-nfgblue text-white rounded-lg shadow text-sm hover:bg-nfgdark">
                <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>
                Draw
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create Route Modal -->
  <div id="create-route-modal" class="hidden fixed inset-0 bg-black/40 items-center justify-center p-4 z-[60]">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-nfg border border-nfgray w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="p-4 border-b border-nfgray flex items-center justify-between sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h3 class="text-nfgblue dark:text-blue-400 font-semibold text-lg">Create New Route</h3>
        <button data-action="close-modal" data-target="create-route-modal" class="p-1 rounded-lg hover:bg-nfglight dark:hover:bg-gray-600">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="create-route-form" class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Route Name <span class="text-red-500">*</span></label>
          <input type="text" id="route-name" required class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700" placeholder="e.g., Downtown Route - Jan 15" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Route Date <span class="text-red-500">*</span></label>
          <input type="date" id="route-date" required class="w-full border border-nfgray rounded-xl p-2.5 dark:bg-gray-700" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Assign to Rep <span class="text-red-500">*</span></label>
          <select id="route-assigned-rep" required data-custom-dropdown="true" data-placeholder="Select a rep">
            <option value="">Select a rep</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Territory (Optional)</label>
          <select id="route-territory" data-custom-dropdown="true" data-placeholder="Select a territory">
            <option value="">No territory</option>
          </select>
        </div>
        <div id="create-route-error" class="hidden text-red-600 text-sm bg-red-50 border border-red-200 rounded-xl p-3"></div>
        <div class="flex items-center justify-end gap-3 pt-2 border-t border-nfgray">
          <button type="button" data-action="close-modal" data-target="create-route-modal" class="px-4 py-2 rounded-xl border border-nfgray hover:bg-nfglight dark:hover:bg-gray-600">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 rounded-xl bg-nfgblue dark:bg-blue-900 text-white hover:bg-nfgdark">
            Create Route
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Set sales mode flag in sessionStorage
    sessionStorage.setItem('isSalesMode', 'true');
    
    import { supabase } from './js/supabase.js';
    import { initMobileSidebar } from './js/ui.js';
    import { toast } from './js/notifications.js';
    import { 
      fetchRoutes, 
      createRoute, 
      ROUTE_STATUS,
      getRouteProgress 
    } from './js/routes.js';
    import { getCurrentUser, canManageUsers } from './js/user-management.js';
    import { generateRoutePlan } from './js/route-optimizer.js';
    import {
      fetchTerritories,
      createTerritory,
      updateTerritory,
      deleteTerritory,
      fetchTerritory,
      assignRepToTerritory,
      unassignRepFromTerritory,
      fetchTerritoryAssignments,
      computeTerritoryCoverage,
      getCachedCoverage,
      isPointInTerritory
    } from './js/territory-management.js';

    // Initialize
    let currentUser = null;
    let currentUserProfile = null;
    let allRoutes = [];
    let currentFilter = 'all';
    let currentTab = 'route-planner';
    let currentPlannerSubtab = 'plans';
    let territories = [];
    let selectedTerritory = null;
    let territoriesMap = null;
    let drawControl = null;
    let currentRoutePlan = null;

    // Initialize UI
    initMobileSidebar();
    lucide.createIcons();

    // Hide loader when page loads
    window.addEventListener('load', () => {
      const loader = document.getElementById('page-loader');
      if (loader) loader.style.display = 'none';
    });

    // Get current user
    async function init() {
      try {
        currentUser = await getCurrentUser();
        if (currentUser) {
          const { data: profile } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();
          currentUserProfile = profile;
        }
        await loadRoutes();
        await loadUsers();
        await loadTerritories();
        await loadRoutePlans();
        initializeTabs();
        setupEventListeners();
        if (currentTab === 'territories') {
          initializeTerritoriesMap();
        }
      } catch (error) {
        console.error('Error initializing:', error);
        toast.error('Failed to load routes');
      }
    }

    // Load routes
    async function loadRoutes() {
      try {
        const filters = currentFilter !== 'all' ? { status: currentFilter } : {};
        allRoutes = await fetchRoutes(filters);
        renderRoutes(allRoutes);
      } catch (error) {
        console.error('Error loading routes:', error);
        toast.error('Failed to load routes');
      }
    }

    // Render routes
    function renderRoutes(routes) {
      const grid = document.getElementById('routes-grid');
      if (!grid) return;

      if (routes.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12">
            <i data-lucide="route" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
            <p class="text-gray-500">No routes found</p>
            <button id="create-route-btn-empty" class="mt-4 px-4 py-2 bg-nfgblue text-white rounded-xl hover:bg-nfgdark">
              Create Your First Route
            </button>
          </div>
        `;
        lucide.createIcons();
        document.getElementById('create-route-btn-empty')?.addEventListener('click', () => {
          document.getElementById('create-route-btn').click();
        });
        return;
      }

      grid.innerHTML = routes.map(route => {
        const statusColors = {
          draft: 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300',
          active: 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300',
          completed: 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300',
          cancelled: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300'
        };

        return `
          <div class="bg-white dark:bg-gray-800 rounded-xl border border-nfgray p-4 hover:shadow-lg transition cursor-pointer route-card" data-route-id="${route.id}">
            <div class="flex items-start justify-between mb-3">
              <h3 class="font-semibold text-nfgblue dark:text-blue-400">${route.name || 'Unnamed Route'}</h3>
              <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[route.status] || statusColors.draft}">
                ${route.status || 'draft'}
              </span>
            </div>
            <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400">
              <div class="flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i>
                <span>${new Date(route.route_date).toLocaleDateString()}</span>
              </div>
              ${route.assigned_rep ? `
                <div class="flex items-center gap-2">
                  <i data-lucide="user" class="w-4 h-4"></i>
                  <span>${route.assigned_rep.full_name || route.assigned_rep.email}</span>
                </div>
              ` : ''}
            </div>
            <div class="mt-4 pt-4 border-t border-nfgray">
              <button class="w-full px-4 py-2 bg-nfgblue text-white rounded-lg hover:bg-nfgdark text-sm font-medium view-route-btn" data-route-id="${route.id}">
                View Route
              </button>
            </div>
          </div>
        `;
      }).join('');

      lucide.createIcons();
      
      // Add click handlers
      document.querySelectorAll('.route-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.classList.contains('view-route-btn')) {
            const routeId = card.dataset.routeId;
            window.location.href = `route-detail.html?id=${routeId}`;
          }
        });
      });

      document.querySelectorAll('.view-route-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const routeId = btn.dataset.routeId;
          window.location.href = `route-detail.html?id=${routeId}`;
        });
      });
    }

    // Load users for assignment
    async function loadUsers() {
      try {
        const { data: users, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, email, role')
          .eq('status', 'active')
          .order('full_name');

        if (error) throw error;

        // Populate route-assigned-rep dropdown
        const select = document.getElementById('route-assigned-rep');
        if (select) {
          select.innerHTML = '<option value="">Select a rep</option>' +
            users.map(user => 
              `<option value="${user.id}">${user.full_name || user.email}</option>`
            ).join('');
        }
        
        // Populate plan-rep dropdown
        const planRepSelect = document.getElementById('plan-rep');
        if (planRepSelect) {
          planRepSelect.innerHTML = '<option value="">Select rep</option>' +
            users.map(user => 
              `<option value="${user.id}">${user.full_name || user.email}</option>`
            ).join('');
        }
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    // Load territories
    async function loadTerritories() {
      try {
        territories = await fetchTerritories();
        
        // Populate route-territory dropdown
        const select = document.getElementById('route-territory');
        if (select) {
          select.innerHTML = '<option value="">No territory</option>' +
            territories.map(territory => 
              `<option value="${territory.id}">${territory.name}</option>`
            ).join('');
        }
        
        // Populate plan-territory dropdown
        const planTerritorySelect = document.getElementById('plan-territory');
        if (planTerritorySelect) {
          planTerritorySelect.innerHTML = '<option value="">All territories</option>' +
            territories.map(territory => 
              `<option value="${territory.id}">${territory.name}</option>`
            ).join('');
        }
      } catch (error) {
        console.error('Error loading territories:', error);
      }
    }
    
    // Toggle heatmap overlay
    let heatmapLayer = null;
    async function toggleHeatmap() {
      if (!territoriesMap) return;
      
      if (heatmapLayer) {
        territoriesMap.removeLayer(heatmapLayer);
        heatmapLayer = null;
        document.getElementById('toggle-heatmap-btn').classList.remove('bg-nfgblue', 'text-white');
        document.getElementById('toggle-heatmap-btn').classList.add('bg-white', 'text-gray-700');
        return;
      }
      
      // Build heatmap grid
      const bounds = territoriesMap.getBounds();
      const gridSize = 0.01; // ~1km grid cells
      const grid = [];
      
      // Fetch leads in bounds
      const { data: leads } = await supabase
        .from('leads')
        .select('latitude, longitude')
        .gte('latitude', bounds.getSouth())
        .lte('latitude', bounds.getNorth())
        .gte('longitude', bounds.getWest())
        .lte('longitude', bounds.getEast())
        .eq('routing_eligible', true)
        .not('latitude', 'is', null)
        .not('longitude', 'is', null);
      
      if (!leads || leads.length === 0) {
        toast.info('No leads found in this area');
        return;
      }
      
      // Create grid cells
      const cellCounts = new Map();
      for (const lead of leads) {
        const cellLat = Math.floor(lead.latitude / gridSize) * gridSize;
        const cellLng = Math.floor(lead.longitude / gridSize) * gridSize;
        const key = `${cellLat},${cellLng}`;
        cellCounts.set(key, (cellCounts.get(key) || 0) + 1);
      }
      
      // Create heatmap layer
      const heatmapFeatures = [];
      let maxCount = 0;
      for (const [key, count] of cellCounts) {
        maxCount = Math.max(maxCount, count);
        const [lat, lng] = key.split(',').map(Number);
        heatmapFeatures.push({
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: [lng, lat]
          },
          properties: { count }
        });
      }
      
      // Create circles for each grid cell
      heatmapLayer = L.layerGroup();
      for (const [key, count] of cellCounts) {
        const [lat, lng] = key.split(',').map(Number);
        const intensity = count / maxCount;
        const radius = Math.max(50, Math.min(500, count * 20));
        const opacity = Math.min(0.6, intensity * 0.8);
        
        L.circle([lat, lng], {
          radius,
          fillColor: intensity > 0.7 ? '#ff0000' : intensity > 0.4 ? '#ff8800' : '#ffaa00',
          color: '#ff8800',
          weight: 1,
          fillOpacity: opacity
        }).addTo(heatmapLayer);
      }
      
      heatmapLayer.addTo(territoriesMap);
      document.getElementById('toggle-heatmap-btn').classList.add('bg-nfgblue', 'text-white');
      document.getElementById('toggle-heatmap-btn').classList.remove('bg-white', 'text-gray-700');
    }
    
    // Toggle route plan map view
    let routePlanMap = null;
    function toggleRoutePlanMap() {
      const output = document.getElementById('route-plan-output');
      if (!output || !currentRoutePlan) return;
      
      if (routePlanMap) {
        // Hide map, show list
        output.innerHTML = '';
        renderRoutePlan(currentRoutePlan);
        routePlanMap = null;
        document.getElementById('toggle-map-view').innerHTML = '<i data-lucide="map" class="w-4 h-4 inline mr-1"></i> Show Map';
        lucide.createIcons();
        return;
      }
      
      // Show map
      const mapContainer = document.createElement('div');
      mapContainer.id = 'route-plan-map-container';
      mapContainer.style.height = '500px';
      mapContainer.style.width = '100%';
      output.innerHTML = '';
      output.appendChild(mapContainer);
      
      routePlanMap = L.map('route-plan-map-container').setView([43.6532, -79.3832], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(routePlanMap);
      
      // Add route stops
      const routePoints = [];
      currentRoutePlan.route.forEach((stop, idx) => {
        const marker = L.marker([stop.stop.lat, stop.stop.lng])
          .bindPopup(`Stop ${idx + 1}: ${stop.stop.address || 'Unknown'}`)
          .addTo(routePlanMap);
        
        routePoints.push([stop.stop.lat, stop.stop.lng]);
      });
      
      // Draw route polyline
      if (routePoints.length > 1) {
        L.polyline(routePoints, {
          color: '#0D47A1',
          weight: 3,
          opacity: 0.7
        }).addTo(routePlanMap);
      }
      
      // Fit bounds
      if (routePoints.length > 0) {
        routePlanMap.fitBounds(routePoints);
      }
      
      document.getElementById('toggle-map-view').innerHTML = '<i data-lucide="list" class="w-4 h-4 inline mr-1"></i> Show List';
      lucide.createIcons();
    }
    
    // Edit territory (global function for onclick)
    window.editTerritory = async function(territoryId) {
      const territory = territories.find(t => t.id === territoryId);
      if (!territory) return;
      
      const name = prompt('Enter new territory name:', territory.name);
      if (!name) return;
      
      try {
        await updateTerritory(territoryId, { name });
        toast.success('Territory updated');
        await loadAndRenderTerritories();
      } catch (error) {
        toast.error('Failed to update territory');
        console.error(error);
      }
    };
    
    // Delete territory confirm (global function for onclick)
    window.deleteTerritoryConfirm = async function(territoryId) {
      if (!confirm('Are you sure you want to delete this territory? This action cannot be undone.')) {
        return;
      }
      
      try {
        await deleteTerritory(territoryId);
        toast.success('Territory deleted');
        selectedTerritory = null;
        await loadAndRenderTerritories();
        document.getElementById('territory-details').innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">Select a territory to view details</div>';
      } catch (error) {
        toast.error('Failed to delete territory');
        console.error(error);
      }
    };
    
    // Open assign rep modal (global function for onclick)
    window.openAssignRepModal = async function(territoryId) {
      // Simple prompt-based assignment for now
      const { data: users } = await supabase
        .from('user_profiles')
        .select('id, full_name, email')
        .eq('status', 'active')
        .in('role', ['admin', 'client', 'staff']);
      
      if (!users || users.length === 0) {
        toast.error('No reps available');
        return;
      }
      
      const repList = users.map((u, i) => `${i + 1}. ${u.full_name || u.email}`).join('\n');
      const choice = prompt(`Select rep to assign:\n\n${repList}\n\nEnter number:`);
      const repIndex = parseInt(choice) - 1;
      
      if (repIndex >= 0 && repIndex < users.length) {
        try {
          await assignRepToTerritory(territoryId, users[repIndex].id, {
            isPrimary: false,
            maxStopsPerDay: 30,
            maxDriveMinutesPerDay: 480,
            shiftStartMinutes: 480,
            shiftEndMinutes: 1080
          });
          toast.success('Rep assigned to territory');
          await selectTerritory(territoryId);
        } catch (error) {
          toast.error('Failed to assign rep');
          console.error(error);
        }
      }
    };

    // Initialize tabs
    function initializeTabs() {
      // Main tabs
      document.querySelectorAll('.main-tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          switchTab(tab);
        });
      });
      
      // Planner subtabs
      document.querySelectorAll('.planner-subtab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const subtab = btn.dataset.subtab;
          switchPlannerSubtab(subtab);
        });
      });
    }
    
    // Switch main tab
    function switchTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.main-tab-btn').forEach(btn => {
        if (btn.dataset.tab === tab) {
          btn.classList.add('text-nfgblue', 'border-nfgblue', 'dark:text-blue-400');
          btn.classList.remove('text-gray-500', 'border-transparent');
        } else {
          btn.classList.remove('text-nfgblue', 'border-nfgblue', 'dark:text-blue-400');
          btn.classList.add('text-gray-500', 'border-transparent');
        }
      });
      
      // Show/hide tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        if (content.id === `tab-content-${tab}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
      
      // Initialize map if territories tab
      if (tab === 'territories' && !territoriesMap) {
        initializeTerritoriesMap();
      }
    }
    
    // Switch planner subtab
    function switchPlannerSubtab(subtab) {
      currentPlannerSubtab = subtab;
      
      // Update subtab buttons
      document.querySelectorAll('.planner-subtab-btn').forEach(btn => {
        if (btn.dataset.subtab === subtab) {
          btn.classList.add('text-nfgblue', 'border-nfgblue', 'dark:text-blue-400');
          btn.classList.remove('text-gray-500', 'border-transparent');
        } else {
          btn.classList.remove('text-nfgblue', 'border-nfgblue', 'dark:text-blue-400');
          btn.classList.add('text-gray-500', 'border-transparent');
        }
      });
      
      // Show/hide subtab content
      document.querySelectorAll('.planner-subtab-content').forEach(content => {
        if (content.id === `planner-subtab-${subtab}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    }
    
    // Load route plans (saved optimized routes)
    async function loadRoutePlans() {
      try {
        const { data: plans, error } = await supabase
          .from('route_plans')
          .select('*')
          .order('date', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        // Fetch user profiles and territories separately
        if (plans && plans.length > 0) {
          const repIds = [...new Set(plans.map(p => p.rep_user_id).filter(Boolean))];
          const territoryIds = [...new Set(plans.map(p => p.territory_id).filter(Boolean))];
          
          let reps = [];
          let territoryData = [];
          
          if (repIds.length > 0) {
            const { data: repsData } = await supabase
              .from('user_profiles')
              .select('id, full_name, email')
              .in('id', repIds);
            reps = repsData || [];
          }
          
          if (territoryIds.length > 0) {
            const { data: territoriesData } = await supabase
              .from('territories')
              .select('id, name')
              .in('id', territoryIds);
            territoryData = territoriesData || [];
          }
          
          const repMap = new Map(reps.map(r => [r.id, r]));
          const territoryMap = new Map(territoryData.map(t => [t.id, t]));
          
          plans.forEach(plan => {
            if (plan.rep_user_id && repMap.has(plan.rep_user_id)) {
              plan.rep = repMap.get(plan.rep_user_id);
            }
            if (plan.territory_id && territoryMap.has(plan.territory_id)) {
              plan.territory = territoryMap.get(plan.territory_id);
            }
          });
        }
        
        // Store for later use
        window.routePlans = plans || [];
      } catch (error) {
        console.error('Error loading route plans:', error);
        // Don't throw - this is optional data
      }
    }
    
    // Initialize territories map
    function initializeTerritoriesMap() {
      if (territoriesMap) return;
      
      // Initialize Leaflet map
      territoriesMap = L.map('territories-map').setView([43.6532, -79.3832], 10); // Default to Toronto
      
      // Add tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(territoriesMap);
      
      // Initialize draw control
      drawControl = new L.Control.Draw({
        draw: {
          polygon: {
            allowIntersection: false,
            showArea: true
          },
          polyline: false,
          rectangle: false,
          circle: false,
          marker: false,
          circlemarker: false
        },
        edit: {
          featureGroup: L.featureGroup(),
          remove: true
        }
      });
      
      territoriesMap.addControl(drawControl);
      
      // Handle draw events
      territoriesMap.on(L.Draw.Event.CREATED, handleTerritoryDrawn);
      territoriesMap.on(L.Draw.Event.EDITED, handleTerritoryEdited);
      territoriesMap.on(L.Draw.Event.DELETED, handleTerritoryDeleted);
      
      // Load and render territories
      loadAndRenderTerritories();
    }
    
    // Load and render territories on map
    async function loadAndRenderTerritories() {
      try {
        territories = await fetchTerritories();
        renderTerritoriesList();
        renderTerritoriesOnMap();
      } catch (error) {
        console.error('Error loading territories:', error);
        toast.error('Failed to load territories');
      }
    }
    
    // Render territories list
    function renderTerritoriesList() {
      const list = document.getElementById('territories-list');
      if (!list) return;
      
      if (territories.length === 0) {
        list.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No territories yet</p>';
        return;
      }
      
      list.innerHTML = territories.map(territory => `
        <div class="territory-item p-2 rounded-lg border border-nfgray cursor-pointer hover:bg-nfglight ${selectedTerritory?.id === territory.id ? 'bg-nfglight border-nfgblue' : ''}" 
             data-territory-id="${territory.id}">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full" style="background-color: ${territory.color || '#0D47A1'}"></div>
            <span class="text-sm font-medium">${territory.name}</span>
          </div>
        </div>
      `).join('');
      
      // Add click handlers
      list.querySelectorAll('.territory-item').forEach(item => {
        item.addEventListener('click', async () => {
          const territoryId = item.dataset.territoryId;
          await selectTerritory(territoryId);
        });
      });
    }
    
    // Select territory
    async function selectTerritory(territoryId) {
      try {
        selectedTerritory = await fetchTerritory(territoryId);
        renderTerritoryDetails(selectedTerritory);
        highlightTerritoryOnMap(selectedTerritory);
        
        // Update list selection
        document.querySelectorAll('.territory-item').forEach(item => {
          if (item.dataset.territoryId === territoryId) {
            item.classList.add('bg-nfglight', 'border-nfgblue');
          } else {
            item.classList.remove('bg-nfglight', 'border-nfgblue');
          }
        });
      } catch (error) {
        console.error('Error selecting territory:', error);
        toast.error('Failed to load territory details');
      }
    }
    
    // Render territory details
    async function renderTerritoryDetails(territory) {
      const details = document.getElementById('territory-details');
      if (!details) return;
      
      // Get coverage metrics
      let coverage = await getCachedCoverage(territory.id);
      if (!coverage) {
        coverage = await computeTerritoryCoverage(territory.id);
      }
      
      // Get assignments
      const assignments = await fetchTerritoryAssignments(territory.id);
      
      details.innerHTML = `
        <div class="space-y-4">
          <div>
            <h4 class="font-semibold text-nfgblue dark:text-blue-400 mb-2">${territory.name}</h4>
            <p class="text-sm text-gray-500">${territory.description || 'No description'}</p>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-nfglight dark:bg-gray-700 rounded-lg p-2">
              <p class="text-xs text-gray-500">Total Leads</p>
              <p class="text-lg font-bold text-nfgblue">${coverage?.totalLeads || 0}</p>
            </div>
            <div class="bg-nfglight dark:bg-gray-700 rounded-lg p-2">
              <p class="text-xs text-gray-500">Coverage Score</p>
              <p class="text-lg font-bold text-green-600">${coverage?.coverageScore || 0}</p>
            </div>
            <div class="bg-nfglight dark:bg-gray-700 rounded-lg p-2">
              <p class="text-xs text-gray-500">Touched 7d</p>
              <p class="text-lg font-bold">${coverage?.leadsTouched7d || 0}</p>
            </div>
            <div class="bg-nfglight dark:bg-gray-700 rounded-lg p-2">
              <p class="text-xs text-gray-500">Untouched 14d</p>
              <p class="text-lg font-bold text-orange-600">${coverage?.leadsUntouched14d || 0}</p>
            </div>
          </div>
          
          <div>
            <div class="flex items-center justify-between mb-2">
              <h5 class="font-medium text-sm">Assigned Reps</h5>
              <button class="text-xs text-nfgblue hover:underline" onclick="openAssignRepModal('${territory.id}')">
                + Assign
              </button>
            </div>
            <div class="space-y-1">
              ${assignments.length === 0 ? '<p class="text-xs text-gray-500">No reps assigned</p>' : 
                assignments.map(a => `
                  <div class="flex items-center justify-between p-2 bg-nfglight rounded text-sm">
                    <span>${a.rep?.full_name || a.rep?.email || 'Unknown'}</span>
                    ${a.is_primary ? '<span class="text-xs text-nfgblue">Primary</span>' : ''}
                  </div>
                `).join('')
              }
            </div>
          </div>
          
          <div class="flex gap-2">
            <button onclick="editTerritory('${territory.id}')" class="flex-1 px-3 py-2 border border-nfgray rounded-lg hover:bg-nfglight text-sm">
              Edit
            </button>
            <button onclick="deleteTerritoryConfirm('${territory.id}')" class="flex-1 px-3 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50 text-sm">
              Delete
            </button>
          </div>
        </div>
      `;
    }
    
    // Render territories on map
    function renderTerritoriesOnMap() {
      if (!territoriesMap) return;
      
      // Clear existing layers
      territoriesMap.eachLayer(layer => {
        if (layer instanceof L.Polygon || layer instanceof L.Marker) {
          territoriesMap.removeLayer(layer);
        }
      });
      
      // Add territory polygons
      territories.forEach(territory => {
        const geojson = territory.geojson || territory.polygon_coordinates;
        if (geojson && geojson.coordinates) {
          const polygon = L.polygon(geojson.coordinates[0].map(coord => [coord[1], coord[0]]), {
            color: territory.color || '#0D47A1',
            fillColor: territory.color || '#0D47A1',
            fillOpacity: 0.2,
            weight: 2
          }).bindPopup(territory.name);
          
          polygon.territoryId = territory.id;
          polygon.addTo(territoriesMap);
          
          polygon.on('click', () => selectTerritory(territory.id));
        }
      });
    }
    
    // Highlight territory on map
    function highlightTerritoryOnMap(territory) {
      if (!territoriesMap) return;
      
      territoriesMap.eachLayer(layer => {
        if (layer.territoryId) {
          if (layer.territoryId === territory.id) {
            layer.setStyle({ weight: 4, fillOpacity: 0.3 });
            territoriesMap.fitBounds(layer.getBounds());
          } else {
            layer.setStyle({ weight: 2, fillOpacity: 0.2 });
          }
        }
      });
    }
    
    // Handle territory drawn
    function handleTerritoryDrawn(e) {
      const layer = e.layer;
      const geoJson = layer.toGeoJSON();
      
      // Open create territory modal with drawn polygon
      openCreateTerritoryModal(geoJson);
      
      // Remove the drawn layer (will be added back when saved)
      territoriesMap.removeLayer(layer);
    }
    
    // Handle territory edited
    function handleTerritoryEdited(e) {
      // Territory editing will be handled through the edit modal
    }
    
    // Handle territory deleted
    function handleTerritoryDeleted(e) {
      // Territory deletion will be handled through the delete confirmation
    }
    
    // Open create territory modal
    function openCreateTerritoryModal(geojson = null) {
      // This will be implemented with a modal
      const name = prompt('Enter territory name:');
      if (!name) return;
      
      createTerritory({
        name,
        geojson: geojson || null,
        color: '#0D47A1',
        active: true
      }).then(() => {
        toast.success('Territory created');
        loadAndRenderTerritories();
      }).catch(error => {
        toast.error('Failed to create territory');
        console.error(error);
      });
    }
    
    // Generate route plan
    async function generateRoutePlanHandler() {
      const errorDiv = document.getElementById('plan-error');
      errorDiv.classList.add('hidden');
      
      try {
        // Get inputs
        const date = document.getElementById('plan-date').value;
        const repId = document.getElementById('plan-rep').value;
        const territoryId = document.getElementById('plan-territory').value;
        const objective = document.getElementById('plan-objective').value;
        const stopsSource = document.getElementById('plan-stops-source').value;
        
        const shiftStart = document.getElementById('plan-shift-start').value;
        const shiftEnd = document.getElementById('plan-shift-end').value;
        const maxStops = parseInt(document.getElementById('plan-max-stops').value);
        const lunchStart = document.getElementById('plan-lunch-start').value;
        const lunchDuration = parseInt(document.getElementById('plan-lunch-duration').value);
        const serviceDuration = parseInt(document.getElementById('plan-service-duration').value);
        
        const priorityWeight = parseFloat(document.getElementById('plan-priority-weight').value);
        const recencyWeight = parseFloat(document.getElementById('plan-recency-weight').value);
        const valueWeight = parseFloat(document.getElementById('plan-value-weight').value);
        
        // Validate
        if (!date || !repId) {
          throw new Error('Date and Rep are required');
        }
        
        // Convert time to minutes
        const [startHour, startMin] = shiftStart.split(':').map(Number);
        const shiftStartMinutes = startHour * 60 + startMin;
        
        const [endHour, endMin] = shiftEnd.split(':').map(Number);
        const shiftEndMinutes = endHour * 60 + endMin;
        
        const [lunchHour, lunchMin] = lunchStart.split(':').map(Number);
        const lunchStartMinutes = lunchHour * 60 + lunchMin;
        
        // Fetch candidate stops (leads/appointments)
        const stops = await fetchCandidateStops(stopsSource, territoryId, repId);
        
        if (stops.length === 0) {
          throw new Error('No eligible stops found for this route');
        }
        
        // Get rep's home base or territory centroid
        const startPoint = await getStartPoint(repId, territoryId);
        
        // Generate route plan
        const result = generateRoutePlan({
          stops,
          startPoint,
          constraints: {
            shiftStartMinutes,
            shiftEndMinutes,
            lunchBreakStart: lunchStartMinutes,
            lunchBreakDuration: lunchDuration,
            maxStops,
            serviceDurationMinutes: serviceDuration
          },
          weights: {
            priorityWeight,
            recencyWeight,
            valueWeight
          }
        });
        
        if (!result.success) {
          throw new Error(result.error || 'Failed to generate route');
        }
        
        currentRoutePlan = result;
        renderRoutePlan(result);
        
        // Show save/export buttons
        document.getElementById('route-plan-actions').classList.remove('hidden');
        
        toast.success(`Route generated with ${result.route.length} stops`);
      } catch (error) {
        console.error('Error generating route:', error);
        errorDiv.textContent = error.message || 'Failed to generate route';
        errorDiv.classList.remove('hidden');
        toast.error(error.message || 'Failed to generate route');
      }
    }
    
    // Fetch candidate stops
    async function fetchCandidateStops(stopsSource, territoryId, repId) {
      const stops = [];
      
      if (stopsSource === 'leads' || stopsSource === 'mixed') {
        let query = supabase
          .from('leads')
          .select('id, latitude, longitude, status, last_touched_at, do_not_contact, routing_eligible, address')
          .eq('routing_eligible', true)
          .eq('do_not_contact', false)
          .not('latitude', 'is', null)
          .not('longitude', 'is', null);
        
        const { data: leads } = await query;
        
        if (leads) {
          for (const lead of leads) {
            // Filter by territory if specified
            if (territoryId) {
              const territory = territories.find(t => t.id === territoryId);
              if (territory) {
                const geojson = territory.geojson || territory.polygon_coordinates;
                if (geojson) {
                  if (!isPointInTerritory(lead.latitude, lead.longitude, geojson)) {
                    continue;
                  }
                }
              }
            }
            
            const daysSinceTouch = lead.last_touched_at 
              ? Math.floor((Date.now() - new Date(lead.last_touched_at).getTime()) / (1000 * 60 * 60 * 24))
              : 999;
            
            stops.push({
              id: lead.id,
              type: 'lead',
              lat: parseFloat(lead.latitude),
              lng: parseFloat(lead.longitude),
              priority: 3, // Default priority
              serviceDurationMinutes: 15,
              daysSinceLastTouch: daysSinceTouch,
              address: lead.address,
              routingEligible: lead.routing_eligible,
              doNotContact: lead.do_not_contact
            });
          }
        }
      }
      
      if (stopsSource === 'appointments' || stopsSource === 'mixed') {
        const { data: appointments } = await supabase
          .from('appointments')
          .select(`
            id, scheduled_date, scheduled_time, duration_minutes,
            lead:leads (latitude, longitude, address)
          `)
          .eq('status', 'scheduled')
          .gte('scheduled_date', new Date().toISOString().split('T')[0]);
        
        if (appointments) {
          for (const apt of appointments) {
            if (apt.lead?.latitude && apt.lead?.longitude) {
              const [hour, minute] = apt.scheduled_time ? apt.scheduled_time.split(':').map(Number) : [12, 0];
              const timeWindowStart = hour * 60 + minute;
              const timeWindowEnd = timeWindowStart + (apt.duration_minutes || 30);
              
              stops.push({
                id: apt.id,
                type: 'appointment',
                lat: parseFloat(apt.lead.latitude),
                lng: parseFloat(apt.lead.longitude),
                priority: 5, // Appointments are high priority
                serviceDurationMinutes: apt.duration_minutes || 30,
                timeWindowStartMinutes: timeWindowStart,
                timeWindowEndMinutes: timeWindowEnd,
                mustVisit: true,
                address: apt.lead.address
              });
            }
          }
        }
      }
      
      return stops;
    }
    
    // Get start point (rep home or territory centroid)
    async function getStartPoint(repId, territoryId) {
      // For now, use territory centroid or default location
      if (territoryId) {
        const territory = territories.find(t => t.id === territoryId);
        if (territory?.geojson) {
          const coords = territory.geojson.coordinates[0];
          const centerLat = coords.reduce((sum, c) => sum + c[1], 0) / coords.length;
          const centerLng = coords.reduce((sum, c) => sum + c[0], 0) / coords.length;
          return { lat: centerLat, lng: centerLng };
        }
      }
      
      // Default to Toronto
      return { lat: 43.6532, lng: -79.3832 };
    }
    
    // Render route plan output
    function renderRoutePlan(plan) {
      const output = document.getElementById('route-plan-output');
      if (!output) return;
      
      if (!plan.success || !plan.route || plan.route.length === 0) {
        output.innerHTML = '<div class="text-center py-8 text-red-600">Failed to generate route plan</div>';
        return;
      }
      
      output.innerHTML = `
        <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 mb-4">
          <h4 class="font-semibold text-nfgblue dark:text-blue-400 mb-2">Route Summary</h4>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div>
              <span class="text-gray-500">Total Stops:</span>
              <span class="font-medium ml-2">${plan.route.length}</span>
            </div>
            <div>
              <span class="text-gray-500">Drive Time:</span>
              <span class="font-medium ml-2">${Math.round(plan.stats.totalTravelMinutes)} min</span>
            </div>
            <div>
              <span class="text-gray-500">Service Time:</span>
              <span class="font-medium ml-2">${Math.round(plan.stats.totalServiceMinutes)} min</span>
            </div>
            <div>
              <span class="text-gray-500">Total Time:</span>
              <span class="font-medium ml-2">${Math.round(plan.stats.totalTime)} min</span>
            </div>
          </div>
        </div>
        
        <div class="space-y-2">
          <h4 class="font-semibold text-nfgblue dark:text-blue-400">Route Stops</h4>
          ${plan.route.map((stop, idx) => {
            const stopData = stop.stop;
            const hours = Math.floor(stop.etaMinutesFromShiftStart / 60);
            const minutes = stop.etaMinutesFromShiftStart % 60;
            const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            
            return `
              <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-lg p-3">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <span class="w-6 h-6 rounded-full bg-nfgblue text-white text-xs flex items-center justify-center">${idx + 1}</span>
                      <span class="font-medium">${stopData.address || 'Unknown Address'}</span>
                    </div>
                    <div class="text-xs text-gray-500 ml-8">
                      ETA: ${timeStr} | Travel: ${stop.travelMinutesFromPrev || 0} min | Service: ${stopData.serviceDurationMinutes || 15} min
                    </div>
                  </div>
                  ${stopData.mustVisit ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">Appointment</span>' : ''}
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      lucide.createIcons();
    }
    
    // Save route plan
    async function saveRoutePlan() {
      if (!currentRoutePlan) {
        toast.error('No route plan to save');
        return;
      }
      
      try {
        const date = document.getElementById('plan-date').value;
        const repId = document.getElementById('plan-rep').value;
        const territoryId = document.getElementById('plan-territory').value || null;
        const objective = document.getElementById('plan-objective').value;
        const stopsSource = document.getElementById('plan-stops-source').value;
        
        const shiftStart = document.getElementById('plan-shift-start').value;
        const shiftEnd = document.getElementById('plan-shift-end').value;
        const maxStops = parseInt(document.getElementById('plan-max-stops').value);
        const lunchStart = document.getElementById('plan-lunch-start').value;
        const lunchDuration = parseInt(document.getElementById('plan-lunch-duration').value);
        const serviceDuration = parseInt(document.getElementById('plan-service-duration').value);
        
        const priorityWeight = parseFloat(document.getElementById('plan-priority-weight').value);
        const recencyWeight = parseFloat(document.getElementById('plan-recency-weight').value);
        const valueWeight = parseFloat(document.getElementById('plan-value-weight').value);
        
        const [startHour, startMin] = shiftStart.split(':').map(Number);
        const shiftStartMinutes = startHour * 60 + startMin;
        const [endHour, endMin] = shiftEnd.split(':').map(Number);
        const shiftEndMinutes = endHour * 60 + endMin;
        const [lunchHour, lunchMin] = lunchStart.split(':').map(Number);
        const lunchStartMinutes = lunchHour * 60 + lunchMin;
        
        // Create route plan
        const { data: routePlan, error: planError } = await supabase
          .from('route_plans')
          .insert({
            date,
            rep_user_id: repId,
            territory_id: territoryId,
            status: 'draft',
            route_objective: objective,
            stops_source: stopsSource,
            constraints: {
              shiftStartMinutes,
              shiftEndMinutes,
              lunchBreakStart: lunchStartMinutes,
              lunchBreakDuration: lunchDuration,
              maxStops,
              serviceDurationMinutes: serviceDuration
            },
            weights: {
              priorityWeight,
              recencyWeight,
              valueWeight
            },
            engine_version: '1.0',
            stats: currentRoutePlan.stats,
            diagnostics: currentRoutePlan.diagnostics,
            created_by: currentUser.id
          })
          .select()
          .single();
        
        if (planError) throw planError;
        
        // Create route plan stops
        const stops = currentRoutePlan.route.map((stop, idx) => ({
          route_plan_id: routePlan.id,
          stop_type: stop.stop.type,
          stop_ref_id: stop.stop.id,
          lat: stop.stop.lat,
          lng: stop.stop.lng,
          order_index: idx,
          eta_minutes_from_shift_start: stop.etaMinutesFromShiftStart,
          planned_start_minutes: stop.plannedStartMinutes,
          planned_end_minutes: stop.plannedEndMinutes,
          travel_minutes_from_prev: stop.travelMinutesFromPrev || 0,
          service_duration_minutes: stop.stop.serviceDurationMinutes || 15,
          priority: stop.stop.priority || 3,
          time_window_start_minutes: stop.stop.timeWindowStartMinutes,
          time_window_end_minutes: stop.stop.timeWindowEndMinutes,
          must_visit: stop.stop.mustVisit || false
        }));
        
        const { error: stopsError } = await supabase
          .from('route_plan_stops')
          .insert(stops);
        
        if (stopsError) throw stopsError;
        
        toast.success('Route plan saved successfully');
        await loadRoutePlans();
        switchPlannerSubtab('plans');
      } catch (error) {
        console.error('Error saving route plan:', error);
        toast.error('Failed to save route plan');
      }
    }
    
    // Export route plan
    function exportRoutePlan() {
      if (!currentRoutePlan) {
        toast.error('No route plan to export');
        return;
      }
      
      // Export as CSV
      const csv = [
        ['Stop', 'Address', 'ETA', 'Travel Time', 'Service Duration', 'Priority'].join(','),
        ...currentRoutePlan.route.map((stop, idx) => [
          idx + 1,
          `"${stop.stop.address || 'Unknown'}"`,
          formatMinutesToTime(stop.etaMinutesFromShiftStart),
          stop.travelMinutesFromPrev || 0,
          stop.stop.serviceDurationMinutes || 15,
          stop.stop.priority || 3
        ].join(','))
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `route-plan-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      toast.success('Route plan exported');
    }
    
    function formatMinutesToTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Create route button
      document.getElementById('create-route-btn')?.addEventListener('click', () => {
        document.getElementById('create-route-modal').classList.remove('hidden');
      });
      
      // Generate route button
      document.getElementById('generate-route-btn')?.addEventListener('click', generateRoutePlanHandler);
      
      // Save route plan button
      document.getElementById('save-route-plan-btn')?.addEventListener('click', saveRoutePlan);
      
      // Export route plan button
      document.getElementById('export-route-plan-btn')?.addEventListener('click', exportRoutePlan);
      
      // Create territory button
      document.getElementById('create-territory-btn')?.addEventListener('click', () => {
        openCreateTerritoryModal();
      });
      
      // Draw territory button
      document.getElementById('draw-territory-btn')?.addEventListener('click', () => {
        if (drawControl && territoriesMap) {
          const drawPolygon = new L.Draw.Polygon(territoriesMap, {
            allowIntersection: false,
            showArea: true
          });
          drawPolygon.enable();
        }
      });
      
      // Toggle heatmap
      document.getElementById('toggle-heatmap-btn')?.addEventListener('click', () => {
        toggleHeatmap();
      });
      
      // Toggle map view for route plan
      document.getElementById('toggle-map-view')?.addEventListener('click', () => {
        toggleRoutePlanMap();
      });

      // Filter tabs
      document.querySelectorAll('.route-filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.route-filter-tab').forEach(t => {
            t.classList.remove('text-nfgblue', 'border-nfgblue', 'dark:text-blue-400');
            t.classList.add('text-gray-500', 'border-transparent');
          });
          tab.classList.remove('text-gray-500', 'border-transparent');
          tab.classList.add('text-nfgblue', 'border-nfgblue', 'dark:text-blue-400');
          currentFilter = tab.dataset.status;
          loadRoutes();
        });
      });

      // Create route form
      document.getElementById('create-route-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorDiv = document.getElementById('create-route-error');
        errorDiv.classList.add('hidden');

        try {
          const routeData = {
            name: document.getElementById('route-name').value.trim(),
            route_date: document.getElementById('route-date').value,
            assigned_rep_id: document.getElementById('route-assigned-rep').value,
            territory_id: document.getElementById('route-territory').value || null
          };

          const route = await createRoute(routeData);
          toast.success('Route created successfully');
          document.getElementById('create-route-modal').classList.add('hidden');
          document.getElementById('create-route-form').reset();
          await loadRoutes();
          
          // Navigate to route detail
          window.location.href = `route-detail.html?id=${route.id}`;
        } catch (error) {
          console.error('Error creating route:', error);
          errorDiv.textContent = error.message || 'Failed to create route';
          errorDiv.classList.remove('hidden');
        }
      });

      // Logout
      document.getElementById('logout-btn')?.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = './index.html';
      });

      // Modal close handlers
      document.querySelectorAll('[data-action="close-modal"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.target;
          if (target) {
            document.getElementById(target)?.classList.add('hidden');
          }
        });
      });
    }

    // Initialize on load
    init();
  </script>

  <!-- Notification Center -->
  <script type="module" src="./js/notification-center.js"></script>
  
  <!-- UI Helpers -->
  <script type="module" src="./js/ui.js"></script>
</body>
</html>
