<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG â€” Sales Portal</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">
  
  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

  <!-- Sales Portal Styles -->
  <style>
    .health-bar {
      height: 4px;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .health-excellent { background: #10b981; }
    .health-good { background: #3b82f6; }
    .health-fair { background: #f59e0b; }
    .health-poor { background: #ef4444; }
    .timeline-item {
      position: relative;
      padding-left: 2rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: -1rem;
      width: 2px;
      background: #E5E7EB;
    }
    .timeline-item:last-child::before {
      display: none;
    }
    .single-scroll-container {
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
    }

    /* Kanban Board Styles */
    #deals-kanban {
      scrollbar-width: thin;
      scrollbar-color: #E5E7EB transparent;
    }

    #deals-kanban::-webkit-scrollbar {
      height: 8px;
    }

    #deals-kanban::-webkit-scrollbar-track {
      background: transparent;
    }

    #deals-kanban::-webkit-scrollbar-thumb {
      background: #E5E7EB;
      border-radius: 4px;
    }

    .dark #deals-kanban::-webkit-scrollbar-thumb {
      background: #374151;
    }

    .kanban-column {
      min-height: 400px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .kanban-deals {
      min-height: 200px;
    }

    .deal-card {
      transition: all 0.2s ease;
      user-select: none;
    }

    .deal-card:hover {
      transform: translateY(-2px);
    }

    .deal-card:active {
      cursor: grabbing;
    }

    .kanban-deals.drag-over {
      background-color: rgba(13, 71, 161, 0.1);
      border: 2px dashed #0D47A1;
      border-radius: 8px;
    }

    .dark .kanban-deals.drag-over {
      background-color: rgba(59, 130, 246, 0.2);
      border-color: #3B82F6;
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .view-option.active {
      background-color: white;
    }
    
    .dark .view-option.active {
      background-color: #374151;
    }
    
    .deals-view {
      min-height: 400px;
    }
    
    .deals-view.hidden {
      display: none;
    }

    .deal-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
  </style>
</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Sales Portal...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" 
        alt="NFG" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a id="nav-sales" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="sales.html" onclick="event.preventDefault(); if (window.switchTab) window.switchTab('dashboard');">
        <i data-lucide="trending-up" class="w-4 h-4"></i> Sales
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="routes.html">
        <i data-lucide="route" class="w-4 h-4"></i> Routes
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700 space-y-2">
      <a href="dashboard.html" onclick="sessionStorage.removeItem('isSalesMode');" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfgblue dark:bg-blue-600 text-white hover:bg-nfgdark dark:hover:bg-blue-700 w-full text-left font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Ops Mode
      </a>
      <button id="logout-btn" data-action="logout" class="w-full border border-nfgray dark:border-gray-600 text-nftext dark:text-gray-300 hover:bg-nfgray dark:hover:bg-gray-700 rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 id="page-title" class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Sales Portal</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="back-to-queue-btn" class="hidden px-3 py-1.5 text-sm bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 rounded-lg hover:bg-nfgray dark:hover:bg-gray-600 transition">
            <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> Back to Queue
          </button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden flex flex-col">
      <!-- Sales Dashboard Tabs -->
      <div class="border-b border-nfgray dark:border-gray-700 bg-white dark:bg-gray-800">
        <div class="px-4 md:px-6 flex gap-1 overflow-x-auto">
          <button class="sales-tab active px-4 py-3 text-sm font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue dark:border-blue-400 whitespace-nowrap" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-2"></i> Dashboard
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="deals">
            <i data-lucide="briefcase" class="w-4 h-4 inline mr-2"></i> Deals
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="quotes">
            <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i> Quotes
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="leads">
            <i data-lucide="user-plus" class="w-4 h-4 inline mr-2"></i> Leads
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="contacts">
            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i> Contacts
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="calls">
            <i data-lucide="phone" class="w-4 h-4 inline mr-2"></i> Calls
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="sequences">
            <i data-lucide="repeat" class="w-4 h-4 inline mr-2"></i> Sequences
          </button>
        </div>
      </div>

      <!-- Tab Content Container -->
      <div class="flex-1 overflow-hidden">
        <!-- Dashboard Tab (Command Console) -->
        <div id="tab-dashboard" class="sales-tab-content h-full overflow-y-auto p-4 md:p-6">
          <!-- Sales Pipeline Header -->
          <div class="mb-4">
            <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Sales Pipeline</h2>
          </div>

          <!-- 1. Top KPI Strip (4 Cards) -->
          <div id="kpi-strip" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Card 1: Open Pipeline -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="open-pipeline">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Open Pipeline</span>
                <i data-lucide="trending-up" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <p id="kpi-total-open" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mb-1">$0</p>
              <p id="kpi-weighted-open" class="text-xs text-gray-500 dark:text-gray-400">Weighted: $0</p>
            </div>

            <!-- Card 2: Today -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="today">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Today</span>
                <i data-lucide="calendar" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Calls:</span>
                  <span id="kpi-today-calls" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Quotes:</span>
                  <span id="kpi-today-quotes" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Closed:</span>
                  <span id="kpi-today-closed" class="font-semibold text-green-600 dark:text-green-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Walkthroughs:</span>
                  <span id="kpi-today-walkthroughs" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
              </div>
            </div>

            <!-- Card 3: Next 7 Days -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="next-7-days">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Next 7 Days</span>
                <i data-lucide="clock" class="w-5 h-5 text-orange-500"></i>
              </div>
              <p id="kpi-at-risk" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-1">0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">At Risk</p>
            </div>

            <!-- Card 4: Urgent -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="urgent">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Urgent</span>
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Uncontacted:</span>
                  <span id="kpi-uncontacted" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Quotes <48h:</span>
                  <span id="kpi-quotes-expiring" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Idle >7d:</span>
                  <span id="kpi-idle-deals" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Priority Actions Queue -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Priority Actions</h3>
            <div id="priority-actions" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
              <div id="priority-actions-list" class="divide-y divide-nfgray dark:divide-gray-700">
                <!-- Priority actions will be rendered here -->
              </div>
            </div>
          </div>

          <!-- 3. Active Deals Table (Main Body) -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Active Deals</h3>
              <button id="create-deal-dashboard-btn" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition">
                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> New Deal
              </button>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Company</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Stage</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Deal $</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Last Contact</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Next Action</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Days Idle</th>
                    </tr>
                  </thead>
                  <tbody id="deals-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
                    <!-- Deals will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 4. Pipeline Stage Snapshot -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Pipeline Stages</h3>
            <div id="pipeline-snapshot" class="grid grid-cols-2 md:grid-cols-6 gap-3">
              <!-- Pipeline stages will be rendered here -->
            </div>
          </div>

          <!-- Bottom Section: Quotes Watch & Walkthroughs -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 5. Quotes Watch -->
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Quotes Watch</h3>
              <div id="quotes-watch" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
                <div id="quotes-watch-list" class="divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Quotes will be rendered here -->
                </div>
              </div>
            </div>

            <!-- 6. Walkthroughs Today -->
            <div>
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Walkthroughs Today</h3>
              <div id="walkthroughs-today" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
                <div id="walkthroughs-list" class="divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Walkthroughs will be rendered here -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Deals Tab -->
        <div id="tab-deals" class="sales-tab-content hidden h-full overflow-y-auto">
          <!-- Modern Header Section -->
          <div class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-4 md:px-6 py-6">
            <div class="flex flex-col gap-4">
              <!-- Title and Description -->
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Deals</h1>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Keep track of your sales pipeline all in one place.</p>
                </div>
                <div class="flex items-center gap-3">
                  <button id="create-deal-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition inline-flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> New Deal
                  </button>
                </div>
              </div>

              <!-- View Options and Filters -->
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-2 border-t border-gray-200 dark:border-gray-700">
                <!-- View Tabs -->
                <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                  <button class="view-option px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 rounded transition" data-view="overview">
                    <i data-lucide="layout-grid" class="w-4 h-4 inline mr-1"></i> Overview
                  </button>
                  <button class="view-option active px-3 py-1.5 text-sm font-medium text-nfgblue dark:text-blue-400 bg-white dark:bg-gray-700 rounded transition" data-view="board">
                    <i data-lucide="columns" class="w-4 h-4 inline mr-1"></i> Board
                  </button>
                  <button class="view-option px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 rounded transition" data-view="list">
                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i> List
                  </button>
                  <button class="view-option px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 rounded transition" data-view="table">
                    <i data-lucide="table" class="w-4 h-4 inline mr-1"></i> Table
                  </button>
                </div>

                <!-- Filter Controls -->
                <div class="flex items-center gap-2">
                  <button class="filter-btn px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 rounded-lg transition inline-flex items-center gap-2">
                    <i data-lucide="filter" class="w-4 h-4"></i> Filter
                  </button>
                  <button class="group-btn px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 rounded-lg transition inline-flex items-center gap-2">
                    <i data-lucide="layers" class="w-4 h-4"></i> Group by
                  </button>
                  <button class="sort-btn px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 rounded-lg transition inline-flex items-center gap-2">
                    <i data-lucide="arrow-up-down" class="w-4 h-4"></i> Sort
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- View Containers -->
          <div class="p-4 md:p-6">
            <!-- Overview View -->
            <div id="deals-overview-view" class="deals-view hidden">
              <div id="deals-overview-content">
                <!-- Overview content will be rendered here -->
              </div>
            </div>

            <!-- Board View -->
            <div id="deals-board-view" class="deals-view">
              <div id="deals-kanban" class="flex gap-4 overflow-x-auto pb-4">
              <!-- Prospecting Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="prospecting">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Prospecting</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="prospecting">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Qualification Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="qualification">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Qualification</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="qualification">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Proposal Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="proposal">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Proposal</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="proposal">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Negotiation Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="negotiation">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-orange-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Negotiation</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="negotiation">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Closed Won Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-green-200 dark:border-green-800" data-stage="closed_won">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-400"></span>
                    <h3 class="font-semibold text-green-700 dark:text-green-300">Closed Won</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="kanban-count bg-green-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="closed_won">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Closed Lost Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="closed_lost">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Closed Lost</h3>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="kanban-count bg-gray-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="closed_lost">
                  <!-- Deals will be rendered here -->
                </div>
              </div>
            </div>
            </div>

            <!-- List View -->
            <div id="deals-list-view" class="deals-view hidden">
              <div id="deals-list-content" class="space-y-3">
                <!-- List content will be rendered here -->
              </div>
            </div>

            <!-- Table View -->
            <div id="deals-table-view" class="deals-view hidden">
              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Company</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Contact</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Stage</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Value</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Priority</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Due Date</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="deals-table-content" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Table content will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
          <div class="bg-white dark:bg-gray-800 border-2 border-dashed border-nfgray dark:border-gray-700 rounded-xl p-12 max-w-md mx-auto">
            <i data-lucide="trending-up" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-nfgblue dark:text-blue-400 font-semibold text-xl mb-2">No Deals Yet</h3>
            <p class="text-nftext dark:text-gray-300 text-sm mb-6">Get started by creating your first deal from a site.</p>
            <button id="create-first-deal-btn" class="bg-nfgblue hover:bg-nfgdark text-white rounded-xl px-6 py-3 font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-5 h-5"></i> Create Your First Deal
            </button>
          </div>
        </div>
      </div>

        <!-- Quotes Tab -->
        <div id="tab-quotes" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Quotes</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage and track all quotes</p>
            </div>
            <button id="new-quote-btn-tab" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Quote
            </button>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-4 mb-6 p-4 bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
              <select id="quotes-filter-status" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                <option value="">All Statuses</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="viewed">Viewed</option>
                <option value="accepted">Accepted</option>
                <option value="declined">Declined</option>
                <option value="expired">Expired</option>
                <option value="withdrawn">Withdrawn</option>
              </select>
            </div>
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quote Type</label>
              <select id="quotes-filter-type" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                <option value="">All Types</option>
                <option value="standard">Standard</option>
                <option value="walkthrough_required">Walkthrough Required</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="quotes-filter-reset" class="px-4 py-2 text-sm border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition">
                Reset Filters
              </button>
            </div>
          </div>

          <!-- Quotes Table -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-nfglight dark:bg-gray-700">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Quote Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Latest Revision</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Total / Range</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Sent Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Expiry</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Owner</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="quotes-table-body" class="bg-white dark:bg-gray-800 divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Quotes will be rendered here -->
                </tbody>
              </table>
            </div>
            <div id="quotes-empty-state" class="hidden p-12 text-center">
              <i data-lucide="file-text" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
              <p class="text-gray-500 dark:text-gray-400">No quotes yet</p>
              <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Click "New Quote" to create your first quote</p>
            </div>
          </div>
        </div>

        <!-- Leads Tab -->
        <div id="tab-leads" class="sales-tab-content hidden h-full flex flex-col">
          <!-- Sticky top bar -->
          <div class="sticky top-0 z-10 bg-white dark:bg-gray-900 border-b border-nfgray p-4 md:p-6">
            <div class="flex flex-col gap-4">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Leads</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Quo-style calling list for lead management</p>
                </div>
                <button id="create-lead-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
                  <i data-lucide="plus" class="w-4 h-4"></i> New Lead
                </button>
              </div>
              
              <!-- Search and Filters -->
              <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1">
                  <input
                    type="text"
                    id="leads-search"
                    placeholder="Search by company, person, phone, or email..."
                    class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-4 py-2 focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800"
                  />
                </div>
                <div class="flex gap-2 flex-wrap">
                  <select id="leads-status-filter" class="border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800">
                    <option value="">All Status</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="dm_reached">DM Reached</option>
                    <option value="walkthrough_booked">Walkthrough Booked</option>
                    <option value="quote_pending">Quote Pending</option>
                    <option value="unqualified">Unqualified</option>
                    <option value="do_not_contact">Do Not Contact</option>
                  </select>
                  <select id="leads-source-filter" class="border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800">
                    <option value="">All Sources</option>
                    <option value="glsa">GLSA</option>
                    <option value="coldlist">Cold List</option>
                    <option value="referral">Referral</option>
                    <option value="web">Web</option>
                    <option value="other">Other</option>
                  </select>
                  <select id="leads-owner-filter" class="border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800 hidden">
                    <option value="">All Owners</option>
                  </select>
                  <select id="leads-priority-filter" class="border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800">
                    <option value="">All Priorities</option>
                    <option value="5">Priority 5 (Highest)</option>
                    <option value="4">Priority 4</option>
                    <option value="3">Priority 3</option>
                    <option value="2">Priority 2</option>
                    <option value="1">Priority 1 (Lowest)</option>
                  </select>
                  <select id="leads-has-phone-filter" class="border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800">
                    <option value="">All Leads</option>
                    <option value="yes">Has Phone</option>
                    <option value="no">No Phone</option>
                  </select>
                  <select id="leads-sort" class="border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none bg-white dark:bg-gray-800">
                    <option value="next_action_at_asc">Next Action Due</option>
                    <option value="last_touch_at_desc">Last Touched</option>
                    <option value="priority_desc">Highest Priority</option>
                    <option value="created_at_desc">Newest</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Leads List -->
          <div class="flex-1 overflow-auto p-4 md:p-6">
            <div id="leads-list" class="space-y-3">
              <!-- Leads will be rendered here -->
            </div>
          </div>
        </div>

        <!-- Contacts Tab (Accounts Directory) -->
        <div id="tab-contacts" class="sales-tab-content hidden h-full flex flex-col">
          <!-- Sticky top bar -->
          <div class="sticky top-0 z-10 bg-white dark:bg-gray-900 border-b border-nfgray p-4 md:p-6">
            <div class="flex flex-col gap-4">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Client Accounts</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your client accounts directory</p>
                </div>
                <button id="create-account-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
                  <i data-lucide="plus" class="w-4 h-4"></i> New Account
                </button>
              </div>
              
              <!-- Search and Filters -->
              <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1">
                  <input
                    type="text"
                    id="accounts-search"
                    placeholder="Search by company name, DM, phone, or email..."
                    class="w-full border border-nfgray rounded-xl px-4 py-2 focus:ring-2 focus:ring-nfgblue outline-none"
                  />
                </div>
                <div class="flex gap-2 flex-wrap">
                  <select id="accounts-status-filter" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                    <option value="">All Status</option>
                    <option value="prospect">Prospect</option>
                    <option value="in_progress">In Progress</option>
                    <option value="active">Active</option>
                    <option value="dormant">Dormant</option>
                  </select>
                  <select id="accounts-owner-filter" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none hidden">
                    <option value="">All Owners</option>
                  </select>
                  <select id="accounts-sites-filter" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                    <option value="">All Sites</option>
                    <option value="1">1 site</option>
                    <option value="2-5">2-5 sites</option>
                    <option value="6+">6+ sites</option>
                  </select>
                  <select id="accounts-sort" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                    <option value="last_touch_at_desc">Recently Touched</option>
                    <option value="site_count_desc">Most Sites</option>
                    <option value="name_asc">A-Z</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Accounts Table -->
          <div class="flex-1 overflow-auto p-4 md:p-6">
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-nfglight dark:bg-gray-700 border-b border-nfgray">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Company</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Decision Maker</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Contact</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Sites</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Status</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Owner</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Last Touch</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400"></th>
                    </tr>
                  </thead>
                  <tbody id="accounts-table-body">
                    <tr>
                      <td colspan="8" class="px-4 py-12 text-center text-gray-500">Loading...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Calls Tab -->
        <div id="tab-calls" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Calls</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">View call history and recordings</p>
            </div>
            <button id="new-call-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="phone" class="w-4 h-4"></i> New Call
            </button>
          </div>
          <div id="calls-list" class="space-y-4">
            <!-- Calls will be rendered here -->
          </div>
        </div>

        <!-- Sequences Tab -->
        <div id="tab-sequences" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Follow-Up Sequences</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Automate your follow-up workflows</p>
            </div>
            <button id="create-sequence-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-4 h-4"></i> New Sequence
            </button>
          </div>
          <div id="sequences-list" class="space-y-4">
            <!-- Sequences will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Deal Detail View (Modal Overlay) -->
      <div id="deal-detail-view" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Deal Details</h3>
            <button id="close-deal-detail" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <!-- Deal Header -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
              <div class="flex-1">
                <h2 id="deal-detail-name" class="text-2xl font-semibold text-nfgblue dark:text-blue-400 mb-2">Deal Name</h2>
                <p id="deal-detail-site" class="text-gray-500 dark:text-gray-400">Site Name</p>
              </div>
              <div class="flex items-center gap-2">
                <span id="deal-detail-status" class="px-3 py-1 rounded-lg text-sm font-medium bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300">Active</span>
                <span id="deal-detail-priority" class="px-3 py-1 rounded-lg text-sm font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">High</span>
              </div>
            </div>
            
            <!-- Health Score -->
            <div class="mb-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Deal Health</span>
                <span id="deal-health-score" class="text-sm font-semibold text-nfgblue dark:text-blue-400">50%</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div id="deal-health-bar" class="health-bar h-2 rounded-full" style="width: 50%"></div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-2">
              <button id="call-deal-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="phone" class="w-4 h-4"></i> Call
              </button>
              <button id="text-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="message-square" class="w-4 h-4"></i> Text
              </button>
              <button id="email-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="mail" class="w-4 h-4"></i> Email
              </button>
              <button id="create-quote-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4"></i> Create Quote
              </button>
              <button id="set-appointment-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i> Set Appointment
              </button>
            </div>
          </div>

          <!-- Timeline Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Timeline</h3>
            <div id="timeline-container" class="space-y-4">
              <!-- Timeline items will be rendered here -->
            </div>
          </div>

          <!-- Post-Call Next Action Panel -->
          <div id="post-call-panel" class="hidden bg-nfglight dark:bg-gray-700 border border-nfgray dark:border-gray-600 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Next Action</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Action</label>
                <input type="text" id="next-action-input" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Follow up in 3 days">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date</label>
                <input type="datetime-local" id="next-action-date-input" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              </div>
              <button id="save-next-action-btn" class="w-full px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
                Save Next Action
              </button>
            </div>
          </div>

          <!-- Follow-Up Sequences -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Follow-Up Sequences</h3>
              <button id="assign-sequence-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                Assign Sequence
              </button>
            </div>
            <div id="sequences-container" class="space-y-3">
              <!-- Sequences will be rendered here -->
            </div>
          </div>

          <!-- Quotes Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Quotes</h3>
              <button id="new-quote-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                New Quote
              </button>
            </div>
            <div id="quotes-container" class="space-y-3">
              <!-- Quotes will be rendered here -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create Deal Modal -->
  <div id="create-deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create New Lead/Deal</h3>
          <button id="close-create-deal-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="create-deal-form" class="p-6 space-y-6">
        <!-- Company Information -->
        <div class="border-b border-nfgray dark:border-gray-700 pb-4">
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Company Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Name <span class="text-red-500">*</span></label>
              <input type="text" id="deal-company-name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Enter company name" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Industry</label>
              <select id="deal-industry" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                <option value="">Select industry...</option>
                <option value="commercial_office">Commercial Office</option>
                <option value="medical_clinic">Medical Clinic</option>
                <option value="dental">Dental</option>
                <option value="restaurant">Restaurant</option>
                <option value="retail">Retail</option>
                <option value="industrial">Industrial</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address</label>
            <input type="text" id="deal-address" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Street address">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City</label>
              <input type="text" id="deal-city" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="City">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Province</label>
              <input type="text" id="deal-province" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="ON">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Postal Code</label>
              <input type="text" id="deal-postal" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="A1A 1A1">
            </div>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="border-b border-nfgray dark:border-gray-700 pb-4">
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Primary Contact</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">First Name</label>
              <input type="text" id="deal-contact-first" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="First name">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Last Name</label>
              <input type="text" id="deal-contact-last" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Last name">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
              <input type="email" id="deal-contact-email" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="email@example.com">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
              <input type="tel" id="deal-contact-phone" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title/Role</label>
            <input type="text" id="deal-contact-title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Facilities Manager, Owner">
          </div>
        </div>

        <!-- Deal Details -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Deal Details</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deal Title</label>
              <input type="text" id="deal-title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Monthly Cleaning Service">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stage</label>
              <select id="deal-stage-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                <option value="prospecting" selected>Prospecting</option>
                <option value="qualification">Qualification</option>
                <option value="proposal">Proposal</option>
                <option value="negotiation">Negotiation</option>
                <option value="closed_won">Closed Won</option>
                <option value="closed_lost">Closed Lost</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
              <select id="deal-priority-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estimated Value ($)</label>
              <input type="number" id="deal-value-input" step="0.01" min="0" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0.00">
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expected Close Date</label>
            <input type="date" id="deal-close-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
            <textarea id="deal-notes-input" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Add any notes about this lead/deal..."></textarea>
          </div>
        </div>

        <div class="flex gap-3 pt-4 border-t border-nfgray dark:border-gray-700">
          <button type="button" id="cancel-create-deal" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Create Lead/Deal
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Lead Modal -->
  <div id="create-lead-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create New Lead</h3>
          <button id="close-create-lead-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="create-lead-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Name</label>
          <input type="text" name="company_name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Company name (optional)">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Person Name</label>
          <input type="text" name="person_name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Contact person name">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title</label>
          <input type="text" name="title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Job title">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
            <input type="tel" name="phone" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="(555) 123-4567">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
            <input type="email" name="email" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="email@example.com">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address</label>
          <input type="text" name="address" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Street address">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City</label>
            <input type="text" name="city" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="City">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Source</label>
            <select name="source" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="other">Other</option>
              <option value="glsa">GLSA</option>
              <option value="coldlist">Cold List</option>
              <option value="referral">Referral</option>
              <option value="web">Web</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
          <select name="priority" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
            <option value="3" selected>3 (Medium)</option>
            <option value="5">5 (Highest)</option>
            <option value="4">4</option>
            <option value="2">2</option>
            <option value="1">1 (Lowest)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
          <textarea name="notes_lite" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Brief notes..."></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancel-create-lead" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Create Lead
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Disposition Modal -->
  <div id="disposition-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Call Disposition</h3>
          <button id="close-disposition-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="dispositions-list" class="space-y-2">
          <!-- Disposition options will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Convert Lead Modal -->
  <div id="convert-lead-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Convert Lead to Account</h3>
          <button id="close-convert-lead-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="convert-lead-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account Name</label>
          <input type="text" id="convert-account-name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Company name">
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="convert-create-deal" name="create_deal" class="w-4 h-4 text-nfgblue rounded border-nfgray focus:ring-2 focus:ring-nfgblue">
          <label for="convert-create-deal" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Create Deal</label>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancel-convert-lead" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition">
            Convert
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lead Drawer -->
  <div id="lead-drawer" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end md:items-center md:justify-end p-0">
    <div class="bg-white dark:bg-gray-800 w-full md:w-96 h-full md:h-[90vh] flex flex-col shadow-xl">
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Lead Details</h3>
          <button id="lead-drawer-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-6">
        <div id="drawer-lead-summary">
          <!-- Lead summary will be rendered here -->
        </div>
        <div>
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Recent Activity</h4>
          <div id="drawer-activities" class="space-y-2">
            <!-- Activities will be rendered here -->
          </div>
        </div>
        <div>
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Conversion Status</h4>
          <div id="drawer-conversion">
            <!-- Conversion status will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quote Builder Modal (3-Step Wizard) -->
  <div id="quote-builder-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create Quote</h3>
          <button id="close-quote-builder-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
        <!-- Step Indicator -->
        <div class="flex items-center justify-between">
          <div class="flex items-center flex-1">
            <div class="flex items-center">
              <div id="wizard-step-1-indicator" class="w-8 h-8 rounded-full bg-nfgblue text-white flex items-center justify-center font-semibold text-sm">1</div>
              <span class="ml-2 text-sm font-medium text-nfgblue dark:text-blue-400">Account Type</span>
            </div>
            <div class="flex-1 h-0.5 bg-nfgray dark:bg-gray-700 mx-4"></div>
            <div class="flex items-center">
              <div id="wizard-step-2-indicator" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">2</div>
              <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Context</span>
            </div>
            <div class="flex-1 h-0.5 bg-nfgray dark:bg-gray-700 mx-4"></div>
            <div class="flex items-center">
              <div id="wizard-step-3-indicator" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">3</div>
              <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Pricing</span>
            </div>
            <div class="flex-1 h-0.5 bg-nfgray dark:bg-gray-700 mx-4"></div>
            <div class="flex items-center">
              <div id="wizard-step-4-indicator" class="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-600 text-gray-600 dark:text-gray-300 flex items-center justify-center font-semibold text-sm">4</div>
              <span class="ml-2 text-sm font-medium text-gray-500 dark:text-gray-400">Terms</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step Content (scrollable) -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Step 1: Account Type Selection -->
        <div id="wizard-step-1" class="wizard-step space-y-4">
          <div class="text-center py-8">
            <h4 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Select Account Type</h4>
            <p class="text-gray-600 dark:text-gray-400 mb-8">Choose whether this quote is for a new account or an existing account</p>
            <div class="grid grid-cols-2 gap-6 max-w-2xl mx-auto">
              <button type="button" id="account-type-new" class="account-type-btn p-8 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue dark:hover:border-blue-400 rounded-xl bg-white dark:bg-gray-800 transition cursor-pointer text-center">
                <div class="text-4xl mb-4">âœ¨</div>
                <h5 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">New Account</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400">Create a quote for a new customer</p>
              </button>
              <button type="button" id="account-type-existing" class="account-type-btn p-8 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue dark:hover:border-blue-400 rounded-xl bg-white dark:bg-gray-800 transition cursor-pointer text-center">
                <div class="text-4xl mb-4">ðŸ¢</div>
                <h5 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-2">Existing Account</h5>
                <p class="text-sm text-gray-600 dark:text-gray-400">Create a quote for an existing customer</p>
              </button>
            </div>
          </div>
        </div>

        <!-- Step 2: Context -->
        <div id="wizard-step-2" class="wizard-step hidden space-y-4">
          <!-- Account Selection (conditional based on account type) -->
          <div id="existing-account-fields" class="hidden">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account (Site) <span class="text-red-500">*</span></label>
            <select id="quote-account-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              <option value="">Select an account...</option>
            </select>
          </div>
          <div id="new-account-fields" class="hidden space-y-4">
            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg mb-4">
              <p class="text-sm text-blue-900 dark:text-blue-100 font-medium">New Account Information</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account Name <span class="text-red-500">*</span></label>
              <input type="text" id="new-account-name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Company or Site Name" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address <span class="text-red-500">*</span></label>
              <input type="text" id="new-account-address" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Street Address" required>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City</label>
                <input type="text" id="new-account-city" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="City">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Province/State</label>
                <input type="text" id="new-account-province" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Province/State">
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Postal Code</label>
                <input type="text" id="new-account-postal-code" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="A1A 1A1">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact Phone</label>
                <input type="tel" id="new-account-phone" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="(555) 123-4567">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact Email</label>
              <input type="email" id="new-account-email" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="contact@example.com">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Primary Contact</label>
            <select id="quote-contact-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="">Select a contact...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deal (Optional)</label>
            <select id="quote-deal-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="">Link to a deal...</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quote Type <span class="text-red-500">*</span></label>
            <select id="quote-type-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              <option value="standard" selected>Standard Quote</option>
              <option value="walkthrough_required">Walkthrough Request (Send Welcome Email)</option>
            </select>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Walkthrough Required: Client must complete a site walkthrough before final quote</p>
          </div>
        </div>

        <!-- Step 3: Pricing + Scope (dynamic based on quote type) -->
        <div id="wizard-step-3" class="wizard-step hidden space-y-6">
          <!-- QUOTE ENGINE FORM (Standard Quote Only) -->
          <div id="quote-engine-form-section" class="hidden border border-nfgray dark:border-gray-700 rounded-xl p-6 bg-nfglight dark:bg-gray-700/50 space-y-6">
            <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Quote Calculation</h4>
            
            <!-- Service Type & Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Type <span class="text-red-500">*</span></label>
                <select id="quote-service-type" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                  <option value="">Select service type...</option>
                  <option value="commercial_office">Commercial Office</option>
                  <option value="medical_clinic">Medical Clinic</option>
                  <option value="physio_chiro">Physio/Chiro</option>
                  <option value="dental">Dental</option>
                  <option value="optical">Optical</option>
                  <option value="industrial">Industrial</option>
                  <option value="residential_common_area">Residential Common Area</option>
                  <option value="restaurant">Restaurant</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Square Footage Estimate</label>
                <input type="number" id="quote-sqft-estimate" min="0" step="100" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="1500">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Optional but recommended. Conservative default used if empty.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency (Visits per Month) <span class="text-red-500">*</span></label>
                <input type="number" id="quote-frequency-per-month" min="1" max="20" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="4" value="4" required>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">4 = Weekly, 8 = Twice Weekly, 12 = 3x Weekly</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Urgency (Days Until Start)</label>
                <input type="number" id="quote-urgency-days" min="0" max="30" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="30" value="30">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">0-2 = Urgent (+10%), 3-7 = Moderate (+5%), 8+ = Normal</p>
              </div>
            </div>

            <!-- Touchpoints -->
            <div class="border-t border-nfgray dark:border-gray-700 pt-4">
              <h5 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">Touchpoints</h5>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms" min="0" max="10" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Treatment Rooms</label>
                  <input type="number" id="quote-num-treatment-rooms" min="0" max="20" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reception</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-reception" class="w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kitchen</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-kitchen" class="w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>
            </div>

            <!-- Complexity Factors -->
            <div class="border-t border-nfgray dark:border-gray-700 pt-4">
              <h5 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">Complexity Factors</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Flooring Type</label>
                  <select id="quote-flooring" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                    <option value="mostly_hard" selected>Mostly Hard (Tile/Hardwood)</option>
                    <option value="mixed">Mixed</option>
                    <option value="mostly_carpet">Mostly Carpet</option>
                  </select>
                </div>
                <div class="space-y-3">
                  <label class="flex items-center">
                    <input type="checkbox" id="quote-after-hours" class="mr-2 w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">After Hours Required</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="quote-supplies-included" class="mr-2 w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Supplies Included</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="quote-high-touch-disinfection" class="mr-2 w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">High-Touch Disinfection</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
              <textarea id="quote-notes" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Any special requirements, construction dust, biohazards, etc."></textarea>
            </div>

            <!-- Real-time Quote Calculation Display -->
            <div id="quote-calculation-result" class="hidden border-t border-nfgray dark:border-gray-700 pt-4 mt-4">
              <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-lg p-4 space-y-3">
                <h5 class="font-semibold text-nfgblue dark:text-blue-400">Calculated Quote</h5>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Monthly (ex-HST)</p>
                    <p id="calc-monthly-ex-hst" class="text-xl font-semibold text-gray-900 dark:text-gray-100">$0.00</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Per Visit</p>
                    <p id="calc-per-visit" class="text-xl font-semibold text-gray-900 dark:text-gray-100">$0.00</p>
                  </div>
                </div>
                <div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">HST (13%)</p>
                  <p id="calc-hst" class="text-lg font-semibold text-gray-900 dark:text-gray-100">$0.00</p>
                </div>
                <div class="border-t border-nfgray dark:border-gray-700 pt-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Total (inc-HST)</p>
                  <p id="calc-total" class="text-2xl font-bold text-nfgblue dark:text-blue-400">$0.00</p>
                </div>
                <div id="calc-assumptions" class="text-xs text-gray-500 dark:text-gray-400 mt-2"></div>
                <div id="calc-walkthrough-warning" class="hidden mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-sm text-yellow-800 dark:text-yellow-200">
                  âš ï¸ Walkthrough recommended for accurate pricing
                </div>
              </div>
            </div>
          </div>

          <!-- For Walkthrough Required: Scope Summary Only -->
          <div id="walkthrough-scope-section" class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Booking Date <span class="text-red-500">*</span></label>
                <input type="date" id="quote-walkthrough-booking-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Booking Time <span class="text-red-500">*</span></label>
                <input type="time" id="quote-walkthrough-booking-time" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Schedule Summary <span class="text-red-500">*</span></label>
              <textarea id="quote-service-schedule" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Weekly cleaning on Mondays and Thursdays, 2 hours per visit"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Scope Summary <span class="text-red-500">*</span></label>
              <textarea id="quote-scope-summary" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Describe what services will be included..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assumptions</label>
              <textarea id="quote-assumptions" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Any assumptions about the work..."></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exclusions</label>
              <textarea id="quote-exclusions" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="What is NOT included..."></textarea>
            </div>
            <!-- Optional Range Estimate -->
            <div class="border border-nfgray dark:border-gray-700 rounded-lg p-4 bg-nfglight dark:bg-gray-700/50">
              <label class="flex items-center mb-2">
                <input type="checkbox" id="include-range-estimate" class="mr-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Include Non-Binding Range Estimate</span>
              </label>
              <div id="range-estimate-fields" class="hidden mt-3 grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Low Estimate ($)</label>
                  <input type="number" id="quote-range-low" step="0.01" min="0" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                </div>
                <div>
                  <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">High Estimate ($)</label>
                  <input type="number" id="quote-range-high" step="0.01" min="0" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                </div>
              </div>
            </div>
          </div>

          <!-- For Standard Quote: Line Items Builder -->
          <div id="binding-line-items-section" class="hidden space-y-4">
            <div class="flex justify-between items-center">
              <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Line Items</h4>
              <button type="button" id="add-line-item-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                + Add Line Item
              </button>
            </div>
            <div id="quote-line-items-list" class="space-y-3">
              <!-- Line items will be dynamically added here -->
            </div>
            <div class="border-t border-nfgray dark:border-gray-700 pt-4 mt-4">
              <div class="flex justify-end">
                <div class="text-right">
                  <div class="text-sm text-gray-600 dark:text-gray-400">Subtotal</div>
                  <div id="quote-subtotal" class="text-xl font-semibold text-gray-900 dark:text-gray-100">$0.00</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Tax (13% HST)</div>
                  <div id="quote-tax" class="text-lg text-gray-900 dark:text-gray-100">$0.00</div>
                  <div class="text-lg font-semibold text-nfgblue dark:text-blue-400 mt-2">Total</div>
                  <div id="quote-total" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">$0.00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Terms + Send -->
        <div id="wizard-step-4" class="wizard-step hidden space-y-4">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Billing Frequency</label>
              <select id="quote-billing-frequency" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                <option value="monthly" selected>Monthly</option>
                <option value="weekly">Weekly</option>
                <option value="biweekly">Bi-Weekly</option>
                <option value="one_time">One-Time</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Proposed Start Date</label>
            <input type="date" id="quote-start-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expiry (Days) <span class="text-red-500">*</span></label>
            <input type="number" id="quote-expiry-days" min="1" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="7" value="7" required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Quote will expire after this many days</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Internal Notes (Not shown to client)</label>
            <textarea id="quote-internal-notes" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Internal notes only..."></textarea>
          </div>
        </div>
      </div>

      <!-- Footer with Navigation Buttons -->
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex-shrink-0 flex justify-between items-center">
        <button type="button" id="wizard-cancel-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
          Cancel
        </button>
        <div class="flex gap-3">
          <button type="button" id="wizard-back-btn" class="hidden px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            â† Back
          </button>
          <button type="button" id="wizard-save-draft-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Save Draft
          </button>
          <button type="button" id="wizard-next-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Next â†’
          </button>
          <button type="button" id="wizard-send-btn" class="hidden px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition">
            Create Quote
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quote Send Confirmation Modal -->
  <div id="quote-send-confirmation-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Confirm Quote Creation</h3>
          <button id="close-quote-send-confirmation-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6 space-y-4">
        <div class="bg-nfglight/30 dark:bg-blue-900/20 border border-nfgblue/20 dark:border-blue-800 rounded-xl p-4">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Final Quote Price:</p>
          <div class="flex items-baseline justify-between">
            <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Subtotal:</span>
            <span id="confirmation-subtotal" class="text-lg font-semibold text-gray-900 dark:text-gray-100">$0.00</span>
          </div>
          <div class="flex items-baseline justify-between mt-2">
            <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Tax (13% HST):</span>
            <span id="confirmation-tax" class="text-lg font-semibold text-gray-900 dark:text-gray-100">$0.00</span>
          </div>
          <div class="flex items-baseline justify-between mt-3 pt-3 border-t border-nfgblue/20 dark:border-blue-800">
            <span class="text-xl font-semibold text-nfgblue dark:text-blue-400">Total:</span>
            <span id="confirmation-total" class="text-3xl font-bold text-nfgblue dark:text-blue-400">$0.00</span>
          </div>
        </div>
        
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4">
          <div class="flex items-start gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5"></i>
            <p class="text-sm text-yellow-800 dark:text-yellow-200">
              Please review the final quote price above. This quote will be created and saved.
            </p>
          </div>
        </div>
      </div>
      
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex gap-3 justify-end">
        <button 
          id="cancel-quote-send-btn" 
          class="px-4 py-2 border border-nfgray dark:border-gray-600 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg font-medium transition"
        >
          Cancel
        </button>
        <button 
          id="confirm-quote-send-btn" 
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition"
        >
          Yes, Create Quote
        </button>
      </div>
    </div>
  </div>

  <!-- Quote Detail Modal -->
  <div id="quote-detail-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center">
          <div>
            <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400" id="quote-detail-title">Quote Details</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1" id="quote-detail-subtitle">Loading...</p>
          </div>
          <button id="close-quote-detail-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Content (scrollable) -->
      <div class="flex-1 overflow-y-auto p-6">
        <!-- Walkthrough Status Block (if walkthrough_required) -->
        <div id="quote-walkthrough-block" class="hidden mb-6 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl">
          <h4 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Walkthrough Status</h4>
          <div id="walkthrough-status-content"></div>
          <div id="walkthrough-actions" class="mt-4 flex gap-2"></div>
        </div>

        <!-- Revisions List -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Revisions</h4>
          <div id="quote-revisions-list" class="space-y-4">
            <!-- Revisions will be rendered here -->
          </div>
        </div>

        <!-- Events Timeline -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Timeline</h4>
          <div id="quote-events-timeline" class="space-y-3">
            <!-- Events will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex-shrink-0 flex justify-between items-center">
        <button type="button" id="quote-detail-close-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
          Close
        </button>
        <div id="quote-detail-actions" class="flex gap-3">
          <!-- Action buttons will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Set sales mode flag in sessionStorage
    sessionStorage.setItem('isSalesMode', 'true');
    
    // Initialize environment
    window.ENV = {
      SUPABASE_URL: 'https://zqcbldgheimqrnqmbbed.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxY2JsZGdoZWltcXJucW1iYmVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDM5NjIsImV4cCI6MjA3NjI3OTk2Mn0.UYlnTQeCjNLed6g9oNRLQIXD69OgzRrXupl3LXUvh4I'
    };

    // Import modules
    console.log('[Sales Dashboard] Starting module imports...');
    let supabase, showNotification, toast, hideLoader, initializeUI, sales;
    
    try {
      const supabaseModule = await import('./js/supabase.js');
      supabase = supabaseModule.supabase;
      console.log('[Sales Dashboard] âœ… supabase module loaded');
      
      const notificationsModule = await import('./js/notifications.js');
      toast = notificationsModule.toast;
      showNotification = notificationsModule.showNotification;
      console.log('[Sales Dashboard] âœ… notifications module loaded');
      
      const loaderModule = await import('./js/loader.js');
      hideLoader = loaderModule.hideLoader;
      console.log('[Sales Dashboard] âœ… loader module loaded');
      
      const uiModule = await import('./js/ui.js');
      initializeUI = uiModule.initializeUI;
      console.log('[Sales Dashboard] âœ… ui module loaded');
      
      sales = await import('./js/sales.js');
      console.log('[Sales Dashboard] âœ… sales module loaded');
      
      // Load quotes module
      window.quotesModule = await import('./js/quotes.js');
      console.log('[Sales Dashboard] âœ… quotes module loaded');
      
      // Load quote wizard module
      window.quoteWizard = await import('./js/quote-wizard.js');
      console.log('[Sales Dashboard] âœ… quote wizard module loaded');
      
      // Load quote detail module
      window.quoteDetail = await import('./js/quote-detail.js');
      console.log('[Sales Dashboard] âœ… quote detail module loaded');
      
      // Load accounts directory module
      window.accountsDirectory = await import('./js/accounts-directory.js');
      console.log('[Sales Dashboard] âœ… accounts directory module loaded');
      
      // Load leads directory module
      window.leadsDirectory = await import('./js/leads-directory.js');
      console.log('[Sales Dashboard] âœ… leads directory module loaded');
      
      console.log('[Sales Dashboard] âœ… All modules loaded successfully');
    } catch (error) {
      console.error('[Sales Dashboard] âŒ Error loading modules:', error);
      // Show error immediately if modules can't load
      document.body.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-6 bg-gray-50 dark:bg-gray-900">
          <div class="bg-white dark:bg-gray-800 border border-red-300 dark:border-red-700 rounded-xl p-8 max-w-md text-center shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">Failed to Load</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Could not load required modules. Please check your browser console for details.</p>
            <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-3 rounded mb-4 text-left overflow-auto max-h-32">${error.message}\n${error.stack || ''}</pre>
            <button onclick="window.location.reload()" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
              Reload Page
            </button>
          </div>
        </div>
      `;
      throw error; // Stop execution
    }

    // Tab switching functionality
    function switchTab(targetTabName) {
      const tabs = document.querySelectorAll('.sales-tab');
      const tabContents = document.querySelectorAll('.sales-tab-content');
      const targetTab = Array.from(tabs).find(t => t.dataset.tab === targetTabName);
      
      if (!targetTab) return;
      
      // Update active tab
      tabs.forEach(t => {
        t.classList.remove('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        t.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
      });
      targetTab.classList.add('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
      targetTab.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');
      
      // Show/hide tab content
      tabContents.forEach(content => {
        if (content.id === `tab-${targetTabName}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
      
      // Load data for the active tab
      loadTabData(targetTabName);
    }
    
    // Make switchTab available globally for sidebar links
    window.switchTab = switchTab;
    
    function initTabs() {
      const tabs = document.querySelectorAll('.sales-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          switchTab(tab.dataset.tab);
        });
      });
      
      // Setup sidebar navigation links to switch tabs when on sales.html
      const dashboardLink = document.getElementById('nav-dashboard');
      if (dashboardLink) {
        dashboardLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('dashboard');
          }
        });
      }
      
      const salesLink = document.getElementById('nav-sales');
      if (salesLink) {
        salesLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('dashboard');
          }
        });
      }

      // Setup KPI card click handlers for filtering
      document.querySelectorAll('.kpi-card').forEach(card => {
        card.addEventListener('click', () => {
          const filter = card.dataset.filter;
          applyKPIFilter(filter);
        });
      });

      // Setup create deal button
      const createDealBtn = document.getElementById('create-deal-dashboard-btn');
      if (createDealBtn) {
        createDealBtn.addEventListener('click', () => {
          // Open create deal modal or navigate to deals tab
          if (window.sales && typeof window.sales.openCreateDealModal === 'function') {
            window.sales.openCreateDealModal();
          } else {
            switchTab('deals');
            // Trigger create deal button in deals tab
            setTimeout(() => {
              const dealsCreateBtn = document.getElementById('create-deal-btn');
              if (dealsCreateBtn) dealsCreateBtn.click();
            }, 100);
          }
        });
      }
    }

    // Apply KPI filter
    function applyKPIFilter(filter) {
      const tbody = document.getElementById('deals-table-body');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('.deal-row');
      const now = new Date();
      const sevenDaysFromNow = new Date(now);
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

      rows.forEach(row => {
        let show = true;
        const dealId = row.dataset.dealId;
        
        // This is a simplified filter - you may need to fetch deal data to filter properly
        switch(filter) {
          case 'open-pipeline':
            show = true; // All deals are open pipeline
            break;
          case 'today':
            // Filter deals with activity today
            show = true; // Simplified - would need to check last_contacted_at
            break;
          case 'next-7-days':
            // Filter deals at risk in next 7 days
            show = true; // Simplified - would need to check next_action_date
            break;
          case 'urgent':
            // Filter urgent deals (uncontacted, expiring quotes, idle)
            show = true; // Simplified
            break;
          default:
            show = true;
        }

        row.style.display = show ? '' : 'none';
      });
    }
    
    // Load data for specific tab
    async function loadTabData(tabName) {
      try {
        switch(tabName) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'deals':
            // Load deals and render kanban board
            const dealsData = await loadDealsForDashboard();
            renderDealsKanban(dealsData);
            if (sales && typeof sales.loadDeals === 'function') {
              await sales.loadDeals();
            }
            break;
          case 'quotes':
            await loadQuotes();
            break;
          case 'leads':
            // Initialize leads directory on first load
            if (window.leadsDirectory && typeof window.leadsDirectory.init === 'function') {
              await window.leadsDirectory.init();
            } else {
              await loadLeads();
            }
            break;
          case 'contacts':
            // Initialize accounts directory on first load
            if (window.accountsDirectory && typeof window.accountsDirectory.init === 'function') {
              await window.accountsDirectory.init();
            } else {
              await loadContacts();
            }
            break;
          case 'calls':
            await loadCalls();
            break;
          case 'sequences':
            await loadSequences();
            break;
        }
      } catch (error) {
        console.error(`Error loading ${tabName} data:`, error);
        toast.error(`Failed to load ${tabName}`, 'Error');
      }
    }
    
    // Load functions for each tab
    async function loadDashboardData() {
      try {
        console.log('[Dashboard] Loading dashboard data...');
        
        // Load all data in parallel
        const [dealsData, quotesData, callsData, leadsData] = await Promise.all([
          loadDealsForDashboard(),
          loadQuotesForDashboard(),
          loadCallsForDashboard(),
          loadLeadsForDashboard()
        ]);

        // Calculate and render KPIs
        calculateAndRenderKPIs(dealsData, quotesData, callsData, leadsData);

        // Generate and render priority actions
        generatePriorityActions(dealsData, quotesData, leadsData);

        // Render active deals table
        renderActiveDealsTable(dealsData);
        renderDealsKanban(dealsData);

        // Render pipeline stage snapshot
        renderPipelineSnapshot(dealsData);

        // Render quotes watch
        renderQuotesWatch(quotesData);

        // Render walkthroughs today
        renderWalkthroughsToday(dealsData);

        console.log('[Dashboard] âœ… Dashboard data loaded');
      } catch (error) {
        console.error('[Dashboard] Error loading dashboard data:', error);
        toast.error('Failed to load dashboard data', 'Error');
      }
    }

    // Helper functions to load data
    // Expose to window for quote wizard to refresh deals
    window.loadDealsForDashboard = async function loadDealsForDashboard() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return [];

        // Load all deals including closed ones for kanban board
        // Don't use relationship syntax to avoid FK errors - load contact data separately if needed
        let query = supabase
          .from('deals')
          .select('*')
          .order('updated_at', { ascending: false });

        // Filter by assigned user if rep
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        if (profile && profile.role === 'rep') {
          query = query.or(`assigned_to.eq.${user.id},assigned_user_id.eq.${user.id}`);
        }

        const { data, error } = await query;
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading deals:', error);
        return [];
      }
    }

    async function loadQuotesForDashboard() {
      try {
        const { data, error } = await supabase
          .from('quotes')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading quotes:', error);
        return [];
      }
    }

    async function loadCallsForDashboard() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const { data, error } = await supabase
          .from('calls')
          .select('*')
          .gte('created_at', today.toISOString());
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading calls:', error);
        return [];
      }
    }

    async function loadLeadsForDashboard() {
      try {
        const { data, error } = await supabase
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading leads:', error);
        return [];
      }
    }

    // Calculate and render KPIs
    function calculateAndRenderKPIs(deals, quotes, calls, leads) {
      // Open Pipeline
      const openDeals = deals.filter(d => ['prospecting', 'qualification', 'proposal', 'negotiation'].includes(d.stage));
      const totalOpen = openDeals.reduce((sum, d) => sum + (Number(d.deal_value) || 0), 0);
      const weightedOpen = openDeals.reduce((sum, d) => {
        const stageWeights = { prospecting: 0.1, qualification: 0.3, proposal: 0.7, negotiation: 0.9 };
        return sum + (Number(d.deal_value) || 0) * (stageWeights[d.stage] || 0.5);
      }, 0);

      document.getElementById('kpi-total-open').textContent = `$${totalOpen.toLocaleString()}`;
      document.getElementById('kpi-weighted-open').textContent = `Weighted: $${Math.round(weightedOpen).toLocaleString()}`;

      // Today metrics
      const today = new Date().toISOString().split('T')[0];
      const todayCalls = calls.length;
      const todayQuotes = quotes.filter(q => q.created_at?.startsWith(today)).length;
      const todayClosed = deals.filter(d => d.stage === 'closed_won' && d.updated_at?.startsWith(today)).length;
      const todayWalkthroughs = deals.filter(d => {
        // Check if deal has walkthrough scheduled for today
        // This is a placeholder - adjust based on your schema
        return false; // TODO: Implement based on actual walkthrough data
      }).length;

      document.getElementById('kpi-today-calls').textContent = todayCalls;
      document.getElementById('kpi-today-quotes').textContent = todayQuotes;
      document.getElementById('kpi-today-closed').textContent = todayClosed;
      document.getElementById('kpi-today-walkthroughs').textContent = todayWalkthroughs;

      // Next 7 days at risk
      const sevenDaysFromNow = new Date();
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
      const atRisk = deals.filter(d => {
        if (!d.next_action_date) return false;
        const nextAction = new Date(d.next_action_date);
        return nextAction <= sevenDaysFromNow && nextAction >= new Date();
      }).length;

      document.getElementById('kpi-at-risk').textContent = atRisk;

      // Urgent metrics
      const uncontactedLeads = leads.filter(l => !l.last_contacted_at).length;
      const quotesExpiring = quotes.filter(q => {
        if (!q.expiry_date) return false;
        const expiry = new Date(q.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        return hoursUntilExpiry < 48 && hoursUntilExpiry > 0;
      }).length;
      const idleDeals = deals.filter(d => {
        if (!d.last_contacted_at) return true;
        const lastContact = new Date(d.last_contacted_at);
        const daysSinceContact = (new Date() - lastContact) / (1000 * 60 * 60 * 24);
        return daysSinceContact > 7;
      }).length;

      document.getElementById('kpi-uncontacted').textContent = uncontactedLeads;
      document.getElementById('kpi-quotes-expiring').textContent = quotesExpiring;
      document.getElementById('kpi-idle-deals').textContent = idleDeals;
    }

    // Generate priority actions
    function generatePriorityActions(deals, quotes, leads) {
      const actions = [];

      // Quotes expiring soon
      quotes.forEach(q => {
        if (!q.expiry_date) return;
        const expiry = new Date(q.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        if (hoursUntilExpiry < 48 && hoursUntilExpiry > 0) {
          actions.push({
            type: 'quote_expiring',
            priority: hoursUntilExpiry,
            company: q.company_name || 'Unknown',
            dealValue: q.quote_value || 0,
            reason: `Quote expiring in ${Math.round(hoursUntilExpiry)}h`,
            lastActivity: q.created_at,
            dealId: q.deal_id,
            quoteId: q.id
          });
        }
      });

      // Missed callbacks
      deals.forEach(d => {
        if (d.next_action_date && d.next_action_type === 'callback') {
          const nextAction = new Date(d.next_action_date);
          if (nextAction < new Date()) {
            actions.push({
              type: 'missed_callback',
              priority: (new Date() - nextAction) / (1000 * 60 * 60), // hours overdue
              company: d.company_name || d.title || 'Unknown',
              dealValue: d.deal_value || 0,
              reason: 'Missed callback',
              lastActivity: d.last_contacted_at || d.updated_at,
              dealId: d.id
            });
          }
        }
      });

      // Walkthroughs today
      deals.forEach(d => {
        if (d.next_action_date && d.next_action_type === 'walkthrough') {
          const nextAction = new Date(d.next_action_date);
          const today = new Date();
          if (nextAction.toDateString() === today.toDateString()) {
            actions.push({
              type: 'walkthrough_today',
              priority: nextAction.getHours() * 60 + nextAction.getMinutes(), // minutes from midnight
              company: d.company_name || d.title || 'Unknown',
              dealValue: d.deal_value || 0,
              reason: `Walkthrough at ${nextAction.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`,
              lastActivity: d.last_contacted_at || d.updated_at,
              dealId: d.id,
              walkthroughTime: nextAction
            });
          }
        }
      });

      // Uncontacted leads
      leads.forEach(l => {
        if (!l.last_contacted_at) {
          const hoursSinceCreated = (new Date() - new Date(l.created_at)) / (1000 * 60 * 60);
          if (hoursSinceCreated > 2) {
            actions.push({
              type: 'uncontacted_lead',
              priority: hoursSinceCreated,
              company: l.company_name || l.name || 'Unknown',
              dealValue: 0,
              reason: `New inbound lead untouched for ${Math.round(hoursSinceCreated)}h`,
              lastActivity: l.created_at,
              leadId: l.id
            });
          }
        }
      });

      // Sort by priority (lower number = higher priority)
      actions.sort((a, b) => a.priority - b.priority);

      // Render actions
      const actionsList = document.getElementById('priority-actions-list');
      if (!actionsList) return;

      if (actions.length === 0) {
        actionsList.innerHTML = `
          <div class="p-6 text-center text-gray-500 dark:text-gray-400">
            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 text-green-500"></i>
            <p>No priority actions at this time</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }

      actionsList.innerHTML = actions.slice(0, 10).map(action => `
        <div class="p-4 hover:bg-nfglight dark:hover:bg-gray-700 transition">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-nfgblue dark:text-blue-400">${action.company}</span>
                <span class="text-sm text-gray-600 dark:text-gray-400">$${Number(action.dealValue).toLocaleString()}</span>
              </div>
              <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">${action.reason}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Last activity: ${action.lastActivity ? new Date(action.lastActivity).toLocaleString() : 'Never'}</p>
            </div>
            <div class="flex gap-2 ml-4">
              ${action.dealId ? `
                <button onclick="window.openDeal('${action.dealId}')" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium transition">
                  Open Deal
                </button>
              ` : ''}
              ${action.leadId ? `
                <button onclick="window.openLead('${action.leadId}')" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium transition">
                  Open Lead
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Render deals in kanban board
    // Expose to window for quote wizard to refresh deals
    window.renderDealsKanban = function renderDealsKanban(deals) {
      // Store deals globally for view switching
      globalDealsData = deals;
      
      const kanbanBoard = document.getElementById('deals-kanban');
      if (!kanbanBoard) return;

      const stages = ['prospecting', 'qualification', 'proposal', 'negotiation', 'closed_won', 'closed_lost'];
      
      // Clear all columns
      stages.forEach(stage => {
        const column = kanbanBoard.querySelector(`.kanban-deals[data-stage="${stage}"]`);
        const countEl = kanbanBoard.querySelector(`.kanban-column[data-stage="${stage}"] .kanban-count`);
        if (column) column.innerHTML = '';
        if (countEl) countEl.textContent = '0';
      });

      if (deals.length === 0) {
        return;
      }

      // Group deals by stage
      const dealsByStage = {};
      stages.forEach(stage => {
        dealsByStage[stage] = deals.filter(d => d.stage === stage);
      });

      // Render deals in each column
      stages.forEach(stage => {
        const column = kanbanBoard.querySelector(`.kanban-deals[data-stage="${stage}"]`);
        const countEl = kanbanBoard.querySelector(`.kanban-column[data-stage="${stage}"] .kanban-count`);
        const stageDeals = dealsByStage[stage] || [];

        if (countEl) countEl.textContent = stageDeals.length;

        if (column) {
          column.innerHTML = stageDeals.map(deal => {
            const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
            const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
            const isIdle = daysIdle && daysIdle > 7;
            const contactName = deal.contact?.full_name || deal.contact?.email || 'No contact';
            const dealValue = Number(deal.deal_value || 0);
            
            // Determine status and priority
            let statusTag = '';
            let statusColorClass = 'bg-purple-400';
            if (stage === 'prospecting') {
              statusTag = 'Not Started';
              statusColorClass = 'bg-purple-400';
            } else if (stage === 'qualification') {
              statusTag = 'In Research';
              statusColorClass = 'bg-yellow-400';
            } else if (stage === 'proposal') {
              statusTag = 'On Track';
              statusColorClass = 'bg-pink-400';
            } else if (stage === 'negotiation') {
              statusTag = 'On Track';
              statusColorClass = 'bg-pink-400';
            } else if (stage === 'closed_won') {
              statusTag = 'Complete';
              statusColorClass = 'bg-green-400';
            } else {
              statusTag = 'Not Started';
              statusColorClass = 'bg-purple-400';
            }
            
            // Determine priority based on deal value and stage
            let priority = 'Low';
            let priorityBgClass = 'bg-purple-100';
            let priorityTextClass = 'text-purple-700';
            let priorityDarkBgClass = 'dark:bg-purple-900/30';
            let priorityDarkTextClass = 'dark:text-purple-300';
            if (dealValue >= 10000) {
              priority = 'High';
              priorityBgClass = 'bg-red-100';
              priorityTextClass = 'text-red-700';
              priorityDarkBgClass = 'dark:bg-red-900/30';
              priorityDarkTextClass = 'dark:text-red-300';
            } else if (dealValue >= 5000) {
              priority = 'Medium';
              priorityBgClass = 'bg-orange-100';
              priorityTextClass = 'text-orange-700';
              priorityDarkBgClass = 'dark:bg-orange-900/30';
              priorityDarkTextClass = 'dark:text-orange-300';
            }
            
            // Format due date or last contact
            let dateText = '';
            if (deal.expected_close_date) {
              const closeDate = new Date(deal.expected_close_date);
              const today = new Date();
              const daysUntil = Math.ceil((closeDate - today) / (1000 * 60 * 60 * 24));
              if (daysUntil < 0) {
                dateText = 'Overdue';
              } else if (daysUntil === 0) {
                dateText = 'Today';
              } else if (daysUntil <= 7) {
                dateText = closeDate.toLocaleDateString('en-CA', { day: 'numeric', month: 'short', year: 'numeric' });
              } else {
                dateText = closeDate.toLocaleDateString('en-CA', { day: 'numeric', month: 'short', year: 'numeric' });
              }
            } else if (lastContact) {
              dateText = daysIdle !== null ? daysIdle + 'd ago' : 'Recently';
            }
            
            // Get assignee initials (placeholder for now)
            const assigneeInitials = contactName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || 'NF';
            
            // Count comments and links (placeholder - would need to fetch from related tables)
            const commentCount = 0; // deal.comments?.length || 0;
            const linkCount = 0; // deal.links?.length || 0;
            
            return `
              <div 
                class="deal-card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm hover:shadow-md transition cursor-move ${isIdle ? 'border-red-300 dark:border-red-700' : ''}" 
                data-deal-id="${deal.id}"
                draggable="true"
              >
                <!-- Status Tag -->
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full ${statusColorClass}"></span>
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400">${statusTag}</span>
                  </div>
                </div>
                
                <!-- Deal Title -->
                <h4 class="font-semibold text-gray-900 dark:text-white text-sm mb-2 line-clamp-2">${deal.name || deal.company_name || deal.title || 'Unnamed Deal'}</h4>
                
                <!-- Description -->
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3 line-clamp-2">${contactName}</p>
                
                <!-- Assignees and Due Date -->
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center -space-x-2">
                    <div class="w-6 h-6 rounded-full bg-nfgblue text-white text-xs flex items-center justify-center font-medium border-2 border-white dark:border-gray-800">
                      ${assigneeInitials}
                    </div>
                  </div>
                  ${dateText ? `<span class="text-xs text-gray-500 dark:text-gray-400">${dateText}</span>` : ''}
                </div>
                
                <!-- Priority and Value -->
                <div class="flex items-center justify-between mb-3">
                  <span class="px-2 py-0.5 rounded text-xs font-medium ${priorityBgClass} ${priorityTextClass} ${priorityDarkBgClass} ${priorityDarkTextClass}">${priority}</span>
                  <span class="text-sm font-semibold text-gray-900 dark:text-white">$${dealValue.toLocaleString()}</span>
                </div>
                
                <!-- Metadata (Comments, Links, Progress) -->
                <div class="flex items-center gap-4 pt-2 border-t border-gray-100 dark:border-gray-700">
                  <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
                    <i data-lucide="message-circle" class="w-3 h-3"></i>
                    <span>${commentCount}</span>
                  </div>
                  <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
                    <i data-lucide="link" class="w-3 h-3"></i>
                    <span>${linkCount}</span>
                  </div>
                  ${isIdle ? '<span class="ml-auto text-xs text-red-600 dark:text-red-400 font-medium">Idle</span>' : ''}
                </div>
              </div>
            `;
          }).join('');

          // Add drag and drop event listeners
          column.querySelectorAll('.deal-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('click', async (e) => {
              // Don't trigger if clicking on a button or interactive element
              if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                return;
              }
              
              e.preventDefault();
              e.stopPropagation();
              
              const dealId = card.dataset.dealId;
              console.log('[Sales] Deal card clicked, dealId:', dealId);
              console.log('[Sales] window.sales available:', !!window.sales);
              console.log('[Sales] openDealDetail function available:', !!(window.sales && typeof window.sales.openDealDetail === 'function'));
              
              if (window.sales && typeof window.sales.openDealDetail === 'function') {
                console.log('[Sales] Calling window.sales.openDealDetail');
                await window.sales.openDealDetail(dealId);
              } else if (window.openDeal) {
                console.log('[Sales] Falling back to window.openDeal');
                await window.openDeal(dealId);
              } else {
                console.error('[Sales] Deal detail function not available');
                console.error('[Sales] window.sales:', window.sales);
                toast.error('Unable to open deal details. Check console for details.', 'Error');
              }
            });
          });

          // Add drop zone listeners
          column.addEventListener('dragover', handleDragOver);
          column.addEventListener('drop', handleDrop);
          column.addEventListener('dragenter', handleDragEnter);
          column.addEventListener('dragleave', handleDragLeave);
        }
      });
      
      // Initialize icons after rendering
      if (window.lucide) {
        lucide.createIcons();
      }
    }
    
    // Store deals data globally for all views
    let globalDealsData = [];

    // View option handlers
    function initViewOptions() {
      document.querySelectorAll('.view-option').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const view = e.currentTarget.dataset.view;
          
          // Update active button
          document.querySelectorAll('.view-option').forEach(b => {
            b.classList.remove('active');
            b.classList.remove('bg-white', 'dark:bg-gray-700');
            b.classList.add('text-gray-600', 'dark:text-gray-400');
            b.classList.remove('text-nfgblue', 'dark:text-blue-400');
          });
          e.currentTarget.classList.add('active');
          e.currentTarget.classList.add('bg-white', 'dark:bg-gray-700');
          e.currentTarget.classList.remove('text-gray-600', 'dark:text-gray-400');
          e.currentTarget.classList.add('text-nfgblue', 'dark:text-blue-400');
          
          // Switch views
          switchDealsView(view);
        });
      });
    }

    // Switch between deals views
    function switchDealsView(view) {
      // Hide all views
      document.querySelectorAll('.deals-view').forEach(v => v.classList.add('hidden'));
      
      // Show selected view
      let viewElement = null;
      switch(view) {
        case 'overview':
          viewElement = document.getElementById('deals-overview-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsOverview(globalDealsData);
          }
          break;
        case 'board':
          viewElement = document.getElementById('deals-board-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsKanban(globalDealsData);
          }
          break;
        case 'list':
          viewElement = document.getElementById('deals-list-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsList(globalDealsData);
          }
          break;
        case 'table':
          viewElement = document.getElementById('deals-table-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsTable(globalDealsData);
          }
          break;
      }
      
      if (viewElement) {
        viewElement.classList.remove('hidden');
      }
    }

    // Render deals overview (dashboard-style)
    function renderDealsOverview(deals) {
      const container = document.getElementById('deals-overview-content');
      if (!container) return;

      const stages = ['prospecting', 'qualification', 'proposal', 'negotiation', 'closed_won', 'closed_lost'];
      const stageLabels = {
        prospecting: 'Prospecting',
        qualification: 'Qualification',
        proposal: 'Proposal',
        negotiation: 'Negotiation',
        closed_won: 'Closed Won',
        closed_lost: 'Closed Lost'
      };

      // Calculate totals
      const totalDeals = deals.length;
      const totalValue = deals.reduce((sum, d) => sum + (Number(d.deal_value) || 0), 0);
      const openDeals = deals.filter(d => !d.stage?.includes('closed')).length;
      const wonDeals = deals.filter(d => d.stage === 'closed_won').length;
      const winRate = totalDeals > 0 ? ((wonDeals / (wonDeals + deals.filter(d => d.stage === 'closed_lost').length)) * 100).toFixed(1) : 0;

      // Group by stage
      const dealsByStage = {};
      stages.forEach(stage => {
        dealsByStage[stage] = deals.filter(d => d.stage === stage);
      });

      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Deals</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">${totalDeals}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Value</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">$${totalValue.toLocaleString()}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Open Deals</div>
            <div class="text-2xl font-bold text-nfgblue dark:text-blue-400">${openDeals}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Win Rate</div>
            <div class="text-2xl font-bold text-green-600 dark:text-green-400">${winRate}%</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          ${stages.map(stage => {
            const stageDeals = dealsByStage[stage] || [];
            const stageValue = stageDeals.reduce((sum, d) => sum + (Number(d.deal_value) || 0), 0);
            return `
              <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-gray-700 dark:text-gray-300">${stageLabels[stage]}</h3>
                  <span class="text-sm text-gray-500 dark:text-gray-400">${stageDeals.length}</span>
                </div>
                <div class="text-2xl font-bold text-nfgblue dark:text-blue-400 mb-2">$${stageValue.toLocaleString()}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${stageDeals.length} deal${stageDeals.length !== 1 ? 's' : ''}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      if (window.lucide) lucide.createIcons();
    }

    // Render deals list view
    function renderDealsList(deals) {
      const container = document.getElementById('deals-list-content');
      if (!container) return;

      if (deals.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
            <i data-lucide="briefcase" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">No deals found</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }

      container.innerHTML = deals.map(deal => {
        const contactName = deal.contact?.full_name || deal.contact?.email || 'No contact';
        const dealValue = Number(deal.deal_value || 0);
        const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
        const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
        const isIdle = daysIdle && daysIdle > 7;
        
        // Determine priority
        let priority = 'Low';
        let priorityClass = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300';
        if (dealValue >= 10000) {
          priority = 'High';
          priorityClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
        } else if (dealValue >= 5000) {
          priority = 'Medium';
          priorityClass = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
        }

        // Format stage
        const stageLabels = {
          prospecting: 'Prospecting',
          qualification: 'Qualification',
          proposal: 'Proposal',
          negotiation: 'Negotiation',
          closed_won: 'Closed Won',
          closed_lost: 'Closed Lost'
        };
        const stageLabel = stageLabels[deal.stage] || deal.stage || 'Unknown';

        return `
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 hover:shadow-md transition cursor-pointer" onclick="if (window.openDeal) window.openDeal('${deal.id}')">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h4 class="font-semibold text-gray-900 dark:text-white">${deal.company_name || deal.title || 'Unnamed Deal'}</h4>
                  <span class="px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${priority}</span>
                  ${isIdle ? '<span class="text-xs text-red-600 dark:text-red-400 font-medium">Idle</span>' : ''}
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">${contactName}</p>
                <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
                  <span>Stage: ${stageLabel}</span>
                  <span>Value: $${dealValue.toLocaleString()}</span>
                  ${lastContact ? `<span>Last contact: ${daysIdle !== null ? daysIdle + 'd ago' : 'Recently'}</span>` : ''}
                </div>
              </div>
              <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Render deals table view
    function renderDealsTable(deals) {
      const tbody = document.getElementById('deals-table-content');
      if (!tbody) return;

      if (deals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              No deals found
            </td>
          </tr>
        `;
        return;
      }

      const stageLabels = {
        prospecting: 'Prospecting',
        qualification: 'Qualification',
        proposal: 'Proposal',
        negotiation: 'Negotiation',
        closed_won: 'Closed Won',
        closed_lost: 'Closed Lost'
      };

      tbody.innerHTML = deals.map(deal => {
        const contactName = deal.contact?.full_name || deal.contact?.email || 'No contact';
        const dealValue = Number(deal.deal_value || 0);
        
        // Determine priority
        let priority = 'Low';
        let priorityClass = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300';
        if (dealValue >= 10000) {
          priority = 'High';
          priorityClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
        } else if (dealValue >= 5000) {
          priority = 'Medium';
          priorityClass = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
        }

        const stageLabel = stageLabels[deal.stage] || deal.stage || 'Unknown';
        const dueDate = deal.expected_close_date ? new Date(deal.expected_close_date).toLocaleDateString('en-CA') : '-';

        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" onclick="if (window.openDeal) window.openDeal('${deal.id}')">
            <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">${deal.company_name || deal.title || 'Unnamed Deal'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${contactName}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${stageLabel}</td>
            <td class="px-4 py-3 text-sm font-semibold text-gray-900 dark:text-white">$${dealValue.toLocaleString()}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${priority}</span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${dueDate}</td>
            <td class="px-4 py-3 text-sm">
              <button class="text-nfgblue dark:text-blue-400 hover:text-nfgdark dark:hover:text-blue-300">
                <i data-lucide="eye" class="w-4 h-4"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Drag and drop handlers
    let draggedDeal = null;

    function handleDragStart(e) {
      draggedDeal = e.target;
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.outerHTML);
    }

    function handleDragEnd(e) {
      e.target.style.opacity = '1';
      document.querySelectorAll('.kanban-deals').forEach(col => {
        col.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      e.currentTarget.classList.remove('drag-over');

      if (draggedDeal) {
        const dealId = draggedDeal.dataset.dealId;
        const newStage = e.currentTarget.dataset.stage;

        if (newStage) {
          await updateDealStageAndConvert(dealId, newStage);
        }
      }

      return false;
    }

    // Render active deals table (kept for backward compatibility)
    function renderActiveDealsTable(deals) {
      const tbody = document.getElementById('deals-table-body');
      if (!tbody) return;

      if (deals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              No active deals
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = deals.map(deal => {
        const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
        const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
        const isIdle = daysIdle && daysIdle > 7;

        return `
          <tr class="deal-row ${isIdle ? 'bg-red-50 dark:bg-red-900/20' : 'hover:bg-nfglight dark:hover:bg-gray-700'} cursor-pointer transition" data-deal-id="${deal.id}">
            <td class="px-4 py-3 text-sm font-medium text-nfgblue dark:text-blue-400">${deal.company_name || deal.title || 'Unknown'}</td>
            <td class="px-4 py-3">
              <select class="text-sm border border-nfgray dark:border-gray-600 rounded-lg px-2 py-1 bg-white dark:bg-gray-800 text-nftext dark:text-gray-200" onchange="updateDealStage('${deal.id}', this.value)" value="${deal.stage || 'prospecting'}">
                <option value="prospecting" ${deal.stage === 'prospecting' ? 'selected' : ''}>Prospecting</option>
                <option value="qualification" ${deal.stage === 'qualification' ? 'selected' : ''}>Qualification</option>
                <option value="proposal" ${deal.stage === 'proposal' ? 'selected' : ''}>Proposal</option>
                <option value="negotiation" ${deal.stage === 'negotiation' ? 'selected' : ''}>Negotiation</option>
                <option value="closed_won" ${deal.stage === 'closed_won' ? 'selected' : ''}>Closed Won</option>
                <option value="closed_lost" ${deal.stage === 'closed_lost' ? 'selected' : ''}>Closed Lost</option>
              </select>
            </td>
            <td class="px-4 py-3 text-sm font-semibold">$${Number(deal.deal_value || 0).toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${lastContact ? lastContact.toLocaleDateString() : 'Never'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${deal.next_action_type || 'None'}</td>
            <td class="px-4 py-3 text-sm ${isIdle ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-600 dark:text-gray-400'}">${daysIdle !== null ? daysIdle : 'N/A'}</td>
          </tr>
        `;
      }).join('');

      // Add click handlers to rows
      tbody.querySelectorAll('.deal-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.tagName !== 'SELECT') {
            const dealId = row.dataset.dealId;
            window.openDeal(dealId);
          }
        });
      });
    }

    // Render pipeline stage snapshot
    function renderPipelineSnapshot(deals) {
      const stages = [
        { key: 'prospecting', label: 'Prospecting' },
        { key: 'qualification', label: 'Qualification' },
        { key: 'proposal', label: 'Proposal' },
        { key: 'negotiation', label: 'Negotiation' },
        { key: 'closed_won', label: 'Closed Won' },
        { key: 'closed_lost', label: 'Closed Lost' }
      ];

      const snapshot = document.getElementById('pipeline-snapshot');
      if (!snapshot) return;

      snapshot.innerHTML = stages.map(stage => {
        const stageDeals = deals.filter(d => d.stage === stage.key);
        const totalValue = stageDeals.reduce((sum, d) => sum + (Number(d.deal_value) || 0), 0);
        const avgDays = stageDeals.length > 0 
          ? Math.round(stageDeals.reduce((sum, d) => {
              const created = new Date(d.created_at);
              const days = (new Date() - created) / (1000 * 60 * 60 * 24);
              return sum + days;
            }, 0) / stageDeals.length)
          : 0;

        return `
          <div class="pipeline-stage-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:shadow-lg transition" data-stage="${stage.key}">
            <div class="text-center">
              <p class="text-2xl font-bold text-nfgblue dark:text-blue-400">${stageDeals.length}</p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">${stage.label}</p>
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">$${totalValue.toLocaleString()}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Avg: ${avgDays}d</p>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers to filter table
      snapshot.querySelectorAll('.pipeline-stage-card').forEach(card => {
        card.addEventListener('click', () => {
          const stage = card.dataset.stage;
          filterDealsTableByStage(stage);
        });
      });
    }

    // Render quotes watch
    function renderQuotesWatch(quotes) {
      const watchList = document.getElementById('quotes-watch-list');
      if (!watchList) return;

      // Sort by expiry date (soonest first)
      const sortedQuotes = quotes
        .filter(q => q.expiry_date)
        .sort((a, b) => new Date(a.expiry_date) - new Date(b.expiry_date))
        .slice(0, 10);

      if (sortedQuotes.length === 0) {
        watchList.innerHTML = `
          <div class="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">
            No quotes to watch
          </div>
        `;
        return;
      }

      watchList.innerHTML = sortedQuotes.map(quote => {
        const expiry = new Date(quote.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        const isExpiringSoon = hoursUntilExpiry < 48;

        return `
          <div class="p-3 hover:bg-nfglight dark:hover:bg-gray-700 transition">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-nfgblue dark:text-blue-400">${quote.company_name || 'Unknown'}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">$${Number(quote.quote_value || 0).toLocaleString()}</p>
              </div>
              <div class="text-right">
                <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(quote.created_at).toLocaleDateString()}</p>
                <p class="text-xs ${isExpiringSoon ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-500 dark:text-gray-400'}">
                  ${hoursUntilExpiry > 0 ? `${Math.round(hoursUntilExpiry)}h left` : 'Expired'}
                </p>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render walkthroughs today
    function renderWalkthroughsToday(deals) {
      const walkthroughsList = document.getElementById('walkthroughs-list');
      if (!walkthroughsList) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);

      const walkthroughs = deals
        .filter(d => d.next_action_type === 'walkthrough' && d.next_action_date)
        .filter(d => {
          const actionDate = new Date(d.next_action_date);
          return actionDate >= today && actionDate < tomorrow;
        })
        .sort((a, b) => new Date(a.next_action_date) - new Date(b.next_action_date));

      if (walkthroughs.length === 0) {
        walkthroughsList.innerHTML = `
          <div class="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">
            No walkthroughs scheduled for today
          </div>
        `;
        return;
      }

      walkthroughsList.innerHTML = walkthroughs.map(deal => {
        const walkthroughTime = new Date(deal.next_action_date);
        return `
          <div class="p-3 hover:bg-nfglight dark:hover:bg-gray-700 transition">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-nfgblue dark:text-blue-400">${deal.company_name || deal.title || 'Unknown'}</p>
                <p class="text-xs text-gray-600 dark:text-gray-400">${walkthroughTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">Scheduled</span>
                <button class="px-2 py-1 bg-nfgblue hover:bg-nfgdark text-white rounded text-xs font-medium transition">
                  Outcome
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Helper functions
    function filterDealsTableByStage(stage) {
      const rows = document.querySelectorAll('#deals-table-body .deal-row');
      rows.forEach(row => {
        const rowStage = row.querySelector('select')?.value;
        if (stage === 'all' || rowStage === stage) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    // Make functions available globally
    window.openDeal = async (dealId) => {
      if (window.sales && typeof window.sales.openDealDetail === 'function') {
        await window.sales.openDealDetail(dealId);
      } else {
        console.error('[Sales] openDealDetail function not available');
        toast.error('Unable to open deal details', 'Error');
      }
    };

    window.openLead = (leadId) => {
      // TODO: Implement lead detail page
      console.log('Open lead:', leadId);
    };

    // Update deal stage and convert to site if closed_won
    async function updateDealStageAndConvert(dealId, newStage) {
      try {
        // Get current deal to check if it's moving to closed_won
        const { data: currentDeal } = await supabase
          .from('deals')
          .select('*')
          .eq('id', dealId)
          .single();

        if (!currentDeal) {
          throw new Error('Deal not found');
        }

        const wasClosedWon = currentDeal.stage === 'closed_won';
        const isMovingToClosedWon = newStage === 'closed_won';

        // Update deal stage (fix: use 'stage' not 'status')
        const { error: updateError } = await supabase
          .from('deals')
          .update({ 
            stage: newStage, 
            updated_at: new Date().toISOString(),
            last_touch_at: new Date().toISOString()
          })
          .eq('id', dealId);
        
        if (updateError) throw updateError;

        // If moving to closed_won and wasn't already closed_won, convert to site
        if (isMovingToClosedWon && !wasClosedWon) {
          await convertDealToSite(dealId, currentDeal);
        }

        toast.success('Deal stage updated', 'Success');
        await loadDashboardData();
      } catch (error) {
        console.error('Error updating deal stage:', error);
        toast.error('Failed to update deal stage', 'Error');
      }
    }

    // Convert closed deal to site
    async function convertDealToSite(dealId, deal) {
      try {
        // Check if site already exists for this deal
        const { data: existingSite } = await supabase
          .from('sites')
          .select('id')
          .eq('deal_id', dealId)
          .maybeSingle();

        if (existingSite) {
          console.log('[Deal Conversion] Site already exists for this deal');
          return existingSite;
        }

        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get contact information
        let contactName = null;
        let contactPhone = null;
        let contactEmail = null;
        let address = null;

        if (deal.contact_id) {
          const { data: contact } = await supabase
            .from('contacts')
            .select('full_name, phone, email, address')
            .eq('id', deal.contact_id)
            .single();

          if (contact) {
            contactName = contact.full_name;
            contactPhone = contact.phone;
            contactEmail = contact.email;
            address = contact.address;
          }
        }

        // Create site from deal
        const siteData = {
          name: deal.company_name || deal.title || 'New Site',
          address: address || deal.address || 'Address TBD',
          contact_phone: contactPhone || deal.contact_phone || null,
          contact_email: contactEmail || deal.contact_email || null,
          deal_value: deal.deal_value || null,
          status: 'Active',
          notes: deal.notes || null,
          created_by: user.id
        };

        // Add deal_id if column exists (optional)
        // Note: You may need to run: ALTER TABLE sites ADD COLUMN IF NOT EXISTS deal_id UUID REFERENCES deals(id);

        const { data: newSite, error: siteError } = await supabase
          .from('sites')
          .insert(siteData)
          .select()
          .single();

        if (siteError) throw siteError;

        toast.success(`Deal converted to site: ${newSite.name}`, 'Success');
        console.log('[Deal Conversion] Site created:', newSite);

        return newSite;
      } catch (error) {
        console.error('[Deal Conversion] Error converting deal to site:', error);
        toast.error('Deal stage updated, but failed to create site. Please create site manually.', 'Warning');
        throw error;
      }
    }

    window.updateDealStage = async (dealId, newStage) => {
      await updateDealStageAndConvert(dealId, newStage);
    };
    
    async function loadQuotes() {
      const tableBody = document.getElementById('quotes-table-body');
      const emptyState = document.getElementById('quotes-empty-state');
      if (!tableBody) return;
      
      try {
        // Use quotes module if available, otherwise fallback
        let quotes = [];
        if (window.quotesModule && typeof window.quotesModule.loadQuotes === 'function') {
          const statusFilter = document.getElementById('quotes-filter-status')?.value || '';
          const typeFilter = document.getElementById('quotes-filter-type')?.value || '';
          quotes = await window.quotesModule.loadQuotes({
            status: statusFilter || undefined,
            quote_type: typeFilter || undefined
          });
        } else {
          // Fallback to direct query
          const { data, error } = await supabase
            .from('quotes')
            .select('*')
            .order('updated_at', { ascending: false })
            .limit(100);
          if (error) throw error;
          quotes = data || [];
        }
        
        if (!quotes || quotes.length === 0) {
          if (tableBody) tableBody.innerHTML = '';
          if (emptyState) {
            emptyState.classList.remove('hidden');
          }
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        
        // Render table rows
        tableBody.innerHTML = quotes.map(quote => {
          const siteName = quote.sites?.name || 'No Account';
          const statusColors = {
            draft: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300',
            sent: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
            viewed: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
            accepted: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
            declined: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300',
            expired: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300',
            withdrawn: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
          };
          const statusColor = statusColors[quote.status] || statusColors.draft;
          
          // Get latest revision info (would need to fetch separately in production)
          const revisionType = quote.quote_type === 'walkthrough_required' ? 'Proposal' : 'Final';
          const totalDisplay = 'TBD'; // Would fetch from latest revision
          
          const sentDate = quote.updated_at ? new Date(quote.updated_at).toLocaleDateString() : '-';
          const expiryDate = '-'; // Would fetch from latest revision
          
          return `
            <tr class="hover:bg-nfglight dark:hover:bg-gray-700 cursor-pointer quote-row" data-quote-id="${quote.id}">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${siteName}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${quote.quote_type === 'walkthrough_required' ? 'Walkthrough' : 'Standard'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium rounded-lg ${statusColor}">${quote.status || 'draft'}</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${revisionType}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${totalDisplay}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${sentDate}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${expiryDate}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">-</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button class="text-nfgblue hover:text-nfgdark font-medium view-quote-btn" data-quote-id="${quote.id}">View</button>
              </td>
            </tr>
          `;
        }).join('');
        
        // Click handlers are set up via event delegation in the initialization section
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading quotes:', error);
        if (tableBody) tableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Failed to load quotes</td></tr>`;
      }
    }
    
    async function loadLeads() {
      const leadsList = document.getElementById('leads-list');
      if (!leadsList) return;
      
      try {
        const { data: leads, error } = await supabase
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        if (!leads || leads.length === 0) {
          leadsList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="user-plus" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No leads yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        leadsList.innerHTML = leads.map(lead => `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${lead.name || 'Unnamed Lead'}</h3>
                <p class="text-sm text-gray-500 mt-1">${lead.email || lead.phone || 'No contact info'}</p>
                <p class="text-sm text-gray-600 mt-2">${lead.notes || 'No notes'}</p>
              </div>
              <span class="px-3 py-1 rounded-lg text-xs font-medium bg-nfglight dark:bg-gray-700">
                ${lead.status || 'new'}
              </span>
            </div>
          </div>
        `).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading leads:', error);
        leadsList.innerHTML = `<div class="text-center py-12 text-red-500">Failed to load leads</div>`;
      }
    }
    
    async function loadContacts() {
      // Load accounts directory instead
      if (window.accountsDirectory && typeof window.accountsDirectory.loadAccounts === 'function') {
        await window.accountsDirectory.loadAccounts();
      }
    }
    
    async function loadCalls() {
      const callsList = document.getElementById('calls-list');
      if (!callsList) return;
      
      try {
        // Load calls without relationship syntax to avoid FK errors
        const { data: calls, error } = await supabase
          .from('calls')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        // Optionally load deal titles if deal_id exists
        let dealsMap = new Map();
        if (calls && calls.length > 0 && calls[0].deal_id) {
          try {
            const dealIds = [...new Set(calls.map(c => c.deal_id).filter(Boolean))];
            if (dealIds.length > 0) {
              const { data: dealsData } = await supabase
                .from('deals')
                .select('id, title')
                .in('id', dealIds);
              if (dealsData) {
                dealsMap = new Map(dealsData.map(d => [d.id, d]));
              }
            }
          } catch (dealError) {
            console.warn('[Sales] Could not load deal data for calls:', dealError);
          }
        }
        
        if (!calls || calls.length === 0) {
          callsList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="phone" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No calls yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        callsList.innerHTML = calls.map(call => {
          const deal = call.deal_id ? dealsMap.get(call.deal_id) : null;
          return `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${deal?.title || call.deal_id || 'No deal'}</h3>
                <p class="text-sm text-gray-500 mt-1">${call.phone_number || 'No phone'}</p>
                <p class="text-sm text-gray-600 mt-2">${call.outcome || 'No outcome'}</p>
                <p class="text-xs text-gray-400 mt-1">${call.created_at ? new Date(call.created_at).toLocaleString() : ''}</p>
              </div>
            </div>
          </div>
        `;
        }).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading calls:', error);
        callsList.innerHTML = `
          <div class="text-center py-12">
            <i data-lucide="phone" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-2">Failed to load calls</p>
            <p class="text-sm text-gray-400">${error.message || 'Unknown error'}</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      }
    }
    
    async function loadSequences() {
      const sequencesList = document.getElementById('sequences-list');
      if (!sequencesList) return;
      
      try {
        const { data: sequences, error } = await supabase
          .from('sequences')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) {
          // Handle permission denied or table doesn't exist
          if (error.code === '42501' || error.message?.includes('permission denied')) {
            console.warn('[Sales] Sequences table not accessible - may need RLS policies or table may not exist');
            sequencesList.innerHTML = `
              <div class="text-center py-12">
                <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                <p class="text-gray-500 mb-2">Sequences feature not available</p>
                <p class="text-sm text-gray-400">This feature requires database setup</p>
              </div>
            `;
            if (window.lucide) lucide.createIcons();
            return;
          }
          throw error;
        }
        
        if (!sequences || sequences.length === 0) {
          sequencesList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No sequences yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        sequencesList.innerHTML = sequences.map(seq => `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${seq.name || 'Unnamed Sequence'}</h3>
                <p class="text-sm text-gray-500 mt-1">${seq.description || 'No description'}</p>
                <p class="text-sm text-gray-600 mt-2">Steps: ${seq.steps?.length || 0}</p>
              </div>
              <span class="px-3 py-1 rounded-lg text-xs font-medium bg-nfglight dark:bg-gray-700">
                ${seq.status || 'active'}
              </span>
            </div>
          </div>
        `).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading sequences:', error);
        sequencesList.innerHTML = `
          <div class="text-center py-12">
            <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-2">Failed to load sequences</p>
            <p class="text-sm text-gray-400">${error.message || 'Unknown error'}</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      }
    }
    
    async function loadPerformanceMetrics() {
      try {
        const { count: dealsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true });
        
        const { count: callsCount } = await supabase
          .from('calls')
          .select('*', { count: 'exact', head: true });
        
        const { count: quotesCount } = await supabase
          .from('quotes')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'sent');
        
        const { count: winsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true })
          .eq('stage', 'closed_won');
        
        const totalDealsEl = document.getElementById('total-deals');
        const totalCallsEl = document.getElementById('total-calls');
        const totalQuotesEl = document.getElementById('total-quotes');
        const totalWinsEl = document.getElementById('total-wins');
        
        if (totalDealsEl) totalDealsEl.textContent = dealsCount || 0;
        if (totalCallsEl) totalCallsEl.textContent = callsCount || 0;
        if (totalQuotesEl) totalQuotesEl.textContent = quotesCount || 0;
        if (totalWinsEl) totalWinsEl.textContent = winsCount || 0;
      } catch (error) {
        console.error('Error loading performance metrics:', error);
      }
    }
    
    // Close deal detail modal
    document.getElementById('close-deal-detail')?.addEventListener('click', () => {
      document.getElementById('deal-detail-view')?.classList.add('hidden');
    });

    // Initialize
    console.log('[Sales Dashboard] Setting up DOMContentLoaded handler...');
    
    // Check if DOM is already loaded
    if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('[Sales Dashboard] DOMContentLoaded fired, starting initialization...');
        await initializeSalesDashboard();
      });
    } else {
      // DOM already loaded
      console.log('[Sales Dashboard] DOM already loaded, starting initialization immediately...');
      initializeSalesDashboard();
    }
    
    async function initializeSalesDashboard() {
      try {
        console.log('[Sales Dashboard] Step 1: Initializing icons...');
      if (window.lucide) lucide.createIcons();
        
        console.log('[Sales Dashboard] Step 2: Initializing tabs...');
        initTabs();
        
        console.log('[Sales Dashboard] Step 2.5: Initializing view options...');
        initViewOptions();
        
        console.log('[Sales Dashboard] Step 3: Initializing UI...');
        // Initialize UI first
        if (typeof initializeUI === 'function') {
          initializeUI();
        }
        
        console.log('[Sales Dashboard] Step 4: Hiding loader...');
        // Hide loader early, before sales.init() which might redirect
        if (typeof hideLoader === 'function') {
          hideLoader();
        } else {
          // Fallback: directly hide loader
          const loader = document.getElementById('page-loader');
          if (loader) {
            loader.classList.add('hidden');
            console.log('[Sales Dashboard] âœ… Loader hidden (fallback)');
          }
        }
        
        console.log('[Sales Dashboard] Step 5: Initializing sales module...');
        // Initialize sales module (this might redirect if no user)
        if (sales && typeof sales.init === 'function') {
      await sales.init();
          console.log('[Sales Dashboard] âœ… Sales module initialized');
          
          // Initialize quotes module after sales module (to get currentUser)
          if (window.quotesModule && typeof window.quotesModule.initQuotes === 'function') {
            try {
              const { data: { user } } = await supabase.auth.getUser();
              if (user) {
                await window.quotesModule.initQuotes(user);
                console.log('[Sales Dashboard] âœ… Quotes module initialized');
              }
            } catch (err) {
              console.warn('[Sales Dashboard] âš ï¸ Could not initialize quotes module:', err);
            }
          }

          // Initialize quote wizard
          if (window.quoteWizard && typeof window.quoteWizard.initQuoteWizard === 'function') {
            window.quoteWizard.initQuoteWizard();
            console.log('[Sales Dashboard] âœ… Quote wizard initialized');
          }
        } else {
          console.warn('[Sales Dashboard] âš ï¸ Sales module or init function not available');
        }
        
        console.log('[Sales Dashboard] Step 6: Loading dashboard data...');
        // Load dashboard tab by default
        await loadDashboardData();
        console.log('[Sales Dashboard] âœ… Initialization complete!');
      } catch (error) {
        console.error('[Sales Dashboard] âŒ Error during initialization:', error);
        
        // Always hide loader on error
        if (typeof hideLoader === 'function') {
      hideLoader();
        } else {
          const loader = document.getElementById('page-loader');
          if (loader) loader.classList.add('hidden');
        }
        
        // Show error message
        const main = document.querySelector('main');
        if (main) {
          main.innerHTML = `
            <div class="flex items-center justify-center h-full p-6">
              <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-8 max-w-md text-center">
                <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">Failed to Load</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">${error.message || 'An error occurred while loading the sales dashboard'}</p>
                <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-2 rounded mb-4 text-left overflow-auto max-h-24">${error.stack || error.toString()}</pre>
                <button onclick="window.location.reload()" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
                  Reload Page
                </button>
              </div>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
        }
      }
    }

    // Make sales module available globally
    window.sales = sales;
    window.loadTabData = loadTabData;
    
    // Setup quote filter listeners (after DOM is ready)
    setTimeout(() => {
      const quotesFilterStatus = document.getElementById('quotes-filter-status');
      const quotesFilterType = document.getElementById('quotes-filter-type');
      const quotesFilterReset = document.getElementById('quotes-filter-reset');
      
      if (quotesFilterStatus) {
        quotesFilterStatus.addEventListener('change', () => loadQuotes());
      }
      if (quotesFilterType) {
        quotesFilterType.addEventListener('change', () => loadQuotes());
      }
      if (quotesFilterReset) {
        quotesFilterReset.addEventListener('click', () => {
          if (quotesFilterStatus) quotesFilterStatus.value = '';
          if (quotesFilterType) quotesFilterType.value = '';
          loadQuotes();
        });
      }
      
      // Setup new quote button
      const newQuoteBtnTab = document.getElementById('new-quote-btn-tab');
      if (newQuoteBtnTab) {
        newQuoteBtnTab.addEventListener('click', async () => {
          if (window.quoteWizard && typeof window.quoteWizard.openQuoteWizard === 'function') {
            window.quoteWizard.openQuoteWizard();
          } else {
            if (toast) toast.error('Quote wizard not loaded', 'Error');
          }
        });
      }

      // Setup quote detail modal close button
      const closeQuoteDetailBtn = document.getElementById('close-quote-detail-modal');
      const quoteDetailCloseBtn = document.getElementById('quote-detail-close-btn');
      if (closeQuoteDetailBtn) {
        closeQuoteDetailBtn.addEventListener('click', () => {
          document.getElementById('quote-detail-modal')?.classList.add('hidden');
        });
      }
      if (quoteDetailCloseBtn) {
        quoteDetailCloseBtn.addEventListener('click', () => {
          document.getElementById('quote-detail-modal')?.classList.add('hidden');
        });
      }

      // Setup lead modals close buttons
      const closeCreateLeadBtn = document.getElementById('close-create-lead-modal');
      const cancelCreateLeadBtn = document.getElementById('cancel-create-lead');
      if (closeCreateLeadBtn) {
        closeCreateLeadBtn.addEventListener('click', () => {
          document.getElementById('create-lead-modal')?.classList.add('hidden');
        });
      }
      if (cancelCreateLeadBtn) {
        cancelCreateLeadBtn.addEventListener('click', () => {
          document.getElementById('create-lead-modal')?.classList.add('hidden');
        });
      }

      const closeDispositionBtn = document.getElementById('close-disposition-modal');
      if (closeDispositionBtn) {
        closeDispositionBtn.addEventListener('click', () => {
          document.getElementById('disposition-modal')?.classList.add('hidden');
        });
      }

      const closeConvertLeadBtn = document.getElementById('close-convert-lead-modal');
      const cancelConvertLeadBtn = document.getElementById('cancel-convert-lead');
      if (closeConvertLeadBtn) {
        closeConvertLeadBtn.addEventListener('click', () => {
          document.getElementById('convert-lead-modal')?.classList.add('hidden');
        });
      }
      if (cancelConvertLeadBtn) {
        cancelConvertLeadBtn.addEventListener('click', () => {
          document.getElementById('convert-lead-modal')?.classList.add('hidden');
        });
      }

      // Setup create lead form
      const createLeadForm = document.getElementById('create-lead-form');
      if (createLeadForm) {
        createLeadForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!window.leadsDirectory) {
            console.error('Leads directory not loaded');
            return;
          }
          const formData = new FormData(e.target);
          try {
            const { createLead } = await import('./js/leads-service.js');
            await createLead({
              company_name: formData.get('company_name'),
              person_name: formData.get('person_name'),
              title: formData.get('title'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address'),
              city: formData.get('city'),
              source: formData.get('source'),
              priority: parseInt(formData.get('priority')),
              notes_lite: formData.get('notes_lite')
            });
            if (toast) toast.success('Lead created');
            document.getElementById('create-lead-modal')?.classList.add('hidden');
            e.target.reset();
            if (window.leadsDirectory && typeof window.leadsDirectory.loadLeads === 'function') {
              await window.leadsDirectory.loadLeads();
            }
          } catch (error) {
            console.error('Error creating lead:', error);
            if (toast) toast.error('Failed to create lead', 'Error');
          }
        });
      }

      // Setup quote row click handlers (delegated)
      const quotesTableBody = document.getElementById('quotes-table-body');
      if (quotesTableBody) {
        quotesTableBody.addEventListener('click', (e) => {
          const row = e.target.closest('.quote-row');
          const viewBtn = e.target.closest('.view-quote-btn');
          if (row || viewBtn) {
            const quoteId = row?.dataset.quoteId || viewBtn?.dataset.quoteId;
            if (quoteId && window.quoteDetail && typeof window.quoteDetail.openQuoteDetail === 'function') {
              window.quoteDetail.openQuoteDetail(quoteId);
            }
          }
        });
      }
    }, 1000);
  </script>
  <script type="module" src="./js/auth.js"></script>
</body>
</html>
