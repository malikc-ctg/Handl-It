<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NFG â€” Sales Portal</title>
  <link rel="icon" type="image/png" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">
  
  <!-- PWA Support -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0D47A1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NFG">
  <link rel="apple-touch-icon" href="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU">

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Tailwind CDN + NFG theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            nfgblue: '#0D47A1',
            nfgdark: '#0A3A84',
            nfglight: '#E3ECFA',
            nfgray: '#E5E7EB',
            nftext: '#1E293B',
            nfbg: '#F8FAFC'
          },
          fontFamily: { inter: ['Inter','sans-serif'] },
          borderRadius: { xl: '12px' },
          boxShadow: { nfg: '0 4px 14px rgba(13,71,161,0.06)' }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Custom Dropdown Styles -->
  <link rel="stylesheet" href="./css/custom-dropdown.css">
  
  <!-- Mobile Menu Styles -->
  <link rel="stylesheet" href="./css/mobile-menu.css">
  
  <!-- Notification System -->
  <link rel="stylesheet" href="./css/notifications.css">
  
  <!-- Page Loader -->
  <link rel="stylesheet" href="./css/loader.css">
  <link rel="stylesheet" href="./css/skeleton-loaders.css">
  
  <!-- Dark Mode -->
  <link rel="stylesheet" href="./css/dark-mode.css">
  <script src="./js/dark-mode.js"></script>
  
  <!-- Notification Center -->
  <link rel="stylesheet" href="./css/notification-center.css">
  
  <!-- Offline Sync -->
  <script type="module" src="./js/offline-sync.js"></script>
  <script type="module" src="./js/offline-indicator.js"></script>

  <!-- Sales Portal Styles -->
  <style>
    .health-bar {
      height: 4px;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .health-excellent { background: #10b981; }
    .health-good { background: #3b82f6; }
    .health-fair { background: #f59e0b; }
    .health-poor { background: #ef4444; }
    .timeline-item {
      position: relative;
      padding-left: 2rem;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 0.5rem;
      top: 0;
      bottom: -1rem;
      width: 2px;
      background: #E5E7EB;
    }
    .timeline-item:last-child::before {
      display: none;
    }
    .single-scroll-container {
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
    }

    /* Kanban Board Styles */
    #deals-kanban {
      scrollbar-width: thin;
      scrollbar-color: #E5E7EB transparent;
    }

    #deals-kanban::-webkit-scrollbar {
      height: 8px;
    }

    #deals-kanban::-webkit-scrollbar-track {
      background: transparent;
    }

    #deals-kanban::-webkit-scrollbar-thumb {
      background: #E5E7EB;
      border-radius: 4px;
    }

    .dark #deals-kanban::-webkit-scrollbar-thumb {
      background: #374151;
    }

    .kanban-column {
      min-height: 400px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .kanban-deals {
      min-height: 200px;
    }

    .deal-card {
      transition: all 0.2s ease;
      user-select: none;
    }

    .deal-card:hover {
      transform: translateY(-2px);
    }

    .deal-card:active {
      cursor: grabbing;
    }

    .kanban-deals.drag-over {
      background-color: rgba(13, 71, 161, 0.1);
      border: 2px dashed #0D47A1;
      border-radius: 8px;
    }

    .dark .kanban-deals.drag-over {
      background-color: rgba(59, 130, 246, 0.2);
      border-color: #3B82F6;
    }
    
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .view-option.active {
      background-color: white;
    }
    
    .dark .view-option.active {
      background-color: #374151;
    }
    
    .deals-view {
      min-height: 400px;
    }
    
    .deals-view.hidden {
      display: none;
    }

    .deal-card.dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
  </style>
</head>

<body class="font-inter bg-nfbg dark:bg-gray-900 min-h-screen flex text-nftext dark:text-gray-200">
  <!-- Full-Page Loader -->
  <div id="page-loader">
    <div class="loader-logo">
      <img src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" alt="NFG">
    </div>
    <div class="banter-loader">
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
      <div class="banter-loader__box"></div>
    </div>
    <div class="loader-text">Loading Sales Portal...</div>
    <div class="loader-text-subtitle">Please wait</div>
  </div>

  
  <!-- ========== SIDEBAR ========== -->
  <aside id="sidebar" class="w-64 shrink-0 bg-white dark:bg-gray-800 border-r border-nfgray hidden md:flex md:flex-col transition-all">
    <div class="p-5 flex items-center justify-center">
      <img 
        src="https://zqcbldgheimqrnqmbbed.supabase.co/storage/v1/object/sign/app-images/NFG%20one.png?token=eyJraWQiOiJzdG9yYWdlLXVybC1zaWduaW5nLWtleV8xN2RmNDhlMi0xNGJlLTQ5NzMtODZlNy0zZTc0MjgzMWIzOTQiLCJhbGciOiJIUzI1NiJ9.eyJ1cmwiOiJhcHAtaW1hZ2VzL05GRyBvbmUucG5nIiwiaWF0IjoxNzYyOTc5NzU5LCJleHAiOjQ4ODUwNDM3NTl9.fnJIDQep2yYlgGKlBRNnkrUoUzXzG7eac39GG6NQPuU" 
        alt="NFG" 
        class="h-32 w-auto"
      />
    </div>
    <nav class="px-3 pb-4 flex-1 space-y-1">
      <a id="nav-sales" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 font-medium w-full text-left" href="sales.html">
        <i data-lucide="trending-up" class="w-4 h-4"></i> Sales
      </a>
      <a id="nav-priority" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="sales.html?tab=priority">
        <i data-lucide="zap" class="w-4 h-4"></i> Priority Actions
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="routes.html">
        <i data-lucide="route" class="w-4 h-4"></i> Routes
      </a>
      <a id="nav-tools" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="sales.html?tab=tools">
        <i data-lucide="wrench" class="w-4 h-4"></i> Tools & Resources
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="bookings.html" onclick="sessionStorage.setItem('isSalesMode','true');">
        <i data-lucide="calendar" class="w-4 h-4"></i> Calendar
      </a>
      <a id="nav-messages" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="messages.html">
        <i data-lucide="message-circle" class="w-4 h-4"></i> Messages
      </a>
      <a class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 w-full text-left" href="settings.html">
        <i data-lucide="settings" class="w-4 h-4"></i> Settings
      </a>
    </nav>
    <div class="p-4 border-t border-nfgray dark:border-gray-700 space-y-2">
      <a href="dashboard.html" onclick="sessionStorage.removeItem('isSalesMode');" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-nfgblue dark:bg-blue-600 text-white hover:bg-nfgdark dark:hover:bg-blue-700 w-full text-left font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Ops Mode
      </a>
      <button id="logout-btn" data-action="logout" class="w-full border border-nfgray dark:border-gray-600 text-nftext dark:text-gray-300 hover:bg-nfgray dark:hover:bg-gray-700 rounded-xl py-2 font-medium">
        Logout
      </button>
    </div>
  </aside>

  <!-- ========== MAIN ========== -->
  <div class="flex-1 flex flex-col min-w-0">
    <!-- TOPBAR -->
    <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700">
      <div class="h-14 px-2 sm:px-4 md:px-6 flex items-center justify-between gap-1 sm:gap-2">
        <div class="flex items-center gap-1 sm:gap-2 min-w-0 flex-1">
          <button class="md:hidden p-1.5 sm:p-2 rounded-lg border border-nfgray text-nfgblue dark:text-blue-400 flex-shrink-0" data-action="toggle-sidebar" aria-label="Toggle sidebar">
            <i data-lucide="menu" class="w-4 h-4 sm:w-5 sm:h-5"></i>
          </button>
          <h1 id="page-title" class="text-nfgblue dark:text-blue-400 font-semibold text-sm sm:text-base truncate">Sales Portal</h1>
        </div>
        <div class="flex items-center gap-2">
          <button id="back-to-queue-btn" class="hidden px-3 py-1.5 text-sm bg-nfglight dark:bg-gray-700 text-nfgblue dark:text-blue-400 rounded-lg hover:bg-nfgray dark:hover:bg-gray-600 transition">
            <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> Back to Queue
          </button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-hidden flex flex-col">
      <!-- Sales Dashboard Tabs -->
      <div id="sales-dashboard-tabs" class="border-b border-nfgray dark:border-gray-700 bg-white dark:bg-gray-800">
        <div class="px-4 md:px-6 flex gap-1 overflow-x-auto">
          <button class="sales-tab active px-4 py-3 text-sm font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue dark:border-blue-400 whitespace-nowrap" data-tab="dashboard">
            <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-2"></i> Dashboard
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="deals">
            <i data-lucide="briefcase" class="w-4 h-4 inline mr-2"></i> Deals
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="quotes">
            <i data-lucide="file-text" class="w-4 h-4 inline mr-2"></i> Quotes
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="contacts">
            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i> Contacts
          </button>
          <button class="sales-tab px-4 py-3 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border-b-2 border-transparent whitespace-nowrap" data-tab="team">
            <i data-lucide="users-2" class="w-4 h-4 inline mr-2"></i> Team
          </button>
        </div>
      </div>

      <!-- Tab Content Container -->
      <div class="flex-1 overflow-hidden">
        <!-- Dashboard Tab (Command Console) -->
        <div id="tab-dashboard" class="sales-tab-content h-full overflow-y-auto p-4 md:p-6">
          <!-- Sales Pipeline Header -->
          <div class="mb-4">
            <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Sales Pipeline</h2>
          </div>

          <!-- 1. Top KPI Strip (4 Cards) -->
          <div id="kpi-strip" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Card 1: Open Pipeline -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="open-pipeline">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Open Pipeline</span>
                <i data-lucide="trending-up" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <p id="kpi-total-open" class="text-2xl font-bold text-nfgblue dark:text-blue-400 mb-1">$0</p>
              <p id="kpi-weighted-open" class="text-xs text-gray-500 dark:text-gray-400">Weighted: $0</p>
            </div>

            <!-- Card 2: Today -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="today">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Today</span>
                <i data-lucide="calendar" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Quotes:</span>
                  <span id="kpi-today-quotes" class="font-semibold text-nfgblue dark:text-blue-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Closed:</span>
                  <span id="kpi-today-closed" class="font-semibold text-green-600 dark:text-green-400">0</span>
                </div>
              </div>
            </div>

            <!-- Card 3: Next 7 Days -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="next-7-days">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Next 7 Days</span>
                <i data-lucide="clock" class="w-5 h-5 text-orange-500"></i>
              </div>
              <p id="kpi-at-risk" class="text-2xl font-bold text-orange-600 dark:text-orange-400 mb-1">0</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">At Risk</p>
            </div>

            <!-- Card 4: Urgent -->
            <div class="kpi-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4 shadow-nfg cursor-pointer hover:shadow-lg transition" data-filter="urgent">
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Urgent</span>
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
              </div>
              <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Uncontacted:</span>
                  <span id="kpi-uncontacted" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Quotes <48h:</span>
                  <span id="kpi-quotes-expiring" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-600 dark:text-gray-400">Idle >7d:</span>
                  <span id="kpi-idle-deals" class="font-semibold text-red-600 dark:text-red-400">0</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 2. Priority Actions Queue (Top 3) -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Priority Actions</h3>
              <a href="sales.html?tab=priority" class="text-sm text-nfgblue hover:text-nfgdark font-medium flex items-center gap-1">
                View All <i data-lucide="arrow-right" class="w-4 h-4"></i>
              </a>
            </div>
            <div id="priority-actions" class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg">
              <div id="priority-actions-list" class="divide-y divide-nfgray dark:divide-gray-700">
                <!-- Priority actions will be rendered here -->
              </div>
            </div>
          </div>

          <!-- 3. Active Deals Table (Main Body) -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Active Deals</h3>
              <button id="create-deal-dashboard-btn" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition">
                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> New Deal
              </button>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead class="bg-nfglight dark:bg-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Company</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Stage</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Deal $</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Last Contact</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Next Action</th>
                      <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase">Days Idle</th>
                    </tr>
                  </thead>
                  <tbody id="deals-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
                    <!-- Deals will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 4. Pipeline Stage Snapshot -->
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Pipeline Stages</h3>
            <div id="pipeline-snapshot" class="grid grid-cols-2 md:grid-cols-6 gap-3">
              <!-- Pipeline stages will be rendered here -->
            </div>
          </div>

        </div>

        <!-- Deals Tab -->
        <div id="tab-deals" class="sales-tab-content hidden h-full overflow-y-auto">
          <!-- Modern Header Section -->
          <div class="bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 px-4 md:px-6 py-6">
            <div class="flex flex-col gap-4">
              <!-- Title and Description -->
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Deals</h1>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Keep track of your sales pipeline all in one place.</p>
                </div>
                <div class="flex items-center gap-3">
                  <button id="create-deal-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition inline-flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> New Deal
                  </button>
                </div>
              </div>

              <!-- View Options and Filters -->
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-2 border-t border-gray-200 dark:border-gray-700">
                <!-- View Tabs -->
                <div class="flex items-center gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                  <button class="view-option px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 rounded transition" data-view="overview">
                    <i data-lucide="layout-grid" class="w-4 h-4 inline mr-1"></i> Overview
                  </button>
                  <button class="view-option active px-3 py-1.5 text-sm font-medium text-nfgblue dark:text-blue-400 bg-white dark:bg-gray-700 rounded transition" data-view="board">
                    <i data-lucide="columns" class="w-4 h-4 inline mr-1"></i> Board
                  </button>
                  <button class="view-option px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 rounded transition" data-view="list">
                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i> List
                  </button>
                  <button class="view-option px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 rounded transition" data-view="table">
                    <i data-lucide="table" class="w-4 h-4 inline mr-1"></i> Table
                  </button>
                </div>

                <!-- Filter Controls -->
                <div class="flex items-center gap-2">
                  <button class="filter-btn px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 rounded-lg transition inline-flex items-center gap-2">
                    <i data-lucide="filter" class="w-4 h-4"></i> Filter
                  </button>
                  <button class="group-btn px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 rounded-lg transition inline-flex items-center gap-2">
                    <i data-lucide="layers" class="w-4 h-4"></i> Group by
                  </button>
                  <button class="sort-btn px-3 py-1.5 text-sm font-medium text-gray-600 dark:text-gray-400 hover:text-nfgblue dark:hover:text-blue-400 border border-gray-300 dark:border-gray-600 rounded-lg transition inline-flex items-center gap-2">
                    <i data-lucide="arrow-up-down" class="w-4 h-4"></i> Sort
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- View Containers -->
          <div class="p-4 md:p-6">
            <!-- Overview View -->
            <div id="deals-overview-view" class="deals-view hidden">
              <div id="deals-overview-content">
                <!-- Overview content will be rendered here -->
              </div>
            </div>

            <!-- Board View -->
            <div id="deals-board-view" class="deals-view">
              <div id="deals-kanban" class="flex gap-4 overflow-x-auto pb-4">
              <!-- Qualification Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="qualification">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-blue-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Qualification</h3>
                  </div>
                  <div class="flex items-center gap-2 relative">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button type="button" class="kanban-plus-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-stage="qualification" title="New deal">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button type="button" class="kanban-menu-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-stage="qualification" title="Options">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <div class="kanban-stage-dropdown hidden absolute right-0 top-full mt-1 py-1 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                      <button type="button" class="kanban-export-btn w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export deals
                      </button>
                      <button type="button" class="kanban-view-list-btn w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i> View in list
                      </button>
                    </div>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="qualification">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Proposal Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="proposal">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-purple-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Proposal</h3>
                  </div>
                  <div class="flex items-center gap-2 relative">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button type="button" class="kanban-plus-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-stage="proposal" title="New deal">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button type="button" class="kanban-menu-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-stage="proposal" title="Options">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <div class="kanban-stage-dropdown hidden absolute right-0 top-full mt-1 py-1 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                      <button type="button" class="kanban-export-btn w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export deals
                      </button>
                      <button type="button" class="kanban-view-list-btn w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i> View in list
                      </button>
                    </div>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="proposal">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Negotiation Column -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="negotiation">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-orange-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Negotiation</h3>
                  </div>
                  <div class="flex items-center gap-2 relative">
                    <span class="kanban-count bg-nfgblue text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button type="button" class="kanban-plus-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-stage="negotiation" title="New deal">
                      <i data-lucide="plus" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <button type="button" class="kanban-menu-btn p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" data-stage="negotiation" title="Options">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <div class="kanban-stage-dropdown hidden absolute right-0 top-full mt-1 py-1 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                      <button type="button" class="kanban-export-btn w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Export deals
                      </button>
                      <button type="button" class="kanban-view-list-btn w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="list" class="w-4 h-4"></i> View in list
                      </button>
                    </div>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="negotiation">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Closed Won Column (no +; three-dots: Clear pipeline, Export deals) -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border-2 border-green-200 dark:border-green-800" data-stage="closed_won">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-400"></span>
                    <h3 class="font-semibold text-green-700 dark:text-green-300">Closed Won</h3>
                  </div>
                  <div class="flex items-center gap-2 relative">
                    <span class="kanban-count bg-green-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button type="button" id="kanban-closed-won-menu-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" title="Options">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <div id="kanban-closed-won-dropdown" class="hidden absolute right-0 top-full mt-1 py-1 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                      <button type="button" id="kanban-closed-won-clear-btn" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                        Clear pipeline
                      </button>
                      <button type="button" id="kanban-closed-won-export-btn" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export deals
                      </button>
                    </div>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="closed_won">
                  <!-- Deals will be rendered here -->
                </div>
              </div>

              <!-- Closed Lost Column (no add button; three-dots menu for Clear pipeline only) -->
              <div class="kanban-column flex-shrink-0 w-80 bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700" data-stage="closed_lost">
                <div class="flex items-center justify-between mb-4">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <h3 class="font-semibold text-gray-700 dark:text-gray-300">Closed Lost</h3>
                  </div>
                  <div class="flex items-center gap-2 relative">
                    <span class="kanban-count bg-gray-500 text-white px-2 py-0.5 rounded-full text-xs font-medium">0</span>
                    <button type="button" id="kanban-closed-lost-menu-btn" class="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition" title="Options">
                      <i data-lucide="more-horizontal" class="w-4 h-4 text-gray-500 dark:text-gray-400"></i>
                    </button>
                    <div id="kanban-closed-lost-dropdown" class="hidden absolute right-0 top-full mt-1 py-1 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50">
                      <button type="button" id="kanban-closed-lost-clear-btn" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                        Clear pipeline
                      </button>
                    </div>
                  </div>
                </div>
                <div class="kanban-deals space-y-3 min-h-[200px]" data-stage="closed_lost">
                  <!-- Deals will be rendered here -->
                </div>
              </div>
            </div>
            </div>

            <!-- List View -->
            <div id="deals-list-view" class="deals-view hidden">
              <div id="deals-list-content" class="space-y-3">
                <!-- List content will be rendered here -->
              </div>
            </div>

            <!-- Table View -->
            <div id="deals-table-view" class="deals-view hidden">
              <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                  <thead class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
                    <tr>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Company</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Contact</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Stage</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Value</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Priority</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Due Date</th>
                      <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="deals-table-content" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Table content will be rendered here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-16">
          <div class="bg-white dark:bg-gray-800 border-2 border-dashed border-nfgray dark:border-gray-700 rounded-xl p-12 max-w-md mx-auto">
            <i data-lucide="trending-up" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-nfgblue dark:text-blue-400 font-semibold text-xl mb-2">No Deals Yet</h3>
            <p class="text-nftext dark:text-gray-300 text-sm mb-6">Get started by creating your first deal from a site.</p>
            <button id="create-first-deal-btn" class="bg-nfgblue hover:bg-nfgdark text-white rounded-xl px-6 py-3 font-medium transition inline-flex items-center gap-2">
              <i data-lucide="plus" class="w-5 h-5"></i> Create Your First Deal
            </button>
          </div>
        </div>
      </div>

        <!-- Quotes Tab -->
        <div id="tab-quotes" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Quotes</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage and track all quotes</p>
            </div>
            <div class="flex items-center gap-3">
              <button id="quotes-delete-selected" class="px-4 py-2 border border-red-300 text-red-600 dark:border-red-700 dark:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-xl font-medium transition inline-flex items-center gap-2 disabled:opacity-40 disabled:cursor-not-allowed" disabled>
                <i data-lucide="trash" class="w-4 h-4"></i> Delete Selected
              </button>
              <button id="new-quote-btn-tab" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> New Quote
              </button>
            </div>
          </div>

          <!-- Filters -->
          <div class="flex flex-wrap gap-4 mb-6 p-4 bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl">
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
              <select id="quotes-filter-status" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                <option value="">All Statuses</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="viewed">Viewed</option>
                <option value="accepted">Accepted</option>
                <option value="declined">Declined</option>
                <option value="expired">Expired</option>
                <option value="withdrawn">Withdrawn</option>
              </select>
            </div>
            <div class="flex-1 min-w-[200px]">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quote Type</label>
              <select id="quotes-filter-type" class="w-full px-3 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                <option value="">All Types</option>
                <option value="standard">Standard</option>
                <option value="walkthrough_required">Walkthrough Required</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="quotes-filter-reset" class="px-4 py-2 text-sm border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition">
                Reset Filters
              </button>
            </div>
          </div>

          <!-- Quotes Table -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl shadow-nfg overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-nfglight dark:bg-gray-700">
                  <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                      <input id="quotes-select-all" type="checkbox" class="h-4 w-4 text-nfgblue border-gray-300 rounded focus:ring-nfgblue">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Company</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Quote Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Latest Revision</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Total / Range</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Sent Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Expiry</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Owner</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody id="quotes-table-body" class="bg-white dark:bg-gray-800 divide-y divide-nfgray dark:divide-gray-700">
                  <!-- Quotes will be rendered here -->
                </tbody>
              </table>
            </div>
            <div id="quotes-empty-state" class="hidden p-12 text-center">
              <i data-lucide="file-text" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
              <p class="text-gray-500 dark:text-gray-400">No quotes yet</p>
              <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Click "New Quote" to create your first quote</p>
            </div>
          </div>
        </div>

        <!-- Contacts Tab (Accounts Directory) -->
        <div id="tab-contacts" class="sales-tab-content hidden h-full flex flex-col">
          <!-- Sticky top bar -->
          <div class="sticky top-0 z-10 bg-white dark:bg-gray-900 border-b border-nfgray p-4 md:p-6">
            <div class="flex flex-col gap-4">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                  <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400">Client Accounts</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your client accounts directory</p>
                </div>
              <button id="create-account-btn" onclick="var m=document.getElementById('create-account-modal'); if(m){m.classList.remove('hidden');m.style.display='flex';} if(window.lucide)lucide.createIcons();" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition inline-flex items-center gap-2">
                  <i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i> <span class="pointer-events-none">New Account</span>
                </button>
              </div>
              
              <!-- Search and Filters -->
              <div class="flex flex-col md:flex-row gap-3">
                <div class="flex-1">
                  <input
                    type="text"
                    id="accounts-search"
                    placeholder="Search by company name, DM, phone, or email..."
                    class="w-full border border-nfgray rounded-xl px-4 py-2 focus:ring-2 focus:ring-nfgblue outline-none"
                  />
                </div>
                <div class="flex gap-2 flex-wrap">
                  <select id="accounts-status-filter" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                    <option value="">All Status</option>
                    <option value="prospect">Prospect</option>
                    <option value="in_progress">In Progress</option>
                    <option value="active">Active</option>
                    <option value="dormant">Dormant</option>
                  </select>
                  <select id="accounts-owner-filter" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none hidden">
                    <option value="">All Owners</option>
                  </select>
                  <select id="accounts-sites-filter" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                    <option value="">All Sites</option>
                    <option value="1">1 site</option>
                    <option value="2-5">2-5 sites</option>
                    <option value="6+">6+ sites</option>
                  </select>
                  <select id="accounts-sort" class="border border-nfgray rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-nfgblue outline-none">
                    <option value="last_touch_at_desc">Recently Touched</option>
                    <option value="site_count_desc">Most Sites</option>
                    <option value="name_asc">A-Z</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Accounts Table -->
          <div class="flex-1 overflow-auto p-4 md:p-6">
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="bg-nfglight dark:bg-gray-700 border-b border-nfgray">
                    <tr>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Company</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Decision Maker</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Contact</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Sites</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Status</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Owner</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Last Touch</th>
                      <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400"></th>
                    </tr>
                  </thead>
                  <tbody id="accounts-table-body">
                    <!-- Skeleton shown by accounts-directory.js on load -->
                    <tr class="skeleton-table-row animate-pulse">
                      <td class="px-4 py-3" colspan="8">
                        <div class="max-w-md mx-auto space-y-3 py-6">
                          <div class="skeleton-bar skeleton-bar-w-3/4 h-4 rounded"></div>
                          <div class="skeleton-bar skeleton-bar-w-1/2 h-4 rounded"></div>
                          <div class="skeleton-bar skeleton-bar-w-1/2 h-4 rounded"></div>
                          <div class="skeleton-bar skeleton-bar-w-1/4 h-4 rounded"></div>
                          <div class="skeleton-bar skeleton-bar-w-1/2 h-4 rounded"></div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Priority Actions Tab (Mini Powerhouse CRM - reference layout) -->
        <div id="tab-priority" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6 bg-gray-50 dark:bg-gray-900">
          <div class="max-w-7xl mx-auto">
            <!-- Top bar: Search, Sort, Filters, Me, + Add -->
            <div class="flex flex-wrap items-center gap-3 mb-6">
              <div class="flex-1 min-w-[200px] relative max-w-md">
                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                <input type="text" id="priority-search" placeholder="Search customer..." class="w-full pl-10 pr-4 py-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400" />
              </div>
              <div class="flex items-center gap-2">
                <select id="priority-sort" class="px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 text-sm">
                  <option value="priority">Sort by priority</option>
                  <option value="last_activity">Last activity</option>
                  <option value="deal_value">Deal value</option>
                  <option value="next_followup">Next follow-up</option>
                </select>
                <button type="button" id="priority-filters-btn" class="p-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                  <i data-lucide="filter" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i>
                </button>
                <button type="button" id="priority-me-btn" class="p-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition" title="My actions only">
                  <i data-lucide="user" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i>
                </button>
                <button type="button" id="priority-refresh-btn" class="p-2 border border-gray-200 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 transition" title="Refresh list">
                  <i data-lucide="refresh-cw" class="w-4 h-4 text-gray-600 dark:text-gray-400"></i>
                </button>
                <button type="button" id="priority-add-customer-btn" class="px-4 py-2 bg-gray-900 dark:bg-white text-white dark:text-gray-900 rounded-xl font-medium transition flex items-center gap-2 hover:opacity-90">
                  <i data-lucide="plus" class="w-4 h-4"></i> Add customer
                </button>
              </div>
            </div>

            <!-- Filters panel (collapsible) -->
            <div id="priority-filters-panel" class="hidden mb-6 p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
              <div class="flex flex-wrap items-center gap-4">
                <div>
                  <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Priority</label>
                  <select id="priority-filter-priority" class="px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                    <option value="">All</option>
                    <option value="1">P1 Urgent</option>
                    <option value="2">P2 High</option>
                    <option value="3">P3 Medium</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Type</label>
                  <select id="priority-filter-type" class="px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                    <option value="">All types</option>
                    <option value="contact_final_attempt">Final attempt</option>
                    <option value="contact_missed_followup">Missed follow-up</option>
                    <option value="contact_follow_up">Follow up (1 no-contact)</option>
                    <option value="contact_quote_followup">Quote follow-up</option>
                    <option value="contact_new">New contact</option>
                    <option value="contact_idle">Idle</option>
                    <option value="quote_expiring">Quote expiring</option>
                    <option value="missed_callback">Missed callback</option>
                    <option value="walkthrough_today">Walkthrough today</option>
                    <option value="follow_up_needed">Deal follow-up</option>
                    <option value="quote_follow_up">Deal quote follow-up</option>
                    <option value="post_walkthrough">Post walkthrough</option>
                    <option value="idle_deal">Idle deal</option>
                    <option value="stuck_in_stage">Stuck in stage</option>
                    <option value="new_uncontacted">New uncontacted deal</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Has deal</label>
                  <select id="priority-filter-deal" class="px-3 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
                    <option value="">All</option>
                    <option value="yes">With deal</option>
                    <option value="no">No deal</option>
                  </select>
                </div>
                <button type="button" id="priority-filters-apply" class="self-end px-3 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm">Apply</button>
              </div>
            </div>

            <!-- KPI row (reference style) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
              <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 flex items-center justify-between shadow-sm">
                <div>
                  <p id="priority-p1-count" class="text-2xl font-bold text-red-600 dark:text-red-400">0</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Urgent (P1)</p>
                </div>
                <i data-lucide="alert-circle" class="w-8 h-8 text-red-500/30"></i>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 flex items-center justify-between shadow-sm">
                <div>
                  <p id="priority-p2-count" class="text-2xl font-bold text-orange-600 dark:text-orange-400">0</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">High (P2)</p>
                </div>
                <i data-lucide="trending-up" class="w-8 h-8 text-orange-500/30"></i>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 flex items-center justify-between shadow-sm">
                <div>
                  <p id="priority-tasks-count" class="text-2xl font-bold text-nfgblue dark:text-blue-400">0</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Tasks in progress</p>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
              </div>
              <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 flex items-center justify-between shadow-sm">
                <div>
                  <p id="priority-value" class="text-2xl font-bold text-green-600 dark:text-green-400">$0</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">Pipeline value</p>
                </div>
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
              </div>
            </div>

            <!-- Priority Actions card grid -->
            <div id="priority-actions-full-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="col-span-full text-center py-12 text-gray-400">
                <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                <p>Loading priority actions...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Priority card three-dots dropdown (shared template, filled by JS) -->
        <div id="priority-card-menu-portal" class="hidden fixed z-[100] py-1 min-w-[180px] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl"></div>
        <!-- Quick log / Schedule next modal -->
        <div id="priority-quick-log-modal" class="hidden fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4">
          <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Log outcome & next step</h3>
              <button type="button" id="priority-quick-log-close" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                <i data-lucide="x" class="w-5 h-5"></i>
              </button>
            </div>
            <input type="hidden" id="priority-quick-log-contact-id" />
            <input type="hidden" id="priority-quick-log-deal-id" />
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Outcome</label>
                <select id="priority-quick-log-outcome" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                  <option value="contact_made">Contact made</option>
                  <option value="no_answer">No answer</option>
                  <option value="voicemail">Left voicemail</option>
                  <option value="callback_scheduled">Callback scheduled</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Next follow-up (optional)</label>
                <input type="date" id="priority-quick-log-next-date" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Note</label>
                <textarea id="priority-quick-log-note" rows="2" class="w-full px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Brief note..."></textarea>
              </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
              <button type="button" id="priority-quick-log-cancel" class="px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
              <button type="button" id="priority-quick-log-save" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg">Save</button>
            </div>
          </div>
        </div>

        <!-- Tools & Resources Tab -->
        <div id="tab-tools" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-6">
              <h2 class="text-2xl font-semibold text-nfgblue dark:text-blue-400 mb-2">Tools & Resources</h2>
              <p class="text-sm text-gray-500 dark:text-gray-400">Quick access to calculators, templates, and sales resources</p>
            </div>

            <!-- Calculators & Tools Section -->
            <div class="mb-8">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="calculator" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
                Calculators & Tools
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- ROI Calculator Card -->
                <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 shadow-nfg hover:shadow-lg transition cursor-pointer" onclick="window.salesTools?.openROICalculator()">
                  <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                      <i data-lucide="trending-up" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i>
                    </div>
                  </div>
                  <h4 class="font-semibold text-gray-900 dark:text-white mb-2">ROI Calculator</h4>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Calculate ROI and payback period for proposals</p>
                </div>

                <!-- Commission Calculator Card -->
                <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 shadow-nfg hover:shadow-lg transition cursor-pointer" onclick="window.salesTools?.openCommissionCalculator()">
                  <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-green-100 dark:bg-green-900/30 rounded-lg">
                      <i data-lucide="dollar-sign" class="w-6 h-6 text-green-600 dark:text-green-400"></i>
                    </div>
                  </div>
                  <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Commission Calculator</h4>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Calculate commission based on deal value</p>
                </div>

                <!-- Pricing Guide Card -->
                <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 shadow-nfg hover:shadow-lg transition cursor-pointer" onclick="window.salesTools?.openPricingGuide()">
                  <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg">
                      <i data-lucide="file-text" class="w-6 h-6 text-purple-600 dark:text-purple-400"></i>
                    </div>
                  </div>
                  <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Pricing Guide</h4>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Reference guide for standard pricing</p>
                </div>
              </div>
            </div>

            <!-- Templates & Scripts Section -->
            <div class="mb-8">
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-nfgblue dark:text-blue-400"></i>
                Templates & Scripts
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Email Templates Card -->
                <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 shadow-nfg hover:shadow-lg transition cursor-pointer" onclick="window.salesTools?.openEmailTemplates()">
                  <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg">
                      <i data-lucide="mail" class="w-6 h-6 text-orange-600 dark:text-orange-400"></i>
                    </div>
                  </div>
                  <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Email Templates</h4>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Pre-written email templates for common scenarios</p>
                </div>

                <!-- Call Scripts Card -->
                <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 shadow-nfg hover:shadow-lg transition cursor-pointer" onclick="window.salesTools?.openCallScripts()">
                  <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-lg">
                      <i data-lucide="phone" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                    </div>
                  </div>
                  <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Call Scripts</h4>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Scripts for cold calls, follow-ups, and objections</p>
                </div>

                <!-- Quote Templates Card -->
                <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 shadow-nfg hover:shadow-lg transition cursor-pointer" onclick="window.salesTools?.openQuoteTemplates()">
                  <div class="flex items-start justify-between mb-4">
                    <div class="p-3 bg-indigo-100 dark:bg-indigo-900/30 rounded-lg">
                      <i data-lucide="file-check" class="w-6 h-6 text-indigo-600 dark:text-indigo-400"></i>
                    </div>
                  </div>
                  <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Quote Templates</h4>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Quick access to saved quote templates</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Team Tab -->
        <div id="tab-team" class="sales-tab-content hidden h-full overflow-y-auto p-4 md:p-6">
          <!-- Statistics Header -->
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Revenue</p>
              <p id="team-total-revenue" class="text-2xl font-semibold text-green-600 dark:text-green-400">$0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">This Month</p>
              <p id="team-month-revenue" class="text-2xl font-semibold text-green-600 dark:text-green-400">$0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Active Deals</p>
              <p id="team-active-deals" class="text-2xl font-semibold text-blue-600 dark:text-blue-400">0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Portfolio Size</p>
              <p id="team-portfolio-size" class="text-2xl font-semibold text-purple-600 dark:text-purple-400">0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Win Rate</p>
              <p id="team-win-rate" class="text-2xl font-semibold text-indigo-600 dark:text-indigo-400">0%</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Avg Deal Value</p>
              <p id="team-avg-deal" class="text-2xl font-semibold text-yellow-600 dark:text-yellow-400">$0</p>
            </div>
            <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl p-4 shadow-nfg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Pipeline Value</p>
              <p id="team-pipeline-value" class="text-2xl font-semibold text-nfgblue dark:text-blue-400">$0</p>
            </div>
          </div>

          <!-- Search & Filter Bar -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
              <!-- Search -->
              <div class="flex-1">
                <div class="relative">
                  <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                  <input 
                    type="search" 
                    id="team-search-input" 
                    placeholder="Search by name, email, or phone..." 
                    class="w-full pl-10 pr-4 py-2 border border-nfgray rounded-xl focus:ring-2 focus:ring-nfgblue outline-none dark:bg-gray-700 dark:border-gray-600"
                  />
                </div>
              </div>
              
              <!-- Role Filter -->
              <select 
                id="team-role-filter" 
                class="px-4 py-2 border border-nfgray rounded-xl focus:ring-2 focus:ring-nfgblue outline-none dark:bg-gray-700 dark:border-gray-600"
              >
                <option value="all">All Roles</option>
                <option value="admin">Admin</option>
                <option value="staff">Staff</option>
                <option value="client">Client</option>
              </select>
              
              <!-- Status Filter -->
              <select 
                id="team-status-filter" 
                class="px-4 py-2 border border-nfgray rounded-xl focus:ring-2 focus:ring-nfgblue outline-none dark:bg-gray-700 dark:border-gray-600"
              >
                <option value="all">All Status</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="inactive">Inactive</option>
                <option value="suspended">Suspended</option>
              </select>
              
              <!-- Sort -->
              <select 
                id="team-sort-select" 
                class="px-4 py-2 border border-nfgray rounded-xl focus:ring-2 focus:ring-nfgblue outline-none dark:bg-gray-700 dark:border-gray-600"
              >
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
                <option value="revenue-desc">Revenue (High to Low)</option>
                <option value="revenue-asc">Revenue (Low to High)</option>
                <option value="winrate-desc">Win Rate (High to Low)</option>
                <option value="deals-desc">Active Deals (Most)</option>
                <option value="active-desc">Last Active</option>
              </select>
              
              <!-- Clear Filters -->
              <button 
                id="team-clear-filters-btn" 
                class="px-4 py-2 border border-nfgray rounded-xl hover:bg-nfglight dark:hover:bg-gray-700 transition whitespace-nowrap"
              >
                Clear
              </button>
            </div>
          </div>

          <!-- Employee Cards Grid -->
          <div id="team-employees-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Employee cards will be rendered here -->
            <div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">
              Loading employees...
            </div>
          </div>
        </div>

      </div>

      <!-- Deal Detail View (Modal Overlay) -->
      <div id="deal-detail-view" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Deal Details</h3>
            <div class="flex items-center gap-2">
              <button id="edit-deal-btn" class="px-3 py-1.5 text-sm border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition inline-flex items-center gap-2">
                <i data-lucide="edit" class="w-4 h-4"></i> Edit
              </button>
              <button id="delete-deal-btn" class="px-3 py-1.5 text-sm border border-red-300 dark:border-red-700 hover:bg-red-50 dark:hover:bg-red-900 text-red-600 dark:text-red-400 rounded-lg transition inline-flex items-center gap-2">
                <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
              </button>
              <button id="close-deal-detail" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i data-lucide="x" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
          <div class="flex-1 overflow-y-auto p-4 md:p-6">
          <!-- Deal Header -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
              <div class="flex-1">
                <h2 id="deal-detail-name" class="text-2xl font-semibold text-nfgblue dark:text-blue-400 mb-2">Deal Name</h2>
                <p id="deal-detail-site" class="text-gray-500 dark:text-gray-400">Site Name</p>
              </div>
              <div class="flex items-center gap-2">
                <span id="deal-detail-status" class="px-3 py-1 rounded-lg text-sm font-medium bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300">Active</span>
                <span id="deal-detail-priority" class="px-3 py-1 rounded-lg text-sm font-medium bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">High</span>
              </div>
            </div>
            
            <!-- Health Score -->
            <div class="mb-4">
              <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Deal Health</span>
                <span id="deal-health-score" class="text-sm font-semibold text-nfgblue dark:text-blue-400">50%</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                <div id="deal-health-bar" class="health-bar h-2 rounded-full" style="width: 50%"></div>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="flex flex-wrap gap-2">
              <button id="call-deal-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="phone" class="w-4 h-4"></i> Call
              </button>
              <button id="text-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="message-square" class="w-4 h-4"></i> Text
              </button>
              <button id="email-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="mail" class="w-4 h-4"></i> Email
              </button>
              <button id="proposal-email-deal-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4"></i> Proposal
              </button>
              <button id="create-quote-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="file-text" class="w-4 h-4"></i> Create Quote
              </button>
              <button id="set-appointment-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
                <i data-lucide="calendar" class="w-4 h-4"></i> Set Appointment
              </button>
            </div>
          </div>

          <!-- Timeline Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Activity Timeline</h3>
              <button type="button" id="log-activity-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition inline-flex items-center gap-2">
                <i data-lucide="plus" class="w-4 h-4"></i> Log Activity
              </button>
            </div>
            <div id="timeline-container" class="space-y-4">
              <!-- Timeline items will be rendered here -->
            </div>
          </div>

          <!-- Log Activity Modal (deal detail) -->
          <div id="deal-log-activity-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-hidden flex flex-col">
              <div class="p-4 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400" id="deal-log-activity-modal-title">Log Activity</h3>
                <button type="button" id="close-deal-log-activity-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
              <form id="deal-log-activity-form" class="flex-1 overflow-y-auto p-6 space-y-4">
                <input type="hidden" id="deal-log-activity-deal-id" value="">
                <input type="hidden" id="activity-edit-id" value="">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
                  <select id="activity-type" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                    <option value="call">Call</option>
                    <option value="email">Email</option>
                    <option value="meeting">Meeting</option>
                    <option value="note">Note</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Date</label>
                  <input type="datetime-local" id="activity-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Outcome</label>
                  <select id="activity-outcome" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                    <option value="">â€”</option>
                    <option value="contact_made">Contact made</option>
                    <option value="no_contact">No contact</option>
                    <option value="voicemail">Voicemail</option>
                    <option value="scheduled">Scheduled</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="email_sent">Email sent</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                  <textarea id="activity-notes" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Optional notes"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                  <button type="button" id="cancel-deal-log-activity" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition">Cancel</button>
                  <button type="submit" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">Save</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Post-Call Next Action Panel -->
          <div id="post-call-panel" class="hidden bg-nfglight dark:bg-gray-700 border border-nfgray dark:border-gray-600 rounded-xl p-6 mb-6">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Next Action</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Action</label>
                <input type="text" id="next-action-input" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Follow up in 3 days">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Date</label>
                <input type="datetime-local" id="next-action-date-input" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              </div>
              <button id="save-next-action-btn" class="w-full px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
                Save Next Action
              </button>
            </div>
          </div>

          <!-- Deal Information Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-4">Deal Information</h3>
            <div class="space-y-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deal Owner</label>
                <div id="deal-detail-owner" class="text-sm text-gray-600 dark:text-gray-400">Loading...</div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
                <div id="deal-detail-notes" class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap">No notes</div>
              </div>
            </div>
          </div>

          <!-- Quotes Section -->
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-6 mb-6 shadow-nfg">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Quotes</h3>
              <button id="new-quote-btn" class="px-3 py-1.5 text-sm bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                New Quote
              </button>
            </div>
            <div id="quotes-container" class="space-y-3">
              <!-- Quotes will be rendered here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Deal Modal -->
      <div id="edit-deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Edit Deal</h3>
            <button id="close-edit-deal-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-6">
            <form id="edit-deal-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title</label>
                <input type="text" id="edit-deal-title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stage</label>
                <select id="edit-deal-stage" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                  <option value="qualification">Qualification</option>
                  <option value="proposal">Proposal</option>
                  <option value="negotiation">Negotiation</option>
                  <option value="closed_won">Closed Won</option>
                  <option value="closed_lost">Closed Lost</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deal Value ($)</label>
                <input type="number" id="edit-deal-value" step="0.01" min="0" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0.00">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
                <textarea id="edit-deal-notes" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800"></textarea>
              </div>

              <div class="flex justify-end gap-3 pt-4">
                <button type="button" id="cancel-edit-deal" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition">
                  Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg transition">
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Delete Deal Confirmation Modal -->
      <div id="delete-deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full p-6">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center flex-shrink-0">
              <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Delete Deal</h3>
              <p class="text-sm text-gray-500 dark:text-gray-400">This action cannot be undone</p>
            </div>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
            Are you sure you want to delete this deal? All associated data will be permanently removed.
          </p>
          <div class="flex justify-end gap-3">
            <button id="cancel-delete-deal" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition">
              Cancel
            </button>
            <button id="confirm-delete-deal" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition">
              Delete Deal
            </button>
          </div>
        </div>
      </div>

      <!-- Compose Email / Proposal Modal -->
      <div id="compose-email-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
          <div class="p-4 border-b border-nfgray dark:border-gray-700 flex items-center justify-between">
            <h3 id="compose-modal-title" class="text-lg font-semibold text-nfgblue dark:text-blue-400">Compose Email</h3>
            <button type="button" id="close-compose-modal" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <input type="hidden" id="compose-deal-id">
            <input type="hidden" id="compose-type" value="follow_up">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">To</label>
              <input type="email" id="compose-to" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="recipient@example.com" readonly>
            </div>
            <div class="flex items-end gap-2">
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject</label>
                <input type="text" id="compose-subject" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Email subject">
              </div>
              <button type="button" id="compose-use-template-btn" class="px-4 py-2 border border-nfgblue dark:border-blue-500 text-nfgblue dark:text-blue-400 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2 whitespace-nowrap">
                <i data-lucide="file-text" class="w-4 h-4"></i> Use template
              </button>
            </div>
            <div id="compose-template-picker" class="hidden rounded-lg border border-nfgray dark:border-gray-600 bg-nfglight dark:bg-gray-700 p-3 space-y-2">
              <p class="text-xs font-medium text-gray-600 dark:text-gray-400">Choose a template (merge fields will be filled from this deal):</p>
              <div id="compose-template-list" class="max-h-40 overflow-y-auto space-y-1">
                <!-- Templates loaded by JS -->
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Body</label>
              <textarea id="compose-body" rows="12" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Email or proposal text... Use {contact_name}, {company_name}, {site_name}, {deal_value} for merge fields."></textarea>
            </div>
          </div>
          <div class="p-4 border-t border-nfgray dark:border-gray-700 flex justify-end gap-3">
            <button type="button" id="compose-copy-btn" class="px-4 py-2 border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
              <i data-lucide="copy" class="w-4 h-4"></i> Copy
            </button>
            <button type="button" id="compose-send-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium transition inline-flex items-center gap-2">
              <i data-lucide="send" class="w-4 h-4"></i> Send
            </button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Log Activity Modal (placed outside main for proper z-index stacking) -->
  <div id="log-activity-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4" style="z-index: 9999;">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-lg w-full">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Log Activity</h3>
        <button type="button" id="close-activity-modal" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 cursor-pointer" onclick="closeActivityModal()">
          <i data-lucide="x" class="w-5 h-5 pointer-events-none"></i>
        </button>
      </div>
      <form id="log-activity-form" class="p-4 space-y-4">
        <input type="hidden" id="activity-deal-id">
        
        <!-- Deal Info Banner -->
        <div id="activity-deal-info" class="p-3 bg-nfglight dark:bg-gray-700 rounded-lg">
          <p class="font-medium text-nfgblue dark:text-blue-400" id="activity-deal-name">Deal Name</p>
          <p class="text-sm text-gray-600 dark:text-gray-400">
            Contact attempts: <span id="activity-attempt-count">0</span> | 
            No-contact streak: <span id="activity-streak-count" class="font-semibold">0</span>/3
          </p>
        </div>
        
        <!-- Activity Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Activity Type</label>
          <div class="grid grid-cols-4 gap-2">
            <button type="button" class="activity-type-btn p-3 border-2 border-nfgblue bg-nfgblue text-white rounded-lg text-center transition cursor-pointer" data-type="call" onclick="selectActivityType('call')">
              <i data-lucide="phone" class="w-5 h-5 mx-auto mb-1 pointer-events-none"></i>
              <span class="text-xs pointer-events-none">Call</span>
            </button>
            <button type="button" class="activity-type-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue rounded-lg text-center transition cursor-pointer" data-type="email" onclick="selectActivityType('email')">
              <i data-lucide="mail" class="w-5 h-5 mx-auto mb-1 pointer-events-none"></i>
              <span class="text-xs pointer-events-none">Email</span>
            </button>
            <button type="button" class="activity-type-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue rounded-lg text-center transition cursor-pointer" data-type="meeting" onclick="selectActivityType('meeting')">
              <i data-lucide="users" class="w-5 h-5 mx-auto mb-1 pointer-events-none"></i>
              <span class="text-xs pointer-events-none">Meeting</span>
            </button>
            <button type="button" class="activity-type-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue rounded-lg text-center transition cursor-pointer" data-type="walkthrough" onclick="selectActivityType('walkthrough')">
              <i data-lucide="map-pin" class="w-5 h-5 mx-auto mb-1 pointer-events-none"></i>
              <span class="text-xs pointer-events-none">Site Visit</span>
            </button>
          </div>
        </div>
        
        <!-- Outcome -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Outcome</label>
          <div class="grid grid-cols-2 gap-3">
            <button type="button" class="activity-outcome-btn p-3 border-2 border-green-500 bg-green-500 text-white rounded-lg flex items-center justify-center gap-2 transition cursor-pointer" data-outcome="contact_made" onclick="selectOutcome('contact_made')">
              <i data-lucide="check-circle" class="w-5 h-5 pointer-events-none"></i>
              <span class="pointer-events-none">Contact Made</span>
            </button>
            <button type="button" class="activity-outcome-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-red-500 rounded-lg flex items-center justify-center gap-2 transition cursor-pointer" data-outcome="no_contact" onclick="selectOutcome('no_contact')">
              <i data-lucide="x-circle" class="w-5 h-5 pointer-events-none"></i>
              <span class="pointer-events-none">No Contact</span>
            </button>
            <button type="button" class="activity-outcome-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-yellow-500 rounded-lg flex items-center justify-center gap-2 transition cursor-pointer" data-outcome="voicemail" onclick="selectOutcome('voicemail')">
              <i data-lucide="voicemail" class="w-5 h-5 pointer-events-none"></i>
              <span class="pointer-events-none">Voicemail</span>
            </button>
            <button type="button" class="activity-outcome-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-blue-500 rounded-lg flex items-center justify-center gap-2 transition cursor-pointer" data-outcome="scheduled" onclick="selectOutcome('scheduled')">
              <i data-lucide="calendar-check" class="w-5 h-5 pointer-events-none"></i>
              <span class="pointer-events-none">Scheduled</span>
            </button>
          </div>
        </div>
        
        <!-- Warning for No Contact -->
        <div id="no-contact-warning" class="hidden p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <div class="flex items-center gap-2 text-red-700 dark:text-red-400">
            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
            <span id="no-contact-warning-text" class="text-sm font-medium">This will be attempt 2 of 3</span>
          </div>
        </div>
        
        <!-- Notes -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
          <textarea id="activity-notes" rows="2" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 resize-none" placeholder="What was discussed?"></textarea>
        </div>
        
        <!-- Next Action -->
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Next Action</label>
            <select id="activity-next-action" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="">None scheduled</option>
              <option value="call">Follow-up Call</option>
              <option value="email">Send Email</option>
              <option value="meeting">Schedule Meeting</option>
              <option value="walkthrough">Schedule Walkthrough</option>
              <option value="quote">Send Quote</option>
              <option value="close">Close Deal</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">When</label>
            <input type="datetime-local" id="activity-next-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
          </div>
        </div>
        
        <!-- Actions -->
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="cancel-activity" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg transition cursor-pointer" onclick="closeActivityModal()">
            Cancel
          </button>
          <button type="button" id="save-activity-btn" class="px-6 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition flex items-center gap-2 cursor-pointer" onclick="submitActivity()">
            <i data-lucide="save" class="w-4 h-4 pointer-events-none"></i>
            <span class="pointer-events-none">Save Activity</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Account/Contact Modal -->
  <div id="create-account-modal" class="hidden fixed inset-0 bg-black/40 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 id="create-modal-title" class="text-lg font-semibold text-nfgblue dark:text-blue-400">Create Account</h3>
        <button id="create-account-close" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="create-account-form" class="p-4 space-y-4">
        <!-- Contact Type Selector -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contact Type</label>
          <div class="grid grid-cols-2 gap-3">
            <button type="button" id="contact-type-account" class="contact-type-btn p-3 border-2 border-nfgblue bg-nfgblue text-white rounded-xl font-medium transition cursor-pointer text-center">
              <i data-lucide="building-2" class="w-5 h-5 mx-auto mb-1"></i>
              <span>Account</span>
            </button>
            <button type="button" id="contact-type-contact" class="contact-type-btn p-3 border-2 border-nfgray dark:border-gray-600 hover:border-nfgblue dark:hover:border-blue-400 rounded-xl bg-white dark:bg-gray-800 transition cursor-pointer text-center">
              <i data-lucide="user" class="w-5 h-5 mx-auto mb-1"></i>
              <span>Contact</span>
            </button>
          </div>
        </div>

        <!-- Account Fields (shown when Account is selected) -->
        <div id="account-fields" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name <span class="text-red-500">*</span></label>
            <input name="name" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
              <select name="status" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
                <option value="prospect">Prospect</option>
                <option value="in_progress">In Progress</option>
                <option value="active">Active Client</option>
                <option value="dormant">Dormant</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Industry</label>
              <select name="industry" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
                <option value="">Select Industry</option>
                <option value="healthcare">Healthcare</option>
                <option value="real_estate">Real Estate</option>
                <option value="hospitality">Hospitality</option>
                <option value="retail">Retail</option>
                <option value="education">Education</option>
                <option value="manufacturing">Manufacturing</option>
                <option value="construction">Construction</option>
                <option value="property_management">Property Management</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
              <input name="account_phone" type="tel" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="(555) 123-4567">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
              <input name="account_email" type="email" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="info@company.com">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Website</label>
            <input name="website" type="url" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="https://www.company.com">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">HQ Address</label>
              <input name="hq_address" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City</label>
              <input name="city" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
            </div>
          </div>

          <!-- Decision Maker Section -->
          <div class="border-t border-nfgray dark:border-gray-700 pt-4 mt-4">
            <div class="flex items-center justify-between mb-3">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Decision Maker (Primary Contact)</label>
              <button type="button" id="toggle-dm-fields" class="text-xs text-nfgblue hover:underline flex items-center gap-1">
                <i data-lucide="plus" class="w-3 h-3"></i> Add Contact
              </button>
            </div>
            <div id="dm-fields" class="hidden space-y-3 p-3 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">First Name</label>
                  <input name="dm_first_name" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-800">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Last Name</label>
                  <input name="dm_last_name" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-800">
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Title/Role</label>
                <input name="dm_title" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-800" placeholder="e.g., Operations Manager">
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Phone</label>
                  <input name="dm_phone" type="tel" class="w-full border border-nfgray dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-800">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Email</label>
                  <input name="dm_email" type="email" class="w-full border border-nfgray dark:border-gray-600 rounded-lg px-3 py-2 text-sm bg-white dark:bg-gray-800">
                </div>
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
            <textarea name="notes" rows="2" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="Any additional notes about this account..."></textarea>
          </div>
        </div>

        <!-- Contact Fields (shown when Contact is selected) -->
        <div id="contact-fields" class="hidden space-y-4">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name <span class="text-red-500">*</span></label>
              <input name="first_name" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name <span class="text-red-500">*</span></label>
              <input name="last_name" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
            <input name="email" type="email" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
            <input name="phone" type="tel" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title</label>
            <input name="title" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="e.g., Manager, Director">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name</label>
            <input name="company_name" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address</label>
            <input name="address" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City</label>
            <input name="contact_city" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="create-account-cancel" class="px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
            Cancel
          </button>
          <button type="submit" id="create-submit-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg">
            Create
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Contact Detail Modal (View Mode) - Enhanced with Sales Flow -->
  <div id="contact-detail-modal" class="hidden fixed inset-0 bg-black/40 z-[80] flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl border border-nfgray dark:border-gray-700 my-4">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Contact Details</h3>
        <button id="contact-detail-close" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Left Column: Contact Info -->
          <div>
            <!-- Contact Avatar & Name -->
            <div class="text-center mb-4">
              <div class="w-16 h-16 bg-nfglight dark:bg-gray-700 rounded-full mx-auto flex items-center justify-center mb-2">
                <i data-lucide="user" class="w-8 h-8 text-nfgblue dark:text-blue-400"></i>
              </div>
              <h4 id="detail-contact-name" class="text-lg font-semibold text-gray-900 dark:text-white"></h4>
              <p id="detail-contact-title" class="text-sm text-gray-500 dark:text-gray-400"></p>
            </div>
            
            <!-- Sales Status Badge -->
            <div id="detail-contact-status-section" class="mb-4 text-center">
              <span id="detail-contact-status" class="px-3 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">New</span>
              <span id="detail-contact-streak" class="ml-2 px-2 py-1 text-xs font-bold rounded hidden"></span>
            </div>
            
            <!-- Contact Info -->
            <div class="space-y-3">
              <div class="flex items-center gap-3 p-2 bg-nfglight dark:bg-gray-700 rounded-lg">
                <i data-lucide="building" class="w-4 h-4 text-gray-500"></i>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 dark:text-gray-400">Company</p>
                  <p id="detail-contact-company" class="text-sm font-medium text-gray-900 dark:text-white"></p>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 bg-nfglight dark:bg-gray-700 rounded-lg">
                <i data-lucide="phone" class="w-4 h-4 text-gray-500"></i>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 dark:text-gray-400">Phone</p>
                  <p id="detail-contact-phone" class="text-sm font-medium text-gray-900 dark:text-white"></p>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 bg-nfglight dark:bg-gray-700 rounded-lg">
                <i data-lucide="mail" class="w-4 h-4 text-gray-500"></i>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 dark:text-gray-400">Email</p>
                  <p id="detail-contact-email" class="text-sm font-medium text-gray-900 dark:text-white"></p>
                </div>
              </div>
              <div class="flex items-center gap-3 p-2 bg-nfglight dark:bg-gray-700 rounded-lg">
                <i data-lucide="map-pin" class="w-4 h-4 text-gray-500"></i>
                <div class="flex-1">
                  <p class="text-xs text-gray-500 dark:text-gray-400">Location</p>
                  <p id="detail-contact-location" class="text-sm font-medium text-gray-900 dark:text-white"></p>
                </div>
              </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-2 mt-4">
              <div class="text-center p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <p id="detail-contact-attempts" class="text-lg font-bold text-nfgblue">0</p>
                <p class="text-xs text-gray-500">Attempts</p>
              </div>
              <div class="text-center p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <p id="detail-contact-connected" class="text-lg font-bold text-green-600">0</p>
                <p class="text-xs text-gray-500">Connected</p>
              </div>
              <div class="text-center p-2 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <p id="detail-contact-days" class="text-lg font-bold text-gray-600">â€”</p>
                <p class="text-xs text-gray-500">Days Idle</p>
              </div>
            </div>
            
            <!-- Next Follow-up -->
            <div id="detail-next-followup-section" class="mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg hidden">
              <p class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">NEXT FOLLOW-UP</p>
              <p id="detail-next-followup" class="text-sm font-semibold text-yellow-800 dark:text-yellow-200"></p>
            </div>
          </div>
          
          <!-- Right Column: Activity Timeline -->
          <div>
            <div class="flex items-center justify-between mb-3">
              <h5 class="font-semibold text-gray-900 dark:text-white">Activity Timeline</h5>
              <button id="detail-log-activity-btn" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-medium transition flex items-center gap-1">
                <i data-lucide="plus" class="w-3.5 h-3.5"></i> Log Activity
              </button>
            </div>
            
            <!-- Timeline -->
            <div id="detail-activity-timeline" class="space-y-3 max-h-80 overflow-y-auto pr-2">
              <div class="text-center py-8 text-gray-400">
                <i data-lucide="clock" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                <p class="text-sm">No activities yet</p>
                <p class="text-xs">Click "Log Activity" to record your first call</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex gap-3 mt-6 pt-4 border-t border-nfgray dark:border-gray-700">
          <button id="detail-call-btn" class="flex-1 px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-xl font-medium transition flex items-center justify-center gap-2">
            <i data-lucide="phone" class="w-4 h-4"></i> Call
          </button>
          <button id="contact-detail-edit-btn" class="flex-1 px-4 py-2.5 bg-nfgblue hover:bg-nfgdark text-white rounded-xl font-medium transition flex items-center justify-center gap-2">
            <i data-lucide="edit" class="w-4 h-4"></i> Edit
          </button>
          <button id="contact-detail-delete-btn" class="px-4 py-2.5 border border-red-300 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl font-medium transition flex items-center justify-center gap-2">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Contact Modal -->
  <div id="edit-contact-modal" class="hidden fixed inset-0 bg-black/40 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Edit Contact</h3>
        <button id="edit-contact-close" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="edit-contact-form" class="p-4 space-y-4">
        <input type="hidden" id="edit-contact-id" name="contact_id">
        
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name <span class="text-red-500">*</span></label>
            <input id="edit-first-name" name="first_name" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name <span class="text-red-500">*</span></label>
            <input id="edit-last-name" name="last_name" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
          <input id="edit-email" name="email" type="email" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
          <input id="edit-phone" name="phone" type="tel" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title</label>
          <input id="edit-title" name="title" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="e.g., Manager, Director">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name</label>
          <input id="edit-company-name" name="company_name" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address</label>
          <input id="edit-address" name="address" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City</label>
          <input id="edit-city" name="city" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>

        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="edit-contact-cancel" class="px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg">
            Save Changes
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Account Drawer (Slide-in from right) -->
  <div id="account-drawer" class="hidden fixed inset-y-0 right-0 w-full max-w-lg bg-white dark:bg-gray-800 shadow-2xl z-[9999] transform transition-transform overflow-y-auto">
    <div class="sticky top-0 bg-white dark:bg-gray-800 border-b border-nfgray dark:border-gray-700 p-4 flex items-center justify-between z-10">
      <h2 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Account Details</h2>
      <button id="close-account-drawer" onclick="window.accountsDirectory?.closeAccountDrawer()" class="p-2 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg">
        <i data-lucide="x" class="w-5 h-5"></i>
      </button>
    </div>
    
    <div class="p-4 space-y-6">
      <!-- Company Summary -->
      <div id="drawer-company-summary" class="border-b border-nfgray dark:border-gray-700 pb-4">
        <!-- Populated by JS -->
      </div>
      
      <!-- Decision Maker Section -->
      <div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2">
          <i data-lucide="user-check" class="w-4 h-4"></i> Decision Maker
        </h3>
        <div id="drawer-decision-maker">
          <!-- Populated by JS -->
        </div>
      </div>
      
      <!-- Contacts Section -->
      <div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2">
          <i data-lucide="users" class="w-4 h-4"></i> Contacts
        </h3>
        <div id="drawer-contacts-list" class="space-y-2">
          <!-- Populated by JS -->
        </div>
      </div>
      
      <!-- Sites Section -->
      <div>
        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-3 flex items-center gap-2">
          <i data-lucide="building" class="w-4 h-4"></i> Sites
        </h3>
        <div id="drawer-sites-list" class="space-y-2">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Account Drawer Backdrop -->
  <div id="account-drawer-backdrop" class="hidden fixed inset-0 bg-black/40 z-[9998]" onclick="window.accountsDirectory?.closeAccountDrawer()"></div>

  <!-- Add Contact to Account Modal -->
  <div id="add-contact-modal" class="hidden fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Add Contact to Account</h3>
        <button onclick="closeAddContactModal()" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 pointer-events-none"></i>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="flex border-b border-nfgray dark:border-gray-700">
        <button id="add-contact-tab-existing" onclick="switchAddContactTab('existing')" class="flex-1 px-4 py-3 text-sm font-medium text-nfgblue border-b-2 border-nfgblue">
          Select Existing
        </button>
        <button id="add-contact-tab-new" onclick="switchAddContactTab('new')" class="flex-1 px-4 py-3 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-nfgblue">
          Create New
        </button>
      </div>
      
      <!-- Select Existing Contact Tab -->
      <div id="add-contact-existing-tab" class="p-4">
        <div class="mb-3">
          <input id="existing-contact-search" type="text" placeholder="Search contacts..." class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" oninput="filterExistingContacts(this.value)">
        </div>
        <div id="existing-contacts-list" class="space-y-2 max-h-64 overflow-y-auto">
          <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">Loading contacts...</p>
        </div>
      </div>
      
      <!-- Create New Contact Tab -->
      <div id="add-contact-new-tab" class="hidden">
        <form id="add-contact-form" class="p-4 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name <span class="text-red-500">*</span></label>
            <input name="full_name" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title/Role</label>
            <input name="title" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="e.g., Property Manager">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
              <input name="phone" type="tel" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
              <input name="email" type="email" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Role Tag</label>
            <select name="role_tag" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
              <option value="other">Other</option>
              <option value="decision_maker">Decision Maker</option>
              <option value="admin">Admin</option>
              <option value="facilities">Facilities</option>
              <option value="billing">Billing</option>
            </select>
          </div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" onclick="closeAddContactModal()" class="px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg">Create & Add</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Site to Account Modal -->
  <div id="add-site-modal" class="hidden fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Add Site to Account</h3>
        <button onclick="document.getElementById('add-site-modal').classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="add-site-form" class="p-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Site Name <span class="text-red-500">*</span></label>
          <input name="name" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="e.g., Main Office, Warehouse A">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Address <span class="text-red-500">*</span></label>
          <input name="address" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City</label>
          <input name="city" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="document.getElementById('add-site-modal').classList.add('hidden')" class="px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg">Add Site</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Set Decision Maker Modal -->
  <div id="set-dm-modal" class="hidden fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Set Decision Maker</h3>
        <button onclick="document.getElementById('set-dm-modal').classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-4">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Select a contact to set as the Decision Maker for this account:</p>
        <div id="set-dm-contacts-list" class="space-y-2 max-h-64 overflow-y-auto">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Account Modal -->
  <div id="edit-account-modal" class="hidden fixed inset-0 bg-black/40 z-[10000] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Edit Account</h3>
        <button onclick="document.getElementById('edit-account-modal').classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="edit-account-form" class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
        <input type="hidden" id="edit-account-id" name="account_id">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Company Name <span class="text-red-500">*</span></label>
          <input id="edit-account-name" name="name" type="text" required class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
            <select id="edit-account-status" name="status" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
              <option value="prospect">Prospect</option>
              <option value="in_progress">In Progress</option>
              <option value="active">Active Client</option>
              <option value="dormant">Dormant</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Industry</label>
            <select id="edit-account-industry" name="industry" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
              <option value="">Select Industry</option>
              <option value="healthcare">Healthcare</option>
              <option value="real_estate">Real Estate</option>
              <option value="hospitality">Hospitality</option>
              <option value="retail">Retail</option>
              <option value="education">Education</option>
              <option value="manufacturing">Manufacturing</option>
              <option value="construction">Construction</option>
              <option value="property_management">Property Management</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Phone</label>
            <input id="edit-account-phone" name="phone" type="tel" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
            <input id="edit-account-email" name="email" type="email" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Website</label>
          <input id="edit-account-website" name="website" type="url" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">HQ Address</label>
            <input id="edit-account-hq-address" name="hq_address" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">City</label>
            <input id="edit-account-city" name="city" type="text" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes</label>
          <textarea id="edit-account-notes" name="notes" rows="3" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800"></textarea>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" onclick="document.getElementById('edit-account-modal').classList.add('hidden')" class="px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Employee Details Modal -->
  <div id="employee-detail-modal" class="hidden fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div id="emp-detail-avatar" class="w-12 h-12 rounded-full bg-nfgblue flex items-center justify-center text-white font-bold"></div>
          <div>
            <h3 id="emp-detail-name" class="text-lg font-semibold text-gray-900 dark:text-white"></h3>
            <p id="emp-detail-email" class="text-sm text-gray-500 dark:text-gray-400"></p>
          </div>
        </div>
        <button onclick="document.getElementById('employee-detail-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700 text-gray-500">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-4">
        <!-- Stats Summary -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="emp-detail-deals">0</p>
            <p class="text-xs text-gray-600 dark:text-gray-400">Active Deals</p>
          </div>
          <div class="bg-green-50 dark:bg-green-900/20 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="emp-detail-revenue">$0</p>
            <p class="text-xs text-gray-600 dark:text-gray-400">Revenue</p>
          </div>
          <div class="bg-purple-50 dark:bg-purple-900/20 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-purple-600 dark:text-purple-400" id="emp-detail-winrate">0%</p>
            <p class="text-xs text-gray-600 dark:text-gray-400">Win Rate</p>
          </div>
          <div class="bg-orange-50 dark:bg-orange-900/20 rounded-xl p-4 text-center">
            <p class="text-2xl font-bold text-orange-600 dark:text-orange-400" id="emp-detail-portfolio">0</p>
            <p class="text-xs text-gray-600 dark:text-gray-400">Portfolio Size</p>
          </div>
        </div>
        
        <!-- Employee Info -->
        <div class="mb-6 grid grid-cols-2 gap-4">
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Role</p>
            <p id="emp-detail-role" class="font-medium text-gray-900 dark:text-white"></p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Status</p>
            <p id="emp-detail-status" class="font-medium text-gray-900 dark:text-white"></p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Phone</p>
            <p id="emp-detail-phone" class="font-medium text-gray-900 dark:text-white"></p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3">
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Today's Goal</p>
            <p id="emp-detail-goal" class="font-medium text-gray-900 dark:text-white italic"></p>
          </div>
        </div>
        
        <!-- Deals List -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
            <i data-lucide="briefcase" class="w-4 h-4"></i>
            Deals
          </h4>
          <div id="emp-detail-deals-list" class="space-y-2">
            <!-- Deals will be rendered here -->
          </div>
        </div>
      </div>
      
      <div class="p-4 border-t border-nfgray dark:border-gray-700 flex justify-end gap-2">
        <button onclick="document.getElementById('employee-detail-modal')?.classList.add('hidden')" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Tools & Resources Modals -->
  
  <!-- ROI Calculator Modal -->
  <div id="roi-calculator-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">ROI Calculator</h3>
        <button onclick="document.getElementById('roi-calculator-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Monthly Cost <span class="text-red-500">*</span></label>
          <input type="number" id="roi-current-cost" step="0.01" min="0" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Proposed Monthly Cost <span class="text-red-500">*</span></label>
          <input type="number" id="roi-proposed-cost" step="0.01" min="0" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">One-time Setup Cost</label>
          <input type="number" id="roi-setup-cost" step="0.01" min="0" value="0" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="0.00">
        </div>
        <button onclick="window.salesTools?.calculateROI()" class="w-full px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium">
          Calculate ROI
        </button>
        <div id="roi-results" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- Commission Calculator Modal -->
  <div id="commission-calculator-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-lg border border-nfgray dark:border-gray-700">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Commission Calculator</h3>
        <button onclick="document.getElementById('commission-calculator-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Deal Value <span class="text-red-500">*</span></label>
          <input type="number" id="commission-deal-value" step="0.01" min="0" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="0.00">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Commission Rate (%) <span class="text-red-500">*</span></label>
          <input type="number" id="commission-rate" step="0.1" min="0" max="100" value="10" class="w-full border border-nfgray dark:border-gray-600 rounded-xl px-3 py-2 bg-white dark:bg-gray-800" placeholder="10">
        </div>
        <button onclick="window.salesTools?.calculateCommission()" class="w-full px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium">
          Calculate Commission
        </button>
        <div id="commission-results" class="hidden"></div>
      </div>
    </div>
  </div>

  <!-- Pricing Guide Modal -->
  <div id="pricing-guide-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Pricing Guide</h3>
        <button onclick="document.getElementById('pricing-guide-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <table class="w-full text-sm">
          <thead class="bg-nfglight dark:bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Service</th>
              <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Frequency</th>
              <th class="px-4 py-3 text-left font-medium text-nfgblue dark:text-blue-400">Price Range</th>
            </tr>
          </thead>
          <tbody id="pricing-guide-table-body" class="divide-y divide-nfgray dark:divide-gray-700">
            <!-- Pricing data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Email Templates Modal -->
  <div id="email-templates-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800 z-10">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Follow-up &amp; Proposal Templates</h3>
        <div class="flex items-center gap-2">
          <select id="email-templates-filter" class="px-3 py-1.5 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-sm">
            <option value="">All</option>
            <option value="follow_up">Follow-up</option>
            <option value="proposal">Proposal</option>
          </select>
          <button type="button" id="email-templates-new-btn" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium inline-flex items-center gap-1">
            <i data-lucide="plus" class="w-4 h-4"></i> New
          </button>
          <button onclick="document.getElementById('email-templates-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="email-templates-list" class="space-y-3">
          <!-- Templates will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Sales Template Form Modal (Create / Edit) -->
  <div id="sales-template-form-modal" class="hidden fixed inset-0 bg-black/40 z-[95] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700">
        <h3 id="sales-template-form-title" class="text-lg font-semibold text-nfgblue dark:text-blue-400">New Template</h3>
        <button type="button" id="sales-template-form-close" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <form id="sales-template-form" class="flex-1 overflow-y-auto p-4 space-y-4">
        <input type="hidden" id="sales-template-form-id">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Name</label>
          <input type="text" id="sales-template-form-name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g. Follow-up After Meeting" required>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Type</label>
          <select id="sales-template-form-type" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
            <option value="follow_up">Follow-up (email)</option>
            <option value="proposal">Proposal (email/document)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Subject (for email)</label>
          <input type="text" id="sales-template-form-subject" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g. Re: Proposal for {company_name}">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Body</label>
          <textarea id="sales-template-form-body" rows="10" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Hi {contact_name},&#10;&#10;..." required></textarea>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Merge fields: {contact_name}, {company_name}, {site_name}, {deal_value}, {contact_email}, {deal_title}</p>
        </div>
      </form>
      <div class="p-4 border-t border-nfgray dark:border-gray-700 flex justify-end gap-3">
        <button type="button" id="sales-template-form-cancel" class="px-4 py-2 border border-nfgray dark:border-gray-600 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg text-sm">Cancel</button>
        <button type="submit" form="sales-template-form" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-sm font-medium">Save</button>
      </div>
    </div>
  </div>

  <!-- Call Scripts Modal -->
  <div id="call-scripts-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-5xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-hidden flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Call Scripts</h3>
        <button onclick="document.getElementById('call-scripts-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <!-- Script Tabs -->
      <div class="flex gap-2 px-4 pt-4 border-b border-nfgray dark:border-gray-700 bg-white dark:bg-gray-800">
        <button onclick="switchCallScriptTab('script1')" id="call-script-tab-1" class="px-4 py-2 text-sm font-medium text-nfgblue dark:text-blue-400 border-b-2 border-nfgblue dark:border-blue-400">
          NFG Script
        </button>
        <button onclick="switchCallScriptTab('script2')" id="call-script-tab-2" class="px-4 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:text-nfgblue dark:hover:text-blue-400">
          Realtor Script
        </button>
      </div>
      <div class="flex-1 p-4">
        <!-- Script Board 1 -->
        <div id="call-script-content-1" class="h-full">
          <iframe 
            width="100%" 
            height="500" 
            src="https://miro.com/app/live-embed/uXjVJ9BVqMQ=/?embedMode=view_only_without_ui&moveToViewport=7698,-2906,4950,2557&embedId=266515558152" 
            frameborder="0" 
            scrolling="no" 
            allow="fullscreen; clipboard-read; clipboard-write" 
            allowfullscreen
            class="rounded-lg w-full"
          ></iframe>
        </div>
        <!-- Script Board 2 -->
        <div id="call-script-content-2" class="h-full hidden">
          <iframe 
            width="100%" 
            height="500" 
            src="https://miro.com/app/live-embed/uXjVGTbzzpQ=/?embedMode=view_only_without_ui&moveToViewport=-9570,-1014,5739,2965&embedId=271208307847" 
            frameborder="0" 
            scrolling="no" 
            allow="fullscreen; clipboard-read; clipboard-write" 
            allowfullscreen
            class="rounded-lg w-full"
          ></iframe>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    function switchCallScriptTab(tab) {
      const tab1 = document.getElementById('call-script-tab-1');
      const tab2 = document.getElementById('call-script-tab-2');
      const content1 = document.getElementById('call-script-content-1');
      const content2 = document.getElementById('call-script-content-2');
      
      if (tab === 'script1') {
        tab1?.classList.add('text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        tab1?.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
        tab2?.classList.remove('text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        tab2?.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
        content1?.classList.remove('hidden');
        content2?.classList.add('hidden');
      } else {
        tab2?.classList.add('text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        tab2?.classList.remove('text-gray-500', 'dark:text-gray-400', 'border-transparent');
        tab1?.classList.remove('text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        tab1?.classList.add('text-gray-500', 'dark:text-gray-400', 'border-transparent');
        content2?.classList.remove('hidden');
        content1?.classList.add('hidden');
      }
    }
  </script>

  <!-- Sales Playbooks Modal -->
  <div id="sales-playbooks-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Sales Playbooks</h3>
        <button onclick="document.getElementById('sales-playbooks-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <div id="sales-playbooks-list" class="space-y-3">
          <!-- Playbooks will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Product Knowledge Modal -->
  <div id="product-knowledge-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Product Knowledge</h3>
        <button onclick="document.getElementById('product-knowledge-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <div id="product-knowledge-list" class="space-y-3">
          <!-- Products will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Video Tutorials Modal -->
  <div id="video-tutorials-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Video Tutorials</h3>
        <button onclick="document.getElementById('video-tutorials-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <div id="video-tutorials-list" class="space-y-3">
          <!-- Tutorials will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- External Tools Modal -->
  <div id="external-tools-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">External Tools</h3>
        <button onclick="document.getElementById('external-tools-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <div id="external-tools-list" class="space-y-3">
          <!-- Tools will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Company Resources Modal -->
  <div id="company-resources-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Company Resources</h3>
        <button onclick="document.getElementById('company-resources-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <div id="company-resources-list" class="space-y-3">
          <!-- Resources will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Help & Support Modal -->
  <div id="help-support-modal" class="hidden fixed inset-0 bg-black/40 z-[90] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl border border-nfgray dark:border-gray-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between p-4 border-b border-nfgray dark:border-gray-700 sticky top-0 bg-white dark:bg-gray-800">
        <h3 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Help & Support</h3>
        <button onclick="document.getElementById('help-support-modal')?.classList.add('hidden')" class="p-2 rounded-lg hover:bg-nfglight dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <div class="p-6">
        <h4 class="font-semibold text-gray-900 dark:text-white mb-4">Frequently Asked Questions</h4>
        <div id="help-support-faq" class="space-y-3">
          <!-- FAQs will be loaded here -->
        </div>
        <div class="mt-6 pt-6 border-t border-nfgray dark:border-gray-700">
          <h4 class="font-semibold text-gray-900 dark:text-white mb-3">Need More Help?</h4>
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Contact support for additional assistance:</p>
          <div class="space-y-2">
            <a href="mailto:support@nfgone.ca" class="flex items-center gap-2 text-nfgblue dark:text-blue-400 hover:text-nfgdark dark:hover:text-blue-300">
              <i data-lucide="mail" class="w-4 h-4"></i>
              <span>support@nfgone.ca</span>
            </a>
            <a href="tel:+1234567890" class="flex items-center gap-2 text-nfgblue dark:text-blue-400 hover:text-nfgdark dark:hover:text-blue-300">
              <i data-lucide="phone" class="w-4 h-4"></i>
              <span>(123) 456-7890</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Deal Modal -->
  <div id="create-deal-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create New Lead/Deal</h3>
          <button id="close-create-deal-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="create-deal-form" class="p-6 space-y-6">
        <!-- Company Information -->
        <div class="border-b border-nfgray dark:border-gray-700 pb-4">
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Company Information</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Name <span class="text-red-500">*</span></label>
              <input type="text" id="deal-company-name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Enter company name" required>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Industry</label>
              <select id="deal-industry" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                <option value="">Select industry...</option>
                <option value="commercial_office">Commercial Office</option>
                <option value="medical_clinic">Medical Clinic</option>
                <option value="dental">Dental</option>
                <option value="restaurant">Restaurant</option>
                <option value="retail">Retail</option>
                <option value="industrial">Industrial</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address</label>
            <input type="text" id="deal-address" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Street address">
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City</label>
              <input type="text" id="deal-city" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="City">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Province</label>
              <input type="text" id="deal-province" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="ON">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Postal Code</label>
              <input type="text" id="deal-postal" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="A1A 1A1">
            </div>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="border-b border-nfgray dark:border-gray-700 pb-4">
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Primary Contact</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">First Name</label>
              <input type="text" id="deal-contact-first" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="First name">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Last Name</label>
              <input type="text" id="deal-contact-last" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Last name">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
              <input type="email" id="deal-contact-email" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="email@example.com">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
              <input type="tel" id="deal-contact-phone" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title/Role</label>
            <input type="text" id="deal-contact-title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Facilities Manager, Owner">
          </div>
        </div>

        <!-- Deal Details -->
        <div>
          <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-4">Deal Details</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Deal Title</label>
              <input type="text" id="deal-title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Monthly Cleaning Service">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stage</label>
              <select id="deal-stage-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                <option value="qualification" selected>Qualification</option>
                <option value="proposal">Proposal</option>
                <option value="negotiation">Negotiation</option>
                <option value="closed_won">Closed Won</option>
                <option value="closed_lost">Closed Lost</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
              <select id="deal-priority-select" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Estimated Value ($)</label>
              <input type="number" id="deal-value-input" step="0.01" min="0" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0.00">
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Expected Close Date</label>
            <input type="date" id="deal-close-date" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
            <textarea id="deal-notes-input" rows="4" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Add any notes about this lead/deal..."></textarea>
          </div>
        </div>

        <div class="flex gap-3 pt-4 border-t border-nfgray dark:border-gray-700">
          <button type="button" id="cancel-create-deal" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Create Lead/Deal
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Lead Modal -->
  <div id="create-lead-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Create New Lead</h3>
          <button id="close-create-lead-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="create-lead-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Company Name</label>
          <input type="text" name="company_name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Company name (optional)">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Person Name</label>
          <input type="text" name="person_name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Contact person name">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Title</label>
          <input type="text" name="title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Job title">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Phone</label>
            <input type="tel" name="phone" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="(555) 123-4567">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
            <input type="email" name="email" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="email@example.com">
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Address</label>
          <input type="text" name="address" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Street address">
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">City</label>
            <input type="text" name="city" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="City">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Source</label>
            <select name="source" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
              <option value="other">Other</option>
              <option value="glsa">GLSA</option>
              <option value="coldlist">Cold List</option>
              <option value="referral">Referral</option>
              <option value="web">Web</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority</label>
          <select name="priority" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
            <option value="3" selected>3 (Medium)</option>
            <option value="5">5 (Highest)</option>
            <option value="4">4</option>
            <option value="2">2</option>
            <option value="1">1 (Lowest)</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
          <textarea name="notes_lite" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Brief notes..."></textarea>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancel-create-lead" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            Create Lead
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Disposition Modal -->
  <div id="disposition-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Call Disposition</h3>
          <button id="close-disposition-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="dispositions-list" class="space-y-2">
          <!-- Disposition options will be rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Convert Lead Modal -->
  <div id="convert-lead-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Convert Lead to Account</h3>
          <button id="close-convert-lead-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <form id="convert-lead-form" class="p-6 space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Account Name</label>
          <input type="text" id="convert-account-name" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Company name">
        </div>
        <div class="flex items-center">
          <input type="checkbox" id="convert-create-deal" name="create_deal" class="w-4 h-4 text-nfgblue rounded border-nfgray focus:ring-2 focus:ring-nfgblue">
          <label for="convert-create-deal" class="ml-2 text-sm text-gray-700 dark:text-gray-300">Create Deal</label>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" id="cancel-convert-lead" class="flex-1 px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
            Cancel
          </button>
          <button type="submit" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition">
            Convert
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Lead Drawer -->
  <div id="lead-drawer" class="hidden fixed inset-0 bg-black/50 z-50 flex items-end md:items-center md:justify-end p-0">
    <div class="bg-white dark:bg-gray-800 w-full md:w-96 h-full md:h-[90vh] flex flex-col shadow-xl">
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Lead Details</h3>
          <button id="lead-drawer-close" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      <div class="flex-1 overflow-y-auto p-6 space-y-6">
        <div id="drawer-lead-summary">
          <!-- Lead summary will be rendered here -->
        </div>
        <div>
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Recent Activity</h4>
          <div id="drawer-activities" class="space-y-2">
            <!-- Activities will be rendered here -->
          </div>
        </div>
        <div>
          <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400 mb-3">Conversion Status</h4>
          <div id="drawer-conversion">
            <!-- Conversion status will be rendered here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simple Quote Calculator Modal -->
  <div id="quote-builder-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="p-6 border-b border-nfgray dark:border-gray-700 flex-shrink-0">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Quote Calculator</h3>
          <button id="close-quote-builder-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <!-- Quote Form Content (scrollable) -->
      <div class="flex-1 overflow-y-auto p-6">
        <div class="space-y-6">
          <!-- Quote Title -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quote Title</label>
            <input type="text" id="simple-quote-title" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g., Office Cleaning - ABC Corp">
          </div>

          <!-- QUOTE ENGINE FORM -->
          <div class="border border-nfgray dark:border-gray-700 rounded-xl p-6 bg-nfglight dark:bg-gray-700/50 space-y-6">
            <h4 class="text-lg font-semibold text-nfgblue dark:text-blue-400">Quote Calculation</h4>
            
            <!-- Service Type & Basic Info -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Type <span class="text-red-500">*</span></label>
                <select id="quote-service-type" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" required>
                  <option value="">Select service type...</option>
                  <optgroup label="Commercial">
                    <option value="commercial_office">Commercial Office</option>
                    <option value="industrial">Industrial/Warehouse</option>
                    <option value="restaurant">Restaurant</option>
                  </optgroup>
                  <optgroup label="Healthcare">
                    <option value="medical_clinic">Medical Clinic</option>
                    <option value="physio_chiro">Physio/Chiro</option>
                    <option value="dental">Dental</option>
                    <option value="optical">Optical</option>
                  </optgroup>
                  <optgroup label="Residential">
                    <option value="residential_home">Residential Home</option>
                    <option value="residential_common_area">Condo/Apartment Common Area</option>
                  </optgroup>
                  <optgroup label="Real Estate">
                    <option value="realtor">Realtor (Move-in/Move-out)</option>
                    <option value="property_manager">Property Manager</option>
                  </optgroup>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Square Footage Estimate</label>
                <input type="number" id="quote-sqft-estimate" min="0" max="50000" step="100" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="e.g. 1500 (up to 50,000)">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Optional but recommended. Supports up to 50,000 sq ft per property.</p>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frequency (Visits per Month) <span class="text-red-500">*</span></label>
                <input type="number" id="quote-frequency-per-month" min="1" max="20" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="4" value="4" required>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">4 = Weekly, 8 = Twice Weekly, 12 = 3x Weekly</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Urgency (Days Until Start)</label>
                <input type="number" id="quote-urgency-days" min="0" max="30" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="30" value="30">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">0-2 = Urgent (+10%), 3-7 = Moderate (+5%), 8+ = Normal</p>
              </div>
            </div>

            <!-- Service-Specific Touchpoints (dynamic based on service type) -->
            <div id="quote-touchpoints-section" class="hidden border-t border-nfgray dark:border-gray-700 pt-4">
              <h5 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">Space Details</h5>
              
              <!-- Commercial Office -->
              <div id="touchpoints-commercial_office" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Workstations</label>
                  <input type="number" id="quote-num-workstations" min="0" max="200" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Meeting Rooms</label>
                  <input type="number" id="quote-num-meeting-rooms" min="0" max="20" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kitchen/Break Room</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-kitchen" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Reception Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-reception" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Medical Clinic -->
              <div id="touchpoints-medical_clinic" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Rooms</label>
                  <input type="number" id="quote-num-exam-rooms" min="0" max="30" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms-med" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Waiting Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-waiting-med" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lab/Specimen Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-lab" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Physio/Chiro -->
              <div id="touchpoints-physio_chiro" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Treatment Rooms</label>
                  <input type="number" id="quote-num-treatment-rooms" min="0" max="20" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms-physio" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gym/Rehab Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-gym" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Waiting Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-waiting-physio" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
              </div>

              <!-- Dental -->
              <div id="touchpoints-dental" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Operatories</label>
                  <input type="number" id="quote-num-operatories" min="0" max="20" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms-dental" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sterilization Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-sterilization" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">X-Ray Room</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-xray" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Optical -->
              <div id="touchpoints-optical" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Exam Rooms</label>
                  <input type="number" id="quote-num-exam-optical" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms-optical" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Retail/Display Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-retail-optical" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lab/Workshop</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-lab-optical" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Industrial -->
              <div id="touchpoints-industrial" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Warehouse Bays</label>
                  <input type="number" id="quote-num-warehouse-bays" min="0" max="50" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms-ind" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Office Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-office-ind" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Break Room</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-break-ind" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Residential Common Area -->
              <div id="touchpoints-residential_common_area" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Floors/Levels</label>
                  <input type="number" id="quote-num-floors" min="1" max="50" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="1" value="1">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Elevators</label>
                  <input type="number" id="quote-num-elevators" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Lobby</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-lobby" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Gym/Pool Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-gym-res" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Restaurant -->
              <div id="touchpoints-restaurant" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Seating Capacity</label>
                  <input type="number" id="quote-seating-capacity" min="0" max="500" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Washrooms</label>
                  <input type="number" id="quote-num-washrooms-rest" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Commercial Kitchen</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-commercial-kitchen" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bar Area</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-bar" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Residential Home -->
              <div id="touchpoints-residential_home" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bedrooms</label>
                  <input type="number" id="quote-num-bedrooms" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bathrooms</label>
                  <input type="number" id="quote-num-bathrooms" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Floors/Levels</label>
                  <input type="number" id="quote-num-home-floors" min="1" max="5" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="1" value="1">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Basement</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-basement" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Garage</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-garage" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pets in Home</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-pets" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Realtor (Move-in/Move-out) -->
              <div id="touchpoints-realtor" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bedrooms</label>
                  <input type="number" id="quote-num-bedrooms-realtor" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Bathrooms</label>
                  <input type="number" id="quote-num-bathrooms-realtor" min="0" max="10" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="0" value="0">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cleaning Type</label>
                  <select id="quote-realtor-cleaning-type" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                    <option value="move_out">Move-Out Clean</option>
                    <option value="move_in">Move-In Clean</option>
                    <option value="showing_prep">Showing Prep</option>
                    <option value="deep_clean">Deep Clean</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Property Vacant</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-is-vacant" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Appliance Cleaning</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-appliance-cleaning" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Window Cleaning</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-window-cleaning" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>

              <!-- Property Manager -->
              <div id="touchpoints-property_manager" class="hidden grid grid-cols-2 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Total Units</label>
                  <input type="number" id="quote-num-units" min="1" max="500" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="1" value="1">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Avg Bedrooms/Unit</label>
                  <input type="number" id="quote-avg-bedrooms" min="0" max="5" step="0.5" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="2" value="2">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Service Type</label>
                  <select id="quote-pm-service-type" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                    <option value="turnover">Unit Turnover</option>
                    <option value="common_areas">Common Areas Only</option>
                    <option value="full_service">Full Service (Units + Common)</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Est. Turnovers/Month</label>
                  <input type="number" id="quote-turnovers-per-month" min="0" max="50" class="quote-touchpoint w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="2" value="2">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Common Areas</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-has-common-areas" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Priority Response</label>
                  <div class="flex items-center h-10">
                    <input type="checkbox" id="quote-priority-response" class="quote-touchpoint w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                  </div>
                </div>
              </div>
            </div>

            <!-- Complexity Factors -->
            <div class="border-t border-nfgray dark:border-gray-700 pt-4">
              <h5 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-3">Complexity Factors</h5>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Flooring Type</label>
                  <select id="quote-flooring" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800">
                    <option value="mostly_hard" selected>Mostly Hard (Tile/Hardwood)</option>
                    <option value="mixed">Mixed</option>
                    <option value="mostly_carpet">Mostly Carpet</option>
                  </select>
                </div>
                <div class="space-y-3">
                  <label class="flex items-center">
                    <input type="checkbox" id="quote-after-hours" class="mr-2 w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">After Hours Required</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="quote-supplies-included" class="mr-2 w-5 h-5 border border-nfgray dark:border-gray-600 rounded" checked>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Supplies Included</span>
                  </label>
                  <label class="flex items-center">
                    <input type="checkbox" id="quote-high-touch-disinfection" class="mr-2 w-5 h-5 border border-nfgray dark:border-gray-600 rounded">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">High-Touch Disinfection</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Notes -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Notes</label>
              <textarea id="quote-notes" rows="3" class="w-full px-4 py-2 border border-nfgray dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800" placeholder="Any special requirements, construction dust, biohazards, etc."></textarea>
            </div>

            <!-- Real-time Quote Calculation Display -->
            <div id="quote-calculation-result" class="border-t border-nfgray dark:border-gray-700 pt-4 mt-4">
              <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-lg p-4 space-y-3">
                <h5 class="font-semibold text-nfgblue dark:text-blue-400">Calculated Quote</h5>
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Monthly (ex-HST)</p>
                    <p id="calc-monthly-ex-hst" class="text-xl font-semibold text-gray-900 dark:text-gray-100">$0.00</p>
                  </div>
                  <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Per Visit</p>
                    <p id="calc-per-visit" class="text-xl font-semibold text-gray-900 dark:text-gray-100">$0.00</p>
                  </div>
                </div>
                <div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">HST (13%)</p>
                  <p id="calc-hst" class="text-lg font-semibold text-gray-900 dark:text-gray-100">$0.00</p>
                </div>
                <div class="border-t border-nfgray dark:border-gray-700 pt-3">
                  <p class="text-sm text-gray-600 dark:text-gray-400">Total (inc-HST)</p>
                  <p id="calc-total" class="text-2xl font-bold text-nfgblue dark:text-blue-400">$0.00</p>
                </div>
                <div id="calc-assumptions" class="text-xs text-gray-500 dark:text-gray-400 mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer with Simple Buttons -->
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex-shrink-0 flex justify-between items-center">
        <button type="button" id="wizard-cancel-btn" class="px-4 py-2 border border-nfgray dark:border-gray-700 hover:bg-nfglight dark:hover:bg-gray-700 rounded-lg font-medium transition">
          Cancel
        </button>
        <div class="flex gap-3">
          <button type="button" id="wizard-save-draft-btn" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
            <i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Save Quote
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quote Send Confirmation Modal -->
  <div id="quote-send-confirmation-modal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full">
      <div class="p-6 border-b border-nfgray dark:border-gray-700">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-semibold text-nfgblue dark:text-blue-400">Confirm Quote Creation</h3>
          <button id="close-quote-send-confirmation-modal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
      
      <div class="p-6 space-y-4">
        <div class="bg-nfglight/30 dark:bg-blue-900/20 border border-nfgblue/20 dark:border-blue-800 rounded-xl p-4">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Final Quote Price:</p>
          <div class="flex items-baseline justify-between">
            <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Subtotal:</span>
            <span id="confirmation-subtotal" class="text-lg font-semibold text-gray-900 dark:text-gray-100">$0.00</span>
          </div>
          <div class="flex items-baseline justify-between mt-2">
            <span class="text-lg font-medium text-gray-700 dark:text-gray-300">Tax (13% HST):</span>
            <span id="confirmation-tax" class="text-lg font-semibold text-gray-900 dark:text-gray-100">$0.00</span>
          </div>
          <div class="flex items-baseline justify-between mt-3 pt-3 border-t border-nfgblue/20 dark:border-blue-800">
            <span class="text-xl font-semibold text-nfgblue dark:text-blue-400">Total:</span>
            <span id="confirmation-total" class="text-3xl font-bold text-nfgblue dark:text-blue-400">$0.00</span>
          </div>
        </div>
        
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-xl p-4">
          <div class="flex items-start gap-2">
            <i data-lucide="alert-circle" class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5"></i>
            <p class="text-sm text-yellow-800 dark:text-yellow-200">
              Please review the final quote price above. This quote will be created and saved.
            </p>
          </div>
        </div>
      </div>
      
      <div class="p-6 border-t border-nfgray dark:border-gray-700 flex gap-3 justify-end">
        <button 
          id="cancel-quote-send-btn" 
          class="px-4 py-2 border border-nfgray dark:border-gray-600 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg font-medium transition"
        >
          Cancel
        </button>
        <button 
          id="confirm-quote-send-btn" 
          class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition"
        >
          Yes, Create Quote
        </button>
      </div>
    </div>
  </div>

  <!-- Quote Detail Modal -->
  <div id="quote-detail-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-5xl w-full max-h-[95vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="bg-gradient-to-r from-nfgblue to-nfgdark p-6 flex-shrink-0">
        <div class="flex justify-between items-start">
          <div class="flex-1">
            <h3 class="text-2xl font-bold text-white mb-2" id="quote-detail-title">Quote Details</h3>
            <div id="quote-detail-subtitle" class="flex items-center gap-3 flex-wrap">
              <!-- Status and type badges will be rendered here -->
            </div>
            <div id="quote-detail-meta" class="mt-3 flex items-center gap-4 text-sm text-blue-100">
              <!-- Meta information will be rendered here -->
            </div>
          </div>
          <button id="close-quote-detail-modal" class="text-white/80 hover:text-white transition p-2 hover:bg-white/10 rounded-lg">
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>
      </div>

      <!-- Content (scrollable) -->
      <div class="flex-1 overflow-y-auto">
        <div class="p-6">
          <!-- Quote Summary Card -->
          <div id="quote-summary-card" class="mb-6 bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700/50 dark:to-gray-800/50 rounded-xl p-6 border border-gray-200 dark:border-gray-700">
            <!-- Summary content will be rendered here -->
          </div>

          <!-- Walkthrough Status Block (if walkthrough_required) -->
          <div id="quote-walkthrough-block" class="hidden mb-6 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 border-2 border-blue-200 dark:border-blue-800 rounded-xl shadow-sm">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center">
                <i data-lucide="calendar" class="w-5 h-5 text-white"></i>
              </div>
              <h4 class="text-lg font-bold text-blue-900 dark:text-blue-100">Walkthrough Status</h4>
            </div>
            <div id="walkthrough-status-content"></div>
            <div id="walkthrough-actions" class="mt-4 flex gap-2"></div>
          </div>

          <!-- Revisions List -->
          <div class="mb-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-1 h-6 bg-gradient-to-b from-nfgblue to-nfgdark rounded-full"></div>
              <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100">Revisions</h4>
            </div>
            <div id="quote-revisions-list" class="space-y-3">
              <!-- Revisions will be rendered here -->
            </div>
          </div>

          <!-- Events Timeline -->
          <div class="mb-6">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-1 h-6 bg-gradient-to-b from-nfgblue to-nfgdark rounded-full"></div>
              <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100">Timeline</h4>
            </div>
            <div id="quote-events-timeline" class="relative pl-8">
              <!-- Timeline line -->
              <div class="absolute left-3 top-0 bottom-0 w-0.5 bg-gradient-to-b from-nfgblue via-blue-300 to-transparent dark:from-blue-500 dark:via-blue-700"></div>
              <!-- Events will be rendered here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 flex-shrink-0 flex justify-between items-center">
        <button type="button" id="quote-detail-close-btn" class="px-5 py-2.5 border-2 border-gray-300 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg font-medium transition text-gray-700 dark:text-gray-300">
          Close
        </button>
        <div id="quote-detail-actions" class="flex gap-3">
          <!-- Action buttons will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // Set sales mode flag in sessionStorage
    sessionStorage.setItem('isSalesMode', 'true');
    
    // Initialize environment
    window.ENV = {
      SUPABASE_URL: 'https://zqcbldgheimqrnqmbbed.supabase.co',
      SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpxY2JsZGdoZWltcXJucW1iYmVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3MDM5NjIsImV4cCI6MjA3NjI3OTk2Mn0.UYlnTQeCjNLed6g9oNRLQIXD69OgzRrXupl3LXUvh4I'
    };

    // Import modules
    console.log('[Sales Dashboard] Starting module imports...');
    let supabase, showNotification, toast, hideLoader, initializeUI, sales;
    
    try {
      const supabaseModule = await import('./js/supabase.js');
      supabase = supabaseModule.supabase;
      console.log('[Sales Dashboard] âœ… supabase module loaded');
      
      const notificationsModule = await import('./js/notifications.js');
      toast = notificationsModule.toast;
      showNotification = notificationsModule.showNotification;
      console.log('[Sales Dashboard] âœ… notifications module loaded');
      
      const salesNotificationsModule = await import('./js/sales-notifications.js');
      window.salesNotifications = salesNotificationsModule.default;
      console.log('[Sales Dashboard] âœ… sales notifications module loaded');
      
      const loaderModule = await import('./js/loader.js');
      hideLoader = loaderModule.hideLoader;
      console.log('[Sales Dashboard] âœ… loader module loaded');
      
      const uiModule = await import('./js/ui.js');
      initializeUI = uiModule.initializeUI;
      console.log('[Sales Dashboard] âœ… ui module loaded');
      
      sales = await import('./js/sales.js');
      console.log('[Sales Dashboard] âœ… sales module loaded');
      
      // Load quotes module
      window.quotesModule = await import('./js/quotes.js');
      console.log('[Sales Dashboard] âœ… quotes module loaded');
      
      // Load quote wizard module
      window.quoteWizard = await import('./js/quote-wizard.js');
      console.log('[Sales Dashboard] âœ… quote wizard module loaded');
      
      // Load quote detail module
      window.quoteDetail = await import('./js/quote-detail.js');
      console.log('[Sales Dashboard] âœ… quote detail module loaded');
      
      // Load accounts directory module
      const accountsDirModule = await import('./js/accounts-directory.js');
      // Module sets window.accountsDirectory itself, but ensure it's available
      if (!window.accountsDirectory && accountsDirModule.default) {
        window.accountsDirectory = accountsDirModule.default;
      }
      console.log('[Sales Dashboard] âœ… accounts directory module loaded', window.accountsDirectory ? 'âœ“' : 'âœ—');
      
      // Load sales tools module
      window.salesTools = await import('./js/sales-tools.js');
      console.log('[Sales Dashboard] âœ… sales tools module loaded');
      
      
      console.log('[Sales Dashboard] âœ… All modules loaded successfully');
    } catch (error) {
      console.error('[Sales Dashboard] âŒ Error loading modules:', error);
      // Show error immediately if modules can't load
      document.body.innerHTML = `
        <div class="flex items-center justify-center min-h-screen p-6 bg-gray-50 dark:bg-gray-900">
          <div class="bg-white dark:bg-gray-800 border border-red-300 dark:border-red-700 rounded-xl p-8 max-w-md text-center shadow-xl">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">Failed to Load</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Could not load required modules. Please check your browser console for details.</p>
            <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-3 rounded mb-4 text-left overflow-auto max-h-32">${error.message}\n${error.stack || ''}</pre>
            <button onclick="window.location.reload()" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
              Reload Page
            </button>
          </div>
        </div>
      `;
      throw error; // Stop execution
    }

    // Tab switching functionality
    function switchTab(targetTabName) {
      const tabs = document.querySelectorAll('.sales-tab');
      const tabContents = document.querySelectorAll('.sales-tab-content');
      const targetTab = Array.from(tabs).find(t => t.dataset.tab === targetTabName);
      
      // Update active tab (only if tab button exists)
      if (targetTab) {
        tabs.forEach(t => {
          t.classList.remove('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
          t.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
        });
        targetTab.classList.add('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
        targetTab.classList.remove('text-gray-600', 'dark:text-gray-400', 'border-transparent');
      } else {
        // If no tab button exists (like for tools accessed from sidebar), deactivate all tabs
        tabs.forEach(t => {
          t.classList.remove('active', 'text-nfgblue', 'dark:text-blue-400', 'border-nfgblue', 'dark:border-blue-400');
          t.classList.add('text-gray-600', 'dark:text-gray-400', 'border-transparent');
        });
      }
      
      // Show/hide tab content
      const targetContent = document.getElementById(`tab-${targetTabName}`);
      if (!targetContent) {
        console.warn(`[Sales] Tab content not found: tab-${targetTabName}`);
        return;
      }
      
      tabContents.forEach(content => {
        if (content.id === `tab-${targetTabName}`) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
      
      // Show/hide dashboard tabs container (hide for tools tab)
      const tabsContainer = document.getElementById('sales-dashboard-tabs');
      if (tabsContainer) {
        if (targetTabName === 'tools') {
          tabsContainer.classList.add('hidden');
        } else {
          tabsContainer.classList.remove('hidden');
        }
      }
      
      // Update sidebar active state
      updateSidebarActiveState(targetTabName);
      
      // Load data for the active tab
      loadTabData(targetTabName);
    }
    
    // Update sidebar navigation active state
    function updateSidebarActiveState(activeTab) {
      const navSales = document.getElementById('nav-sales');
      const navTools = document.getElementById('nav-tools');
      const navPriority = document.getElementById('nav-priority');
      
      const activeClasses = ['bg-nfglight', 'dark:bg-gray-700', 'text-nfgblue', 'dark:text-blue-400', 'font-medium'];
      const hoverClasses = ['hover:bg-nfglight', 'dark:hover:bg-gray-700'];
      
      // Remove active state from all sidebar links
      [navSales, navTools, navPriority].forEach(nav => {
        if (nav) {
          nav.classList.remove(...activeClasses);
          nav.classList.add(...hoverClasses);
        }
      });
      
      // Add active state based on current tab
      let activeNav = null;
      if (activeTab === 'tools') activeNav = navTools;
      else if (activeTab === 'priority') activeNav = navPriority;
      else if (activeTab === 'dashboard' || activeTab === 'deals' || activeTab === 'quotes' || activeTab === 'contacts' || activeTab === 'team') activeNav = navSales;
      
      if (activeNav) {
        activeNav.classList.add(...activeClasses);
        activeNav.classList.remove(...hoverClasses);
      }
    }
    
    // Make switchTab available globally for sidebar links
    window.switchTab = switchTab;
    
    function initTabs() {
      const tabs = document.querySelectorAll('.sales-tab');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          switchTab(tab.dataset.tab);
        });
      });
      
      // Setup sidebar navigation links to switch tabs when on sales.html
      const dashboardLink = document.getElementById('nav-dashboard');
      if (dashboardLink) {
        dashboardLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('dashboard');
          }
        });
      }
      
      const salesLink = document.getElementById('nav-sales');
      if (salesLink) {
        salesLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('dashboard');
            // Update URL
            const url = new URL(window.location);
            url.searchParams.delete('tab');
            window.history.pushState({}, '', url);
          }
        });
      }
      
      const toolsLink = document.getElementById('nav-tools');
      if (toolsLink) {
        toolsLink.addEventListener('click', (e) => {
          if (window.location.pathname.endsWith('sales.html') || window.location.pathname.endsWith('/sales.html')) {
            e.preventDefault();
            switchTab('tools');
            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('tab', 'tools');
            window.history.pushState({}, '', url);
          }
        });
      }

      // Setup KPI card click handlers for filtering
      document.querySelectorAll('.kpi-card').forEach(card => {
        card.addEventListener('click', () => {
          const filter = card.dataset.filter;
          applyKPIFilter(filter);
        });
      });

      // Setup create deal button
      const createDealBtn = document.getElementById('create-deal-dashboard-btn');
      if (createDealBtn) {
        createDealBtn.addEventListener('click', () => {
          // Open create deal modal or navigate to deals tab
          if (window.sales && typeof window.sales.openCreateDealModal === 'function') {
            window.sales.openCreateDealModal();
          } else {
            switchTab('deals');
            // Trigger create deal button in deals tab
            setTimeout(() => {
              const dealsCreateBtn = document.getElementById('create-deal-btn');
              if (dealsCreateBtn) dealsCreateBtn.click();
            }, 100);
          }
        });
      }
    }

    // Apply KPI filter
    function applyKPIFilter(filter) {
      const tbody = document.getElementById('deals-table-body');
      if (!tbody) return;

      const rows = tbody.querySelectorAll('.deal-row');
      const now = new Date();
      const sevenDaysFromNow = new Date(now);
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);

      rows.forEach(row => {
        let show = true;
        const dealId = row.dataset.dealId;
        
        // This is a simplified filter - you may need to fetch deal data to filter properly
        switch(filter) {
          case 'open-pipeline':
            show = true; // All deals are open pipeline
            break;
          case 'today':
            // Filter deals with activity today
            show = true; // Simplified - would need to check last_contacted_at
            break;
          case 'next-7-days':
            // Filter deals at risk in next 7 days
            show = true; // Simplified - would need to check next_action_date
            break;
          case 'urgent':
            // Filter urgent deals (uncontacted, expiring quotes, idle)
            show = true; // Simplified
            break;
          default:
            show = true;
        }

        row.style.display = show ? '' : 'none';
      });
    }
    
    // Load data for specific tab
    async function loadTabData(tabName) {
      try {
        switch(tabName) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'deals':
            // Load deals and render kanban board
            const dealsData = await loadDealsForDashboard();
            renderDealsKanban(dealsData);
            if (sales && typeof sales.loadDeals === 'function') {
              await sales.loadDeals();
            }
            break;
          case 'quotes':
            await loadQuotes();
            break;
          case 'tools':
            // Tools & Resources tab - no special data loading needed
            console.log('[Sales] Loading tools tab');
            // Initialize icons if needed
            if (window.lucide) {
              lucide.createIcons();
            }
            break;
          case 'priority':
            // Priority Actions full page
            console.log('[Sales] Loading priority actions tab');
            await loadPriorityActionsPage();
            break;
          case 'contacts':
            // Initialize accounts directory on first load
            console.log('[Sales] Loading contacts tab, accountsDirectory available:', !!window.accountsDirectory);
            if (window.accountsDirectory && typeof window.accountsDirectory.init === 'function') {
              console.log('[Sales] Calling accountsDirectory.init()...');
              await window.accountsDirectory.init();
            } else {
              console.warn('[Sales] accountsDirectory not available, trying to load module...');
              // Try to load module if not available
              try {
                const accountsDirModule = await import('./js/accounts-directory.js');
                if (accountsDirModule.default) {
                  window.accountsDirectory = accountsDirModule.default;
                  await window.accountsDirectory.init();
                } else if (accountsDirModule.initAccountsDirectory) {
                  await accountsDirModule.initAccountsDirectory();
                } else {
                  await loadContacts();
                }
              } catch (importError) {
                console.error('[Sales] Failed to import accounts directory:', importError);
                await loadContacts();
              }
            }
            break;
          case 'team':
            // Initialize team view
            console.log('[Sales] Loading team tab');
            await initTeamView();
            break;
        }
      } catch (error) {
        console.error(`Error loading ${tabName} data:`, error);
        toast.error(`Failed to load ${tabName}`, 'Error');
      }
    }
    
    // Load functions for each tab
    async function loadDashboardData() {
      try {
        console.log('[Dashboard] Loading dashboard data...');
        
        // Load all data in parallel (including contacts for priority actions)
        const [dealsData, quotesData, contactsData] = await Promise.all([
          loadDealsForDashboard(),
          loadQuotesForDashboard(),
          loadContactsForPriorityActions()
        ]);

        // Calculate and render KPIs
        calculateAndRenderKPIs(dealsData, quotesData);

        // Generate and render priority actions (from contacts AND deals)
        generatePriorityActions(dealsData, quotesData, contactsData);

        // Render active deals table
        renderActiveDealsTable(dealsData);
        renderDealsKanban(dealsData);

        // Render pipeline stage snapshot
        renderPipelineSnapshot(dealsData);

        console.log('[Dashboard] âœ… Dashboard data loaded');
      } catch (error) {
        console.error('[Dashboard] Error loading dashboard data:', error);
        toast.error('Failed to load dashboard data', 'Error');
      }
    }
    
    // Load contacts for priority actions
    // forPriorityTab: when true, always filter to current user's contacts (for Priority Actions tab only)
    async function loadContactsForPriorityActions(forPriorityTab = false) {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return [];

        const { data: profile } = await supabase
          .from('user_profiles')
          .select('role, company_id')
          .eq('id', user.id)
          .single();

        // Build query for contacts
        let query = supabase
          .from('contacts')
          .select('*')
          .not('contact_status', 'in', '("lost","converted")')
          .order('last_contact_attempt_at', { ascending: true, nullsFirst: true });

        // Filter to current user's contacts: always when forPriorityTab, otherwise only when role is rep
        if (forPriorityTab || (profile && profile.role === 'rep')) {
          query = query.or(`assigned_user_id.eq.${user.id},created_by.eq.${user.id}`);
        }

        const { data, error } = await query.limit(100);
        if (error) {
          console.warn('[Dashboard] Error loading contacts for priority:', error);
          return [];
        }
        
        return data || [];
      } catch (error) {
        console.warn('[Dashboard] Could not load contacts:', error);
        return [];
      }
    }

    // Helper functions to load data
    // Expose to window for quote wizard to refresh deals
    // forPriorityTab: when true, always filter to current user's deals (for Priority Actions tab only)
    window.loadDealsForDashboard = async function loadDealsForDashboard(forPriorityTab = false) {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return [];

        // Load all deals including closed ones for kanban board
        // Try to load site and contact data - fallback to separate queries if relationship fails
        let query = supabase
          .from('deals')
          .select('*')
          .order('updated_at', { ascending: false });

        // Filter to current user's deals: always when forPriorityTab, otherwise only when role is rep
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('role')
          .eq('id', user.id)
          .single();

        if (forPriorityTab || (profile && profile.role === 'rep')) {
          query = query.or(`assigned_user_id.eq.${user.id},created_by.eq.${user.id}`);
        }

        const { data, error } = await query;
        if (error) throw error;
        
        // Debug: Log first deal to see what columns we're getting
        if (data && data.length > 0) {
          console.log('[Deals Debug] First deal sample:', {
            id: data[0].id,
            title: data[0].title,
            deal_value: data[0].deal_value,
            value_estimate: data[0].value_estimate,
            estimated_value: data[0].estimated_value,
            allKeys: Object.keys(data[0])
          });
        }
        
        // Load site and contact data separately for each deal
        const dealsWithDetails = await Promise.all((data || []).map(async (deal) => {
          // Load site data if site_id exists
          if (deal.site_id) {
            try {
              const { data: siteData, error: siteError } = await supabase
                .from('sites')
                .select('id, name, address')
                .eq('id', deal.site_id)
                .single();
              if (siteError) {
                console.warn('[Dashboard] Error loading site for deal:', deal.id, siteError);
              } else if (siteData) {
                deal.sites = siteData;
              }
            } catch (siteError) {
              console.warn('[Dashboard] Could not load site for deal:', deal.id, siteError);
            }
          }
          
          // Load primary contact data if primary_contact_id exists
          if (deal.primary_contact_id) {
            try {
              // Try account_contacts first
              const { data: contactData, error: contactError } = await supabase
                .from('account_contacts')
                .select('id, full_name, email, phone')
                .eq('id', deal.primary_contact_id)
                .single();
              if (contactError) {
                // Try contacts table as fallback
                try {
                  const { data: fallbackContactData, error: fallbackError } = await supabase
                    .from('contacts')
                    .select('id, first_name, last_name, email, phone')
                    .eq('id', deal.primary_contact_id)
                    .single();
                  if (fallbackError) {
                    console.warn('[Dashboard] Could not load contact for deal:', deal.id, fallbackError);
                  } else if (fallbackContactData) {
                    deal.primary_contact = {
                      id: fallbackContactData.id,
                      full_name: `${fallbackContactData.first_name || ''} ${fallbackContactData.last_name || ''}`.trim(),
                      email: fallbackContactData.email,
                      phone: fallbackContactData.phone
                    };
                  }
                } catch (fallbackError) {
                  console.warn('[Dashboard] Could not load contact for deal:', deal.id, fallbackError);
                }
              } else if (contactData) {
                deal.primary_contact = contactData;
              }
            } catch (contactError) {
              console.warn('[Dashboard] Could not load contact for deal:', deal.id, contactError);
            }
          }
          
          return deal;
        }));
        
        return dealsWithDetails;
      } catch (error) {
        console.error('[Dashboard] Error loading deals:', error);
        return [];
      }
    }

    async function loadQuotesForDashboard() {
      try {
        const { data, error } = await supabase
          .from('quotes')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('[Dashboard] Error loading quotes:', error);
        return [];
      }
    }

    // Helper function to get deal value (checks multiple possible column names)
    // Handles both numeric and string values from Supabase
    function getDealValue(deal) {
      if (!deal) return 0;
      
      // Try each possible column name
      let rawValue = deal.deal_value || deal.value_estimate || deal.estimated_value;
      
      // Handle null, undefined, empty string
      if (rawValue == null || rawValue === '' || rawValue === 'null') {
        return 0;
      }
      
      // Convert to number (handles both numeric and string)
      const value = typeof rawValue === 'string' 
        ? parseFloat(rawValue.replace(/[^0-9.-]/g, '')) || 0
        : Number(rawValue) || 0;
      
      // Debug logging for first few deals
      if (window._debugDealCount === undefined) window._debugDealCount = 0;
      if (window._debugDealCount < 3 && deal.id) {
        console.log(`[Deal Value Debug] Deal ${deal.id} (${deal.title}):`, {
          deal_value: deal.deal_value,
          value_estimate: deal.value_estimate,
          estimated_value: deal.estimated_value,
          rawValue: rawValue,
          type: typeof rawValue,
          calculated: value
        });
        window._debugDealCount++;
      }
      
      return isNaN(value) ? 0 : value;
    }

    // Calculate and render KPIs
    function calculateAndRenderKPIs(deals, quotes) {
      // Open Pipeline
      const openDeals = deals.filter(d => ['qualification', 'proposal', 'negotiation'].includes(d.stage));
      const totalOpen = openDeals.reduce((sum, d) => sum + getDealValue(d), 0);
      const weightedOpen = openDeals.reduce((sum, d) => {
        const stageWeights = { qualification: 0.3, proposal: 0.7, negotiation: 0.9 };
        return sum + getDealValue(d) * (stageWeights[d.stage] || 0.5);
      }, 0);

      document.getElementById('kpi-total-open').textContent = `$${totalOpen.toLocaleString()}`;
      document.getElementById('kpi-weighted-open').textContent = `Weighted: $${Math.round(weightedOpen).toLocaleString()}`;

      // Today metrics
      const today = new Date().toISOString().split('T')[0];
      const todayQuotes = quotes.filter(q => q.created_at?.startsWith(today)).length;
      const todayClosed = deals.filter(d => d.stage === 'closed_won' && d.updated_at?.startsWith(today)).length;

      document.getElementById('kpi-today-quotes').textContent = todayQuotes;
      document.getElementById('kpi-today-closed').textContent = todayClosed;

      // Next 7 days at risk
      const sevenDaysFromNow = new Date();
      sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
      const atRisk = deals.filter(d => {
        if (!d.next_action_date) return false;
        const nextAction = new Date(d.next_action_date);
        return nextAction <= sevenDaysFromNow && nextAction >= new Date();
      }).length;

      document.getElementById('kpi-at-risk').textContent = atRisk;

      // Urgent metrics
      const quotesExpiring = quotes.filter(q => {
        if (!q.expiry_date) return false;
        const expiry = new Date(q.expiry_date);
        const now = new Date();
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        return hoursUntilExpiry < 48 && hoursUntilExpiry > 0;
      }).length;
      const idleDeals = deals.filter(d => {
        if (!d.last_contacted_at) return true;
        const lastContact = new Date(d.last_contacted_at);
        const daysSinceContact = (new Date() - lastContact) / (1000 * 60 * 60 * 24);
        return daysSinceContact > 7;
      }).length;

      // Set uncontacted to 0 since leads tab is removed
      const uncontactedEl = document.getElementById('kpi-uncontacted');
      if (uncontactedEl) uncontactedEl.textContent = '0';
      document.getElementById('kpi-quotes-expiring').textContent = quotesExpiring;
      document.getElementById('kpi-idle-deals').textContent = idleDeals;
    }

    // Generate priority actions with 3 No's policy (Contact-Based)
    function generatePriorityActions(deals, quotes, contacts = []) {
      const actions = [];
      const now = new Date();
      const today = now.toDateString();

      // Helper to calculate days since date
      const daysSince = (date) => {
        if (!date) return Infinity;
        return Math.floor((now - new Date(date)) / (1000 * 60 * 60 * 24));
      };

      // ========================================
      // CONTACT-BASED PRIORITY ACTIONS
      // ========================================
      
      // === P1: URGENT - Contact needs final attempt (2/3) ===
      contacts.forEach(c => {
        const streak = c.no_contact_streak || 0;
        const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
        
        if (streak === 2) {
          actions.push({
            type: 'contact_final_attempt',
            priorityLevel: 1,
            priority: 0,
            company: contactName,
            companyName: c.company_name,
            reason: 'ðŸš¨ FINAL ATTEMPT - 2 no-contacts in a row',
            lastActivity: c.last_contact_attempt_at || c.updated_at,
            contactId: c.id,
            streak: streak,
            color: 'red',
            phone: c.phone || c.normalized_phone,
            email: c.email
          });
        }
      });
      
      // === P1: URGENT - Missed follow-up ===
      contacts.forEach(c => {
        if (c.next_follow_up_date) {
          const followUpDate = new Date(c.next_follow_up_date);
          if (followUpDate < now) {
            const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
            actions.push({
              type: 'contact_missed_followup',
              priorityLevel: 1,
              priority: 5,
              company: contactName,
              companyName: c.company_name,
              reason: `ðŸ“ž Missed follow-up: ${c.next_follow_up_type || 'Call'}`,
              lastActivity: c.last_contact_attempt_at || c.updated_at,
              contactId: c.id,
              color: 'red',
              phone: c.phone || c.normalized_phone,
              email: c.email
            });
          }
        }
      });
      
      // === P2: HIGH - 1 no-contact (attempt 2 of 3) ===
      contacts.forEach(c => {
        const streak = c.no_contact_streak || 0;
        if (streak === 1) {
          const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
          actions.push({
            type: 'contact_follow_up',
            priorityLevel: 2,
            priority: 100,
            company: contactName,
            companyName: c.company_name,
            reason: 'ðŸ“± Follow up - 1 no-contact (attempt 2 of 3)',
            lastActivity: c.last_contact_attempt_at || c.updated_at,
            contactId: c.id,
            streak: streak,
            color: 'orange',
            phone: c.phone || c.normalized_phone,
            email: c.email
          });
        }
      });
      
      // === P2: HIGH - Quote sent, needs follow-up ===
      contacts.forEach(c => {
        if (c.quote_sent_at) {
          const daysSinceQuote = daysSince(c.quote_sent_at);
          if (daysSinceQuote >= 1 && daysSinceQuote <= 7) {
            const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
            let followUpText = '';
            if (daysSinceQuote <= 1) followUpText = 'Day 1: Check quote received';
            else if (daysSinceQuote <= 3) followUpText = 'Day 3: Any questions?';
            else followUpText = 'Day 7: Final quote follow-up';
            
            actions.push({
              type: 'contact_quote_followup',
              priorityLevel: 2,
              priority: 100 + daysSinceQuote,
              company: contactName,
              companyName: c.company_name,
              reason: `ðŸ“„ ${followUpText}`,
              lastActivity: c.quote_sent_at,
              contactId: c.id,
              color: 'orange',
              phone: c.phone || c.normalized_phone,
              email: c.email
            });
          }
        }
      });
      
      // === P3: MEDIUM - New contacts never contacted ===
      contacts.forEach(c => {
        if ((c.total_contact_attempts || 0) === 0 && !c.last_contacted_at) {
          const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
          actions.push({
            type: 'contact_new',
            priorityLevel: 3,
            priority: 200,
            company: contactName,
            companyName: c.company_name,
            reason: 'ðŸ†• New contact - make first call',
            lastActivity: c.created_at,
            contactId: c.id,
            color: 'yellow',
            phone: c.phone || c.normalized_phone,
            email: c.email
          });
        }
      });
      
      // === P3: MEDIUM - Idle contacts (>7 days no activity) ===
      contacts.forEach(c => {
        if (c.total_contact_attempts > 0) {
          const lastTouch = c.last_contacted_at || c.last_contact_attempt_at;
          const days = daysSince(lastTouch);
          if (days >= 7 && days < 30) {
            const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
            actions.push({
              type: 'contact_idle',
              priorityLevel: 3,
              priority: 200 + days,
              company: contactName,
              companyName: c.company_name,
              reason: `ðŸ’¤ Re-engage - idle ${days} days`,
              lastActivity: lastTouch,
              contactId: c.id,
              color: 'yellow',
              phone: c.phone || c.normalized_phone,
              email: c.email
            });
          }
        }
      });

      // ========================================
      // DEAL-BASED PRIORITY ACTIONS (Legacy)
      // ========================================

      // Quotes expiring soon (<48h)
      quotes.forEach(q => {
        if (!q.expiry_date) return;
        const expiry = new Date(q.expiry_date);
        const hoursUntilExpiry = (expiry - now) / (1000 * 60 * 60);
        if (hoursUntilExpiry < 48 && hoursUntilExpiry > 0) {
          actions.push({
            type: 'quote_expiring',
            priorityLevel: 1,
            priority: hoursUntilExpiry,
            company: q.company_name || 'Unknown',
            dealValue: q.quote_value || 0,
            reason: `â° Quote expiring in ${Math.round(hoursUntilExpiry)}h`,
            lastActivity: q.created_at,
            dealId: q.deal_id,
            quoteId: q.id,
            color: 'red'
          });
        }
      });

      // Missed callbacks
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        if (d.next_action_date && d.next_action_type === 'callback') {
          const nextAction = new Date(d.next_action_date);
          if (nextAction < now) {
            actions.push({
              type: 'missed_callback',
              priorityLevel: 1,
              priority: (now - nextAction) / (1000 * 60 * 60),
              company: d.company_name || d.title || 'Unknown',
              dealValue: getDealValue(d),
              reason: 'ðŸ“ž Missed callback - overdue',
              lastActivity: d.last_contacted_at || d.updated_at,
              dealId: d.id,
              color: 'red'
            });
          }
        }
      });

      // Walkthroughs today
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        if (d.next_action_date && d.next_action_type === 'walkthrough') {
          const nextAction = new Date(d.next_action_date);
          if (nextAction.toDateString() === today) {
            actions.push({
              type: 'walkthrough_today',
              priorityLevel: 1,
              priority: nextAction.getHours() * 60 + nextAction.getMinutes(),
              company: d.company_name || d.title || 'Unknown',
              dealValue: getDealValue(d),
              reason: `ðŸ“ Walkthrough at ${nextAction.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`,
              lastActivity: d.last_contacted_at || d.updated_at,
              dealId: d.id,
              walkthroughTime: nextAction,
              color: 'red'
            });
          }
        }
      });

      // === P2: HIGH (Orange) ===
      
      // 1 no-contact (follow up needed)
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        const streak = d.no_contact_streak || 0;
        if (streak === 1) {
          actions.push({
            type: 'follow_up_needed',
            priorityLevel: 2,
            priority: 100,
            company: d.company_name || d.title || 'Unknown',
            dealValue: getDealValue(d),
            reason: 'ðŸ“± Follow up - 1 no-contact (attempt 2 of 3)',
            lastActivity: d.last_contact_attempt_at || d.last_touch_at || d.updated_at,
            dealId: d.id,
            streak: streak,
            color: 'orange'
          });
        }
      });

      // Quote follow-up (sent but no response)
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        if (d.quote_sent_at) {
          const daysSinceQuote = daysSince(d.quote_sent_at);
          if (daysSinceQuote >= 1 && daysSinceQuote <= 7) {
            let followUpText = '';
            if (daysSinceQuote <= 1) followUpText = 'Day 1: Check quote received';
            else if (daysSinceQuote <= 3) followUpText = 'Day 3: Any questions on quote?';
            else followUpText = 'Day 7: Final quote follow-up';
            
            actions.push({
              type: 'quote_follow_up',
              priorityLevel: 2,
              priority: 100 + daysSinceQuote,
              company: d.company_name || d.title || 'Unknown',
              dealValue: getDealValue(d),
              reason: `ðŸ“„ ${followUpText}`,
              lastActivity: d.quote_sent_at,
              dealId: d.id,
              color: 'orange'
            });
          }
        }
      });

      // Post-walkthrough (need to send quote)
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        if (d.walkthrough_completed_at && !d.quote_sent_at) {
          actions.push({
            type: 'post_walkthrough',
            priorityLevel: 2,
            priority: 110,
            company: d.company_name || d.title || 'Unknown',
            dealValue: getDealValue(d),
            reason: 'âœï¸ Send quote after walkthrough',
            lastActivity: d.walkthrough_completed_at,
            dealId: d.id,
            color: 'orange'
          });
        }
      });

      // === P3: MEDIUM (Yellow) ===
      
      // Idle deals (>7 days no activity)
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        const lastTouch = d.last_touch_at || d.updated_at;
        const days = daysSince(lastTouch);
        if (days >= 7 && days < 30) {
          actions.push({
            type: 'idle_deal',
            priorityLevel: 3,
            priority: 200 + days,
            company: d.company_name || d.title || 'Unknown',
            dealValue: getDealValue(d),
            reason: `ðŸ’¤ Re-engage - idle ${days} days`,
            lastActivity: lastTouch,
            dealId: d.id,
            color: 'yellow'
          });
        }
      });

      // Stuck in stage (>14 days)
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        const daysInStage = daysSince(d.stage_entered_at);
        if (daysInStage >= 14) {
          actions.push({
            type: 'stuck_in_stage',
            priorityLevel: 3,
            priority: 210 + daysInStage,
            company: d.company_name || d.title || 'Unknown',
            dealValue: getDealValue(d),
            reason: `âš ï¸ Stuck in ${d.stage?.replace('_', ' ')} for ${daysInStage} days`,
            lastActivity: d.stage_entered_at || d.updated_at,
            dealId: d.id,
            color: 'yellow'
          });
        }
      });

      // New deals - never contacted
      deals.forEach(d => {
        if (d.stage?.includes('closed')) return;
        if ((d.total_contact_attempts || 0) === 0) {
          actions.push({
            type: 'new_uncontacted',
            priorityLevel: 3,
            priority: 220,
            company: d.company_name || d.title || 'Unknown',
            dealValue: getDealValue(d),
            reason: 'ðŸ†• New deal - make first contact',
            lastActivity: d.created_at,
            dealId: d.id,
            color: 'yellow'
          });
        }
      });

      // Sort by priority level, then by priority score
      actions.sort((a, b) => {
        if (a.priorityLevel !== b.priorityLevel) return a.priorityLevel - b.priorityLevel;
        return a.priority - b.priority;
      });

      // Render dashboard widget (top 3) when element exists
      const actionsList = document.getElementById('priority-actions-list');
      if (actionsList) {
        if (actions.length === 0) {
          actionsList.innerHTML = `
          <div class="p-6 text-center text-gray-500 dark:text-gray-400">
            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-2 text-green-500"></i>
            <p>No priority actions at this time</p>
          </div>
        `;
        } else {
      const colorClasses = {
        red: 'border-l-4 border-red-500 bg-red-50 dark:bg-red-900/10',
        orange: 'border-l-4 border-orange-500 bg-orange-50 dark:bg-orange-900/10',
        yellow: 'border-l-4 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/10',
        blue: 'border-l-4 border-blue-500 bg-blue-50 dark:bg-blue-900/10'
      };

      actionsList.innerHTML = actions.slice(0, 3).map(action => {
        // Determine if this is a contact or deal action
        const isContact = !!action.contactId;
        const valueDisplay = action.dealValue ? `$${Number(action.dealValue).toLocaleString()}` : (action.companyName || '');
        
        return `
        <div class="p-4 hover:bg-nfglight dark:hover:bg-gray-700 transition ${colorClasses[action.color] || ''}">
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <span class="font-semibold text-nfgblue dark:text-blue-400">${action.company}</span>
                ${valueDisplay ? `<span class="text-sm text-gray-600 dark:text-gray-400">${valueDisplay}</span>` : ''}
                ${action.streak ? `<span class="px-2 py-0.5 text-xs font-medium rounded-full ${action.streak >= 2 ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400'}">${action.streak}/3 no-contact</span>` : ''}
              </div>
              <p class="text-sm text-gray-700 dark:text-gray-300 mb-1">${action.reason}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Last activity: ${action.lastActivity ? new Date(action.lastActivity).toLocaleString() : 'Never'}
                ${action.phone ? ` â€¢ <a href="tel:${action.phone}" class="text-nfgblue hover:underline">${action.phone}</a>` : ''}
              </p>
            </div>
            <div class="flex gap-2 ml-4">
              ${isContact ? `
                <button onclick="window.openLogActivityForContact && window.openLogActivityForContact('${action.contactId}')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-medium transition flex items-center gap-1" title="Log Activity">
                  <i data-lucide="phone" class="w-3.5 h-3.5"></i>
                  Log
                </button>
                ${action.phone ? `<a href="tel:${action.phone}" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium transition flex items-center gap-1">
                  <i data-lucide="phone-call" class="w-3.5 h-3.5"></i>
                  Call
                </a>` : ''}
              ` : ''}
              ${action.dealId ? `
                <button onclick="window.openLogActivity('${action.dealId}')" class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-medium transition" title="Log Activity">
                  <i data-lucide="phone" class="w-3.5 h-3.5"></i>
                </button>
                <button onclick="window.openDeal('${action.dealId}')" class="px-3 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium transition">
                  View
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `}).join('');

      if (window.lucide) lucide.createIcons();
        }
      }
      return actions;
    }

    // Priority Actions: unified list (for filters/sort) â€” set by loadPriorityActionsPage
    window.priorityActionsFullList = [];
    window.priorityActionsFilteredList = [];

    // Load Priority Actions Full Page (unified feed + new card UI)
    async function loadPriorityActionsPage() {
      const listEl = document.getElementById('priority-actions-full-list');
      if (!listEl) return;
      
      listEl.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400"><i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-2 animate-spin"></i><p>Loading priority actions...</p></div>`;
      if (window.lucide) lucide.createIcons();
      
      try {
        // Load only current user's deals and contacts for Priority Actions tab
        const [dealsData, quotesData, contactsData] = await Promise.all([
          loadDealsForDashboard(true),
          loadQuotesForDashboard(),
          loadContactsForPriorityActions(true)
        ]);
        const userDealIds = new Set((dealsData || []).map(d => d.id));
        const quotesForUser = (quotesData || []).filter(q => !q.deal_id || userDealIds.has(q.deal_id));
        let actions = generatePriorityActions(dealsData || [], quotesForUser, contactsData || []) || [];
        // Enrich: link contact -> deal where possible
        (dealsData || []).forEach(deal => {
          const pid = deal.primary_contact_id;
          if (!pid) return;
          actions.forEach(a => {
            if (a.contactId === pid && !a.dealId) {
              a.dealId = deal.id;
              a.dealStage = deal.stage;
              a.dealValue = getDealValue(deal);
              a.deal = deal;
            }
          });
        });
        // Enrich deal-only actions with primary_contact (email, phone, company) for Call/Email
        (dealsData || []).forEach(deal => {
          actions.forEach(a => {
            if (a.dealId !== deal.id) return;
            if (a.email && a.phone) return;
            const pc = deal.primary_contact;
            if (pc) {
              if (!a.email) a.email = pc.email;
              if (!a.phone) a.phone = pc.phone || pc.mobile;
              if (!a.company && pc.full_name) a.company = pc.full_name;
            }
            if (!a.deal) a.deal = deal;
            if (a.dealValue == null) a.dealValue = getDealValue(deal);
          });
        });
        // Attach next_follow_up_date from contacts for display/sort
        (contactsData || []).forEach(c => {
          actions.forEach(a => {
            if (a.contactId === c.id && c.next_follow_up_date) a.next_follow_up_date = c.next_follow_up_date;
          });
        });
        window.priorityActionsFullList = actions;
        applyPriorityFiltersAndRender();
      } catch (error) {
        console.error('[Priority] Error loading priority actions:', error);
        listEl.innerHTML = `<div class="col-span-full text-center py-12 text-red-500"><i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i><p>Failed to load priority actions</p><p class="text-sm text-gray-500">${error.message}</p></div>`;
        if (window.lucide) lucide.createIcons();
      }
    }

    function applyPriorityFiltersAndRender() {
      const listEl = document.getElementById('priority-actions-full-list');
      if (!listEl) return;
      let actions = [...(window.priorityActionsFullList || [])];
      const search = (document.getElementById('priority-search')?.value || '').trim().toLowerCase();
      const filterPriority = document.getElementById('priority-filter-priority')?.value;
      const filterType = document.getElementById('priority-filter-type')?.value;
      const filterDeal = document.getElementById('priority-filter-deal')?.value;
      const sortBy = document.getElementById('priority-sort')?.value || 'priority';

      if (search) {
        actions = actions.filter(a =>
          (a.company || '').toLowerCase().includes(search) ||
          (a.companyName || '').toLowerCase().includes(search) ||
          (a.reason || '').toLowerCase().includes(search)
        );
      }
      if (filterPriority) {
        const p = parseInt(filterPriority, 10);
        actions = actions.filter(a => a.priorityLevel === p);
      }
      if (filterType) actions = actions.filter(a => a.type === filterType);
      if (filterDeal === 'yes') actions = actions.filter(a => !!a.dealId);
      if (filterDeal === 'no') actions = actions.filter(a => !a.dealId);

      if (sortBy === 'last_activity') {
        actions.sort((a, b) => (new Date(a.lastActivity || 0) - new Date(b.lastActivity || 0)));
      } else if (sortBy === 'deal_value') {
        actions.sort((a, b) => (b.dealValue || 0) - (a.dealValue || 0));
      } else if (sortBy === 'next_followup') {
        actions.sort((a, b) => (new Date(a.next_follow_up_date || 0) - new Date(b.next_follow_up_date || 0)));
      } else {
        actions.sort((a, b) => {
          if (a.priorityLevel !== b.priorityLevel) return a.priorityLevel - b.priorityLevel;
          return a.priority - b.priority;
        });
      }

      window.priorityActionsFilteredList = actions;

      const p1Count = (window.priorityActionsFullList || []).filter(a => a.priorityLevel === 1).length;
      const p2Count = (window.priorityActionsFullList || []).filter(a => a.priorityLevel === 2).length;
      const totalTasks = (window.priorityActionsFullList || []).length;
      const totalValue = (window.priorityActionsFullList || []).reduce((s, a) => s + (a.dealValue || 0), 0);
      const elP1 = document.getElementById('priority-p1-count');
      const elP2 = document.getElementById('priority-p2-count');
      const elTasks = document.getElementById('priority-tasks-count');
      const elValue = document.getElementById('priority-value');
      if (elP1) elP1.textContent = p1Count;
      if (elP2) elP2.textContent = p2Count;
      if (elTasks) elTasks.textContent = totalTasks;
      if (elValue) elValue.textContent = '$' + (totalValue || 0).toLocaleString('en-US', { maximumFractionDigits: 0 });

      if (actions.length === 0) {
        listEl.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-400">
            <i data-lucide="check-circle" class="w-12 h-12 mx-auto mb-3 text-green-500"></i>
            <p class="text-lg font-medium text-gray-600 dark:text-gray-400">All caught up!</p>
            <p class="text-sm">No priority actions match your filters.</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }

      const borderColors = { red: 'border-l-4 border-red-500', orange: 'border-l-4 border-orange-500', yellow: 'border-l-4 border-yellow-500' };
      listEl.innerHTML = actions.map((action, idx) => {
        const dateStr = action.lastActivity ? new Date(action.lastActivity).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' }) : 'No due date';
        const safeCompany = (action.company || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        const safeReason = (action.reason || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        const safeCompanyName = (action.companyName || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return `
        <div class="priority-action-card bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm hover:shadow-md transition text-left ${borderColors[action.color] || ''}" data-action-index="${idx}">
          <div class="p-4">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-semibold text-gray-900 dark:text-white truncate">${safeCompany}</span>
                  ${action.dealId ? `<a href="#" class="priority-open-deal text-xs text-nfgblue hover:underline" data-deal-id="${action.dealId}">Open deal</a>` : ''}
                </div>
                ${safeCompanyName ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${safeCompanyName}</p>` : ''}
                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1 line-clamp-2">${safeReason}</p>
                ${action.next_follow_up_date ? `<p class="text-xs text-nfgblue dark:text-blue-400 mt-1">Next: ${new Date(action.next_follow_up_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>` : ''}
              </div>
              <div class="relative">
                <button type="button" class="priority-card-menu-btn p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700" data-action-index="${idx}" title="Actions">
                  <i data-lucide="more-vertical" class="w-4 h-4 text-gray-500"></i>
                </button>
              </div>
            </div>
            <div class="flex items-center gap-4 mt-3 text-xs text-gray-500 dark:text-gray-400">
              <span class="flex items-center gap-1"><i data-lucide="calendar" class="w-3.5 h-3.5"></i> ${dateStr}</span>
              <span class="flex items-center gap-1"><i data-lucide="message-square" class="w-3.5 h-3.5"></i> ${action.activitiesCount ?? 0}</span>
              <span class="flex items-center gap-1"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> ${action.dealId ? 1 : 0}</span>
            </div>
            <div class="priority-card-detail hidden mt-4 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
              ${action.email ? `<p class="text-sm flex items-center gap-2"><i data-lucide="mail" class="w-4 h-4 text-gray-400"></i> <a href="mailto:${action.email}" class="text-nfgblue hover:underline">${action.email}</a></p>` : ''}
              ${action.phone ? `<p class="text-sm flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4 text-gray-400"></i> <a href="tel:${action.phone}" class="text-nfgblue hover:underline">${action.phone}</a></p>` : ''}
              ${action.dealStage ? `<p class="text-xs"><span class="font-medium">Stage:</span> ${(action.dealStage || '').replace('_', ' ')} ${action.dealValue ? ' Â· $' + Number(action.dealValue).toLocaleString() : ''}</p>` : ''}
            </div>
            <div class="flex flex-wrap gap-2 mt-3 priority-action-bar">
              ${action.phone ? `<a href="tel:${action.phone}" class="priority-call-btn inline-flex items-center gap-1 px-2 py-1.5 bg-nfgblue hover:bg-nfgdark text-white rounded-lg text-xs font-medium"><i data-lucide="phone" class="w-3.5 h-3.5"></i> Call</a>` : ''}
              ${action.email ? `<button type="button" class="priority-email-btn inline-flex items-center gap-1 px-2 py-1.5 border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg text-xs font-medium" data-action-index="${idx}"><i data-lucide="mail" class="w-3.5 h-3.5"></i> Follow-up</button>` : ''}
              ${action.email ? `<button type="button" class="priority-proposal-btn inline-flex items-center gap-1 px-2 py-1.5 border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg text-xs font-medium" data-action-index="${idx}"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> Proposal</button>` : ''}
              <button type="button" class="priority-log-btn inline-flex items-center gap-1 px-2 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-medium" data-action-index="${idx}"><i data-lucide="phone" class="w-3.5 h-3.5"></i> Log</button>
              ${action.dealId ? `<button type="button" class="priority-open-deal-btn inline-flex items-center gap-1 px-2 py-1.5 border border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg text-xs font-medium" data-deal-id="${action.dealId}"><i data-lucide="external-link" class="w-3.5 h-3.5"></i> Deal</button>` : ''}
            </div>
          </div>
        </div>
        `;
      }).join('');

      if (window.lucide) lucide.createIcons();
      attachPriorityCardHandlers(listEl);
    }

    function attachPriorityCardHandlers(container) {
      if (!container) return;
      const actions = window.priorityActionsFilteredList || [];
      container.querySelectorAll('.priority-action-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (e.target.closest('.priority-card-menu-btn, .priority-action-bar a, .priority-action-bar button, .priority-open-deal')) return;
          const detail = card.querySelector('.priority-card-detail');
          if (detail) detail.classList.toggle('hidden');
          if (window.lucide) lucide.createIcons();
        });
      });
      container.querySelectorAll('.priority-card-menu-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = parseInt(btn.dataset.actionIndex, 10);
          openPriorityCardMenu(idx, btn);
        });
      });
      container.querySelectorAll('.priority-log-btn').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); const idx = parseInt(btn.dataset.actionIndex, 10); openPriorityQuickLog(idx); });
      });
      container.querySelectorAll('.priority-email-btn').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); const idx = parseInt(btn.dataset.actionIndex, 10); openPriorityCompose(idx, 'follow_up'); });
      });
      container.querySelectorAll('.priority-proposal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => { e.stopPropagation(); const idx = parseInt(btn.dataset.actionIndex, 10); openPriorityCompose(idx, 'proposal'); });
      });
      container.querySelectorAll('.priority-open-deal, .priority-open-deal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const did = btn.dataset.dealId; if (did && window.sales && window.sales.openDealDetail) window.sales.openDealDetail(did); });
      });
    }

    function openPriorityCardMenu(actionIndex, buttonEl) {
      const actions = window.priorityActionsFilteredList || [];
      const action = actions[actionIndex];
      if (!action) return;
      const portal = document.getElementById('priority-card-menu-portal');
      if (!portal) return;
      const rect = buttonEl.getBoundingClientRect();
      portal.style.left = rect.left + 'px';
      portal.style.top = (rect.bottom + 4) + 'px';
      portal.classList.remove('hidden');
      const isContact = !!action.contactId;
      portal.innerHTML = `
        ${action.phone ? `<a href="tel:${action.phone}" class="flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"><i data-lucide="phone" class="w-4 h-4"></i> Call</a>` : ''}
        ${action.email ? `<button type="button" class="priority-menu-email w-full text-left flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-idx="${actionIndex}" data-type="follow_up"><i data-lucide="mail" class="w-4 h-4"></i> Send follow-up</button>` : ''}
        ${action.email ? `<button type="button" class="priority-menu-proposal w-full text-left flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-idx="${actionIndex}" data-type="proposal"><i data-lucide="file-text" class="w-4 h-4"></i> Send proposal</button>` : ''}
        <button type="button" class="priority-menu-log w-full text-left flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-idx="${actionIndex}"><i data-lucide="phone-call" class="w-4 h-4"></i> Log activity</button>
        <button type="button" class="priority-menu-quick-log w-full text-left flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-idx="${actionIndex}"><i data-lucide="calendar" class="w-4 h-4"></i> Schedule next</button>
        ${action.dealId ? `<button type="button" class="priority-menu-deal w-full text-left flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" data-deal-id="${action.dealId}"><i data-lucide="external-link" class="w-4 h-4"></i> Open deal</button>` : ''}
      `;
      if (window.lucide) lucide.createIcons();
      portal.querySelectorAll('.priority-menu-email, .priority-menu-proposal').forEach(b => {
        b.addEventListener('click', () => { const idx = parseInt(b.dataset.idx, 10); const type = b.dataset.type; openPriorityCompose(idx, type); portal.classList.add('hidden'); });
      });
      portal.querySelectorAll('.priority-menu-log').forEach(b => {
        b.addEventListener('click', () => { const idx = parseInt(b.dataset.idx, 10); const a = (window.priorityActionsFilteredList || [])[idx]; if (a && a.contactId && window.openLogActivityForContact) window.openLogActivityForContact(a.contactId); portal.classList.add('hidden'); });
      });
      portal.querySelectorAll('.priority-menu-quick-log').forEach(b => {
        b.addEventListener('click', () => { openPriorityQuickLog(parseInt(b.dataset.idx, 10)); portal.classList.add('hidden'); });
      });
      portal.querySelectorAll('.priority-menu-deal').forEach(b => {
        b.addEventListener('click', () => { const did = b.dataset.dealId; if (did && window.sales && window.sales.openDealDetail) window.sales.openDealDetail(did); portal.classList.add('hidden'); });
      });
      const closeMenu = () => { portal.classList.add('hidden'); document.removeEventListener('click', closeMenu); };
      setTimeout(() => document.addEventListener('click', closeMenu), 0);
    }

    function openPriorityCompose(actionIndex, type) {
      const actions = window.priorityActionsFilteredList || [];
      const action = actions[actionIndex];
      if (!action || !action.email) return;
      const deal = action.deal || (action.dealId ? null : null);
      if (window.sales && typeof window.sales.openComposeModal === 'function') {
        window.sales.openComposeModal(deal || { contact: { email: action.email, name: action.company }, primary_contact: { email: action.email, full_name: action.company }, sites: {}, id: action.dealId }, type);
        document.getElementById('compose-to').value = action.email;
      }
    }

    function openPriorityQuickLog(actionIndex) {
      const actions = window.priorityActionsFilteredList || [];
      const action = actions[actionIndex];
      if (!action) return;
      document.getElementById('priority-quick-log-contact-id').value = action.contactId || '';
      document.getElementById('priority-quick-log-deal-id').value = action.dealId || '';
      document.getElementById('priority-quick-log-modal').classList.remove('hidden');
      if (window.lucide) lucide.createIcons();
    }

    function closePriorityQuickLogModal() {
      document.getElementById('priority-quick-log-modal').classList.add('hidden');
    }

    async function savePriorityQuickLog() {
      const contactId = document.getElementById('priority-quick-log-contact-id')?.value?.trim() || null;
      const dealId = document.getElementById('priority-quick-log-deal-id')?.value?.trim() || null;
      const outcome = document.getElementById('priority-quick-log-outcome')?.value;
      const nextDate = document.getElementById('priority-quick-log-next-date')?.value || null;
      const note = document.getElementById('priority-quick-log-note')?.value?.trim() || null;
      if (!contactId && !dealId) { toast.error('No contact or deal', 'Error'); return; }
      try {
        if (contactId) {
          if (typeof window.saveActivityForContact === 'function') {
            await window.saveActivityForContact(contactId, { outcome, nextDate, note });
          } else {
            await savePriorityQuickLogToContact(contactId, { outcome, nextDate, note });
          }
        } else if (dealId) {
          await savePriorityQuickLogToDeal(dealId, { outcome, nextDate, note });
        }
        closePriorityQuickLogModal();
        loadPriorityActionsPage();
      } catch (e) {
        toast.error(e.message || 'Failed to save', 'Error');
      }
    }

    async function savePriorityQuickLogToContact(contactId, { outcome, nextDate, note }) {
      const updateData = {
        updated_at: new Date().toISOString(),
        last_contact_attempt_at: new Date().toISOString()
      };
      if (nextDate) updateData.next_follow_up_date = nextDate;
      const { error } = await supabase.from('contacts').update(updateData).eq('id', contactId);
      if (error) throw error;
      toast.success('Activity logged', 'Saved');
    }

    async function savePriorityQuickLogToDeal(dealId, { outcome, nextDate, note }) {
      const updateData = { updated_at: new Date().toISOString() };
      if (nextDate) updateData.next_action_date = nextDate;
      const { error } = await supabase.from('deals').update(updateData).eq('id', dealId);
      if (error) throw error;
      toast.success('Activity logged', 'Saved');
    }
    
    // Generate priority actions for full page (returns all, not limited)
    function generatePriorityActionsForPage(contacts = []) {
      const actions = [];
      const now = new Date();
      
      const daysSince = (date) => {
        if (!date) return Infinity;
        return Math.floor((now - new Date(date)) / (1000 * 60 * 60 * 24));
      };
      
      contacts.forEach(c => {
        const streak = c.no_contact_streak || 0;
        const contactName = c.full_name || `${c.first_name || ''} ${c.last_name || ''}`.trim() || c.email || 'Unknown';
        
        // P1: Final attempt (2/3)
        if (streak === 2) {
          actions.push({
            type: 'contact_final_attempt',
            priorityLevel: 1,
            priority: 0,
            company: contactName,
            companyName: c.company_name,
            reason: 'ðŸš¨ FINAL ATTEMPT - 2 no-contacts in a row. One more and they\'re marked as lost.',
            lastActivity: c.last_contact_attempt_at || c.updated_at,
            contactId: c.id,
            streak: streak,
            color: 'red',
            phone: c.phone || c.normalized_phone,
            email: c.email
          });
          return; // Don't add other actions for this contact
        }
        
        // P1: Missed follow-up
        if (c.next_follow_up_date) {
          const followUpDate = new Date(c.next_follow_up_date);
          if (followUpDate < now) {
            actions.push({
              type: 'contact_missed_followup',
              priorityLevel: 1,
              priority: 5,
              company: contactName,
              companyName: c.company_name,
              reason: `ðŸ“ž Missed scheduled follow-up: ${c.next_follow_up_type || 'Call'} was due ${followUpDate.toLocaleDateString()}`,
              lastActivity: c.last_contact_attempt_at || c.updated_at,
              contactId: c.id,
              color: 'red',
              phone: c.phone || c.normalized_phone,
              email: c.email
            });
            return;
          }
        }
        
        // P2: 1 no-contact (attempt 2 of 3)
        if (streak === 1) {
          actions.push({
            type: 'contact_follow_up',
            priorityLevel: 2,
            priority: 100,
            company: contactName,
            companyName: c.company_name,
            reason: 'ðŸ“± Follow up needed - 1 no-contact so far (attempt 2 of 3)',
            lastActivity: c.last_contact_attempt_at || c.updated_at,
            contactId: c.id,
            streak: streak,
            color: 'orange',
            phone: c.phone || c.normalized_phone,
            email: c.email
          });
          return;
        }
        
        // P2: Quote sent, needs follow-up
        if (c.quote_sent_at) {
          const daysSinceQuote = daysSince(c.quote_sent_at);
          if (daysSinceQuote >= 1 && daysSinceQuote <= 7) {
            let followUpText = '';
            if (daysSinceQuote <= 1) followUpText = 'Day 1: Check if quote was received';
            else if (daysSinceQuote <= 3) followUpText = 'Day 3: Ask if they have any questions';
            else followUpText = 'Day 7: Final quote follow-up before expiry';
            
            actions.push({
              type: 'contact_quote_followup',
              priorityLevel: 2,
              priority: 100 + daysSinceQuote,
              company: contactName,
              companyName: c.company_name,
              reason: `ðŸ“„ Quote Follow-up - ${followUpText}`,
              lastActivity: c.quote_sent_at,
              contactId: c.id,
              color: 'orange',
              phone: c.phone || c.normalized_phone,
              email: c.email
            });
            return;
          }
        }
        
        // P3: New contacts never contacted
        if ((c.total_contact_attempts || 0) === 0 && !c.last_contacted_at) {
          actions.push({
            type: 'contact_new',
            priorityLevel: 3,
            priority: 200,
            company: contactName,
            companyName: c.company_name,
            reason: 'ðŸ†• New contact - make your first call to introduce services',
            lastActivity: c.created_at,
            contactId: c.id,
            color: 'yellow',
            phone: c.phone || c.normalized_phone,
            email: c.email
          });
          return;
        }
        
        // P3: Idle contacts (>7 days)
        if (c.total_contact_attempts > 0) {
          const lastTouch = c.last_contacted_at || c.last_contact_attempt_at;
          const days = daysSince(lastTouch);
          if (days >= 7 && days < 30) {
            actions.push({
              type: 'contact_idle',
              priorityLevel: 3,
              priority: 200 + days,
              company: contactName,
              companyName: c.company_name,
              reason: `ðŸ’¤ Re-engage contact - ${days} days since last activity`,
              lastActivity: lastTouch,
              contactId: c.id,
              color: 'yellow',
              phone: c.phone || c.normalized_phone,
              email: c.email
            });
          }
        }
      });
      
      // Sort by priority level, then by priority score
      return actions.sort((a, b) => {
        if (a.priorityLevel !== b.priorityLevel) return a.priorityLevel - b.priorityLevel;
        return a.priority - b.priority;
      });
    }
    
    // Expose to window for refresh button
    window.loadPriorityActionsPage = loadPriorityActionsPage;

    // Render deals in kanban board
    // Expose to window for quote wizard to refresh deals
    window.renderDealsKanban = function renderDealsKanban(deals) {
      // Store deals globally for view switching
      globalDealsData = deals;
      
      const kanbanBoard = document.getElementById('deals-kanban');
      if (!kanbanBoard) return;

      const stages = ['qualification', 'proposal', 'negotiation', 'closed_won', 'closed_lost'];
      
      // Clear all columns
      stages.forEach(stage => {
        const column = kanbanBoard.querySelector(`.kanban-deals[data-stage="${stage}"]`);
        const countEl = kanbanBoard.querySelector(`.kanban-column[data-stage="${stage}"] .kanban-count`);
        if (column) column.innerHTML = '';
        if (countEl) countEl.textContent = '0';
      });

      if (deals.length === 0) {
        return;
      }

      // Group deals by stage
      const dealsByStage = {};
      stages.forEach(stage => {
        dealsByStage[stage] = deals.filter(d => d.stage === stage);
      });

      // Render deals in each column
      stages.forEach(stage => {
        const column = kanbanBoard.querySelector(`.kanban-deals[data-stage="${stage}"]`);
        const countEl = kanbanBoard.querySelector(`.kanban-column[data-stage="${stage}"] .kanban-count`);
        const stageDeals = dealsByStage[stage] || [];

        if (countEl) countEl.textContent = stageDeals.length;

        if (column) {
          column.innerHTML = stageDeals.map(deal => {
            const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
            const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
            const isIdle = daysIdle && daysIdle > 7;
            
            // Get company name from site or deal title
            // Check if sites data was loaded (it's an object, not an array)
            let companyName = (deal.sites && typeof deal.sites === 'object' && deal.sites.name) 
              ? deal.sites.name 
              : (deal.title || 'Unnamed Deal');
            
            // Get primary contact name
            // Check if primary_contact data was loaded (it's an object, not an array)
            let contactName = (deal.primary_contact && typeof deal.primary_contact === 'object' && deal.primary_contact.full_name)
              ? deal.primary_contact.full_name
              : ((deal.primary_contact && typeof deal.primary_contact === 'object' && deal.primary_contact.email)
                ? deal.primary_contact.email
                : 'No contact');
            
            // Fallback: Try to parse from notes if site/contact data not available
            // Notes format: "Contact: First Last | email | phone | title\n\nEstimated Value: $..."
            if (contactName === 'No contact' && deal.notes) {
              const contactMatch = deal.notes.match(/Contact:\s*([^|]+)/);
              if (contactMatch) {
                contactName = contactMatch[1].trim();
              }
            }
            
            // If still no company name and title looks generic, try to extract from notes
            if ((companyName === deal.title || companyName === 'Unnamed Deal') && deal.notes) {
              // Notes might have company info stored
              // This is a fallback - ideally site_id should be set
            }
            
            // Get deal value - check multiple possible fields
            let dealValue = getDealValue(deal);
            
            // Fallback: Parse from notes if value is 0 and notes contain "Estimated Value: $X"
            if (dealValue === 0 && deal.notes) {
              const valueMatch = deal.notes.match(/Estimated Value:\s*\$?([\d,]+\.?\d*)/i);
              if (valueMatch) {
                dealValue = Number(valueMatch[1].replace(/,/g, '')) || 0;
              }
            }
            
            // Determine status and priority
            let statusTag = '';
            let statusColorClass = 'bg-purple-400';
            if (stage === 'qualification') {
              statusTag = 'In Research';
              statusColorClass = 'bg-yellow-400';
            } else if (stage === 'proposal') {
              statusTag = 'On Track';
              statusColorClass = 'bg-pink-400';
            } else if (stage === 'negotiation') {
              statusTag = 'On Track';
              statusColorClass = 'bg-pink-400';
            } else if (stage === 'closed_won') {
              statusTag = 'Complete';
              statusColorClass = 'bg-green-400';
            } else {
              statusTag = 'Not Started';
              statusColorClass = 'bg-purple-400';
            }
            
            // Determine priority based on deal value and stage
            let priority = 'Low';
            let priorityBgClass = 'bg-purple-100';
            let priorityTextClass = 'text-purple-700';
            let priorityDarkBgClass = 'dark:bg-purple-900/30';
            let priorityDarkTextClass = 'dark:text-purple-300';
            if (dealValue >= 10000) {
              priority = 'High';
              priorityBgClass = 'bg-red-100';
              priorityTextClass = 'text-red-700';
              priorityDarkBgClass = 'dark:bg-red-900/30';
              priorityDarkTextClass = 'dark:text-red-300';
            } else if (dealValue >= 5000) {
              priority = 'Medium';
              priorityBgClass = 'bg-orange-100';
              priorityTextClass = 'text-orange-700';
              priorityDarkBgClass = 'dark:bg-orange-900/30';
              priorityDarkTextClass = 'dark:text-orange-300';
            }
            
            // Format due date or last contact
            let dateText = '';
            if (deal.expected_close_date) {
              const closeDate = new Date(deal.expected_close_date);
              const today = new Date();
              const daysUntil = Math.ceil((closeDate - today) / (1000 * 60 * 60 * 24));
              if (daysUntil < 0) {
                dateText = 'Overdue';
              } else if (daysUntil === 0) {
                dateText = 'Today';
              } else if (daysUntil <= 7) {
                dateText = closeDate.toLocaleDateString('en-CA', { day: 'numeric', month: 'short', year: 'numeric' });
              } else {
                dateText = closeDate.toLocaleDateString('en-CA', { day: 'numeric', month: 'short', year: 'numeric' });
              }
            } else if (lastContact) {
              dateText = daysIdle !== null ? daysIdle + 'd ago' : 'Recently';
            }
            
            // Get assignee initials (placeholder for now)
            const assigneeInitials = contactName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() || 'NF';
            
            // Count comments and links (placeholder - would need to fetch from related tables)
            const commentCount = 0; // deal.comments?.length || 0;
            const linkCount = 0; // deal.links?.length || 0;
            
            // No-contact streak badge
            const noContactStreak = deal.no_contact_streak || 0;
            let streakBadge = '';
            if (noContactStreak === 2) {
              streakBadge = `<span class="px-1.5 py-0.5 text-xs font-bold rounded bg-red-500 text-white animate-pulse">âš ï¸ 2/3</span>`;
            } else if (noContactStreak === 1) {
              streakBadge = `<span class="px-1.5 py-0.5 text-xs font-medium rounded bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400">1/3</span>`;
            }
            
            return `
              <div 
                class="deal-card bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-4 shadow-sm hover:shadow-md transition cursor-move ${isIdle ? 'border-red-300 dark:border-red-700' : ''} ${noContactStreak >= 2 ? 'border-l-4 border-l-red-500' : noContactStreak === 1 ? 'border-l-4 border-l-yellow-400' : ''}" 
                data-deal-id="${deal.id}"
                draggable="true"
              >
                <!-- Status Tag -->
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full ${statusColorClass}"></span>
                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400">${statusTag}</span>
                  </div>
                  ${streakBadge}
                </div>
                
                <!-- Company Name -->
                <h4 class="font-semibold text-gray-900 dark:text-white text-sm mb-1 line-clamp-2">${companyName}</h4>
                
                <!-- Primary Contact Name -->
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3 line-clamp-1">${contactName}</p>
                
                <!-- Assignees and Due Date -->
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center -space-x-2">
                    <div class="w-6 h-6 rounded-full bg-nfgblue text-white text-xs flex items-center justify-center font-medium border-2 border-white dark:border-gray-800">
                      ${assigneeInitials}
                    </div>
                  </div>
                  ${dateText ? `<span class="text-xs text-gray-500 dark:text-gray-400">${dateText}</span>` : ''}
                </div>
                
                <!-- Priority and Value -->
                <div class="flex items-center justify-between mb-3">
                  <span class="px-2 py-0.5 rounded text-xs font-medium ${priorityBgClass} ${priorityTextClass} ${priorityDarkBgClass} ${priorityDarkTextClass}">${priority}</span>
                  <span class="text-sm font-semibold text-gray-900 dark:text-white">$${dealValue.toLocaleString()}</span>
                </div>
                
                <!-- Metadata and Quick Actions -->
                <div class="flex items-center justify-between pt-2 border-t border-gray-100 dark:border-gray-700">
                  <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
                      <i data-lucide="phone" class="w-3 h-3"></i>
                      <span>${deal.total_contact_attempts || 0}</span>
                    </div>
                    ${isIdle ? '<span class="text-xs text-red-600 dark:text-red-400 font-medium">Idle</span>' : ''}
                  </div>
                  <button 
                    onclick="event.stopPropagation(); window.openLogActivity('${deal.id}')" 
                    class="px-2 py-1 text-xs font-medium text-nfgblue hover:bg-nfglight dark:hover:bg-gray-700 rounded transition flex items-center gap-1"
                    title="Log Activity"
                  >
                    <i data-lucide="plus-circle" class="w-3.5 h-3.5"></i>
                    Log
                  </button>
                </div>
              </div>
            `;
          }).join('');

          // Add drag and drop event listeners
          column.querySelectorAll('.deal-card').forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('click', async (e) => {
              // Don't trigger if clicking on a button or interactive element
              if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                return;
              }
              
              e.preventDefault();
              e.stopPropagation();
              
              const dealId = card.dataset.dealId;
              console.log('[Sales] Deal card clicked, dealId:', dealId);
              console.log('[Sales] window.sales available:', !!window.sales);
              console.log('[Sales] openDealDetail function available:', !!(window.sales && typeof window.sales.openDealDetail === 'function'));
              
              if (window.sales && typeof window.sales.openDealDetail === 'function') {
                console.log('[Sales] Calling window.sales.openDealDetail');
                await window.sales.openDealDetail(dealId);
              } else if (window.openDeal) {
                console.log('[Sales] Falling back to window.openDeal');
                await window.openDeal(dealId);
              } else {
                console.error('[Sales] Deal detail function not available');
                console.error('[Sales] window.sales:', window.sales);
                toast.error('Unable to open deal details. Check console for details.', 'Error');
              }
            });
          });

          // Add drop zone listeners
          column.addEventListener('dragover', handleDragOver);
          column.addEventListener('drop', handleDrop);
          column.addEventListener('dragenter', handleDragEnter);
          column.addEventListener('dragleave', handleDragLeave);
        }
      });
      
      // Initialize icons after rendering
      if (window.lucide) {
        lucide.createIcons();
      }
    }
    
    // Store deals data globally for all views
    let globalDealsData = [];

    // View option handlers
    function initViewOptions() {
      document.querySelectorAll('.view-option').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const view = e.currentTarget.dataset.view;
          
          // Update active button
          document.querySelectorAll('.view-option').forEach(b => {
            b.classList.remove('active');
            b.classList.remove('bg-white', 'dark:bg-gray-700');
            b.classList.add('text-gray-600', 'dark:text-gray-400');
            b.classList.remove('text-nfgblue', 'dark:text-blue-400');
          });
          e.currentTarget.classList.add('active');
          e.currentTarget.classList.add('bg-white', 'dark:bg-gray-700');
          e.currentTarget.classList.remove('text-gray-600', 'dark:text-gray-400');
          e.currentTarget.classList.add('text-nfgblue', 'dark:text-blue-400');
          
          // Switch views
          switchDealsView(view);
        });
      });
    }

    // Closed Lost column: three-dots menu with "Clear pipeline" only (no plus button)
    function setupClosedLostPipelineMenu() {
      const menuBtn = document.getElementById('kanban-closed-lost-menu-btn');
      const dropdown = document.getElementById('kanban-closed-lost-dropdown');
      const clearBtn = document.getElementById('kanban-closed-lost-clear-btn');
      if (!menuBtn || !dropdown || !clearBtn) return;

      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
        if (window.lucide) lucide.createIcons();
      });

      document.addEventListener('click', () => {
        dropdown.classList.add('hidden');
      });
      dropdown.addEventListener('click', (e) => e.stopPropagation());

      clearBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        dropdown.classList.add('hidden');
        try {
          const { data: closedLostDeals, error: fetchErr } = await supabase
            .from('deals')
            .select('id')
            .eq('stage', 'closed_lost');
          if (fetchErr) throw fetchErr;
          const ids = (closedLostDeals || []).map(d => d.id);
          if (ids.length === 0) {
            toast.info('Closed Lost pipeline is already empty', 'Info');
            return;
          }
          if (!confirm(`Permanently delete all ${ids.length} deal(s) in Closed Lost? This cannot be undone.`)) return;
          const { error: deleteErr } = await supabase.from('deals').delete().in('id', ids);
          if (deleteErr) throw deleteErr;
          if (window.loadDealsForDashboard && window.renderDealsKanban) {
            const data = await loadDealsForDashboard();
            renderDealsKanban(data);
          }
          toast.success(`Removed ${ids.length} deal(s) from Closed Lost`, 'Success');
        } catch (err) {
          console.error('[Sales] Clear Closed Lost pipeline:', err);
          toast.error(err.message || 'Failed to clear pipeline', 'Error');
        }
      });
    }

    // Closed Won column: three-dots menu (Clear pipeline, Export deals) â€” no plus button
    function setupClosedWonPipelineMenu() {
      const menuBtn = document.getElementById('kanban-closed-won-menu-btn');
      const dropdown = document.getElementById('kanban-closed-won-dropdown');
      const clearBtn = document.getElementById('kanban-closed-won-clear-btn');
      const exportBtn = document.getElementById('kanban-closed-won-export-btn');
      if (!menuBtn || !dropdown || !clearBtn) return;

      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.kanban-stage-dropdown, #kanban-closed-lost-dropdown').forEach(el => { if (el !== dropdown) el.classList.add('hidden'); });
        dropdown.classList.toggle('hidden');
        if (window.lucide) lucide.createIcons();
      });
      document.addEventListener('click', () => dropdown.classList.add('hidden'));
      dropdown.addEventListener('click', (e) => e.stopPropagation());

      clearBtn.addEventListener('click', async (e) => {
        e.stopPropagation();
        dropdown.classList.add('hidden');
        try {
          const { data: deals, error: fetchErr } = await supabase.from('deals').select('id').eq('stage', 'closed_won');
          if (fetchErr) throw fetchErr;
          const ids = (deals || []).map(d => d.id);
          if (ids.length === 0) {
            toast.info('Closed Won pipeline is already empty', 'Info');
            return;
          }
          if (!confirm(`Permanently delete all ${ids.length} deal(s) in Closed Won? This cannot be undone.`)) return;
          const { error: deleteErr } = await supabase.from('deals').delete().in('id', ids);
          if (deleteErr) throw deleteErr;
          if (window.loadDealsForDashboard && window.renderDealsKanban) {
            const data = await loadDealsForDashboard();
            renderDealsKanban(data);
          }
          toast.success(`Removed ${ids.length} deal(s) from Closed Won`, 'Success');
        } catch (err) {
          console.error('[Sales] Clear Closed Won pipeline:', err);
          toast.error(err.message || 'Failed to clear pipeline', 'Error');
        }
      });

      if (exportBtn) {
        exportBtn.addEventListener('click', async (e) => {
          e.stopPropagation();
          dropdown.classList.add('hidden');
          const data = await loadDealsForDashboard();
          const deals = (data || []).filter(d => d.stage === 'closed_won');
          exportDealsToCsv(deals, 'Closed Won');
        });
      }
    }

    // Export deals to CSV and trigger download
    function exportDealsToCsv(deals, stageLabel) {
      if (!deals || deals.length === 0) {
        toast.info('No deals to export', 'Info');
        return;
      }
      const headers = ['Title', 'Stage', 'Value', 'Updated'];
      const rows = deals.map(d => {
        const title = d.title || (d.sites && d.sites.name) || 'Untitled';
        const value = d.deal_value ?? d.estimated_value ?? d.value_estimate ?? '';
        const updated = d.updated_at ? new Date(d.updated_at).toLocaleDateString() : '';
        return [title, d.stage || '', value, updated];
      });
      const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `deals-${(stageLabel || 'export').replace(/\s+/g, '-').toLowerCase()}-${new Date().toISOString().slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
      toast.success(`Exported ${deals.length} deal(s)`, 'Export');
    }

    // Qualification / Proposal / Negotiation: plus = New deal with stage, three-dots = Export + View in list
    function setupKanbanPlusAndStageMenus() {
      document.querySelectorAll('.kanban-plus-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const stage = btn.dataset.stage;
          if (window.switchTab) switchTab('deals');
          const modal = document.getElementById('create-deal-modal');
          const stageSelect = document.getElementById('deal-stage-select');
          if (modal) modal.classList.remove('hidden');
          if (stageSelect && stage) stageSelect.value = stage;
          if (window.lucide) lucide.createIcons();
        });
      });

      document.querySelectorAll('.kanban-menu-btn').forEach(menuBtn => {
        const stage = menuBtn.dataset.stage;
        const column = menuBtn.closest('.kanban-column');
        const dropdown = column ? column.querySelector('.kanban-stage-dropdown') : null;
        if (!dropdown) return;

        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.kanban-stage-dropdown, #kanban-closed-lost-dropdown, #kanban-closed-won-dropdown').forEach(el => { if (el !== dropdown) el.classList.add('hidden'); });
          dropdown.classList.toggle('hidden');
          if (window.lucide) lucide.createIcons();
        });

        dropdown.querySelectorAll('.kanban-export-btn').forEach(exportBtn => {
          exportBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            dropdown.classList.add('hidden');
            const data = await loadDealsForDashboard();
            const deals = (data || []).filter(d => d.stage === stage);
            const label = { qualification: 'Qualification', proposal: 'Proposal', negotiation: 'Negotiation' }[stage] || stage;
            exportDealsToCsv(deals, label);
          });
        });

        dropdown.querySelectorAll('.kanban-view-list-btn').forEach(viewBtn => {
          viewBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            dropdown.classList.add('hidden');
            if (window.switchTab) switchTab('deals');
            const data = await loadDealsForDashboard();
            globalDealsData = data || [];
            const filtered = globalDealsData.filter(d => d.stage === stage);
            switchDealsView('list');
            renderDealsList(filtered);
            toast.info(`Showing ${filtered.length} deal(s) in list`, 'List view');
          });
        });
      });

      document.addEventListener('click', () => {
        document.querySelectorAll('.kanban-stage-dropdown').forEach(el => el.classList.add('hidden'));
      });
    }

    // Priority Actions tab: search, sort, filters, quick log, add customer
    function setupPriorityTabListeners() {
      const searchEl = document.getElementById('priority-search');
      const sortEl = document.getElementById('priority-sort');
      const filtersBtn = document.getElementById('priority-filters-btn');
      const filtersPanel = document.getElementById('priority-filters-panel');
      const filtersApply = document.getElementById('priority-filters-apply');
      const meBtn = document.getElementById('priority-me-btn');
      const addCustomerBtn = document.getElementById('priority-add-customer-btn');
      const quickLogSave = document.getElementById('priority-quick-log-save');
      const quickLogClose = document.getElementById('priority-quick-log-close');
      const quickLogCancel = document.getElementById('priority-quick-log-cancel');

      if (searchEl) searchEl.addEventListener('input', () => typeof applyPriorityFiltersAndRender === 'function' && applyPriorityFiltersAndRender());
      if (searchEl) searchEl.addEventListener('change', () => typeof applyPriorityFiltersAndRender === 'function' && applyPriorityFiltersAndRender());
      if (sortEl) sortEl.addEventListener('change', () => typeof applyPriorityFiltersAndRender === 'function' && applyPriorityFiltersAndRender());
      if (filtersBtn && filtersPanel) filtersBtn.addEventListener('click', () => filtersPanel.classList.toggle('hidden'));
      if (filtersApply) filtersApply.addEventListener('click', () => { if (filtersPanel) filtersPanel.classList.add('hidden'); typeof applyPriorityFiltersAndRender === 'function' && applyPriorityFiltersAndRender(); });
      if (meBtn) meBtn.addEventListener('click', () => { if (typeof applyPriorityFiltersAndRender === 'function') applyPriorityFiltersAndRender(); });
      if (addCustomerBtn) addCustomerBtn.addEventListener('click', () => {
        if (window.sales && typeof window.sales.openCreateDealModal === 'function') window.sales.openCreateDealModal();
        else { const modal = document.getElementById('create-deal-modal'); if (modal) modal.classList.remove('hidden'); }
        if (window.lucide) lucide.createIcons();
      });
      if (quickLogSave) quickLogSave.addEventListener('click', () => typeof savePriorityQuickLog === 'function' && savePriorityQuickLog());
      if (quickLogClose) quickLogClose.addEventListener('click', () => typeof closePriorityQuickLogModal === 'function' && closePriorityQuickLogModal());
      if (quickLogCancel) quickLogCancel.addEventListener('click', () => typeof closePriorityQuickLogModal === 'function' && closePriorityQuickLogModal());
      const refreshBtn = document.getElementById('priority-refresh-btn');
      if (refreshBtn) refreshBtn.addEventListener('click', () => { if (typeof loadPriorityActionsPage === 'function') loadPriorityActionsPage(); });
    }

    // Switch between deals views
    function switchDealsView(view) {
      // Hide all views
      document.querySelectorAll('.deals-view').forEach(v => v.classList.add('hidden'));
      
      // Show selected view
      let viewElement = null;
      switch(view) {
        case 'overview':
          viewElement = document.getElementById('deals-overview-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsOverview(globalDealsData);
          }
          break;
        case 'board':
          viewElement = document.getElementById('deals-board-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsKanban(globalDealsData);
          }
          break;
        case 'list':
          viewElement = document.getElementById('deals-list-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsList(globalDealsData);
          }
          break;
        case 'table':
          viewElement = document.getElementById('deals-table-view');
          if (viewElement && globalDealsData.length > 0) {
            renderDealsTable(globalDealsData);
          }
          break;
      }
      
      if (viewElement) {
        viewElement.classList.remove('hidden');
      }
    }

    // Render deals overview (dashboard-style)
    function renderDealsOverview(deals) {
      const container = document.getElementById('deals-overview-content');
      if (!container) return;

      const stages = ['qualification', 'proposal', 'negotiation', 'closed_won', 'closed_lost'];
      const stageLabels = {
        qualification: 'Qualification',
        proposal: 'Proposal',
        negotiation: 'Negotiation',
        closed_won: 'Closed Won',
        closed_lost: 'Closed Lost'
      };

      // Calculate totals
      const totalDeals = deals.length;
      const totalValue = deals.reduce((sum, d) => sum + getDealValue(d), 0);
      const openDeals = deals.filter(d => !d.stage?.includes('closed')).length;
      const wonDeals = deals.filter(d => d.stage === 'closed_won').length;
      const winRate = totalDeals > 0 ? ((wonDeals / (wonDeals + deals.filter(d => d.stage === 'closed_lost').length)) * 100).toFixed(1) : 0;

      // Group by stage
      const dealsByStage = {};
      stages.forEach(stage => {
        dealsByStage[stage] = deals.filter(d => d.stage === stage);
      });

      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Deals</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">${totalDeals}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Value</div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">$${totalValue.toLocaleString()}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Open Deals</div>
            <div class="text-2xl font-bold text-nfgblue dark:text-blue-400">${openDeals}</div>
          </div>
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
            <div class="text-sm text-gray-500 dark:text-gray-400 mb-1">Win Rate</div>
            <div class="text-2xl font-bold text-green-600 dark:text-green-400">${winRate}%</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          ${stages.map(stage => {
            const stageDeals = dealsByStage[stage] || [];
            const stageValue = stageDeals.reduce((sum, d) => sum + getDealValue(d), 0);
            return `
              <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-semibold text-gray-700 dark:text-gray-300">${stageLabels[stage]}</h3>
                  <span class="text-sm text-gray-500 dark:text-gray-400">${stageDeals.length}</span>
                </div>
                <div class="text-2xl font-bold text-nfgblue dark:text-blue-400 mb-2">$${stageValue.toLocaleString()}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">${stageDeals.length} deal${stageDeals.length !== 1 ? 's' : ''}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      if (window.lucide) lucide.createIcons();
    }

    // Render deals list view
    function renderDealsList(deals) {
      const container = document.getElementById('deals-list-content');
      if (!container) return;

      if (deals.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
            <i data-lucide="briefcase" class="w-16 h-16 mx-auto text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">No deals found</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
        return;
      }

      container.innerHTML = deals.map(deal => {
        const contactName = deal.contact?.full_name || deal.contact?.email || 'No contact';
        const dealValue = getDealValue(deal);
        const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
        const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
        const isIdle = daysIdle && daysIdle > 7;
        
        // Determine priority
        let priority = 'Low';
        let priorityClass = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300';
        if (dealValue >= 10000) {
          priority = 'High';
          priorityClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
        } else if (dealValue >= 5000) {
          priority = 'Medium';
          priorityClass = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
        }

        // Format stage
        const stageLabels = {
          qualification: 'Qualification',
          proposal: 'Proposal',
          negotiation: 'Negotiation',
          closed_won: 'Closed Won',
          closed_lost: 'Closed Lost'
        };
        const stageLabel = stageLabels[deal.stage] || deal.stage || 'Unknown';

        return `
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 hover:shadow-md transition cursor-pointer" onclick="if (window.openDeal) window.openDeal('${deal.id}')">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <h4 class="font-semibold text-gray-900 dark:text-white">${deal.company_name || deal.title || 'Unnamed Deal'}</h4>
                  <span class="px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${priority}</span>
                  ${isIdle ? '<span class="text-xs text-red-600 dark:text-red-400 font-medium">Idle</span>' : ''}
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">${contactName}</p>
                <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
                  <span>Stage: ${stageLabel}</span>
                  <span>Value: $${dealValue.toLocaleString()}</span>
                  ${lastContact ? `<span>Last contact: ${daysIdle !== null ? daysIdle + 'd ago' : 'Recently'}</span>` : ''}
                </div>
              </div>
              <button class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition">
                <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Render deals table view
    function renderDealsTable(deals) {
      const tbody = document.getElementById('deals-table-content');
      if (!tbody) return;

      if (deals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              No deals found
            </td>
          </tr>
        `;
        return;
      }

      const stageLabels = {
        qualification: 'Qualification',
        proposal: 'Proposal',
        negotiation: 'Negotiation',
        closed_won: 'Closed Won',
        closed_lost: 'Closed Lost'
      };

      tbody.innerHTML = deals.map(deal => {
        const contactName = deal.contact?.full_name || deal.contact?.email || 'No contact';
        const dealValue = getDealValue(deal);
        
        // Determine priority
        let priority = 'Low';
        let priorityClass = 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300';
        if (dealValue >= 10000) {
          priority = 'High';
          priorityClass = 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300';
        } else if (dealValue >= 5000) {
          priority = 'Medium';
          priorityClass = 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300';
        }

        const stageLabel = stageLabels[deal.stage] || deal.stage || 'Unknown';
        const dueDate = deal.expected_close_date ? new Date(deal.expected_close_date).toLocaleDateString('en-CA') : '-';

        return `
          <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer" onclick="if (window.openDeal) window.openDeal('${deal.id}')">
            <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">${deal.company_name || deal.title || 'Unnamed Deal'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${contactName}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${stageLabel}</td>
            <td class="px-4 py-3 text-sm font-semibold text-gray-900 dark:text-white">$${dealValue.toLocaleString()}</td>
            <td class="px-4 py-3 text-sm">
              <span class="px-2 py-0.5 rounded text-xs font-medium ${priorityClass}">${priority}</span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${dueDate}</td>
            <td class="px-4 py-3 text-sm">
              <button class="text-nfgblue dark:text-blue-400 hover:text-nfgdark dark:hover:text-blue-300">
                <i data-lucide="eye" class="w-4 h-4"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');

      if (window.lucide) lucide.createIcons();
    }

    // Drag and drop handlers
    let draggedDeal = null;

    function handleDragStart(e) {
      draggedDeal = e.target;
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', e.target.outerHTML);
    }

    function handleDragEnd(e) {
      e.target.style.opacity = '1';
      document.querySelectorAll('.kanban-deals').forEach(col => {
        col.classList.remove('drag-over');
      });
    }

    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }

    function handleDragEnter(e) {
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    async function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }

      e.currentTarget.classList.remove('drag-over');

      if (draggedDeal) {
        const dealId = draggedDeal.dataset.dealId;
        const newStage = e.currentTarget.dataset.stage;

        if (newStage) {
          await updateDealStageAndConvert(dealId, newStage);
        }
      }

      return false;
    }

    // Render active deals table (kept for backward compatibility)
    function renderActiveDealsTable(deals) {
      const tbody = document.getElementById('deals-table-body');
      if (!tbody) return;

      if (deals.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">
              No active deals
            </td>
          </tr>
        `;
        return;
      }

      // Sort by most recent (updated_at or created_at) and limit to 5
      const sortedDeals = [...deals].sort((a, b) => {
        const aDate = new Date(a.updated_at || a.created_at || 0);
        const bDate = new Date(b.updated_at || b.created_at || 0);
        return bDate - aDate; // Most recent first
      }).slice(0, 5); // Limit to 5 most recent

      tbody.innerHTML = sortedDeals.map(deal => {
        const lastContact = deal.last_contacted_at ? new Date(deal.last_contacted_at) : null;
        const daysIdle = lastContact ? Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24)) : null;
        const isIdle = daysIdle && daysIdle > 7;

        return `
          <tr class="deal-row ${isIdle ? 'bg-red-50 dark:bg-red-900/20' : 'hover:bg-nfglight dark:hover:bg-gray-700'} cursor-pointer transition" data-deal-id="${deal.id}">
            <td class="px-4 py-3 text-sm font-medium text-nfgblue dark:text-blue-400">${deal.company_name || deal.title || 'Unknown'}</td>
            <td class="px-4 py-3">
              <select class="text-sm border border-nfgray dark:border-gray-600 rounded-lg px-2 py-1 bg-white dark:bg-gray-800 text-nftext dark:text-gray-200" onchange="updateDealStage('${deal.id}', this.value)" value="${deal.stage || 'qualification'}">
                <option value="qualification" ${deal.stage === 'qualification' ? 'selected' : ''}>Qualification</option>
                <option value="proposal" ${deal.stage === 'proposal' ? 'selected' : ''}>Proposal</option>
                <option value="negotiation" ${deal.stage === 'negotiation' ? 'selected' : ''}>Negotiation</option>
                <option value="closed_won" ${deal.stage === 'closed_won' ? 'selected' : ''}>Closed Won</option>
                <option value="closed_lost" ${deal.stage === 'closed_lost' ? 'selected' : ''}>Closed Lost</option>
              </select>
            </td>
            <td class="px-4 py-3 text-sm font-semibold">$${getDealValue(deal).toLocaleString()}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${lastContact ? lastContact.toLocaleDateString() : 'Never'}</td>
            <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-400">${deal.next_action_type || 'None'}</td>
            <td class="px-4 py-3 text-sm ${isIdle ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-gray-600 dark:text-gray-400'}">${daysIdle !== null ? daysIdle : 'N/A'}</td>
          </tr>
        `;
      }).join('');

      // Add click handlers to rows
      tbody.querySelectorAll('.deal-row').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.tagName !== 'SELECT') {
            const dealId = row.dataset.dealId;
            window.openDeal(dealId);
          }
        });
      });
    }

    // Render pipeline stage snapshot
    function renderPipelineSnapshot(deals) {
      const stages = [
        { key: 'qualification', label: 'Qualification' },
        { key: 'proposal', label: 'Proposal' },
        { key: 'negotiation', label: 'Negotiation' },
        { key: 'closed_won', label: 'Closed Won' },
        { key: 'closed_lost', label: 'Closed Lost' }
      ];

      const snapshot = document.getElementById('pipeline-snapshot');
      if (!snapshot) return;

      snapshot.innerHTML = stages.map(stage => {
        const stageDeals = deals.filter(d => d.stage === stage.key);
        const totalValue = stageDeals.reduce((sum, d) => sum + getDealValue(d), 0);
        const avgDays = stageDeals.length > 0 
          ? Math.round(stageDeals.reduce((sum, d) => {
              const created = new Date(d.created_at);
              const days = (new Date() - created) / (1000 * 60 * 60 * 24);
              return sum + days;
            }, 0) / stageDeals.length)
          : 0;

        return `
          <div class="pipeline-stage-card bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:shadow-lg transition" data-stage="${stage.key}">
            <div class="text-center">
              <p class="text-2xl font-bold text-nfgblue dark:text-blue-400">${stageDeals.length}</p>
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-1">${stage.label}</p>
              <p class="text-sm font-semibold text-gray-700 dark:text-gray-300">$${totalValue.toLocaleString()}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400">Avg: ${avgDays}d</p>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers to filter table
      snapshot.querySelectorAll('.pipeline-stage-card').forEach(card => {
        card.addEventListener('click', () => {
          const stage = card.dataset.stage;
          filterDealsTableByStage(stage);
        });
      });
    }

    // Calculate and render pipeline analytics
    function calculateAndRenderPipelineAnalytics(deals) {
      const OPEN_STAGES = ['prospecting', 'qualification', 'proposal', 'negotiation'];
      const closedWon = deals.filter(d => d.stage === 'closed_won');
      const closedLost = deals.filter(d => d.stage === 'closed_lost');
      const openDeals = deals.filter(d => OPEN_STAGES.includes(d.stage));

      // Total pipeline value (open deals only)
      const totalPipelineValue = openDeals.reduce((sum, d) => sum + getDealValue(d), 0);
      const elTotal = document.getElementById('analytics-total-pipeline');
      const elDeals = document.getElementById('analytics-total-deals');
      if (elTotal) elTotal.textContent = `$${totalPipelineValue.toLocaleString()}`;
      if (elDeals) elDeals.textContent = `${openDeals.length} active deals`;

      // Trend: this month vs last month pipeline
      const now = new Date();
      const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const thisMonthOpen = openDeals.filter(d => {
        const created = d.created_at ? new Date(d.created_at) : null;
        return created && created >= thisMonthStart;
      });
      const lastMonthOpen = openDeals.filter(d => {
        const created = d.created_at ? new Date(d.created_at) : null;
        return created && created >= lastMonthStart && created < thisMonthStart;
      });
      const trendEl = document.getElementById('analytics-trend-pipeline');
      if (trendEl) {
        const diff = thisMonthOpen.length - lastMonthOpen.length;
        if (lastMonthOpen.length > 0 || thisMonthOpen.length > 0) {
          trendEl.innerHTML = diff >= 0
            ? `<span class="text-green-600 dark:text-green-400">+${diff} vs last month</span>`
            : `<span class="text-red-600 dark:text-red-400">${diff} vs last month</span>`;
        } else {
          trendEl.textContent = '';
        }
      }

      // Win rate & conversion
      const totalClosed = closedWon.length + closedLost.length;
      const winRate = totalClosed > 0 ? Math.round((closedWon.length / totalClosed) * 100) : null;
      const elWinRate = document.getElementById('analytics-win-rate');
      const elWonCount = document.getElementById('analytics-won-count');
      const elLostCount = document.getElementById('analytics-lost-count');
      if (elWinRate) elWinRate.textContent = winRate !== null ? `${winRate}%` : 'â€”';
      if (elWonCount) elWonCount.textContent = closedWon.length;
      if (elLostCount) elLostCount.textContent = closedLost.length;

      // Conversion funnel (stage counts)
      const stages = [
        { key: 'qualification', label: 'Qualification' },
        { key: 'proposal', label: 'Proposal' },
        { key: 'negotiation', label: 'Negotiation' },
        { key: 'closed_won', label: 'Won' }
      ];
      const funnelEl = document.getElementById('analytics-conversion-funnel');
      if (funnelEl) {
        funnelEl.innerHTML = stages.map(s => {
          const count = deals.filter(d => d.stage === s.key).length;
          return `<div class="flex justify-between"><span>${s.label}</span><span class="font-medium">${count}</span></div>`;
        }).join('');
      }

      // Win trend: this month vs last month
      const thisMonthWon = closedWon.filter(d => {
        const updated = d.updated_at ? new Date(d.updated_at) : null;
        return updated && updated >= thisMonthStart;
      });
      const lastMonthWon = closedWon.filter(d => {
        const updated = d.updated_at ? new Date(d.updated_at) : null;
        return updated && updated >= lastMonthStart && updated < thisMonthStart;
      });
      const trendWinEl = document.getElementById('analytics-trend-win');
      if (trendWinEl && (thisMonthWon.length > 0 || lastMonthWon.length > 0)) {
        const diff = thisMonthWon.length - lastMonthWon.length;
        trendWinEl.innerHTML = `Won this month: <strong>${thisMonthWon.length}</strong>${diff !== 0 ? ` (${diff >= 0 ? '+' : ''}${diff} vs last)` : ''}`;
      } else if (trendWinEl) trendWinEl.textContent = '';

      // Won/Lost value breakdown
      const wonValue = closedWon.reduce((sum, d) => sum + getDealValue(d), 0);
      const lostValue = closedLost.reduce((sum, d) => sum + getDealValue(d), 0);
      const elWonValue = document.getElementById('analytics-won-value');
      const elLostValue = document.getElementById('analytics-lost-value');
      if (elWonValue) elWonValue.textContent = `$${wonValue.toLocaleString()}`;
      if (elLostValue) elLostValue.textContent = `$${lostValue.toLocaleString()}`;

      // Loss reasons breakdown
      const reasonsEl = document.getElementById('analytics-loss-reasons');
      if (reasonsEl) {
        const reasonCounts = {};
        closedLost.forEach(d => {
          const r = d.lost_reason || d.closed_reason || 'other';
          reasonCounts[r] = (reasonCounts[r] || 0) + 1;
        });
        const entries = Object.entries(reasonCounts).sort((a, b) => b[1] - a[1]);
        if (entries.length === 0) {
          reasonsEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No lost deals to analyze</p>';
        } else {
          const labels = {
            price_too_high: 'Price',
            competitor: 'Competitor',
            no_decision: 'No decision',
            budget_cut: 'Budget cut',
            timing_not_right: 'Timing',
            features_missing: 'Features',
            abandoned: 'Abandoned',
            won: 'Won',
            lost: 'Lost',
            other: 'Other'
          };
          reasonsEl.innerHTML = entries.map(([k, v]) =>
            `<div class="flex justify-between"><span>${labels[k] || k}</span><span>${v}</span></div>`
          ).join('');
        }
      }

      // Lost trend
      const thisMonthLost = closedLost.filter(d => {
        const updated = d.updated_at ? new Date(d.updated_at) : null;
        return updated && updated >= thisMonthStart;
      });
      const trendLossEl = document.getElementById('analytics-trend-loss');
      if (trendLossEl && (thisMonthLost.length > 0 || closedLost.length > 0)) {
        trendLossEl.textContent = `Lost this month: ${thisMonthLost.length}`;
      } else if (trendLossEl) trendLossEl.textContent = '';
    }

    // Helper functions
    function filterDealsTableByStage(stage) {
      const rows = document.querySelectorAll('#deals-table-body .deal-row');
      rows.forEach(row => {
        const rowStage = row.querySelector('select')?.value;
        if (stage === 'all' || rowStage === stage) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    // Make functions available globally
    window.openDeal = async (dealId) => {
      if (window.sales && typeof window.sales.openDealDetail === 'function') {
        await window.sales.openDealDetail(dealId);
      } else {
        console.error('[Sales] openDealDetail function not available');
        toast.error('Unable to open deal details', 'Error');
      }
    };

    window.openLead = (leadId) => {
      // TODO: Implement lead detail page
      console.log('Open lead:', leadId);
    };

    // ========================================
    // ACTIVITY LOGGER (Contact-Based)
    // ========================================
    let currentActivityContact = null;
    let currentActivityDealId = null; // Optional deal reference
    let selectedActivityType = 'call';
    let selectedOutcome = 'contact_made';

    // Open Create Account Modal
    window.openCreateAccountModal = function() {
      console.log('[Sales] Opening create account modal');
      const modal = document.getElementById('create-account-modal');
      if (modal) {
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
        if (window.lucide) lucide.createIcons();
        console.log('[Sales] Create account modal opened');
      } else {
        console.error('[Sales] Create account modal not found');
      }
    };

    // Open activity logger modal for a CONTACT
    window.openLogActivityForContact = async (contactId, dealId = null) => {
      const modal = document.getElementById('log-activity-modal');
      if (!modal) {
        toast.error('Activity modal not found', 'Error');
        return;
      }

      try {
        // Fetch contact info
        const { data: contact, error } = await supabase
          .from('contacts')
          .select('*')
          .eq('id', contactId)
          .single();

        if (error || !contact) {
          toast.error('Could not load contact', 'Error');
          return;
        }

        currentActivityContact = contact;
        currentActivityDealId = dealId;

        // Populate modal
        document.getElementById('activity-deal-id').value = contactId;
        document.getElementById('activity-deal-name').textContent = contact.full_name || contact.email || 'Unknown Contact';
        document.getElementById('activity-attempt-count').textContent = contact.total_contact_attempts || 0;
        document.getElementById('activity-streak-count').textContent = contact.no_contact_streak || 0;

        // Reset form
        document.getElementById('activity-notes').value = '';
        document.getElementById('activity-next-action').value = '';
        document.getElementById('activity-next-date').value = '';

        // Reset selections
        selectedActivityType = 'call';
        selectedOutcome = 'contact_made';
        updateActivityTypeButtons();
        updateOutcomeButtons();
        updateNoContactWarning();

        // Show modal
        modal.classList.remove('hidden');
        if (window.lucide) lucide.createIcons();
      } catch (err) {
        console.error('[Activity] Error:', err);
        toast.error('Error opening activity logger', 'Error');
      }
    };

    // Backwards compatibility - open for deal (finds primary contact)
    window.openLogActivity = async (dealId) => {
      const modal = document.getElementById('log-activity-modal');
      if (!modal) return;

      // Fetch deal (no embed to avoid 400 if primary_contact_id or FK missing)
      const { data: deal, error } = await supabase
        .from('deals')
        .select('*')
        .eq('id', dealId)
        .single();

      if (error || !deal) {
        toast.error('Could not load deal', 'Error');
        return;
      }

      // Load primary contact separately if column exists
      let primaryContact = null;
      if (deal.primary_contact_id) {
        const { data: contact } = await supabase
          .from('contacts')
          .select('*')
          .eq('id', deal.primary_contact_id)
          .maybeSingle();
        if (contact) primaryContact = contact;
        if (!primaryContact) {
          const { data: profile } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('id', deal.primary_contact_id)
            .maybeSingle();
          if (profile) primaryContact = profile;
        }
      }

      if (primaryContact) {
        currentActivityContact = primaryContact;
        currentActivityDealId = dealId;
      } else {
        // Fallback: create a temporary contact object from deal data
        currentActivityContact = {
          id: null, // No contact ID
          full_name: deal.company_name || deal.title,
          no_contact_streak: deal.no_contact_streak || 0,
          total_contact_attempts: deal.total_contact_attempts || 0
        };
        currentActivityDealId = dealId;
      }

      // Populate modal
      document.getElementById('activity-deal-id').value = currentActivityContact?.id || dealId;
      document.getElementById('activity-deal-name').textContent = currentActivityContact?.full_name || deal.company_name || deal.title || 'Unknown';
      document.getElementById('activity-attempt-count').textContent = currentActivityContact?.total_contact_attempts || 0;
      document.getElementById('activity-streak-count').textContent = currentActivityContact?.no_contact_streak || 0;

      // Reset form
      document.getElementById('activity-notes').value = '';
      document.getElementById('activity-next-action').value = '';
      document.getElementById('activity-next-date').value = '';

      // Reset selections
      selectedActivityType = 'call';
      selectedOutcome = 'contact_made';
      updateActivityTypeButtons();
      updateOutcomeButtons();
      updateNoContactWarning();

      // Show modal
      modal.classList.remove('hidden');
      if (window.lucide) lucide.createIcons();
    };

    // Global function to select activity type (called from onclick)
    window.selectActivityType = function(type) {
      selectedActivityType = type;
      updateActivityTypeButtons();
    };
    
    // Global function to select outcome (called from onclick)
    window.selectOutcome = function(outcome) {
      selectedOutcome = outcome;
      updateOutcomeButtons();
      updateNoContactWarning();
    };
    
    // Global function to close activity modal
    window.closeActivityModal = function() {
      const modal = document.getElementById('log-activity-modal');
      if (modal) {
        modal.classList.add('hidden');
      }
    };
    
    // Global function to submit activity (called from Save button onclick)
    window.submitActivity = async function() {
      const contactId = currentActivityContact?.id;
      const notes = document.getElementById('activity-notes')?.value || '';
      const nextAction = document.getElementById('activity-next-action')?.value || '';
      const nextDate = document.getElementById('activity-next-date')?.value || '';

      console.log('[Activity] Submit clicked');
      console.log('[Activity] Contact:', contactId);
      console.log('[Activity] Type:', selectedActivityType, 'Outcome:', selectedOutcome);
      console.log('[Activity] Notes:', notes);

      if (!contactId && !currentActivityDealId) {
        toast.error('No contact selected', 'Error');
        return;
      }

      const saveBtn = document.getElementById('save-activity-btn');
      if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...';
        if (window.lucide) lucide.createIcons();
      }

      try {
        if (contactId) {
          await saveActivityFallback(contactId, notes, nextAction, nextDate);
        } else if (currentActivityDealId) {
          await saveActivityFallbackDeal(currentActivityDealId, notes, nextAction, nextDate);
        } else {
          toast.error('No contact or deal to save activity for', 'Error');
          return;
        }
        
        // Close modal
        closeActivityModal();
        
        // Refresh priority actions page if visible
        const priorityTab = document.getElementById('tab-priority');
        if (priorityTab && !priorityTab.classList.contains('hidden') && typeof loadPriorityActionsPage === 'function') {
          await loadPriorityActionsPage();
        }
        
        // Refresh dashboard
        if (typeof loadDashboardData === 'function') {
          loadDashboardData();
        }

      } catch (error) {
        console.error('[Activity] Save error:', error);
        toast.error('Failed to save: ' + error.message, 'Error');
      } finally {
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Save Activity';
          if (window.lucide) lucide.createIcons();
        }
      }
    };

    // Update activity type button states
    function updateActivityTypeButtons() {
      document.querySelectorAll('.activity-type-btn').forEach(btn => {
        const isSelected = btn.dataset.type === selectedActivityType;
        btn.classList.toggle('border-nfgblue', isSelected);
        btn.classList.toggle('bg-nfgblue', isSelected);
        btn.classList.toggle('text-white', isSelected);
        btn.classList.toggle('border-nfgray', !isSelected);
        btn.classList.toggle('dark:border-gray-600', !isSelected);
      });
    }

    // Update outcome button states
    function updateOutcomeButtons() {
      document.querySelectorAll('.activity-outcome-btn').forEach(btn => {
        const isSelected = btn.dataset.outcome === selectedOutcome;
        const outcome = btn.dataset.outcome;
        
        // Reset all buttons
        btn.classList.remove('border-green-500', 'bg-green-500', 'border-red-500', 'bg-red-500', 
                            'border-yellow-500', 'bg-yellow-500', 'border-blue-500', 'bg-blue-500', 'text-white');
        btn.classList.add('border-nfgray', 'dark:border-gray-600');
        
        if (isSelected) {
          btn.classList.remove('border-nfgray', 'dark:border-gray-600');
          if (outcome === 'contact_made') {
            btn.classList.add('border-green-500', 'bg-green-500', 'text-white');
          } else if (outcome === 'no_contact') {
            btn.classList.add('border-red-500', 'bg-red-500', 'text-white');
          } else if (outcome === 'voicemail') {
            btn.classList.add('border-yellow-500', 'bg-yellow-500', 'text-white');
          } else if (outcome === 'scheduled') {
            btn.classList.add('border-blue-500', 'bg-blue-500', 'text-white');
          }
        }
      });
    }

    // Update no-contact warning
    function updateNoContactWarning() {
      const warning = document.getElementById('no-contact-warning');
      const warningText = document.getElementById('no-contact-warning-text');
      
      if (!warning || !currentActivityContact) return;
      
      const currentStreak = currentActivityContact.no_contact_streak || 0;
      
      if (selectedOutcome === 'no_contact' || selectedOutcome === 'voicemail') {
        const newStreak = currentStreak + 1;
        warning.classList.remove('hidden');
        
        if (newStreak >= 3) {
          warningText.textContent = `âš ï¸ This will be attempt ${newStreak} of 3 - Contact will be marked as LOST!`;
          warning.classList.remove('bg-red-50', 'dark:bg-red-900/20');
          warning.classList.add('bg-red-100', 'dark:bg-red-900/40');
        } else {
          warningText.textContent = `This will be attempt ${newStreak} of 3`;
          warning.classList.remove('bg-red-100', 'dark:bg-red-900/40');
          warning.classList.add('bg-red-50', 'dark:bg-red-900/20');
        }
      } else {
        warning.classList.add('hidden');
      }
    }

    // Save activity (Contact-Based)
    async function saveActivity(e) {
      e.preventDefault();
      
      const contactId = currentActivityContact?.id;
      const notes = document.getElementById('activity-notes').value;
      const nextAction = document.getElementById('activity-next-action').value;
      const nextDate = document.getElementById('activity-next-date').value;

      console.log('[Activity] Saving activity for contact:', contactId);
      console.log('[Activity] Type:', selectedActivityType, 'Outcome:', selectedOutcome);

      if (!contactId && !currentActivityDealId) {
        toast.error('No contact or deal selected', 'Error');
        return;
      }

      const saveBtn = document.getElementById('save-activity-btn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Saving...';

      try {
        // Always use fallback (direct update) - it's more reliable
        if (contactId) {
          console.log('[Activity] Updating contact directly...');
          await saveActivityFallback(contactId, notes, nextAction, nextDate);
        } else {
          // No contact ID - update deal directly (legacy)
          await saveActivityFallbackDeal(currentActivityDealId, notes, nextAction, nextDate);
        }

        // Close modal
        document.getElementById('log-activity-modal').classList.add('hidden');
        
        // Refresh data
        if (window.loadDeals) {
          await window.loadDeals();
        }
        if (window.loadContacts) {
          await window.loadContacts();
        }
        
        // Refresh contact detail modal if open
        const detailModal = document.getElementById('contact-detail-modal');
        if (detailModal && !detailModal.classList.contains('hidden') && contactId) {
          if (window.accountsDirectory?.openContactDetailModal) {
            await window.accountsDirectory.openContactDetailModal(contactId);
          }
        }
        
        // Refresh dashboard priority actions
        if (typeof loadDashboardData === 'function') {
          loadDashboardData();
        }
        
        // Refresh priority actions page if visible
        if (typeof loadPriorityActionsPage === 'function') {
          const priorityTab = document.getElementById('tab-priority');
          if (priorityTab && !priorityTab.classList.contains('hidden')) {
            loadPriorityActionsPage();
          }
        }

      } catch (error) {
        console.error('[Activity] Error saving:', error);
        toast.error('Failed to save activity', 'Error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Save Activity';
        if (window.lucide) lucide.createIcons();
      }
    }

    // Fallback: Direct contact update
    async function saveActivityFallback(contactId, notes, nextAction, nextDate) {
      console.log('[Activity] saveActivityFallback called for:', contactId);
      
      if (!contactId) {
        if (currentActivityDealId) {
          return saveActivityFallbackDeal(currentActivityDealId, notes, nextAction, nextDate);
        }
        throw new Error('No contact or deal to save activity for');
      }
      
      const currentStreak = currentActivityContact?.no_contact_streak || 0;
      let newStreak = currentStreak;
      
      if (selectedOutcome === 'contact_made' || selectedOutcome === 'scheduled') {
        newStreak = 0;
      } else if (selectedOutcome === 'no_contact' || selectedOutcome === 'voicemail') {
        newStreak = currentStreak + 1;
      }

      // Build update data - only include fields that exist
      const updateData = {
        updated_at: new Date().toISOString()
      };

      // Try to set tracking fields (may not exist in database yet)
      updateData.no_contact_streak = newStreak;
      updateData.total_contact_attempts = (currentActivityContact?.total_contact_attempts || 0) + 1;
      updateData.last_contact_attempt_at = new Date().toISOString();
      updateData.last_contact_result = selectedOutcome;
      
      if (nextDate) {
        updateData.next_follow_up_date = nextDate;
      }
      if (nextAction) {
        updateData.next_follow_up_type = nextAction;
      }

      // Update last_contacted_at if contact was made
      if (selectedOutcome === 'contact_made') {
        updateData.last_contacted_at = new Date().toISOString();
      }

      // Auto-mark as lost if 3 no-contacts
      let autoLost = false;
      if (newStreak >= 3) {
        updateData.contact_status = 'lost';
        updateData.lost_at = new Date().toISOString();
        updateData.lost_reason = 'No response after 3 contact attempts';
        autoLost = true;
      }

      // Never PATCH contacts with null/undefined (causes 400 invalid uuid)
      if (contactId == null || String(contactId) === 'null' || String(contactId).trim() === '') {
        if (currentActivityDealId) {
          return saveActivityFallbackDeal(currentActivityDealId, notes, nextAction, nextDate);
        }
        throw new Error('No contact or deal to save activity for');
      }

      console.log('[Activity] Updating contact with:', updateData);
      
      const { data: updateResult, error: updateError } = await supabase
        .from('contacts')
        .update(updateData)
        .eq('id', contactId)
        .select();

      if (updateError) {
        console.error('[Activity] Contact update error:', updateError);
        // If specific columns don't exist, try minimal update
        if (updateError.message?.includes('column')) {
          console.log('[Activity] Trying minimal update...');
          const { error: minError } = await supabase
            .from('contacts')
            .update({ updated_at: new Date().toISOString() })
            .eq('id', contactId);
          if (minError) {
            throw minError;
          }
        } else {
          throw updateError;
        }
      } else {
        console.log('[Activity] Contact updated successfully:', updateResult);
      }

      // Insert activity record if table exists
      try {
        const { data: { user } } = await supabase.auth.getUser();
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('company_id')
          .eq('user_id', user?.id)
          .single();
          
        const activityRecord = {
          contact_id: contactId,
          deal_id: currentActivityDealId || null,
          assigned_user_id: user?.id,
          created_by: user?.id,
          activity_type: selectedActivityType || 'call',
          outcome: selectedOutcome || 'contact_made',
          notes: notes || null,
          next_action_date: nextDate || null,
          next_action_type: nextAction || null,
          company_id: profile?.company_id || null
        };
        
        console.log('[Activity] Inserting activity record:', activityRecord);
        
        const { data: actData, error: actError } = await supabase
          .from('sales_activities')
          .insert(activityRecord)
          .select();
          
        if (actError) {
          console.log('[Activity] Activity insert error (table may not exist):', actError);
        } else {
          console.log('[Activity] Activity record created:', actData);
        }
      } catch (actErr) {
        console.log('[Activity] Activities table may not exist yet:', actErr);
      }

      if (autoLost) {
        toast.warning('Contact marked as lost: 3 no-contact attempts', 'Contact Lost');
      } else {
        toast.success('Activity logged successfully', 'Success');
      }
    }

    // Fallback: Direct deal update (legacy)
    async function saveActivityFallbackDeal(dealId, notes, nextAction, nextDate) {
      const { data: { user } } = await supabase.auth.getUser();
      
      // Just update the deal's last_touch_at and insert activity
      await supabase
        .from('deals')
        .update({
          last_touch_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        })
        .eq('id', dealId);

      // Insert activity record (deal-only path: no contact)
      try {
        const { data: profile } = await supabase
          .from('user_profiles')
          .select('company_id')
          .eq('user_id', user?.id)
          .single();
        await supabase.from('sales_activities').insert({
          deal_id: dealId,
          assigned_user_id: user?.id,
          created_by: user?.id,
          activity_type: selectedActivityType || 'call',
          outcome: selectedOutcome || 'contact_made',
          notes: notes || null,
          next_action_date: nextDate || null,
          next_action_type: nextAction || null,
          company_id: profile?.company_id || null
        });
      } catch (actErr) {
        console.log('[Activity] Activities table may not exist yet:', actErr);
      }

      toast.success('Activity logged successfully', 'Success');
    }

    // Activity modal event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Activity type buttons
      document.querySelectorAll('.activity-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedActivityType = btn.dataset.type;
          updateActivityTypeButtons();
        });
      });

      // Outcome buttons
      document.querySelectorAll('.activity-outcome-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedOutcome = btn.dataset.outcome;
          updateOutcomeButtons();
          updateNoContactWarning();
        });
      });

      // Close modal
      document.getElementById('close-activity-modal')?.addEventListener('click', () => {
        document.getElementById('log-activity-modal').classList.add('hidden');
      });
      document.getElementById('cancel-activity')?.addEventListener('click', () => {
        document.getElementById('log-activity-modal').classList.add('hidden');
      });

      // Save activity
      document.getElementById('log-activity-form')?.addEventListener('submit', saveActivity);
    });

    // ========================================
    // END ACTIVITY LOGGER
    // ========================================

    // Update deal stage and convert to site if closed_won
    async function updateDealStageAndConvert(dealId, newStage) {
      try {
        // Get current deal to check if it's moving to closed_won
        const { data: currentDeal } = await supabase
          .from('deals')
          .select('*')
          .eq('id', dealId)
          .single();

        if (!currentDeal) {
          throw new Error('Deal not found');
        }

        const wasClosedWon = currentDeal.stage === 'closed_won';
        const isMovingToClosedWon = newStage === 'closed_won';
        const isMovingToClosedLost = newStage === 'closed_lost';
        const isMovingAwayFromClosed = (currentDeal.stage === 'closed_won' || currentDeal.stage === 'closed_lost') && 
                                        newStage !== 'closed_won' && newStage !== 'closed_lost';

        // Prepare update object based on stage to satisfy deals_won_lost_check constraint
        const updateData = {
          stage: newStage,
          updated_at: new Date().toISOString(),
          last_touch_at: new Date().toISOString()
        };

        // Handle closed_won: requires won_at, lost_at must be NULL, lost_reason must be NULL
        if (isMovingToClosedWon) {
          updateData.won_at = new Date().toISOString();
          updateData.lost_at = null;
          updateData.lost_reason = null;
        }
        // Handle closed_lost: requires lost_at, lost_reason, won_at must be NULL
        else if (isMovingToClosedLost) {
          updateData.lost_at = new Date().toISOString();
          updateData.won_at = null;
          // Default to 'other' if lost_reason is not already set
          updateData.lost_reason = currentDeal.lost_reason || 'other';
        }
        // Handle moving away from closed stages: clear all closed-related fields
        else if (isMovingAwayFromClosed) {
          updateData.won_at = null;
          updateData.lost_at = null;
          updateData.lost_reason = null;
        }

        // Update deal stage
        const { error: updateError } = await supabase
          .from('deals')
          .update(updateData)
          .eq('id', dealId);
        
        if (updateError) throw updateError;

        // If moving to closed_won and wasn't already closed_won, convert to site
        if (isMovingToClosedWon && !wasClosedWon) {
          await convertDealToSite(dealId, currentDeal);
        }

        toast.success('Deal stage updated', 'Success');
        
        // Send notification for stage change
        if (window.salesNotifications?.deal) {
          const oldStage = currentDeal.stage;
          await window.salesNotifications.deal.stageChanged(currentDeal, oldStage, newStage);
        }
        
        await loadDashboardData();
      } catch (error) {
        console.error('Error updating deal stage:', error);
        toast.error('Failed to update deal stage', 'Error');
      }
    }

    // Convert closed deal to site
    async function convertDealToSite(dealId, deal) {
      try {
        // Check if site already exists for this deal
        const { data: existingSite } = await supabase
          .from('sites')
          .select('id')
          .eq('deal_id', dealId)
          .maybeSingle();

        if (existingSite) {
          console.log('[Deal Conversion] Site already exists for this deal');
          return existingSite;
        }

        // Get current user
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get contact information
        let contactName = null;
        let contactPhone = null;
        let contactEmail = null;
        let address = null;

        if (deal.contact_id) {
          const { data: contact } = await supabase
            .from('contacts')
            .select('full_name, phone, email, address')
            .eq('id', deal.contact_id)
            .single();

          if (contact) {
            contactName = contact.full_name;
            contactPhone = contact.phone;
            contactEmail = contact.email;
            address = contact.address;
          }
        }

        // Create site from deal
        const siteData = {
          name: deal.company_name || deal.title || 'New Site',
          address: address || deal.address || 'Address TBD',
          contact_phone: contactPhone || deal.contact_phone || null,
          contact_email: contactEmail || deal.contact_email || null,
          deal_value: getDealValue(deal) || null,
          status: 'Active',
          notes: deal.notes || null,
          created_by: user.id
        };

        // Add deal_id if column exists (optional)
        // Note: You may need to run: ALTER TABLE sites ADD COLUMN IF NOT EXISTS deal_id UUID REFERENCES deals(id);

        const { data: newSite, error: siteError } = await supabase
          .from('sites')
          .insert(siteData)
          .select()
          .single();

        if (siteError) throw siteError;

        toast.success(`Deal converted to site: ${newSite.name}`, 'Success');
        
        // Send notification
        if (window.salesNotifications?.deal) {
          await window.salesNotifications.deal.convertedToSite(deal, newSite);
        }
        console.log('[Deal Conversion] Site created:', newSite);

        return newSite;
      } catch (error) {
        console.error('[Deal Conversion] Error converting deal to site:', error);
        toast.error('Deal stage updated, but failed to create site. Please create site manually.', 'Warning');
        throw error;
      }
    }

    window.updateDealStage = async (dealId, newStage) => {
      await updateDealStageAndConvert(dealId, newStage);
    };
    
    // Quote selection state
    window.selectedQuoteIds = new Set();

    function updateSelectAllCheckbox() {
      const selectAll = document.getElementById('quotes-select-all');
      if (!selectAll) return;
      const totalRows = document.querySelectorAll('#quotes-table-body .quote-select-checkbox').length;
      const selectedCount = window.selectedQuoteIds.size;
      selectAll.checked = totalRows > 0 && selectedCount === totalRows;
      selectAll.indeterminate = selectedCount > 0 && selectedCount < totalRows;
      updateQuoteBulkActions();
    }

    function updateQuoteBulkActions() {
      const deleteBtn = document.getElementById('quotes-delete-selected');
      if (!deleteBtn) return;
      const hasSelection = window.selectedQuoteIds.size > 0;
      deleteBtn.disabled = !hasSelection;
    }

    async function loadQuotes() {
      const tableBody = document.getElementById('quotes-table-body');
      const emptyState = document.getElementById('quotes-empty-state');
      if (!tableBody) return;
      
      try {
        // Use quotes module if available, otherwise fallback
        let quotes = [];
        if (window.quotesModule && typeof window.quotesModule.loadQuotes === 'function') {
          const statusFilter = document.getElementById('quotes-filter-status')?.value || '';
          const typeFilter = document.getElementById('quotes-filter-type')?.value || '';
          quotes = await window.quotesModule.loadQuotes({
            status: statusFilter || undefined,
            quote_type: typeFilter || undefined
          });
        } else {
          // Fallback to direct query
          const { data, error } = await supabase
            .from('quotes')
            .select('*')
            .order('updated_at', { ascending: false })
            .limit(100);
          if (error) throw error;
          quotes = data || [];
        }
        
        if (!quotes || quotes.length === 0) {
          if (tableBody) tableBody.innerHTML = '';
          if (emptyState) {
            emptyState.classList.remove('hidden');
          }
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        if (emptyState) emptyState.classList.add('hidden');
        
        // Render table rows
        tableBody.innerHTML = quotes.map(quote => {
          const siteName = quote.sites?.name || 'No Account';
          const statusColors = {
            draft: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300',
            sent: 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300',
            viewed: 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300',
            accepted: 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300',
            declined: 'bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300',
            expired: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300',
            withdrawn: 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'
          };
          const statusColor = statusColors[quote.status] || statusColors.draft;
          
          // Get latest revision info
          const revisionType = quote.quote_type === 'walkthrough_required' ? 'Proposal' : 'Final';
          let totalDisplay = 'N/A';
          if (quote.latestRevision) {
            const rev = quote.latestRevision;
            // Try total first, then calculate from subtotal + tax
            if (rev.total != null && rev.total !== 0) {
              totalDisplay = `$${Number(rev.total).toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
            } else if (rev.subtotal != null) {
              const subtotal = Number(rev.subtotal) || 0;
              const tax = Number(rev.tax) || 0;
              const calculatedTotal = subtotal + tax;
              if (calculatedTotal > 0) {
                totalDisplay = `$${calculatedTotal.toLocaleString('en-US', { minimumFractionDigits: 2 })}`;
              }
            }
          }
          
          const sentDate = quote.updated_at ? new Date(quote.updated_at).toLocaleDateString() : '-';
          const expiryDate = '-'; // Would fetch from latest revision
          
          return `
            <tr class="hover:bg-nfglight dark:hover:bg-gray-700 cursor-pointer quote-row ${window.selectedQuoteIds?.has(quote.id) ? 'bg-nfglight/60 dark:bg-gray-700/60' : ''}" data-quote-id="${quote.id}">
              <td class="px-4 py-4 whitespace-nowrap">
                <input type="checkbox" class="quote-select-checkbox h-4 w-4 text-nfgblue border-gray-300 rounded focus:ring-nfgblue" data-quote-id="${quote.id}" ${window.selectedQuoteIds?.has(quote.id) ? 'checked' : ''}>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${siteName}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                ${quote.quote_type === 'walkthrough_required' ? 'Walkthrough' : 'Standard'}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 py-1 text-xs font-medium rounded-lg ${statusColor}">${quote.status || 'draft'}</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${revisionType}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${totalDisplay}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${sentDate}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${expiryDate}</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">-</td>
              <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button class="text-nfgblue hover:text-nfgdark font-medium view-quote-btn" data-quote-id="${quote.id}">View</button>
              </td>
            </tr>
          `;
        }).join('');
        
        updateSelectAllCheckbox();
        // Click handlers are set up via event delegation in the initialization section
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading quotes:', error);
        if (tableBody) tableBody.innerHTML = `<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Failed to load quotes</td></tr>`;
      }
    }
    
    
    async function loadContacts() {
      // Load accounts directory instead
      if (window.accountsDirectory && typeof window.accountsDirectory.loadAccounts === 'function') {
        await window.accountsDirectory.loadAccounts();
      }
    }
    
    async function loadCalls() {
      const callsList = document.getElementById('calls-list');
      if (!callsList) return;
      
      try {
        // Load calls without relationship syntax to avoid FK errors
        const { data: calls, error } = await supabase
          .from('calls')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) throw error;
        
        // Optionally load deal titles if deal_id exists
        let dealsMap = new Map();
        if (calls && calls.length > 0 && calls[0].deal_id) {
          try {
            const dealIds = [...new Set(calls.map(c => c.deal_id).filter(Boolean))];
            if (dealIds.length > 0) {
              const { data: dealsData } = await supabase
                .from('deals')
                .select('id, title')
                .in('id', dealIds);
              if (dealsData) {
                dealsMap = new Map(dealsData.map(d => [d.id, d]));
              }
            }
          } catch (dealError) {
            console.warn('[Sales] Could not load deal data for calls:', dealError);
          }
        }
        
        if (!calls || calls.length === 0) {
          callsList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="phone" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No calls yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        callsList.innerHTML = calls.map(call => {
          const deal = call.deal_id ? dealsMap.get(call.deal_id) : null;
          return `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${deal?.title || call.deal_id || 'No deal'}</h3>
                <p class="text-sm text-gray-500 mt-1">${call.phone_number || 'No phone'}</p>
                <p class="text-sm text-gray-600 mt-2">${call.outcome || 'No outcome'}</p>
                <p class="text-xs text-gray-400 mt-1">${call.created_at ? new Date(call.created_at).toLocaleString() : ''}</p>
              </div>
            </div>
          </div>
        `;
        }).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading calls:', error);
        callsList.innerHTML = `
          <div class="text-center py-12">
            <i data-lucide="phone" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-2">Failed to load calls</p>
            <p class="text-sm text-gray-400">${error.message || 'Unknown error'}</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      }
    }
    
    async function loadSequences() {
      const sequencesList = document.getElementById('sequences-list');
      if (!sequencesList) return;
      
      try {
        const { data: sequences, error } = await supabase
          .from('sequences')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) {
          // Handle permission denied or table doesn't exist
          if (error.code === '42501' || error.message?.includes('permission denied')) {
            console.warn('[Sales] Sequences table not accessible - may need RLS policies or table may not exist');
            sequencesList.innerHTML = `
              <div class="text-center py-12">
                <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
                <p class="text-gray-500 mb-2">Sequences feature not available</p>
                <p class="text-sm text-gray-400">This feature requires database setup</p>
              </div>
            `;
            if (window.lucide) lucide.createIcons();
            return;
          }
          throw error;
        }
        
        if (!sequences || sequences.length === 0) {
          sequencesList.innerHTML = `
            <div class="text-center py-12">
              <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
              <p class="text-gray-500">No sequences yet</p>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
          return;
        }
        
        sequencesList.innerHTML = sequences.map(seq => `
          <div class="bg-white dark:bg-gray-800 border border-nfgray dark:border-gray-700 rounded-xl p-4">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-nfgblue dark:text-blue-400">${seq.name || 'Unnamed Sequence'}</h3>
                <p class="text-sm text-gray-500 mt-1">${seq.description || 'No description'}</p>
                <p class="text-sm text-gray-600 mt-2">Steps: ${seq.steps?.length || 0}</p>
              </div>
              <span class="px-3 py-1 rounded-lg text-xs font-medium bg-nfglight dark:bg-gray-700">
                ${seq.status || 'active'}
              </span>
            </div>
          </div>
        `).join('');
        
        if (window.lucide) lucide.createIcons();
      } catch (error) {
        console.error('Error loading sequences:', error);
        sequencesList.innerHTML = `
          <div class="text-center py-12">
            <i data-lucide="repeat" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
            <p class="text-gray-500 mb-2">Failed to load sequences</p>
            <p class="text-sm text-gray-400">${error.message || 'Unknown error'}</p>
          </div>
        `;
        if (window.lucide) lucide.createIcons();
      }
    }
    
    async function loadPerformanceMetrics() {
      try {
        const { count: dealsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true });
        
        const { count: callsCount } = await supabase
          .from('calls')
          .select('*', { count: 'exact', head: true });
        
        const { count: quotesCount } = await supabase
          .from('quotes')
          .select('*', { count: 'exact', head: true })
          .eq('status', 'sent');
        
        const { count: winsCount } = await supabase
          .from('deals')
          .select('*', { count: 'exact', head: true })
          .eq('stage', 'closed_won');
        
        const totalDealsEl = document.getElementById('total-deals');
        const totalCallsEl = document.getElementById('total-calls');
        const totalQuotesEl = document.getElementById('total-quotes');
        const totalWinsEl = document.getElementById('total-wins');
        
        if (totalDealsEl) totalDealsEl.textContent = dealsCount || 0;
        if (totalCallsEl) totalCallsEl.textContent = callsCount || 0;
        if (totalQuotesEl) totalQuotesEl.textContent = quotesCount || 0;
        if (totalWinsEl) totalWinsEl.textContent = winsCount || 0;
      } catch (error) {
        console.error('Error loading performance metrics:', error);
      }
    }
    
    // Close deal detail modal
    document.getElementById('close-deal-detail')?.addEventListener('click', () => {
      document.getElementById('deal-detail-view')?.classList.add('hidden');
    });

    // Edit and Delete deal button handlers are set up in openDealDetail function
    // via setupDealActions() which is called after rendering deal detail

    // Initialize
    console.log('[Sales Dashboard] Setting up DOMContentLoaded handler...');
    
    // Check if DOM is already loaded
    if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('[Sales Dashboard] DOMContentLoaded fired, starting initialization...');
        await initializeSalesDashboard();
      });
    } else {
      // DOM already loaded
      console.log('[Sales Dashboard] DOM already loaded, starting initialization immediately...');
      initializeSalesDashboard();
    }
    
    async function initializeSalesDashboard() {
      try {
        console.log('[Sales Dashboard] Step 1: Initializing icons...');
      if (window.lucide) lucide.createIcons();
        
        console.log('[Sales Dashboard] Step 2: Initializing tabs...');
        initTabs();
        
        console.log('[Sales Dashboard] Step 2.5: Initializing view options...');
        initViewOptions();
        
        setupClosedLostPipelineMenu();
        setupClosedWonPipelineMenu();
        setupKanbanPlusAndStageMenus();
        setupPriorityTabListeners();

        console.log('[Sales Dashboard] Step 3: Initializing UI...');
        // Initialize UI first
        if (typeof initializeUI === 'function') {
          initializeUI();
        }
        
        console.log('[Sales Dashboard] Step 4: Hiding loader...');
        // Hide loader early, before sales.init() which might redirect
        if (typeof hideLoader === 'function') {
          hideLoader();
        } else {
          // Fallback: directly hide loader
          const loader = document.getElementById('page-loader');
          if (loader) {
            loader.classList.add('hidden');
            console.log('[Sales Dashboard] âœ… Loader hidden (fallback)');
          }
        }
        
        console.log('[Sales Dashboard] Step 5: Initializing sales module...');
        // Initialize sales module (this might redirect if no user)
        if (sales && typeof sales.init === 'function') {
      await sales.init();
          console.log('[Sales Dashboard] âœ… Sales module initialized');
          
          // Initialize quotes module after sales module (to get currentUser)
          if (window.quotesModule && typeof window.quotesModule.initQuotes === 'function') {
            try {
              const { data: { user } } = await supabase.auth.getUser();
              if (user) {
                await window.quotesModule.initQuotes(user);
                console.log('[Sales Dashboard] âœ… Quotes module initialized');
              }
            } catch (err) {
              console.warn('[Sales Dashboard] âš ï¸ Could not initialize quotes module:', err);
            }
          }

          // Initialize quote wizard
          if (window.quoteWizard && typeof window.quoteWizard.initQuoteWizard === 'function') {
            window.quoteWizard.initQuoteWizard();
            console.log('[Sales Dashboard] âœ… Quote wizard initialized');
          }
        } else {
          console.warn('[Sales Dashboard] âš ï¸ Sales module or init function not available');
        }
        
        console.log('[Sales Dashboard] Step 6: Loading dashboard data...');
        // Load dashboard tab by default
        await loadDashboardData();
        
        // Check for tab parameter in URL (e.g., ?tab=tools)
        const urlParams = new URLSearchParams(window.location.search);
        const tabParam = urlParams.get('tab');
        if (tabParam && window.switchTab) {
          console.log(`[Sales Dashboard] Switching to tab from URL: ${tabParam}`);
          // Small delay to ensure everything is loaded
          setTimeout(() => {
            window.switchTab(tabParam);
            updateSidebarActiveState(tabParam);
          }, 100);
        } else {
          // Update sidebar based on default tab
          updateSidebarActiveState('dashboard');
        }
        
        console.log('[Sales Dashboard] âœ… Initialization complete!');
      } catch (error) {
        console.error('[Sales Dashboard] âŒ Error during initialization:', error);
        
        // Always hide loader on error
        if (typeof hideLoader === 'function') {
      hideLoader();
        } else {
          const loader = document.getElementById('page-loader');
          if (loader) loader.classList.add('hidden');
        }
        
        // Show error message
        const main = document.querySelector('main');
        if (main) {
          main.innerHTML = `
            <div class="flex items-center justify-center h-full p-6">
              <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-8 max-w-md text-center">
                <i data-lucide="alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                <h3 class="text-xl font-semibold text-red-600 dark:text-red-400 mb-2">Failed to Load</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">${error.message || 'An error occurred while loading the sales dashboard'}</p>
                <pre class="text-xs bg-gray-100 dark:bg-gray-700 p-2 rounded mb-4 text-left overflow-auto max-h-24">${error.stack || error.toString()}</pre>
                <button onclick="window.location.reload()" class="px-4 py-2 bg-nfgblue hover:bg-nfgdark text-white rounded-lg font-medium transition">
                  Reload Page
                </button>
              </div>
            </div>
          `;
          if (window.lucide) lucide.createIcons();
        }
      }
    }

    // Make sales module available globally
    window.sales = sales;
    window.loadTabData = loadTabData;
    
    // Setup quote filter listeners (after DOM is ready)
    setTimeout(() => {
      const quotesFilterStatus = document.getElementById('quotes-filter-status');
      const quotesFilterType = document.getElementById('quotes-filter-type');
      const quotesFilterReset = document.getElementById('quotes-filter-reset');
      
      if (quotesFilterStatus) {
        quotesFilterStatus.addEventListener('change', () => loadQuotes());
      }
      if (quotesFilterType) {
        quotesFilterType.addEventListener('change', () => loadQuotes());
      }
      if (quotesFilterReset) {
        quotesFilterReset.addEventListener('click', () => {
          if (quotesFilterStatus) quotesFilterStatus.value = '';
          if (quotesFilterType) quotesFilterType.value = '';
          loadQuotes();
        });
      }
      
      // Setup new quote buttons
      const newQuoteBtnTab = document.getElementById('new-quote-btn-tab');
      const newQuoteBtn = document.getElementById('new-quote-btn');
      
      const openQuoteModal = () => {
        if (window.quoteWizard && typeof window.quoteWizard.openQuoteWizard === 'function') {
          window.quoteWizard.openQuoteWizard();
        } else {
          if (toast) toast.error('Quote calculator not loaded', 'Error');
        }
      };
      
      if (newQuoteBtnTab) {
        newQuoteBtnTab.addEventListener('click', openQuoteModal);
      }
      if (newQuoteBtn) {
        newQuoteBtn.addEventListener('click', openQuoteModal);
      }

      // Setup quote detail modal close button
      const closeQuoteDetailBtn = document.getElementById('close-quote-detail-modal');
      const quoteDetailCloseBtn = document.getElementById('quote-detail-close-btn');
      if (closeQuoteDetailBtn) {
        closeQuoteDetailBtn.addEventListener('click', () => {
          document.getElementById('quote-detail-modal')?.classList.add('hidden');
        });
      }
      if (quoteDetailCloseBtn) {
        quoteDetailCloseBtn.addEventListener('click', () => {
          document.getElementById('quote-detail-modal')?.classList.add('hidden');
        });
      }

      // Setup lead modals close buttons
      const closeCreateLeadBtn = document.getElementById('close-create-lead-modal');
      const cancelCreateLeadBtn = document.getElementById('cancel-create-lead');
      if (closeCreateLeadBtn) {
        closeCreateLeadBtn.addEventListener('click', () => {
          document.getElementById('create-lead-modal')?.classList.add('hidden');
        });
      }
      if (cancelCreateLeadBtn) {
        cancelCreateLeadBtn.addEventListener('click', () => {
          document.getElementById('create-lead-modal')?.classList.add('hidden');
        });
      }

      const closeDispositionBtn = document.getElementById('close-disposition-modal');
      if (closeDispositionBtn) {
        closeDispositionBtn.addEventListener('click', () => {
          document.getElementById('disposition-modal')?.classList.add('hidden');
        });
      }

      const closeConvertLeadBtn = document.getElementById('close-convert-lead-modal');
      const cancelConvertLeadBtn = document.getElementById('cancel-convert-lead');
      if (closeConvertLeadBtn) {
        closeConvertLeadBtn.addEventListener('click', () => {
          document.getElementById('convert-lead-modal')?.classList.add('hidden');
        });
      }
      if (cancelConvertLeadBtn) {
        cancelConvertLeadBtn.addEventListener('click', () => {
          document.getElementById('convert-lead-modal')?.classList.add('hidden');
        });
      }

      // Setup create lead form
      const createLeadForm = document.getElementById('create-lead-form');
      if (createLeadForm) {
        createLeadForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!window.leadsDirectory) {
            console.error('Leads directory not loaded');
            return;
          }
          const formData = new FormData(e.target);
          try {
            const { createLead } = await import('./js/leads-service.js');
            await createLead({
              company_name: formData.get('company_name'),
              person_name: formData.get('person_name'),
              title: formData.get('title'),
              phone: formData.get('phone'),
              email: formData.get('email'),
              address: formData.get('address'),
              city: formData.get('city'),
              source: formData.get('source'),
              priority: parseInt(formData.get('priority')),
              notes_lite: formData.get('notes_lite')
            });
            if (toast) toast.success('Lead created');
            document.getElementById('create-lead-modal')?.classList.add('hidden');
            e.target.reset();
          } catch (error) {
            console.error('Error creating lead:', error);
            if (toast) toast.error('Failed to create lead', 'Error');
          }
        });
      }

      // Setup quote row click handlers (delegated)
      const quotesTableBody = document.getElementById('quotes-table-body');
      if (quotesTableBody) {
        quotesTableBody.addEventListener('click', (e) => {
          // Ignore clicks on checkboxes
          if (e.target.closest('.quote-select-checkbox')) return;
          const row = e.target.closest('.quote-row');
          const viewBtn = e.target.closest('.view-quote-btn');
          if (row || viewBtn) {
            const quoteId = row?.dataset.quoteId || viewBtn?.dataset.quoteId;
            if (quoteId && window.quoteDetail && typeof window.quoteDetail.openQuoteDetail === 'function') {
              window.quoteDetail.openQuoteDetail(quoteId);
            }
          }
        });

        // Handle checkbox selection
        quotesTableBody.addEventListener('change', (e) => {
          const checkbox = e.target.closest('.quote-select-checkbox');
          if (!checkbox) return;
          const quoteId = checkbox.dataset.quoteId;
          if (!quoteId) return;
          if (checkbox.checked) {
            window.selectedQuoteIds.add(quoteId);
            checkbox.closest('tr')?.classList.add('bg-nfglight/60', 'dark:bg-gray-700/60');
          } else {
            window.selectedQuoteIds.delete(quoteId);
            checkbox.closest('tr')?.classList.remove('bg-nfglight/60', 'dark:bg-gray-700/60');
          }
          updateSelectAllCheckbox();
        });
      }

      // Select all checkbox
      const selectAll = document.getElementById('quotes-select-all');
      if (selectAll) {
        selectAll.addEventListener('change', () => {
          const checkboxes = document.querySelectorAll('#quotes-table-body .quote-select-checkbox');
          checkboxes.forEach(cb => {
            cb.checked = selectAll.checked;
            const id = cb.dataset.quoteId;
            if (selectAll.checked && id) {
              window.selectedQuoteIds.add(id);
              cb.closest('tr')?.classList.add('bg-nfglight/60', 'dark:bg-gray-700/60');
            } else if (id) {
              window.selectedQuoteIds.delete(id);
              cb.closest('tr')?.classList.remove('bg-nfglight/60', 'dark:bg-gray-700/60');
            }
          });
          updateSelectAllCheckbox();
        });
      }

      // Bulk delete selected quotes
      const deleteSelectedBtn = document.getElementById('quotes-delete-selected');
      if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', async () => {
          const ids = Array.from(window.selectedQuoteIds || []);
          if (ids.length === 0) return;
          const confirmed = confirm(`Delete ${ids.length} selected quote(s)? This cannot be undone.`);
          if (!confirmed) return;
          deleteSelectedBtn.disabled = true;
          deleteSelectedBtn.textContent = 'Deleting...';
          try {
            for (const id of ids) {
              if (window.quotesModule && typeof window.quotesModule.deleteQuote === 'function') {
                await window.quotesModule.deleteQuote(id);
              }
            }
            window.selectedQuoteIds.clear();
            await loadQuotes();
            toast.success('Selected quotes deleted', 'Success');
          } catch (error) {
            console.error('[Quotes] Bulk delete error:', error);
            toast.error('Failed to delete selected quotes', 'Error');
          } finally {
            deleteSelectedBtn.textContent = 'Delete Selected';
            updateQuoteBulkActions();
          }
        });
      }
    }, 1000);

    // ========== TEAM VIEW ==========
    let teamViewInitialized = false;
    let allTeamEmployees = [];
    
    // Debounce helper function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    async function initTeamView() {
      console.log('[Team] initTeamView called');
      if (teamViewInitialized) {
        console.log('[Team] Already initialized, skipping');
        return;
      }
      
      // Check if elements exist
      const searchInput = document.getElementById('team-search-input');
      const grid = document.getElementById('team-employees-grid');
      console.log('[Team] Elements found:', { searchInput: !!searchInput, grid: !!grid });
      
      if (!grid) {
        console.error('[Team] Team employees grid not found!');
        return;
      }
      
      // Attach event listeners
      if (searchInput) {
        searchInput.addEventListener('input', debounce(applyTeamFilters, 300));
      }
      document.getElementById('team-role-filter')?.addEventListener('change', applyTeamFilters);
      document.getElementById('team-status-filter')?.addEventListener('change', applyTeamFilters);
      document.getElementById('team-sort-select')?.addEventListener('change', applyTeamFilters);
      document.getElementById('team-clear-filters-btn')?.addEventListener('click', clearTeamFilters);
      
      // Load team data
      console.log('[Team] Loading team data...');
      await loadTeamData();
      
      teamViewInitialized = true;
      console.log('[Team] Team view initialized');
    }
    
    async function loadTeamData() {
      try {
        const grid = document.getElementById('team-employees-grid');
        if (grid) {
          grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">Loading employees...</div>';
        }
        
        // Fetch all users
        const { data: users, error } = await supabase
          .from('user_profiles')
          .select('id, full_name, email, role, status, phone, created_at, profile_picture')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('[Team] Error fetching users:', error);
          if (grid) {
            grid.innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Failed to load employees. Please try again.</div>';
          }
          return;
        }
        
        if (!users || users.length === 0) {
          updateTeamSalesStats(0, 0, 0, 0, 0, 0, 0);
          renderEmployeeCards([]);
          return;
        }
        
        // Fetch stats for each employee (includes sales data)
        const employeesWithStats = await fetchEmployeeStats(users);
        allTeamEmployees = employeesWithStats;
        
        // Calculate team-wide sales statistics
        const totalRevenue = employeesWithStats.reduce((sum, emp) => sum + (emp.revenue || 0), 0);
        
        // This month revenue (closed_won deals this month)
        const thisMonth = new Date();
        thisMonth.setDate(1);
        thisMonth.setHours(0, 0, 0, 0);
        const { data: thisMonthDeals } = await supabase
          .from('deals')
          .select('deal_value, value_estimate, updated_at')
          .eq('stage', 'closed_won')
          .gte('updated_at', thisMonth.toISOString());
        const monthRevenue = (thisMonthDeals || []).reduce((sum, deal) => {
          return sum + parseFloat(deal.deal_value || deal.value_estimate || 0);
        }, 0);
        
        const activeDeals = employeesWithStats.reduce((sum, emp) => sum + (emp.activeDeals || 0), 0);
        const portfolioSize = employeesWithStats.reduce((sum, emp) => sum + (emp.portfolioSize || 0), 0);
        
        // Win rate (team average) - get actual won/lost counts
        const { data: allDealsForWinRate } = await supabase
          .from('deals')
          .select('stage')
          .in('stage', ['closed_won', 'closed_lost']);
        const totalWon = (allDealsForWinRate || []).filter(d => d.stage === 'closed_won').length;
        const totalClosed = allDealsForWinRate?.length || 0;
        const teamWinRate = totalClosed > 0 ? Math.round((totalWon / totalClosed) * 100) : 0;
        
        // Average deal value
        const { data: allClosedWon } = await supabase
          .from('deals')
          .select('deal_value, value_estimate')
          .eq('stage', 'closed_won');
        const avgDeal = allClosedWon && allClosedWon.length > 0
          ? allClosedWon.reduce((sum, d) => sum + parseFloat(d.deal_value || d.value_estimate || 0), 0) / allClosedWon.length
          : 0;
        
        // Pipeline value (active deals)
        const { data: pipelineDeals } = await supabase
          .from('deals')
          .select('deal_value, value_estimate')
          .not('stage', 'in', '(closed_won,closed_lost)');
        const pipelineValue = (pipelineDeals || []).reduce((sum, deal) => {
          return sum + parseFloat(deal.deal_value || deal.value_estimate || 0);
        }, 0);
        
        updateTeamSalesStats(totalRevenue, monthRevenue, activeDeals, portfolioSize, teamWinRate, avgDeal, pipelineValue);
        
        // Apply filters and render
        applyTeamFilters();
        
      } catch (error) {
        console.error('[Team] Error loading team data:', error);
        const grid = document.getElementById('team-employees-grid');
        if (grid) {
          grid.innerHTML = '<div class="col-span-full text-center py-8 text-red-500">Error loading employees. Please refresh the page.</div>';
        }
      }
    }
    
    async function fetchEmployeeStats(users) {
      const userIds = users.map(u => u.id);
      
      // Fetch ALL deals with all columns using * (to capture created_by, assigned_user_id, etc.)
      const { data: allDeals, error: dealsError } = await supabase
        .from('deals')
        .select('*');
      
      if (dealsError) {
        console.error('[Team] Error fetching deals:', dealsError);
      }
      
      // Debug: Log deal info
      if (allDeals && allDeals.length > 0) {
        console.log('[Team] Total deals found:', allDeals.length);
        console.log('[Team] Sample deal columns:', Object.keys(allDeals[0]));
        console.log('[Team] Sample deal owner fields:', {
          created_by: allDeals[0].created_by,
          assigned_user_id: allDeals[0].assigned_user_id,
          assigned_to: allDeals[0].assigned_to
        });
        console.log('[Team] User IDs to match:', userIds);
        
        // Check how many deals have owner set
        const ownedDeals = allDeals.filter(d => d.created_by || d.assigned_user_id);
        console.log('[Team] Deals with owner (created_by OR assigned_user_id):', ownedDeals.length);
      }
      
      // Fetch quotes via deals
      const dealIds = allDeals?.map(d => d.id) || [];
      const { data: allQuotes } = dealIds.length > 0 ? await supabase
        .from('quotes')
        .select('id, deal_id, status')
        .in('deal_id', dealIds) : { data: [] };
      
      // Fetch today's clock-in entries
      const today = new Date().toISOString().split('T')[0];
      const { data: clockIns } = await supabase
        .from('time_entries')
        .select('user_id, clock_in, notes')
        .gte('clock_in', `${today}T00:00:00`)
        .is('clock_out', null)
        .in('user_id', userIds);
      
      // Fetch all sites (for portfolio size calculation)
      const { data: allSites } = await supabase
        .from('sites')
        .select('id, created_by, assigned_worker_id');
      
      // Calculate stats for each user
      return users.map(user => {
        // Get user's deals - check BOTH created_by (owner) AND assigned_user_id
        const userDeals = allDeals?.filter(d => 
          d.created_by === user.id || 
          d.assigned_user_id === user.id ||
          d.assigned_to === user.id
        ) || [];
        
        // Debug: Log deals found for this user
        console.log(`[Team] User ${user.full_name || user.email} (${user.id}) has ${userDeals.length} deals`);
        
        // Active deals (not closed)
        const activeDeals = userDeals.filter(d => 
          d.stage !== 'closed_won' && d.stage !== 'closed_lost'
        ).length;
        
        // Closed won deals
        const closedWon = userDeals.filter(d => d.stage === 'closed_won');
        const closedLost = userDeals.filter(d => d.stage === 'closed_lost');
        
        // Revenue (sum of deal_value or value_estimate for closed_won)
        const revenue = closedWon.reduce((sum, deal) => {
          const value = parseFloat(deal.deal_value || deal.value_estimate || 0);
          return sum + value;
        }, 0);
        
        // Win rate
        const totalClosed = closedWon.length + closedLost.length;
        const winRate = totalClosed > 0 ? Math.round((closedWon.length / totalClosed) * 100) : 0;
        
        // Portfolio size (sites created by or assigned to user)
        const userSites = allSites?.filter(s => 
          s.created_by === user.id || 
          s.assigned_worker_id === user.id
        ) || [];
        const portfolioSize = userSites.length;
        
        // Clock-in status and goal
        const clockIn = clockIns?.find(c => c.user_id === user.id);
        const workDuration = clockIn ? calculateWorkDuration(clockIn.clock_in) : null;
        const goalOfDay = clockIn?.notes || null;
        
        return {
          ...user,
          activeDeals,
          revenue,
          winRate,
          portfolioSize,
          workDuration,
          goalOfDay,
          isClockedIn: !!clockIn
        };
      });
    }
    
    // Calculate work duration in "Xh Ym" format
    function calculateWorkDuration(clockInTime) {
      const now = new Date();
      const clockIn = new Date(clockInTime);
      const diff = now - clockIn;
      const hours = Math.floor(diff / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      return `${hours}h ${minutes}m`;
    }
    
    function updateTeamSalesStats(totalRevenue, monthRevenue, activeDeals, portfolioSize, winRate, avgDeal, pipelineValue) {
      const formatCurrency = (val) => {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val || 0);
      };
      
      const elements = {
        'team-total-revenue': formatCurrency(totalRevenue),
        'team-month-revenue': formatCurrency(monthRevenue),
        'team-active-deals': activeDeals || 0,
        'team-portfolio-size': portfolioSize || 0,
        'team-win-rate': `${winRate || 0}%`,
        'team-avg-deal': formatCurrency(avgDeal),
        'team-pipeline-value': formatCurrency(pipelineValue)
      };
      
      Object.entries(elements).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      });
    }
    
    function applyTeamFilters() {
      let filtered = [...allTeamEmployees];
      
      // Search filter
      const searchTerm = document.getElementById('team-search-input')?.value?.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(emp => 
          emp.full_name?.toLowerCase().includes(searchTerm) ||
          emp.email?.toLowerCase().includes(searchTerm) ||
          emp.phone?.includes(searchTerm)
        );
      }
      
      // Role filter
      const roleFilter = document.getElementById('team-role-filter')?.value || 'all';
      if (roleFilter !== 'all') {
        filtered = filtered.filter(emp => emp.role === roleFilter);
      }
      
      // Status filter
      const statusFilter = document.getElementById('team-status-filter')?.value || 'all';
      if (statusFilter !== 'all') {
        filtered = filtered.filter(emp => emp.status === statusFilter);
      }
      
      // Sort
      const sortValue = document.getElementById('team-sort-select')?.value || 'name-asc';
      const [sortField, sortDir] = sortValue.split('-');
      
      filtered.sort((a, b) => {
        let aVal, bVal;
        
        switch (sortField) {
          case 'name':
            aVal = (a.full_name || a.email || '').toLowerCase();
            bVal = (b.full_name || b.email || '').toLowerCase();
            return sortDir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
          case 'revenue':
            aVal = a.revenue || 0;
            bVal = b.revenue || 0;
            return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
          case 'winrate':
            aVal = a.winRate || 0;
            bVal = b.winRate || 0;
            return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
          case 'deals':
            aVal = a.activeDeals || 0;
            bVal = b.activeDeals || 0;
            return sortDir === 'asc' ? aVal - bVal : bVal - aVal;
          default:
            return 0;
        }
      });
      
      renderEmployeeCards(filtered);
    }
    
    function clearTeamFilters() {
      document.getElementById('team-search-input').value = '';
      document.getElementById('team-role-filter').value = 'all';
      document.getElementById('team-status-filter').value = 'all';
      document.getElementById('team-sort-select').value = 'name-asc';
      applyTeamFilters();
    }
    
    function formatCurrency(val) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val || 0);
    }
    
    function renderEmployeeCards(employees) {
      const grid = document.getElementById('team-employees-grid');
      if (!grid) return;
      
      if (employees.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500 dark:text-gray-400">No employees found matching your filters.</div>';
        return;
      }
      
      grid.innerHTML = employees.map(emp => {
        const initials = getInitials(emp.full_name || emp.email);
        const roleBadge = getRoleBadge(emp.role);
        const statusBadge = getEmployeeStatusBadge(emp.status);
        const avatarUrl = emp.profile_picture || '';
        const revenueFormatted = formatCurrency(emp.revenue || 0);
        
        return `
          <div class="bg-white dark:bg-gray-800 border border-nfgray rounded-xl shadow-nfg p-4 hover:shadow-lg transition">
            <!-- Avatar & Name -->
            <div class="flex items-center gap-3 mb-4">
              ${avatarUrl 
                ? `<img src="${avatarUrl}" alt="${emp.full_name || emp.email}" class="w-12 h-12 rounded-full object-cover">`
                : `<div class="w-12 h-12 rounded-full bg-nfgblue dark:bg-blue-600 flex items-center justify-center text-white font-medium">${initials}</div>`
              }
              <div class="flex-1">
                <h3 class="font-semibold text-gray-900 dark:text-gray-100">${emp.full_name || 'No name'}</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400">${emp.email}</p>
                ${emp.phone ? `<p class="text-xs text-gray-500 dark:text-gray-400">${emp.phone}</p>` : ''}
              </div>
            </div>
            
            <!-- Badges -->
            <div class="flex gap-2 mb-4">
              ${roleBadge}
              ${statusBadge}
            </div>
            
            <!-- Work Duration -->
            ${emp.isClockedIn ? `
              <div class="mb-3 pb-3 border-b border-nfgray dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Working</p>
                <p class="text-sm font-semibold text-green-600 dark:text-green-400">${emp.workDuration || '0h 0m'}</p>
              </div>
            ` : `
              <div class="mb-3 pb-3 border-b border-nfgray dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Status</p>
                <p class="text-sm font-semibold text-gray-500 dark:text-gray-400">Not clocked in</p>
              </div>
            `}
            
            <!-- Sales Stats -->
            <div class="grid grid-cols-3 gap-2 mb-4 pb-4 border-b border-nfgray dark:border-gray-700">
              <div class="text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400">Deals</p>
                <p class="text-lg font-semibold text-blue-600 dark:text-blue-400">${emp.activeDeals || 0}</p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400">Revenue</p>
                <p class="text-lg font-semibold text-green-600 dark:text-green-400">${revenueFormatted}</p>
              </div>
              <div class="text-center">
                <p class="text-xs text-gray-500 dark:text-gray-400">Win Rate</p>
                <p class="text-lg font-semibold text-purple-600 dark:text-purple-400">${emp.winRate || 0}%</p>
              </div>
            </div>
            
            <!-- Goal of the Day -->
            ${emp.goalOfDay ? `
              <div class="mb-4 pb-4 border-b border-nfgray dark:border-gray-700">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Goal of the Day</p>
                <p class="text-sm text-gray-700 dark:text-gray-300 italic">"${emp.goalOfDay}"</p>
              </div>
            ` : ''}
            
            <!-- Actions -->
            <div class="flex gap-2">
              <button onclick="viewEmployeeDetails('${emp.id}')" class="flex-1 px-3 py-2 text-sm rounded-lg bg-nfgblue text-white hover:bg-nfgdark transition">
                View Details
              </button>
            </div>
          </div>
        `;
      }).join('');
      
      if (window.lucide) lucide.createIcons();
    }
    
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    function getRoleBadge(role) {
      const badges = {
        'admin': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">Admin</span>',
        'super_admin': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300">Super Admin</span>',
        'staff': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300">Staff</span>',
        'client': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300">Client</span>'
      };
      return badges[role] || '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">' + (role || 'Unknown') + '</span>';
    }
    
    function getEmployeeStatusBadge(status) {
      const badges = {
        'active': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300">Active</span>',
        'pending': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-300">Pending</span>',
        'inactive': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">Inactive</span>',
        'suspended': '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300">Suspended</span>'
      };
      return badges[status] || '<span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">' + (status || 'Unknown') + '</span>';
    }
    
    async function viewEmployeeDetails(userId) {
      // Find employee in cached data
      const employee = allTeamEmployees.find(e => e.id === userId);
      if (!employee) {
        toast.error('Employee not found', 'Error');
        return;
      }
      
      const modal = document.getElementById('employee-detail-modal');
      if (!modal) return;
      
      // Populate header
      const initials = getInitials(employee.full_name || employee.email);
      const avatarEl = document.getElementById('emp-detail-avatar');
      if (employee.profile_picture) {
        avatarEl.innerHTML = `<img src="${employee.profile_picture}" class="w-12 h-12 rounded-full object-cover">`;
      } else {
        avatarEl.innerHTML = initials;
        avatarEl.className = 'w-12 h-12 rounded-full bg-nfgblue flex items-center justify-center text-white font-bold';
      }
      
      document.getElementById('emp-detail-name').textContent = employee.full_name || 'No name';
      document.getElementById('emp-detail-email').textContent = employee.email;
      
      // Populate stats
      document.getElementById('emp-detail-deals').textContent = employee.activeDeals || 0;
      document.getElementById('emp-detail-revenue').textContent = formatCurrency(employee.revenue || 0);
      document.getElementById('emp-detail-winrate').textContent = (employee.winRate || 0) + '%';
      document.getElementById('emp-detail-portfolio').textContent = employee.portfolioSize || 0;
      
      // Populate info
      document.getElementById('emp-detail-role').textContent = (employee.role || 'Unknown').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      document.getElementById('emp-detail-status').textContent = (employee.status || 'Unknown').replace(/\b\w/g, l => l.toUpperCase());
      document.getElementById('emp-detail-phone').textContent = employee.phone || 'Not provided';
      document.getElementById('emp-detail-goal').textContent = employee.goalOfDay || 'No goal set today';
      
      // Fetch and render employee's deals
      const dealsListEl = document.getElementById('emp-detail-deals-list');
      dealsListEl.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Loading deals...</p>';
      
      try {
        const { data: deals, error } = await supabase
          .from('deals')
          .select('*')
          .or(`created_by.eq.${userId},assigned_user_id.eq.${userId}`)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!deals || deals.length === 0) {
          dealsListEl.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No deals found</p>';
        } else {
          dealsListEl.innerHTML = deals.map(deal => {
            const value = parseFloat(deal.deal_value || deal.value_estimate || 0);
            const stageColors = {
              'qualification': 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300',
              'proposal': 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300',
              'negotiation': 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
              'closed_won': 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300',
              'closed_lost': 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300'
            };
            const stageColor = stageColors[deal.stage] || 'bg-gray-100 text-gray-700';
            const stageLabel = (deal.stage || 'unknown').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            return `
              <div class="bg-gray-50 dark:bg-gray-700/50 rounded-lg p-3 flex items-center justify-between cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600/50 transition" onclick="openDealFromTeam('${deal.id}')">
                <div class="flex-1">
                  <p class="font-medium text-gray-900 dark:text-white">${deal.title || 'Untitled Deal'}</p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(deal.created_at).toLocaleDateString()}</p>
                </div>
                <div class="flex items-center gap-3">
                  <span class="text-sm font-semibold text-green-600 dark:text-green-400">${formatCurrency(value)}</span>
                  <span class="px-2 py-1 text-xs font-medium rounded-full ${stageColor}">${stageLabel}</span>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('[Team] Error loading employee deals:', error);
        dealsListEl.innerHTML = '<p class="text-sm text-red-500">Failed to load deals</p>';
      }
      
      // Show modal
      modal.classList.remove('hidden');
      if (window.lucide) lucide.createIcons();
    }
    
    // Open deal from team modal
    function openDealFromTeam(dealId) {
      document.getElementById('employee-detail-modal')?.classList.add('hidden');
      if (window.sales && typeof window.sales.openDealDetail === 'function') {
        window.sales.openDealDetail(dealId);
      } else if (window.openDeal) {
        window.openDeal(dealId);
      }
    }
    
    // Make team functions globally accessible
    window.viewEmployeeDetails = viewEmployeeDetails;
    window.openDealFromTeam = openDealFromTeam;
  </script>
  <script type="module" src="./js/auth.js"></script>
</body>
</html>
